<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ERNIE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap');
:root{--bg:#050508;--bg2:#0a0a10;--bg3:#12121e;--txt:#d8e0ec;--txt2:#90a0b8;--txtd:#506080;--txtb:#e8f0ff;--blue:#5a7fa0;--gold:#c8a848;--red:#b05050;--warm:#d8a050;--purple:#8a78b8}
*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100dvh;overflow:hidden;background:#000;scrollbar-width:none}html::-webkit-scrollbar,body::-webkit-scrollbar,.g-top::-webkit-scrollbar,.g-bot::-webkit-scrollbar,.g-ch::-webkit-scrollbar{display:none}
body{font-family:'Raleway',sans-serif;background:var(--bg);color:var(--txt);user-select:none;-webkit-user-select:none;touch-action:manipulation}
button{font-family:inherit;cursor:pointer;-webkit-tap-highlight-color:transparent;border:none;background:none}
img{display:block;width:100%;height:100%;object-fit:cover}
.scr{position:fixed;inset:0;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .6s;z-index:1}.scr.on{opacity:1;pointer-events:all;z-index:10}
@keyframes flk{0%,100%{opacity:.35}50%{opacity:1}}@keyframes scan{0%{top:-100%}100%{top:100%}}
@keyframes doorGlow{0%{box-shadow:none}100%{box-shadow:0 0 20px rgba(255,255,255,.05)}}
@keyframes doorOpen{0%{background:rgba(20,20,30,.95)}100%{background:rgba(0,0,0,1);box-shadow:none}}
@keyframes catPulse{0%,100%{filter:drop-shadow(0 0 3px rgba(200,168,72,.2))}50%{filter:drop-shadow(0 0 8px rgba(200,168,72,.5))}}

#s0{background:#000;align-items:center;justify-content:center;overflow:hidden}
#s0 .aw-bg{position:absolute;inset:0;background:#000;opacity:0;transition:opacity 3s ease}
#s0 .aw-bg.on{opacity:1}
/* === MESSENGER INTRO === */
#messengerWrap{position:absolute;inset:0;display:flex;flex-direction:column;background:#000;z-index:2;opacity:0;transition:opacity 1s}
#messengerHead{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid rgba(200,168,72,.08)}
#mAvatar{width:36px;height:36px;border-radius:50%;background:rgba(200,168,72,.12);display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--gold);border:1px solid rgba(200,168,72,.2)}
#mInfo{display:flex;flex-direction:column;gap:2px}
#mName{font-family:'JetBrains Mono',monospace;font-size:13px;letter-spacing:2px;color:var(--txt)}
#mStatus{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txtd);letter-spacing:1px;transition:color .5s}
#mStatus.online{color:var(--gold)}
#messengerChat{flex:1;display:flex;flex-direction:column;justify-content:flex-end;padding:20px;gap:8px;overflow:hidden}
.mBubble{max-width:75%;padding:10px 14px;border-radius:12px 12px 12px 2px;background:rgba(90,127,160,.08);border:1px solid rgba(90,127,160,.06);font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);line-height:1.6;opacity:0;transform:translateY(12px);transition:opacity .4s,transform .4s;align-self:flex-start}
.mBubble.vis{opacity:1;transform:translateY(0)}
.mBubble.del{opacity:0;transform:translateY(-8px) scale(.95);transition:opacity .3s,transform .3s}
.mBubble.ernie{border-color:rgba(200,168,72,.1);background:rgba(200,168,72,.05)}
.mBubble .mTime{font-size:9px;color:var(--txtd);margin-top:4px;font-family:'JetBrains Mono',monospace}
#mTyping{padding:0 20px 0;opacity:0;transition:opacity .3s;display:flex;gap:3px;align-items:center;height:28px}
#mTyping.vis{opacity:1}
.mTypeDot{width:5px;height:5px;border-radius:50%;background:var(--gold);opacity:.4;animation:mDotBounce 1.2s infinite}
.mTypeDot:nth-child(2){animation-delay:.15s}
.mTypeDot:nth-child(3){animation-delay:.3s}
@keyframes mDotBounce{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-4px);opacity:.8}}
#mTapZone{padding:16px 20px;text-align:center;opacity:0;transition:opacity 1s}
#mTapZone button{width:100%;padding:12px;background:rgba(200,168,72,.06);border:1px solid rgba(200,168,72,.12);color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;border-radius:8px;cursor:pointer;transition:all .3s}
#mTapZone button:active{background:rgba(200,168,72,.15);transform:scale(.98)}
.mCrack{position:fixed;inset:0;z-index:100;pointer-events:none;opacity:0;transition:opacity .2s}
.mCrack.vis{opacity:1}
.mCrack svg{width:100%;height:100%}
.aw-scan{position:absolute;width:100%;height:2px;background:rgba(74,107,138,.05);pointer-events:none;animation:scan 3s linear infinite}
#awT{position:relative;z-index:2;font-family:'Raleway',sans-serif;font-size:15px;font-weight:300;font-style:italic;color:#fff;text-align:center;max-width:340px;line-height:1.8;letter-spacing:2px;padding:0 20px;white-space:pre-line}
#awTap{position:absolute;bottom:12%;z-index:2;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--txtd);letter-spacing:4px;animation:flk 2s ease infinite;display:none}

#s1{background:#000}.t-img{position:absolute;inset:0;z-index:1}.t-img img{width:100%;height:100%;object-fit:cover}
.t-ov{position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.85),transparent 35%,transparent 60%,rgba(0,0,0,.5));z-index:2}
.t-bot{position:absolute;bottom:8%;left:0;right:0;text-align:center;z-index:3;padding:0 24px}
.t-lbl{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--blue);opacity:.5;margin-bottom:8px}
#twT{font-family:'Raleway',sans-serif;font-size:15px;font-weight:300;font-style:italic;color:var(--txt);line-height:2;white-space:pre-line;letter-spacing:1px}
#twTap{display:none;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txtd);letter-spacing:3px;margin-top:16px;animation:flk 2s ease infinite}

#s2{background:#000;align-items:center;justify-content:center}
#door{width:120px;height:180px;border:1px solid rgba(200,180,120,.1);background:rgba(15,15,25,.95);position:relative;transition:all 1.8s ease;cursor:pointer}
#door.glow{border-color:rgba(255,255,255,.1);animation:none}
#door.open{width:100vw;height:100dvh;border-color:transparent;animation:doorOpen 1.8s ease forwards;cursor:default}
#doorLbl{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:5px;color:var(--txt2);opacity:0;transition:opacity .6s;white-space:nowrap;z-index:5}
#doorHint{display:none;position:absolute;bottom:18%;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txtd);letter-spacing:3px;animation:flk 2s ease infinite}

/* === GAME: FLEXBOX LAYOUT === */
#sg{background:var(--bg)}
.g-hud{padding:8px 14px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;opacity:.7;transition:opacity .8s}.g-hud.active{opacity:1}
.g-hud-l{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--blue);opacity:.8}
.g-hud-r{display:flex;gap:10px;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--txt2)}.g-hud-r span{display:flex;align-items:center;gap:3px}
.g-tower{width:3px;height:18px;background:rgba(74,107,138,.15);border-radius:2px;position:relative;margin:0 6px}
.g-tower-fill{position:absolute;bottom:0;width:100%;background:var(--blue);border-radius:2px;transition:height .8s ease;height:10%}
.g-tower-dot{position:absolute;width:5px;height:5px;background:var(--gold);border-radius:50%;left:-1px;transition:bottom .8s ease;bottom:10%;box-shadow:0 0 4px rgba(200,168,72,.4)}

/* Top text */
.g-top{padding:6px 20px 4px;min-height:100px;max-height:35vh;flex-shrink:0;overflow-y:auto;display:flex;flex-direction:column;justify-content:flex-end}

/* Center image - FIXED height, centered */
.g-imgw{width:100%;height:34vh;min-height:170px;overflow:hidden;flex-shrink:0;background:var(--bg2);position:relative}
.g-imgw img{object-fit:cover;transform:scale(1.08);animation:kenburns 25s ease-in-out infinite alternate}
@keyframes kenburns{0%{transform:scale(1.08) translate(0,0)}100%{transform:scale(1.14) translate(-1%,-1%)}}
/* === IMAGE STYLE UNIFICATION === */
.g-imgw img,.t-img img{filter:saturate(.6) brightness(.85) contrast(1.1) sepia(.08)}
.g-imgw::after{content:'';position:absolute;inset:0;z-index:3;pointer-events:none;opacity:.06;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.void-mode .g-imgw img{filter:saturate(.3) brightness(1.4) contrast(.9) sepia(.05)}
.void-mode #sg{background:#d8d8d8!important}
.void-mode .d-txt.stage{color:#444!important}
.void-mode .d-txt.narr{color:#555!important}
.void-mode .d-txt{color:#333!important}
.void-mode .d-txt.er{color:#2a5a5a!important}
.void-mode .d-spk{color:#444!important}
.void-mode .g-ctr{color:#555!important}
.ending-mode .g-imgw img{filter:saturate(.65) brightness(.85) contrast(1.1) sepia(.2)}
.g-imgov{position:absolute;inset:0;background:linear-gradient(0deg,var(--bg) 0%,transparent 6%);pointer-events:none;z-index:2}
/* GHOST NPC FLICKER */
@keyframes ghostNpc{0%,100%{opacity:.75;filter:brightness(.95)}40%{opacity:.9;filter:brightness(1.05)}70%{opacity:.8;filter:brightness(.98)}}
.g-imgw.npc-ghost img{animation:ghostNpc 4s ease infinite,kenburns 25s ease-in-out infinite alternate}
/* BREATHING BG */

/* AMBIENT PULSE — фон реагирует на происходящее */
@keyframes ambGold{0%,100%{box-shadow:inset 0 0 80px rgba(200,168,72,.02)}50%{box-shadow:inset 0 0 80px rgba(200,168,72,.06)}}
@keyframes ambRed{0%,100%{box-shadow:inset 0 0 80px rgba(176,80,80,.02)}50%{box-shadow:inset 0 0 80px rgba(176,80,80,.08)}}
@keyframes ambWarm{0%,100%{box-shadow:inset 0 0 80px rgba(216,160,80,.02)}50%{box-shadow:inset 0 0 80px rgba(216,160,80,.05)}}
@keyframes ambCold{0%,100%{box-shadow:inset 0 0 80px rgba(90,127,160,.02)}50%{box-shadow:inset 0 0 80px rgba(90,127,160,.06)}}
.amb-gold #sg{animation:ambGold 3s ease infinite}
.amb-red #sg{animation:ambRed 2s ease infinite}
.amb-warm #sg{animation:ambWarm 4s ease infinite}
.amb-cold #sg{animation:ambCold 3s ease infinite}
@keyframes breathe{0%,100%{background:#0a0a12}50%{background:#070710}}
#sg::after{content:'';position:absolute;inset:0;z-index:0;pointer-events:none;opacity:.1;transition:all 3s ease;background:radial-gradient(ellipse at 20% 80%,var(--ambient1,rgba(200,168,72,.03)) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,var(--ambient2,rgba(90,127,160,.02)) 0%,transparent 50%)}
@keyframes ambientShift{0%,100%{opacity:.3}50%{opacity:.5}}
#sg::after{animation:ambientShift 8s ease infinite}
#sg{animation:breathe 6s ease infinite;position:relative}
#sg::before{content:'';position:absolute;inset:0;opacity:.03;z-index:0;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}

/* DUST PARTICLES */
.g-dust{position:absolute;inset:0;z-index:1;pointer-events:none;overflow:hidden}
.g-dust i{position:absolute;width:2px;height:2px;background:rgba(200,200,200,.15);border-radius:50%;animation:dustFloat linear infinite}
.g-dust i:nth-child(1){left:10%;top:80%;animation-duration:8s;animation-delay:0s}
.g-dust i:nth-child(2){left:30%;top:90%;animation-duration:11s;animation-delay:1s;width:3px;height:3px}
.g-dust i:nth-child(3){left:50%;top:85%;animation-duration:9s;animation-delay:2s}
.g-dust i:nth-child(4){left:70%;top:95%;animation-duration:12s;animation-delay:0.5s;width:1px;height:1px}
.g-dust i:nth-child(5){left:85%;top:88%;animation-duration:10s;animation-delay:3s}
.g-dust i:nth-child(6){left:20%;top:92%;animation-duration:13s;animation-delay:1.5s;width:2px;height:2px}
.g-dust i:nth-child(7){left:60%;top:82%;animation-duration:7s;animation-delay:4s}
.g-dust i:nth-child(8){left:40%;top:96%;animation-duration:14s;animation-delay:2.5s;opacity:.1}
@keyframes dustFloat{0%{transform:translateY(0) translateX(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-250px) translateX(20px);opacity:0}}

/* Bottom text + nav - takes remaining space */
.g-bot-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden}
.g-bot{flex:1;padding:4px 20px;overflow-y:auto;scrollbar-width:none}


.d-spk-ava{width:24px;height:24px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:6px;border:1px solid rgba(200,168,72,.15)}
.d-spk{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:3px;margin-bottom:4px;padding:3px 14px;display:flex;justify-content:center;border-radius:12px}
.spk-er{color:var(--gold);background:rgba(200,168,72,.12);text-shadow:0 0 8px rgba(200,168,72,.15)}
.d-txt.er-sad{opacity:.7;letter-spacing:.5px}
.d-txt.er-angry{animation:erShake .1s ease 3;color:#e8c858}
@keyframes erShake{0%,100%{transform:translateX(0)}50%{transform:translateX(2px)}}
.d-txt.er-whisper{font-size:13px;opacity:.5;letter-spacing:1px}.spk-bo{color:var(--warm);background:rgba(216,160,80,.1)}.spk-li{color:var(--purple);background:rgba(138,120,184,.1)}.spk-ko{color:#70b8a0;background:rgba(112,184,160,.1)}.spk-mm{color:var(--red);background:rgba(176,80,80,.15)}.spk-bi{color:#a0c8a0;background:rgba(160,200,160,.1)}.spk-ak{color:#d4a0d4;background:rgba(212,160,212,.1)}.spk-sm{color:#60d8d8;background:rgba(96,216,216,.1)}.spk-fe{color:#d88060;background:rgba(216,128,96,.12)}.spk-gh{color:#808898;background:rgba(128,136,152,.1)}.spk-rv{color:#a0a0a0;background:rgba(160,160,160,.08)}
.d-txt{font-size:16px;line-height:1.5;color:var(--txt);white-space:pre-line;text-align:center;word-break:break-word;overflow-wrap:break-word;max-width:100%;box-sizing:border-box}
.d-txt.stage{font-size:12px;color:rgba(144,160,184,.6);font-style:italic;text-align:center;line-height:1.6;letter-spacing:.5px}
.d-txt.narr{font-size:14px;color:var(--txt);font-style:italic;letter-spacing:1px}
.g-bot.er-active{background:linear-gradient(180deg,rgba(200,168,72,.03) 0%,rgba(200,168,72,.06) 100%);border-color:rgba(200,168,72,.12)}
.d-txt.narr{font-size:14px;color:var(--txt2);font-style:italic;text-align:center;line-height:1.45}

/* SCREEN SHAKE - урон, крики, опасность */
@keyframes shake{0%{transform:translate(1px,1px)}10%{transform:translate(-2px,-2px)}20%{transform:translate(-3px,0)}30%{transform:translate(3px,2px)}40%{transform:translate(1px,-1px)}50%{transform:translate(-1px,2px)}60%{transform:translate(-3px,1px)}70%{transform:translate(3px,1px)}80%{transform:translate(-1px,-1px)}90%{transform:translate(1px,2px)}100%{transform:translate(1px,-2px)}}
@keyframes dmgFlash{0%{opacity:1}100%{opacity:0}}
@keyframes forbidPulse{0%,100%{opacity:.5}50%{opacity:.8}}
@keyframes btnTremble{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}

/* GLITCH - Смотритель, системные ошибки */
@keyframes glitch{0%{text-shadow:2px 0 #ff0040,-2px 0 #00ffff}25%{text-shadow:-2px 0 #ff0040,2px 0 #00ffff}50%{text-shadow:2px 0 #00ffff,-2px 0 #ff0040}75%{text-shadow:-1px 0 #00ffff,1px 0 #ff0040}100%{text-shadow:2px 0 #ff0040,-2px 0 #00ffff}}
.d-txt.glitch{animation:glitch .15s infinite;color:#fff;font-weight:bold}

/* VIGNETTE - темнеет при потере жизней */
.vignette{position:fixed;inset:0;pointer-events:none;z-index:999;transition:box-shadow 1s ease}
.vig-0{box-shadow:inset 0 0 100px 40px rgba(0,0,0,.7)}
.vig-1{box-shadow:inset 0 0 80px 30px rgba(80,0,0,.5)}
.vig-2{box-shadow:inset 0 0 60px 20px rgba(60,0,0,.3)}
.vig-3{box-shadow:inset 0 0 40px 10px rgba(0,0,0,.15)}
.vig-4{box-shadow:inset 0 0 0 0 transparent}
.vig-5{box-shadow:inset 0 0 0 0 transparent}

/* WHISPER - текст проявляется из темноты */
@keyframes whisper{0%{opacity:0;filter:blur(8px)}100%{opacity:1;filter:blur(0)}}
.d-txt.whisper{animation:whisper 2s ease-out both;color:var(--txtd)}

.g-nav{display:flex;justify-content:space-between;align-items:center;padding:2px 16px;flex-shrink:0}
.g-nav button{width:44px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--txtd);border:1px solid rgba(74,107,138,.06);border-radius:2px}
.g-nav button:active{color:var(--blue)}.g-nav button:disabled{opacity:.12}
#navC{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txtd)}
#gTap{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txtd);letter-spacing:2px;text-align:center;padding:2px 0 6px;flex-shrink:0;animation:flk 2s ease infinite}

.g-ch{padding:4px 14px 10px;display:flex;flex-direction:column;gap:5px;overflow-y:auto;flex:1;justify-content:center}

.g-cb:active{transform:scale(.96);opacity:.8}
.g-loc:active{transform:scale(.97);opacity:.85}
.ch-btn:active{transform:scale(.96)}
.g-cb{padding:10px 16px;min-height:42px;-webkit-tap-highlight-color:transparent;background:rgba(18,18,30,.85);border:1px solid rgba(74,107,138,.1);color:var(--txt);font-size:14px;text-align:left;display:flex;align-items:center;gap:10px;border-radius:8px;line-height:1.4;transition:all .3s ease;opacity:0;transform:translateY(8px);animation:btnIn .4s ease forwards;backdrop-filter:blur(4px)}
.g-cb:nth-child(2){animation-delay:.15s}.g-cb:nth-child(3){animation-delay:.3s}.g-cb:nth-child(4){animation-delay:.45s}.g-cb:nth-child(5){animation-delay:.6s}
.g-cb:active{transform:scale(.97);border-color:var(--blue);background:rgba(90,127,160,.08);box-shadow:0 0 12px rgba(90,127,160,.1)}
.g-cb .cb-icon{font-size:20px;min-width:28px;text-align:center;flex-shrink:0;filter:grayscale(.6) brightness(.75)}
@keyframes btnIn{to{opacity:1;transform:translateY(0)}}
.g-cb:active{border-color:var(--gold);box-shadow:0 0 12px rgba(200,168,72,.2)}
.g-cb:active{border-color:var(--blue);transform:translateX(3px)}.g-cb.used{opacity:.2;pointer-events:none}
.g-locs{display:flex;flex-direction:column;gap:0;padding:4px 8px;width:100%;margin-top:auto}
.g-loc{width:100%;padding:14px 16px;min-height:0;-webkit-tap-highlight-color:transparent;background:rgba(200,168,72,.02);border:none;border-bottom:1px solid rgba(200,168,72,.06);border-radius:0;display:flex;flex-direction:row;align-items:center;gap:14px;transition:all .3s ease;backdrop-filter:none;opacity:0;animation:btnIn .4s ease forwards;text-align:left;cursor:pointer}
.g-loc:nth-child(2){animation-delay:.08s}.g-loc:nth-child(3){animation-delay:.16s}.g-loc:nth-child(4){animation-delay:.24s}.g-loc:nth-child(5){animation-delay:.32s}
.g-loc:last-child{border-bottom:none}
.g-loc:active{background:rgba(200,168,72,.04);border-left:2px solid rgba(200,168,72,.4);padding-left:14px}
.g-loc:active{box-shadow:none}
.g-loc:active{transform:none}.g-loc.done{opacity:.35;pointer-events:none;filter:none}.g-loc.done .g-loc-h::after{content:" ✓";color:rgba(200,168,72,.3)}
.g-loc-i{font-size:20px;opacity:.85;filter:grayscale(.7) brightness(.7);width:28px;text-align:center;flex-shrink:0}.g-loc-n{font-size:14px;color:var(--txtb);font-weight:500;font-family:'Raleway',sans-serif;letter-spacing:.5px}.g-loc-h{font-size:10px;color:var(--txt2);opacity:.7;font-style:italic;margin-left:auto;white-space:nowrap;flex-shrink:0}
.g-bar{padding:6px 18px;padding-bottom:max(10px,env(safe-area-inset-bottom));flex-shrink:0;margin-top:auto}.g-bar button{width:100%;padding:12px;border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:11px;letter-spacing:3px;border-radius:8px;background:rgba(200,168,72,.04);transition:all .3s ease}
.g-bar button:active{transform:scale(.97);background:rgba(200,168,72,.1);box-shadow:0 0 16px rgba(200,168,72,.1)}
/* ch-btn fallback */
.ch-btn{padding:10px 20px;background:rgba(18,18,30,.7);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:14px;border-radius:10px;font-family:'Raleway',sans-serif;transition:all .3s ease;backdrop-filter:blur(6px)}
.ch-btn:active{transform:scale(.97);border-color:var(--gold);background:rgba(200,168,72,.08)}

#inv{display:none;gap:4px;align-items:center;flex-wrap:wrap;padding:2px 16px;flex-shrink:0;justify-content:center}

#towerMap{position:fixed;right:6px;top:50%;transform:translateY(-50%);z-index:75;display:flex;flex-direction:column-reverse;gap:2px;opacity:.3;transition:opacity .3s}
#towerMap:hover,#towerMap:active{opacity:.7}
.tm-floor{width:8px;height:8px;border-radius:2px;background:rgba(90,127,160,.15);transition:all .3s}
.tm-floor.active{background:var(--gold);box-shadow:0 0 6px rgba(200,168,72,.3)}
.tm-floor.visited{background:rgba(90,127,160,.3)}
#bagBtn{position:fixed;bottom:72px;right:12px;z-index:150;width:40px;height:40px;background:var(--bg3);border:1px solid rgba(200,168,72,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;opacity:.85;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.3)}
#bagBtn:active{opacity:1}
#bagOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:flex;align-items:center;justify-content:center}
#bagPopup{background:var(--bg2);border:1px solid rgba(74,107,138,.15);border-radius:8px;padding:20px;min-width:200px;max-width:280px;max-height:70vh;overflow-y:auto;position:relative}
#bagTitle{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--txtd);text-align:center;margin-bottom:14px}
#bagItems{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
#bagItems .bag-item{width:80px;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;background:var(--bg3);border:1px solid rgba(74,107,138,.1);border-radius:8px;cursor:pointer;transition:border-color .3s}
#bagItems .bag-item:active{border-color:var(--gold)}
#bagItems .bag-item img{width:56px;height:56px;border-radius:6px;object-fit:cover;border:1px solid rgba(200,168,72,.15)}
#bagItems .bag-item .bag-name{font-size:9px;color:var(--txtd);letter-spacing:1px;text-align:center;line-height:1.2;font-family:'JetBrains Mono',monospace}
#bagClose{position:absolute;top:8px;right:12px;color:var(--txtd);font-size:14px;cursor:pointer}

/* ITEM POPUP - показ при получении предмета */
#itemPopup{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:110;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px}
#itemPopup.show{display:flex}
#itemPopImg{width:160px;height:160px;border-radius:10px;object-fit:cover;border:1px solid rgba(200,168,72,.2);animation:itemIn .5s ease-out}
#itemPopName{font-family:'JetBrains Mono',monospace;font-size:12px;letter-spacing:3px;color:var(--gold)}
#itemPopDesc{font-size:14px;color:var(--txt2);text-align:center;max-width:240px;line-height:1.5}
#itemPopClose{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--txtd);margin-top:8px;cursor:pointer;padding:8px 20px;border:1px solid rgba(74,107,138,.1);border-radius:3px}
#itemPopClose:active{color:var(--gold);border-color:rgba(200,168,72,.2)}
@keyframes itemIn{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}

/* NOTE POPUP - обрывки дневника */
#notePopup{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:110;display:none;align-items:center;justify-content:center}
#notePopup.show{display:flex}
#noteInner{background:#1a1710;border:1px solid rgba(200,168,72,.15);border-radius:6px;padding:24px 20px;max-width:280px;text-align:center;font-family:'Raleway',sans-serif;animation:itemIn .5s ease-out}
#noteInner .note-title{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--txtd);margin-bottom:12px}
#noteInner .note-text{font-size:18px;color:var(--txt);line-height:1.7;font-style:italic;white-space:pre-line}
#noteInner .note-close{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--txtd);margin-top:16px;cursor:pointer;padding:8px 20px;border:1px solid rgba(74,107,138,.1);border-radius:3px;display:inline-block}
/* TO BE CONTINUED */
#tbc{position:fixed;inset:0;background:#000;z-index:300;display:none;flex-direction:column;align-items:center;gap:8px;text-align:center;padding:16px 12px;overflow-y:auto;-webkit-overflow-scrolling:touch;box-sizing:border-box}
#tbc.show{display:flex}
#tbcLine{width:60px;height:1px;background:var(--blue);opacity:.3;margin-bottom:8px}
#tbcTitle{font-family:'Raleway',sans-serif;font-size:18px;font-weight:300;font-style:italic;color:var(--txt);letter-spacing:3px;line-height:1.8;opacity:0;transition:opacity 2s ease}
#tbcSub{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txtd);letter-spacing:4px;opacity:0;transition:opacity 2s ease 1.5s}
#tbcCont{font-family:'Raleway',sans-serif;font-size:14px;font-weight:300;font-style:italic;color:var(--blue);letter-spacing:2px;opacity:0;transition:opacity 2s ease 3s;margin-top:12px}
#tbcReplay{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txtd);letter-spacing:2px;opacity:0;transition:opacity 1s ease 4s;cursor:pointer;padding:8px 20px;border:1px solid rgba(74,107,138,.1);border-radius:3px;margin-top:16px}
#tbcReplay:active{color:var(--blue);border-color:var(--blue)}
#ravenPopup{position:fixed;top:-200px;left:12px;transform:none;z-index:210;max-width:280px;width:85%;background:rgba(10,10,18,.95);border:1px solid rgba(160,160,160,.15);border-radius:10px;padding:12px;display:flex;gap:10px;align-items:flex-start;transition:top .5s ease;box-shadow:0 4px 20px rgba(0,0,0,.5)}
#ravenPopup.show{top:50px}
#ravenPopImg{width:60px;height:60px;border-radius:50%;object-fit:cover;border:1px solid rgba(160,160,160,.15);flex-shrink:0}
#ravenPopRight{flex:1;min-width:0}
#ravenPopName{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:#a0a0a0;margin-bottom:4px}
#ravenPopText{font-size:12px;color:var(--txt);line-height:1.5;white-space:pre-line}
#ravenPopClose{position:absolute;top:6px;right:10px;font-size:12px;color:var(--txtd);cursor:pointer}
.inv-i{width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:15px;background:var(--bg3);border:1px solid rgba(74,107,138,.1);border-radius:50%}
.cat-glow{animation:catPulse 2s ease infinite;border-color:rgba(200,168,72,.2)}
.riddle-wrap{padding:6px 18px 10px;flex-shrink:0;display:none;flex-direction:column;gap:6px}
.riddle-q{font-size:17px;color:var(--txt);text-align:center;line-height:1.4;padding:4px 0;white-space:pre-line}
.riddle-timer{height:4px;background:rgba(74,107,138,.12);border-radius:2px;overflow:hidden;margin:4px 0}
.riddle-bar{height:100%;background:var(--gold);border-radius:2px;transition:width .1s linear;width:100%}
.riddle-bar.danger{background:var(--red)}
.riddle-opts{display:flex;flex-direction:column;gap:5px}
.riddle-btn{padding:11px 14px;background:var(--bg3);border:1px solid rgba(74,107,138,.08);color:var(--txt);font-size:16px;text-align:left;border-radius:5px;font-family:inherit;cursor:pointer}
.riddle-btn:active{border-color:var(--blue);transform:translateX(3px)}
.riddle-btn.correct{border-color:var(--gold);background:rgba(200,168,72,.1);color:var(--gold)}
.riddle-btn.wrong{border-color:var(--red);background:rgba(176,80,80,.1);color:var(--red);opacity:.6}
#diaryOverlay{display:none;position:fixed;inset:0;background:rgba(2,2,6,.92);z-index:300;backdrop-filter:blur(12px);overflow-y:auto;padding:20px}
#diaryOverlay.show{display:flex;flex-direction:column;align-items:center}
#diaryClose{position:fixed;top:14px;right:18px;font-size:18px;color:var(--txtd);cursor:pointer;z-index:301}
#diaryTitle{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--gold);margin:20px 0 16px;opacity:.6}
.diary-entry{background:rgba(18,18,30,.7);border:1px solid rgba(200,168,72,.08);border-radius:8px;padding:12px 16px;margin:4px 0;max-width:320px;width:100%;font-family:Raleway,sans-serif;font-size:13px;color:var(--txt2);line-height:1.6;font-style:italic;white-space:pre-line;opacity:0;animation:btnIn .4s ease forwards}
.diary-entry .de-floor{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--txtd);margin-bottom:6px}
.diary-entry .de-type{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;margin-bottom:6px}
.de-type.wall{color:var(--blue)}.de-type.letter{color:var(--gold)}.de-type.secret{color:var(--red)}.de-type.lore{color:var(--purple)}
.diary-empty{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txtd);letter-spacing:1px;margin-top:40px;text-align:center}
#wallNote{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);z-index:250;background:rgba(8,8,14,.95);border:1px solid rgba(200,168,72,.15);border-radius:10px;padding:20px 24px;max-width:300px;width:85vw;backdrop-filter:blur(12px);box-shadow:0 8px 40px rgba(0,0,0,.6);opacity:0;transition:all .4s ease}
#wallNote.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1)}
#wallNote .wn-icon{font-size:28px;text-align:center;margin-bottom:10px}
#wallNote .wn-text{font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);line-height:1.7;font-style:italic;white-space:pre-line;text-align:center}
#wallNote .wn-close{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txtd);letter-spacing:2px;text-align:center;margin-top:14px;cursor:pointer;padding:6px}
.notif{position:fixed;top:auto;bottom:60px;left:50%;transform:translateX(-50%) translateY(12px);z-index:60;padding:10px 18px;border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;pointer-events:none;opacity:0;transition:all .4s ease;white-space:nowrap;background:rgba(12,12,20,.88);border:1px solid rgba(200,168,72,.2);color:var(--gold);max-width:85vw;white-space:normal;text-align:center;backdrop-filter:blur(8px);box-shadow:0 4px 20px rgba(0,0,0,.4)}
.notif.show{opacity:1;transform:translateX(-50%) translateY(0)}.nb{border-color:rgba(176,80,80,.2);color:var(--red)}
.fade{position:fixed;inset:0;background:#000;z-index:100;opacity:0;pointer-events:none;transition:opacity .8s ease}.fade.on{opacity:1;pointer-events:all}
@keyframes pressurePulse{0%,100%{box-shadow:inset 0 0 0 0 rgba(180,40,40,0)}50%{box-shadow:inset 0 0 60px 20px rgba(180,40,40,.08)}}
.fx-pressure #sg{animation:pressurePulse 2s ease infinite}

/* === v5.0 НОВЫЕ ЭФФЕКТЫ === */
/* Сердцебиение ERNIE при откровении */
@keyframes heartbeat{0%,100%{transform:scale(1)}15%{transform:scale(1.04)}30%{transform:scale(1)}45%{transform:scale(1.02)}60%{transform:scale(1)}}
.fx-heart #gImgW{animation:heartbeat 1.2s ease infinite}

/* Эффект воспоминания - тёплая засветка */
@keyframes memoryGlow{0%{filter:sepia(0) brightness(1)}50%{filter:sepia(.4) brightness(1.15) saturate(.8)}100%{filter:sepia(0) brightness(1)}}
.fx-memory .g-imgw{animation:memoryGlow 4s ease infinite}

/* Эффект разрыва времени */
@keyframes timeCrack{0%,100%{filter:hue-rotate(0deg) saturate(1)}25%{filter:hue-rotate(15deg) saturate(1.2)}75%{filter:hue-rotate(-10deg) saturate(.8)}}
.fx-timecrack{animation:timeCrack 3s ease infinite}

/* Слова из темноты — новый эффект */
@keyframes emerge{0%{opacity:0;letter-spacing:8px;filter:blur(6px)}100%{opacity:1;letter-spacing:inherit;filter:blur(0)}}
.d-txt.emerge{animation:emerge .8s ease-out both}

/* Письмо от ERNIE — стиль рукописный */
.ernie-letter{background:rgba(20,16,8,.95);border:1px solid rgba(200,168,72,.12);border-radius:4px;padding:18px 16px;font-size:15px;color:rgba(220,210,180,.9);line-height:2;font-style:italic;white-space:pre-line;text-align:left;max-width:280px;margin:0 auto;position:relative}
.ernie-letter::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(transparent,transparent 31px,rgba(200,168,72,.04) 31px,rgba(200,168,72,.04) 32px);pointer-events:none;border-radius:4px}
.ernie-letter-sig{font-size:11px;color:var(--gold);opacity:.6;margin-top:12px;text-align:right;font-family:'JetBrains Mono',monospace;letter-spacing:2px}

/* Флэшбек — монохромный с виньеткой */
@keyframes flashbackIn{0%{filter:grayscale(1) brightness(2)}100%{filter:grayscale(.8) brightness(.9) sepia(.3)}}
.fx-flashback .g-imgw{animation:flashbackIn 2s ease both;border:3px solid rgba(200,168,72,.08)}

/* Новая полоска здоровья ERNIE */
#ernieHpBar{position:fixed;bottom:50px;left:14px;right:14px;z-index:55;display:none;flex-direction:column;gap:3px}
#ernieHpLabel{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txtd);letter-spacing:2px}
#ernieHpTrack{height:3px;background:rgba(90,127,160,.15);border-radius:2px;overflow:hidden}
#ernieHpFill{height:100%;background:var(--blue);border-radius:2px;transition:width 1.5s ease}

/* Таймер напряжения — тикает */
#tensionTimer{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:55;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--red);letter-spacing:3px;display:none;animation:flk .5s ease infinite}

/* Подсказка кошки — особый стиль */
.cat-hint{position:fixed;bottom:145px;right:14px;z-index:56;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);opacity:0;transition:opacity .5s;letter-spacing:1px;max-width:80px;text-align:right;line-height:1.4}

/* Прогресс этажей */
#floorProgress{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--gold));z-index:99;transition:width 1s ease;width:0%;box-shadow:0 0 8px rgba(90,127,160,.3),0 0 16px rgba(200,168,72,.15)}

/* Эффект проявляющейся надписи */
@keyframes inkBleed{0%{opacity:0;filter:blur(4px);transform:scaleX(.95)}100%{opacity:1;filter:blur(0);transform:scaleX(1)}}
.ink-reveal{animation:inkBleed .6s ease-out both}

/* Новые стили диалогов */
.d-txt.critical{color:var(--red);font-weight:600;font-size:16px;animation:flk .3s ease 5}
.d-txt.gold-text{color:var(--gold);font-style:italic}
.d-txt.whisper-slow{animation:whisper 4s ease-out both;color:var(--txtd);font-size:12px}

/* Кнопка секрета */
.g-cb.secret{border-color:rgba(200,168,72,.25);color:var(--gold)}
.g-cb.secret::before{content:'✧ '}

/* Экран флэшбека */
#flashbackScr{position:fixed;inset:0;background:#000;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center}
#flashbackScr.show{display:flex}
#flashbackYear{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:6px;color:var(--gold);opacity:.4;margin-bottom:20px}
#flashbackContent{font-family:'Raleway',sans-serif;font-size:16px;color:rgba(220,215,200,.8);text-align:center;line-height:2.2;font-style:italic;max-width:300px;white-space:pre-line}

/* Статика экрана */
@keyframes staticFlash{0%,100%{opacity:0}50%{opacity:1}}
#staticOverlay{position:fixed;inset:0;z-index:150;pointer-events:none;display:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.03) 2px,rgba(255,255,255,.03) 4px);animation:staticFlash .1s ease infinite}

/* Новый экран: Письма ERNIE */
#letterScr{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:210;display:none;align-items:center;justify-content:center;padding:24px;backdrop-filter:blur(16px)}
#letterScr.show{display:flex}
#letterInner{max-width:290px;width:100%}
#letterClose{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txtd);letter-spacing:2px;text-align:center;margin-top:16px;cursor:pointer;padding:8px;border:1px solid rgba(74,107,138,.1);border-radius:3px}

/* Эффект "кто-то смотрит" */
@keyframes eyeWatch{0%,100%{box-shadow:none}50%{box-shadow:inset 0 0 40px rgba(90,127,160,.05)}}
.being-watched{animation:eyeWatch 8s ease infinite}

/* Новые кнопки с индикатором кармы */
.g-cb[data-karma]:after{content:attr(data-karma);font-size:9px;color:var(--gold);opacity:.5;margin-left:auto;font-family:'JetBrains Mono',monospace}

/* Вода — для фонтана */
@keyframes waterRipple{0%{transform:scale(.8);opacity:.6}100%{transform:scale(2);opacity:0}}
.water-ripple{animation:waterRipple 1.5s ease-out infinite}

/* === RAIN SYSTEM === */
#rainCanvas{position:fixed;inset:0;z-index:3;pointer-events:none;opacity:0;transition:opacity 2s ease}
#rainCanvas.on{opacity:.35}

/* === DODGE GAME === */
#dodgeGame{position:fixed;inset:0;z-index:150;background:rgba(0,0,0,.95);display:none;flex-direction:column;align-items:center;justify-content:center}
#dodgeGame.on{display:flex}
#dodgeCanvas{border:1px solid rgba(90,127,160,.2);border-radius:4px;touch-action:none}
#dodgeHud{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txtd);letter-spacing:2px;margin-bottom:12px;text-align:center}
#dodgeMsg{font-family:'Raleway',sans-serif;font-size:14px;color:var(--txt2);font-style:italic;margin-top:12px;text-align:center;line-height:1.6;min-height:40px}

/* === CRT EFFECT === */
.fx-crt #sg::after{content:'';position:fixed;inset:0;z-index:998;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);animation:crtFlicker 8s ease infinite}
@keyframes crtFlicker{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.8}94%{opacity:1}96%{opacity:.9}97%{opacity:1}}

/* === HEARTBEAT VISUAL === */
@keyframes heartbeat{0%,100%{transform:scale(1)}14%{transform:scale(1.04)}28%{transform:scale(1)}42%{transform:scale(1.02)}56%{transform:scale(1)}}
.fx-heartbeat .g-imgw{animation:heartbeat 1.2s ease infinite}

/* === GLITCH FULL SCREEN === */
@keyframes glitchFull{0%,100%{transform:translate(0)}20%{transform:translate(-2px,1px)}40%{transform:translate(2px,-1px)}60%{transform:translate(-1px,2px)}80%{transform:translate(1px,-2px)}}
.fx-glitch{animation:glitchFull .15s infinite}

/* === ECHO NPC - новый персонаж === */
.spk-ec{color:#b0f0b0;background:rgba(176,240,176,.08)}
.spk-mi{color:#f0c0e0;background:rgba(240,192,224,.08)}
.spk-wt{color:#c0d0f0;background:rgba(192,208,240,.08)}

/* === LETTER GLOW === */
@keyframes letterGlow{0%,100%{text-shadow:0 0 0 transparent}50%{text-shadow:0 0 12px rgba(200,168,72,.4)}}
.d-txt.glow-txt{animation:letterGlow 2s ease infinite}

/* === MEMORY FLASH === */
@keyframes memFlash{0%{opacity:0;background:rgba(255,255,255,.15)}100%{opacity:0;background:transparent}}
.mem-flash{position:fixed;inset:0;z-index:997;pointer-events:none;animation:memFlash .3s ease-out forwards}

/* === SOUND VISUALIZER (ambient) === */
#ambViz{position:fixed;bottom:0;left:0;right:0;height:3px;z-index:2;pointer-events:none;opacity:0;transition:opacity 1s}
#ambViz.on{opacity:.3}
#ambViz canvas{width:100%;height:3px}

/* === NOTEBOOK (new item) === */
.inv-i.notebook-glow{animation:catPulse 2s ease infinite;border-color:rgba(138,120,184,.3)}
/* DYNAMIC VISUAL FX */
@keyframes flicker{0%,100%{opacity:.95}30%{opacity:.9}50%{opacity:1}80%{opacity:.92}}
@keyframes ghostBreath{0%,100%{opacity:.8;transform:scale(1)}50%{opacity:.95;transform:scale(1.01)}}
@keyframes voidPulse{0%,100%{box-shadow:inset 0 0 80px 30px rgba(255,255,255,.02)}50%{box-shadow:inset 0 0 120px 50px rgba(255,255,255,.05)}}
@keyframes shadowDrift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.fx-flicker .g-imgw{animation:flicker 4s ease infinite}
.fx-ghost .g-imgw{animation:ghostBreath 6s ease infinite}
.fx-void .g-imgw{animation:voidPulse 8s ease infinite;background:#0a0a0a}
.fx-shadow .g-imgw{position:relative}
.fx-shadow .g-imgw::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(0,0,0,.3),transparent);background-size:200% 100%;animation:shadowDrift 8s ease infinite;pointer-events:none;z-index:3}
/* CAT COMPANION */
#catComp{position:fixed;bottom:100px;right:14px;z-index:55;display:none;flex-direction:column;align-items:center;cursor:pointer}
@keyframes catPurrWiggle{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-5deg) scale(1.1)}50%{transform:rotate(0) scale(1.05)}75%{transform:rotate(5deg) scale(1.1)}100%{transform:rotate(0) scale(1)}}
#catSprite{font-size:28px;filter:drop-shadow(0 0 4px rgba(200,168,72,.3));transition:all .3s ease;transform-origin:bottom center}
#catBubble{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txt2);background:rgba(10,10,18,.85);border:1px solid rgba(200,168,72,.12);border-radius:8px;padding:3px 8px;margin-bottom:4px;opacity:0;transition:opacity .5s;white-space:nowrap;max-width:100px;text-align:center}
#catBubble.show{opacity:1}
@keyframes catBreathe{0%,100%{transform:scale(1) translateY(0)}50%{transform:scale(1.05) translateY(-2px)}}
@keyframes catPurr{0%,100%{transform:scale(1);filter:drop-shadow(0 0 4px rgba(200,168,72,.3))}50%{transform:scale(1.1);filter:drop-shadow(0 0 12px rgba(200,168,72,.6))}}
@keyframes catHiss{0%{transform:scale(1.1) rotate(-5deg)}25%{transform:scale(1.15) rotate(5deg)}50%{transform:scale(1.1) rotate(-3deg)}75%{transform:scale(1.15) rotate(3deg)}100%{transform:scale(1.1) rotate(-5deg)}}
@keyframes catPlay{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes catSleep{0%,100%{transform:scale(1) rotate(-5deg);opacity:.7}50%{transform:scale(.95) rotate(-5deg);opacity:.5}}
@keyframes catAlert{0%,100%{transform:scale(1)}50%{transform:scale(1.2);filter:drop-shadow(0 0 8px rgba(176,80,80,.5))}}
@keyframes catWait{0%,100%{transform:translateY(0) rotate(0)}30%{transform:translateY(-3px) rotate(5deg)}60%{transform:translateY(0) rotate(-3deg)}}
.cat-breathe #catSprite{animation:catBreathe 3s ease infinite}
.cat-purr #catSprite{animation:catPurr 1.5s ease infinite}
.cat-hiss #catSprite{animation:catHiss .3s ease infinite}
.cat-play #catSprite{animation:catPlay .5s ease 3}
.cat-sleep #catSprite{animation:catSleep 4s ease infinite}
.cat-alert #catSprite{animation:catAlert .4s ease infinite}
.cat-wait #catSprite{animation:catWait 2s ease infinite}
@keyframes breathDot{0%,100%{transform:scale(1);opacity:.3}50%{transform:scale(1.8);opacity:.6}}
@keyframes fogDrift{0%{opacity:.3;transform:translateY(0)}100%{opacity:.6;transform:translateY(-10px)}}
#settingsOverlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);flex-direction:column;align-items:center;justify-content:center}
#settingsOverlay.show{display:flex}
#settingsPanel{background:var(--bg2);border:1px solid rgba(74,107,138,.15);border-radius:12px;padding:24px;width:280px;max-height:80vh;overflow-y:auto}
#settingsPanel h3{font-family:JetBrains Mono,monospace;font-size:11px;letter-spacing:3px;color:var(--gold);margin:0 0 16px;text-align:center}
.s-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(74,107,138,.08)}
.s-row:last-child{border:none}
.s-lbl{font-family:JetBrains Mono,monospace;font-size:11px;color:var(--txt2);letter-spacing:1px}
.s-toggle{width:44px;height:24px;border-radius:12px;background:rgba(74,107,138,.2);border:1px solid rgba(74,107,138,.15);cursor:pointer;position:relative;transition:background .3s}
.s-toggle.on{background:rgba(200,168,72,.3);border-color:rgba(200,168,72,.3)}
.s-toggle::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:var(--txt2);transition:transform .3s}
.s-toggle.on::after{transform:translateX(20px);background:var(--gold)}
.s-range{width:100px;-webkit-appearance:none;height:4px;border-radius:2px;background:rgba(74,107,138,.2);outline:none}
.s-range::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--gold);cursor:pointer}
.s-close{margin-top:16px;width:100%;padding:10px;background:var(--bg3);border:1px solid rgba(74,107,138,.15);color:var(--txt2);font-family:JetBrains Mono,monospace;font-size:11px;letter-spacing:2px;border-radius:6px;cursor:pointer}

            /* Particles */
            .particles-container{position:fixed;inset:0;pointer-events:none;z-index:1;overflow:hidden}
            .particle{position:absolute;border-radius:50%;animation:particleFloat linear infinite;opacity:0}
            @keyframes particleFloat{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-20px) scale(0);opacity:0}}
            .particle-dust{background:rgba(200,168,72,.15);width:2px;height:2px}
            .particle-ember{background:rgba(200,168,72,.4);width:3px;height:3px;box-shadow:0 0 4px rgba(200,168,72,.3)}
            .particle-cold{background:rgba(90,127,160,.2);width:2px;height:2px}

        
            /* Screen shake */
            @keyframes screenShake{0%,100%{transform:translate(0)}10%{transform:translate(-3px,2px)}20%{transform:translate(3px,-2px)}30%{transform:translate(-2px,3px)}40%{transform:translate(2px,-3px)}50%{transform:translate(-1px,1px)}}
            .screen-shake{animation:screenShake .4s ease!important}

        
            /* Progress bar */
            #progressLine{position:fixed;bottom:0;left:0;height:1px;background:linear-gradient(90deg,rgba(200,168,72,.3),rgba(200,168,72,.6));z-index:100;transition:width 1.5s cubic-bezier(.4,0,.2,1);pointer-events:none}

        
            /* Typewriter cursor */
            .tw-cursor::after{content:"▌";color:rgba(200,168,72,.5);animation:twBlink .6s step-end infinite;margin-left:1px}
            @keyframes twBlink{0%,100%{opacity:1}50%{opacity:0}}
            .tw-done::after{content:"";display:none}

        
            /* ERNIE voice fading on high floors */
            
.ernie-glitch .g-loc-n{animation:glitchText 3s infinite}
@keyframes glitchText{0%,95%{transform:none;opacity:1}96%{transform:translate(-2px,1px) skew(-1deg);opacity:.8}97%{transform:translate(2px,-1px);opacity:.6}98%{transform:translate(-1px,2px) skew(2deg);opacity:.9}100%{transform:none;opacity:1}}
.ernie-glitch .g-img{filter:hue-rotate(10deg) saturate(1.2) contrast(1.1)}
.ernie-glitch .g-hud{animation:hudGlitch 5s infinite}
@keyframes hudGlitch{0%,90%{transform:none}91%{transform:translateX(-2px)}92%{transform:translateX(3px)}93%{transform:none}}
#fakeCrash847{position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;font-family:monospace}
.ernie-fading .er{opacity:.7!important;animation:erniePulse 3s ease infinite}
            .ernie-glitch .er{animation:ernieGlitchAnim .1s ease infinite;opacity:.6!important}
            @keyframes erniePulse{0%,100%{opacity:.7}50%{opacity:.5}}
            @keyframes ernieGlitchAnim{0%{transform:translateX(0);opacity:.6}25%{transform:translateX(-2px);opacity:.3}50%{transform:translateX(1px);opacity:.7}75%{transform:translateX(-1px);opacity:.4}100%{transform:translateX(0);opacity:.6}}

        
            /* Vignette */
            #vignette{position:fixed;inset:0;pointer-events:none;z-index:2;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,.4) 100%);transition:opacity 2s}

        
            .er{text-shadow:0 0 20px rgba(200,168,72,.1)}

        
            /* Screen crack */
            @keyframes crackIn{0%{opacity:0;transform:scale(1.5)}100%{opacity:1;transform:scale(1)}}
            .crack-overlay{position:fixed;inset:0;z-index:9998;pointer-events:none;background:radial-gradient(circle at var(--cx,50%) var(--cy,50%),transparent 0%,transparent 2%,rgba(255,255,255,.03) 2.5%,transparent 3%,transparent 5%,rgba(255,255,255,.02) 5.5%,transparent 6%);animation:crackIn .3s ease-out}
            .crack-line{position:absolute;background:rgba(255,255,255,.08);transform-origin:center}

        
            /* Cafe Menu */
            #cafeMenu{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:none;align-items:center;justify-content:center;flex-direction:column}
            #cafeMenu.show{display:flex}
            .cafe-menu-card{background:rgba(20,15,10,.95);border:1px solid rgba(200,168,72,.15);border-radius:8px;padding:20px;max-width:280px;width:85%}
            .cafe-menu-title{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:4px;color:rgba(200,168,72,.5);text-align:center;margin-bottom:16px}
            .cafe-menu-item{display:flex;align-items:center;gap:12px;padding:10px 8px;border-bottom:1px solid rgba(200,168,72,.05);cursor:pointer;transition:background .3s}
            .cafe-menu-item:hover,.cafe-menu-item:active{background:rgba(200,168,72,.05)}
            .cafe-menu-item:last-child{border-bottom:none}
            .cafe-menu-icon{font-size:20px;width:32px;text-align:center}
            .cafe-menu-name{font-family:'Raleway',sans-serif;font-size:13px;color:var(--txt2);font-weight:300}
            .cafe-menu-price{font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(200,168,72,.3);margin-top:2px}
            .cafe-menu-note{font-family:'Raleway',sans-serif;font-size:10px;color:rgba(200,168,72,.25);font-style:italic;text-align:center;margin-top:12px;line-height:1.6}

        
            /* Location hover/focus glow */
            .g-loc:not(.done):hover,.g-loc:not(.done):focus{background:rgba(200,168,72,.03);border-left:2px solid rgba(200,168,72,.2);padding-left:14px}

/* ============================================================ */
/* === v96 EMOTIONAL REVOLUTION — 10 NEW SYSTEMS === */
/* ============================================================ */

/* 1. HOLD-TO-CHOOSE — тяжёлые решения */
.g-cb[data-w="heavy"]{position:relative;overflow:hidden;border-color:rgba(176,80,80,.2);background:rgba(176,80,80,.03)}
.g-cb[data-w="heavy"]::before{content:'';position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,rgba(176,80,80,.15),rgba(200,168,72,.1));transition:none;z-index:0;pointer-events:none}
.g-cb[data-w="heavy"].holding::before{width:100%;transition:width var(--hold-dur,2.5s) linear}
.g-cb[data-w="heavy"] .hold-hint{font-family:'JetBrains Mono',monospace;font-size:8px;color:rgba(176,80,80,.4);display:block;margin-top:3px;letter-spacing:1px;transition:color .3s}
.g-cb[data-w="heavy"].holding .hold-hint{color:rgba(200,168,72,.6)}
.ch-btn[data-w="heavy"]{position:relative;overflow:hidden;border-color:rgba(176,80,80,.2)}
.ch-btn[data-w="heavy"]::before{content:'';position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,rgba(176,80,80,.15),rgba(200,168,72,.1));z-index:0;pointer-events:none}
.ch-btn[data-w="heavy"].holding::before{width:100%;transition:width var(--hold-dur,2.5s) linear}

/* 2. HEARTBEAT OVERLAY */
@keyframes heartbeatScreen{0%,100%{box-shadow:inset 0 0 0 0 transparent}15%{box-shadow:inset 0 0 40px 10px rgba(180,50,50,.06)}30%{box-shadow:inset 0 0 0 0 transparent}45%{box-shadow:inset 0 0 25px 5px rgba(180,50,50,.04)}60%{box-shadow:inset 0 0 0 0 transparent}}
.heartbeat-sync{animation:heartbeatScreen 1.1s ease infinite}
.heartbeat-fast{animation:heartbeatScreen .7s ease infinite}
.heartbeat-stop{animation:none!important;transition:box-shadow 3s ease;box-shadow:inset 0 0 0 0 transparent}
@keyframes heartFlash{0%{opacity:0}50%{opacity:1}100%{opacity:0}}
#heartbeatLine{position:fixed;bottom:0;left:0;right:0;height:2px;z-index:100;pointer-events:none;opacity:0}
.heartbeat-sync #heartbeatLine,.heartbeat-fast #heartbeatLine{opacity:1;background:linear-gradient(90deg,transparent,rgba(180,60,60,.4),transparent);animation:heartFlash 1.1s ease infinite}
.heartbeat-fast #heartbeatLine{animation-duration:.7s}

/* 3. GUILT ECHO */
@keyframes guiltFlicker{0%,95%{opacity:0}96%{opacity:.3}97%{opacity:0}98%{opacity:.2}100%{opacity:0}}
.guilt-echo{position:fixed;pointer-events:none;z-index:500;font-family:'Raleway',sans-serif;font-style:italic;color:rgba(176,80,80,.3);animation:guiltFlicker 8s ease infinite;white-space:nowrap}
@keyframes guiltPulse{0%,100%{box-shadow:none}50%{box-shadow:inset 0 0 60px 15px rgba(176,80,80,.04)}}
.guilt-active #sg{animation:guiltPulse 4s ease infinite}

/* 4. PROMISE BADGE */
@keyframes promisePulse{0%,100%{opacity:.3}50%{opacity:.7}}
#promiseWhisper{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:500;pointer-events:none;font-family:'Raleway',sans-serif;font-size:13px;font-style:italic;color:rgba(200,168,72,.3);opacity:0;transition:opacity 2s ease;text-align:center;white-space:pre-line;max-width:250px;text-shadow:0 0 20px rgba(200,168,72,.2)}
#promiseWhisper.show{opacity:1}

/* 5. ERNIE MOOD INDICATORS */
.ernie-mood-cold .d-txt.er{opacity:.5;letter-spacing:1px}
.ernie-mood-guarded .d-txt.er{opacity:.7}
.ernie-mood-warming .d-txt.er{text-shadow:0 0 15px rgba(200,168,72,.08)}
.ernie-mood-open .d-txt.er{text-shadow:0 0 25px rgba(200,168,72,.15)}
.ernie-mood-vulnerable .d-txt.er{text-shadow:0 0 35px rgba(200,168,72,.25);animation:ernieVulnerable 3s ease infinite}
@keyframes ernieVulnerable{0%,100%{opacity:1}50%{opacity:.85}}

/* 6. SKIP DETECTION — ERNIE hurt indicator */
@keyframes skipHurt{0%{border-color:rgba(200,168,72,.15)}50%{border-color:rgba(176,80,80,.3)}100%{border-color:rgba(200,168,72,.15)}}
.skip-hurt .g-imgw{animation:skipHurt 1s ease}
.patience-glow .g-imgw{box-shadow:inset 0 0 30px rgba(200,168,72,.08);transition:box-shadow 2s ease}

/* 7. EMOTIONAL TEMPERATURE BAR */
#emotionBar{position:fixed;top:0;left:0;right:0;height:1px;z-index:99;pointer-events:none;transition:all 2s ease;opacity:.5}
#emotionBar.warm{background:linear-gradient(90deg,transparent 30%,rgba(200,168,72,.4) 50%,transparent 70%)}
#emotionBar.cold{background:linear-gradient(90deg,transparent 30%,rgba(90,127,160,.4) 50%,transparent 70%)}
#emotionBar.pain{background:linear-gradient(90deg,transparent 30%,rgba(176,80,80,.4) 50%,transparent 70%)}

/* 8. TIME AWARENESS BADGE */
@keyframes countFade{0%{opacity:0;transform:translateY(10px)}50%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-10px)}}
.time-count{position:fixed;top:15%;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:10px;color:rgba(200,168,72,.2);z-index:50;pointer-events:none;animation:countFade 4s ease forwards;letter-spacing:2px}

/* 9. PATTERN RECOGNITION BADGE */
#patternNote{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(90,127,160,.3);z-index:50;pointer-events:none;opacity:0;transition:opacity 2s;letter-spacing:1px;white-space:nowrap}
#patternNote.show{opacity:1}

/* 10. NPC CROSS-REFERENCE GLOW */
@keyframes crossRef{0%{border-color:rgba(200,168,72,.1)}50%{border-color:rgba(200,168,72,.25)}100%{border-color:rgba(200,168,72,.1)}}
.cross-ref{animation:crossRef 2s ease 2;border-radius:4px}

/* BONUS: Breathing text for emotional moments */
@keyframes breatheText{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.9;transform:scale(1.005)}}
.d-txt.breathe{animation:breatheText 3s ease infinite}
/* BONUS: Screen blur during dissociation */
@keyframes dissociate{0%,100%{filter:blur(0)}50%{filter:blur(1px)}}
.fx-dissociate{animation:dissociate 4s ease infinite}

/* ERNIE deleted messages — shows briefly then fades */
@keyframes ernieDel{0%{opacity:1;text-decoration:none}60%{opacity:.8;text-decoration:line-through;text-decoration-color:rgba(200,168,72,.4)}100%{opacity:0;transform:translateY(-4px)}}
.d-txt.ernie-del{animation:ernieDel 1.8s ease forwards;color:rgba(200,168,72,.4);font-size:12px}

/* ============================================================ */
/* === v97: "CAN'T CLOSE, CAN'T FORGET" ENGINE === */
/* ============================================================ */

/* ERNIE TYPING INDICATOR — как мессенджер */
#ernieTyping{position:fixed;bottom:52%;left:50%;transform:translateX(-50%);z-index:600;display:none;align-items:center;gap:6px;padding:6px 14px;background:rgba(12,12,20,.85);border:1px solid rgba(200,168,72,.08);border-radius:16px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
#ernieTyping.show{display:flex}
#ernieTyping .et-name{font-family:'JetBrains Mono',monospace;font-size:8px;color:rgba(200,168,72,.4);letter-spacing:2px}
.typing-dots{display:flex;gap:3px;margin-left:4px}
.typing-dots span{width:4px;height:4px;border-radius:50%;background:rgba(200,168,72,.5);animation:typeDot 1.4s ease infinite}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes typeDot{0%,60%,100%{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-3px)}}
/* typing deleted — ERNIE стёр */
#ernieTyping.deleted .typing-dots{display:none}
#ernieTyping.deleted::after{content:'стёр';font-family:'JetBrains Mono',monospace;font-size:8px;color:rgba(176,80,80,.3);letter-spacing:1px;margin-left:4px}

/* SUBLIMINAL FLASH */
#subFlash{position:fixed;inset:0;z-index:9990;pointer-events:none;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.95);opacity:0;transition:none}
#subFlash.fire{opacity:1;transition:opacity .05s}
#subFlash .sf-text{font-family:'Raleway',sans-serif;font-size:28px;font-weight:300;color:rgba(255,255,255,.9);letter-spacing:3px}

/* GHOST COUNTER — таинственное число в углу */
#ghostCount{position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:45;font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(90,127,160,.08);letter-spacing:4px;pointer-events:none;transition:color 2s ease,opacity 2s ease;opacity:0}
#ghostCount.active{opacity:1}
#ghostCount.pulse{color:rgba(200,168,72,.15);transition:color .3s}

/* IMAGE TOUCH SECRET — hold on image reveals */
#imgSecret{position:absolute;inset:0;z-index:3;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);opacity:0;pointer-events:none;transition:opacity .8s ease;backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px)}
#imgSecret.show{opacity:1}
#imgSecret .is-text{font-family:'Raleway',sans-serif;font-size:12px;font-style:italic;color:rgba(200,168,72,.6);text-align:center;max-width:200px;line-height:1.8;letter-spacing:1px}

/* CINEMATIC BARS — кинематографический формат */
.cine-bars #sg::before,.cine-bars #sg::after{content:'';position:fixed;left:0;right:0;height:0;background:#000;z-index:98;pointer-events:none;transition:height .8s cubic-bezier(.4,0,.2,1)}
.cine-bars #sg::before{top:0}
.cine-bars #sg::after{bottom:0;animation:none!important;opacity:1!important;background:#000!important}
.cine-bars.active #sg::before,.cine-bars.active #sg::after{height:30px}

/* MICRO-ACHIEVEMENTS — тихие шёпоты достижений */
@keyframes microAchIn{0%{opacity:0;transform:translate(-50%,10px)}30%{opacity:1;transform:translate(-50%,0)}80%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,-8px)}}
.micro-ach{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:55;padding:5px 14px;font-family:'JetBrains Mono',monospace;font-size:8px;color:rgba(200,168,72,.35);letter-spacing:2px;pointer-events:none;animation:microAchIn 3s ease forwards;white-space:nowrap;border-bottom:1px solid rgba(200,168,72,.08)}

/* ERNIE TELL — визуальный тик когда врёт */
@keyframes ernieTell{0%{opacity:1}48%{opacity:1}50%{opacity:.4}52%{opacity:1}100%{opacity:1}}
.ernie-tell .d-txt.er{animation:ernieTell 4s ease}
@keyframes ernieHesitate{0%{letter-spacing:0}50%{letter-spacing:2px}100%{letter-spacing:0}}
.ernie-hesitate .d-txt.er{animation:ernieHesitate 1.5s ease}

/* PARALLAX IMAGE SHIFT — subtle depth */
.img-parallax{transition:transform .3s ease}

/* SNAP TEXT — words appear one by one with impact */
@keyframes snapWord{0%{opacity:0;transform:scale(1.3)}100%{opacity:1;transform:scale(1)}}
.snap-word{display:inline-block;opacity:0;animation:snapWord .15s ease forwards}

/* PULSE RING — around important choices */
@keyframes pulseRing{0%{box-shadow:0 0 0 0 rgba(200,168,72,.2)}70%{box-shadow:0 0 0 8px rgba(200,168,72,0)}100%{box-shadow:0 0 0 0 rgba(200,168,72,0)}}
.pulse-choice{animation:pulseRing 2s ease infinite}

/* SCENE WIPE — horizontal reveal */
@keyframes sceneWipe{0%{clip-path:inset(0 100% 0 0)}100%{clip-path:inset(0 0 0 0)}}
.scene-wipe{animation:sceneWipe .6s cubic-bezier(.4,0,.2,1) forwards}

/* DEEP ZOOM on reveal */
@keyframes deepZoom{0%{transform:scale(1.5);filter:blur(8px);opacity:0}100%{transform:scale(1.08);filter:blur(0);opacity:1}}
.deep-zoom img{animation:deepZoom 1.2s cubic-bezier(.2,0,.2,1) forwards}
        </style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
var TG = window.Telegram && window.Telegram.WebApp;
if(TG){
    TG.expand();
    if(TG.enableClosingConfirmation && TG.version && parseFloat(TG.version) >= 6.2) {
        try { TG.enableClosingConfirmation(); } catch(e) {}
    }
    document.documentElement.style.setProperty('--tg-safe-top', (TG.safeAreaInset?.top || 0) + 'px');
    document.documentElement.style.setProperty('--tg-safe-bottom', (TG.safeAreaInset?.bottom || 0) + 'px');
}
function tgHaptic(type){
    if(TG&&TG.HapticFeedback){
        if(type==='light')TG.HapticFeedback.impactOccurred('light');
        else if(type==='medium')TG.HapticFeedback.impactOccurred('medium');
        else if(type==='heavy')TG.HapticFeedback.impactOccurred('heavy');
        else if(type==='error')TG.HapticFeedback.notificationOccurred('error');
        else if(type==='success')TG.HapticFeedback.notificationOccurred('success');
    }
}
</script>
<script>
// Global image error handler — prevent broken image icons
document.addEventListener("error",function(e){
    if(e.target.tagName==="IMG"){
        var isAvatar=e.target.width<=128||e.target.closest("#ravenPopup,#ghostPopup,.bag-item,.d-spk-ava");
        if(isAvatar){
            e.target.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect fill='%230a0a14' width='128' height='128' rx='64'/%3E%3Ccircle cx='64' cy='64' r='2' fill='%23c8a848' opacity='.2'/%3E%3C/svg%3E";
        }else{
            e.target.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='720' height='1280'%3E%3Crect fill='%23080810' width='720' height='1280'/%3E%3C/svg%3E";
        }
        e.target.style.opacity="1";
    }
},true);
</script>
</head><body>
<div id="splash" style="position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;transition:opacity .8s ease;overflow:hidden">
<div id="splashImg" style="position:absolute;inset:0;background:center/cover no-repeat;opacity:0;transition:opacity 2s ease;filter:brightness(.4) saturate(.7)"></div>
<div style="position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.9) 0%,rgba(0,0,0,.3) 40%,rgba(0,0,0,.3) 60%,rgba(0,0,0,.7) 100%);z-index:1"></div>
<div style="position:relative;z-index:2;text-align:center">
<div style="font-family:'JetBrains Mono',monospace;font-size:14px;letter-spacing:8px;color:rgba(200,168,72,.7);text-shadow:0 0 20px rgba(0,0,0,.8);margin-bottom:4px">ERNIE</div>
<div style="font-family:Raleway,sans-serif;font-size:11px;color:rgba(200,168,72,.35);text-shadow:0 0 10px rgba(0,0,0,.6);font-style:italic;letter-spacing:2px">the warden's tower</div>
</div>
<div style="position:absolute;bottom:15%;z-index:2;width:100px;height:2px;background:rgba(90,127,160,.1);border-radius:1px;overflow:hidden">
<div id="splashBar" style="height:100%;width:0%;background:linear-gradient(90deg,rgba(200,168,72,.6),rgba(90,127,160,.6));transition:width .3s ease;border-radius:1px"></div>
</div>
</div>
<div class="notif" id="notif"></div><div class="fade" id="fade"></div>
<div id="floorProgress" style="display:none"></div>
<div id="tensionTimer"></div>
<div id="staticOverlay"></div>
<div id="ernieHpBar"><div id="ernieHpLabel">ERNIE · связь</div><div id="ernieHpTrack"><div id="ernieHpFill" style="width:100%"></div></div></div>
<div id="flashbackScr"><div id="flashbackYear">1824</div><div id="flashbackContent"></div></div>
<div id="letterScr"><div id="letterInner"><div class="ernie-letter" id="letterBody"></div><div id="letterClose" onclick="closeLetter()">закрыть</div></div></div>
<canvas id="rainCanvas"></canvas>
<div id="dodgeGame">
  <div id="dodgeHud"><span id="dodgeTitle">ИСПЫТАНИЕ БАШНИ</span> · <span id="dodgeTimer">10</span>с · <span id="dodgeHP">♥♥♥</span></div>
  <canvas id="dodgeCanvas" width="280" height="200"></canvas>
  <div id="dodgeMsg"></div>
</div>
<div id="catComp" class="cat-breathe" onclick="petCat()"><div id="catBubble"></div><div id="catSprite">🐱</div></div>
</div>
<div id="s0" class="scr on">
<div class="aw-bg"></div><div class="aw-scan"></div>
<div id="messengerWrap">
<div id="messengerHead"><div id="mAvatar">E</div><div id="mInfo"><div id="mName">ERNIE</div><div id="mStatus">в сети 200 лет назад</div></div></div>
<div id="messengerChat"></div>
<div id="mTyping"><span class="mTypeDot"></span><span class="mTypeDot"></span><span class="mTypeDot"></span></div>
<div id="mTapZone"></div>
</div>
<div id="awT" style="display:none"></div><div id="awTap" style="display:none">▼</div>
</div>
<div id="s1" class="scr"><div class="t-img"><img id="twImg" src="" alt=""></div><div class="t-ov"></div><div class="t-bot"><div style="font-family:'JetBrains Mono',monospace;font-size:22px;letter-spacing:8px;color:var(--txt);opacity:.8;margin-bottom:2px">ERNIE</div><div style="font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:4px;color:var(--txtd);margin-bottom:12px">THE WARDEN'S TOWER</div><div id="twT"></div><div id="twTap">▸ войти</div></div></div>
<div id="s2" class="scr"><div id="door"><div id="doorLbl">ЭТАЖ 1 · ГОРОД ЭХО</div></div><div id="doorHint">▸</div></div>
<div id="sg" class="scr">
<div class="g-hud"><div class="g-hud-l" id="gFl">ЭТАЖ 1</div><div class="g-hud-r"><span id="settBtn" onclick="openSettings()" style="cursor:pointer;opacity:.4;transition:opacity .3s">⚙️</span><span id="diaryBtn" onclick="openDiary()" style="cursor:pointer;opacity:.4;transition:opacity .3s">📓</span><span id="hKWrap" style="display:none">◆<span id="hK">0</span></span><span id="hEWrap" style="display:none">✦<span id="hE">0</span></span><span id="hHWrap" style="opacity:0;transition:opacity 1s">♥<span id="hH">5</span></span></div></div>
<div id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
<div id="settingsPanel">
<h3>⚙ НАСТРОЙКИ</h3>
<div class="s-row"><span class="s-lbl">🔊 Звуки</span><div class="s-toggle on" id="stSfx" onclick="toggleSetting(this,'sfx')"></div></div>
<div class="s-row"><span class="s-lbl">🎵 Музыка</span><div class="s-toggle on" id="stMus" onclick="toggleSetting(this,'music')"></div></div>
<div class="s-row"><span class="s-lbl">🌧 Дождь</span><div class="s-toggle on" id="stRain" onclick="toggleSetting(this,'rain')"></div></div>
<div class="s-row"><span class="s-lbl">📳 Вибрация</span><div class="s-toggle on" id="stVib" onclick="toggleSetting(this,'vibro')"></div></div>
<div class="s-row"><span class="s-lbl">⏱ Скорость текста</span><input type="range" class="s-range" id="stSpd" min="1" max="3" value="2" oninput="setTextSpeed(this.value)"></div>
<div class="s-row"><span class="s-lbl">🔆 Яркость картинок</span><input type="range" class="s-range" id="stBr" min="1" max="3" value="2" oninput="setImgBright(this.value)"></div>
<button class="s-close" onclick="closeSettings()">ЗАКРЫТЬ</button>
</div>
</div>
<div class="g-top" id="gTop"><div class="d-spk" id="topSpk"></div><div class="d-txt" id="topTxt"></div></div>
<div class="g-imgw" id="gImgW"><img id="gI" src="" alt=""><div class="g-imgov"></div><div id="imgSecret"><div class="is-text" id="imgSecretText"></div></div><div class="g-dust"><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i></div></div>
<div class="g-bot-wrap" id="gBotW">
<div class="g-bot" id="gBot"><div class="d-spk" id="botSpk"></div><div class="d-txt" id="botTxt"></div></div>
<div class="g-nav" id="gNav"><button onclick="nP()" id="nL">◀</button><div id="navC">1/1</div><button onclick="nN()" id="nR">▶</button></div>
<div id="inv"></div>
<div id="towerMap"></div>
<div id="bagBtn" style="display:none" onclick="toggleBag()">🎒<span id="bagCount" style="position:absolute;top:-4px;right:-4px;background:rgba(200,168,72,.8);color:#000;font-size:9px;font-family:JetBrains Mono,monospace;width:16px;height:16px;border-radius:50%;display:none;align-items:center;justify-content:center;font-weight:bold"></span></div>
<div id="bagOverlay" style="display:none" onclick="event.stopPropagation();event.preventDefault();this.style.display='none';bagOpen=false">
<div id="bagPopup" onclick="event.stopPropagation()">
<div id="bagTitle">СУМКА</div>
<div id="bagItems"></div>
<div id="bagClose" onclick="document.getElementById('bagOverlay').style.display='none'">✕</div>
</div>
</div>
<div id="gTap">▸</div>
</div>
<div class="g-ch" id="gCh" style="display:none"></div>
<div class="riddle-wrap" id="riddleW"></div>
<div class="g-bar" id="gBar" style="display:none"></div>
</div>

<script>
var I={
  // ОБЩИЕ
  tower_horiz:"https://raw.githubusercontent.com/akbole/ernie-assets/main/tower_horiz.jpg",
  tower_inside:"https://raw.githubusercontent.com/akbole/ernie-assets/main/tower_inside.jpg",
  borisVid:"https://github.com/akbole/ernie-warden/raw/refs/heads/main/%D0%A3%D0%BA%D0%BB%D0%B0%D1%9A%D0%B0%D1%9A%D0%B5_%D0%B7%D0%B0%D1%82%D0%B5%D0%BC%D1%9A%D0%B5%D1%9A%D0%B0_%D1%81%D0%B0_%D0%B2%D0%B8%D0%B4%D0%B5%D0%B0.mp4",
  // ПРОЛОГ
  prologue_door:"https://raw.githubusercontent.com/akbole/ernie-assets/main/prologue_door.jpg",
  prologue_peek:"https://raw.githubusercontent.com/akbole/ernie-assets/main/prologue_peek.jpg",
  prologue_street:"https://raw.githubusercontent.com/akbole/ernie-assets/main/prologue_street.jpg",
  // ЭТАЖ 1
  city:"https://raw.githubusercontent.com/akbole/ernie-assets/main/city.jpg",
  boris:"https://raw.githubusercontent.com/akbole/ernie-assets/main/boris.jpg",
  cafe_ext:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cafe_ext.jpg",
  cafe_inside:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cafe_inside.jpg",
  lika:"https://raw.githubusercontent.com/akbole/ernie-assets/main/lika.jpg",
  lika_drawing:"https://raw.githubusercontent.com/akbole/ernie-assets/main/lika_drawing.jpg",
  wall:"https://raw.githubusercontent.com/akbole/ernie-assets/main/wall.jpg",
  cat:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cat.jpg",
  cat_closeup:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cat_closeup.jpg",
  trumpeter:"https://raw.githubusercontent.com/akbole/ernie-assets/main/trumpeter.jpg",
  basement_stairs:"https://raw.githubusercontent.com/akbole/ernie-assets/main/basement_stairs.jpg",
  // ЭТАЖ 2
  station:"https://raw.githubusercontent.com/akbole/ernie-assets/main/station.jpg",
  conductor:"https://raw.githubusercontent.com/akbole/ernie-assets/main/conductor.jpg",
  clock:"https://raw.githubusercontent.com/akbole/ernie-assets/main/clock.jpg",
  phone:"https://raw.githubusercontent.com/akbole/ernie-assets/main/phone.jpg",
  shadow:"https://raw.githubusercontent.com/akbole/ernie-assets/main/shadow.jpg",
  shadow_boy:"https://raw.githubusercontent.com/akbole/ernie-assets/main/shadow_boy.jpg",
  nora:"https://raw.githubusercontent.com/akbole/ernie-assets/main/nora.jpg",
  train_inside:"https://raw.githubusercontent.com/akbole/ernie-assets/main/train_inside.jpg",
  // ЭТАЖ 3
  library:"https://raw.githubusercontent.com/akbole/ernie-assets/main/library.jpg",
  librarian:"https://raw.githubusercontent.com/akbole/ernie-assets/main/librarian.jpg",
  burned:"https://raw.githubusercontent.com/akbole/ernie-assets/main/burned.jpg",
  door_room:"https://raw.githubusercontent.com/akbole/ernie-assets/main/door_room.jpg",
  forbidden:"https://raw.githubusercontent.com/akbole/ernie-assets/main/forbidden.jpg",
  demon_book:"https://raw.githubusercontent.com/akbole/ernie-assets/main/demon_book.jpg",
  ash_floor:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ash_floor.jpg",
  ernie_corner:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_corner.jpg",
  // ЭТАЖ 4
  theater:"https://raw.githubusercontent.com/akbole/ernie-assets/main/theater.jpg",
  actor:"https://raw.githubusercontent.com/akbole/ernie-assets/main/actor.jpg",
  actor_mask:"https://raw.githubusercontent.com/akbole/ernie-assets/main/actor_mask.jpg",
  actor_real:"https://raw.githubusercontent.com/akbole/ernie-assets/main/actor_real.jpg",
  mirror:"https://raw.githubusercontent.com/akbole/ernie-assets/main/mirror.jpg",
  audience:"https://raw.githubusercontent.com/akbole/ernie-assets/main/audience.jpg",
  orchestra:"https://raw.githubusercontent.com/akbole/ernie-assets/main/orchestra.jpg",
  alisa:"https://raw.githubusercontent.com/akbole/ernie-assets/main/alisa.jpg",
  // ЭТАЖ 5
  lab:"https://raw.githubusercontent.com/akbole/ernie-assets/main/lab.jpg",
  watcher:"https://raw.githubusercontent.com/akbole/ernie-assets/main/lab.jpg",
  ernie_room:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_room.jpg",
  lab_door:"https://raw.githubusercontent.com/akbole/ernie-assets/main/lab_door.jpg",
  archive:"https://raw.githubusercontent.com/akbole/ernie-assets/main/archive.jpg",
  archive_folder:"https://raw.githubusercontent.com/akbole/ernie-assets/main/archive_folder.jpg",
  camera_wall:"https://raw.githubusercontent.com/akbole/ernie-assets/main/camera_wall.jpg",
  // ЭТАЖ 6
  garden:"https://raw.githubusercontent.com/akbole/ernie-assets/main/garden.jpg",
  tree:"https://raw.githubusercontent.com/akbole/ernie-assets/main/tree.jpg",
  tree_memory:"https://raw.githubusercontent.com/akbole/ernie-assets/main/tree_memory.jpg",
  fountain:"https://raw.githubusercontent.com/akbole/ernie-assets/main/fountain.jpg",
  fountain_vision:"https://raw.githubusercontent.com/akbole/ernie-assets/main/fountain_vision.jpg",
  gazebo:"https://raw.githubusercontent.com/akbole/ernie-assets/main/gazebo.jpg",
  gazebo_ghost:"https://raw.githubusercontent.com/akbole/ernie-assets/main/gazebo_ghost.jpg",
  wilted:"https://raw.githubusercontent.com/akbole/ernie-assets/main/wilted.jpg",
  // ЭТАЖ 7
  maze:"https://raw.githubusercontent.com/akbole/ernie-assets/main/maze.jpg",
  false_ernie:"https://raw.githubusercontent.com/akbole/ernie-assets/main/false_ernie.jpg",
  double:"https://raw.githubusercontent.com/akbole/ernie-assets/main/double.jpg",
  fork:"https://raw.githubusercontent.com/akbole/ernie-assets/main/fork.jpg",
  momcall:"https://raw.githubusercontent.com/akbole/ernie-assets/main/momcall.jpg",
  black_mirror:"https://raw.githubusercontent.com/akbole/ernie-assets/main/black_mirror.jpg",
  cat_sacrifice:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cat_sacrifice.jpg",
  mirror_corridor:"https://raw.githubusercontent.com/akbole/ernie-assets/main/mirror_corridor.jpg",
  // ЭТАЖ 8
  voices:"https://raw.githubusercontent.com/akbole/ernie-assets/main/voices.jpg",
  voices_crowd:"https://raw.githubusercontent.com/akbole/ernie-assets/main/voices_crowd.jpg",
  cat_bye:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cat_byew.jpg",
  cat_farewell:"https://raw.githubusercontent.com/akbole/ernie-assets/main/cat_farewell.jpg",
  // ЭТАЖ 9
  void9:"https://raw.githubusercontent.com/akbole/ernie-assets/main/void9.jpg",
  ernie_visible:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_visible.jpg",
  raven:"https://raw.githubusercontent.com/akbole/ernie-assets/main/raven.jpg",
  raven_perch:"https://raw.githubusercontent.com/akbole/ernie-assets/main/raven_perch.jpg",
  ernie_sitting:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_sitting.jpg",
  ernie_please:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_please.jpg",
  ernie_truth:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_truth.jpg",
  // ЭТАЖ 10
  roof:"https://raw.githubusercontent.com/akbole/ernie-assets/main/roof.jpg",
  guardian:"https://raw.githubusercontent.com/akbole/ernie-assets/main/guardian.jpg",
  guardian_cat:"https://raw.githubusercontent.com/akbole/ernie-assets/main/guardian_cat.jpg",
  guardian_mercy:"https://raw.githubusercontent.com/akbole/ernie-assets/main/guardian_mercy.jpg",
  guardian_hand:"https://raw.githubusercontent.com/akbole/ernie-assets/main/guardian_hand.jpg",
  sunrise:"https://raw.githubusercontent.com/akbole/ernie-assets/main/sunrise.jpg",
  door_out:"https://raw.githubusercontent.com/akbole/ernie-assets/main/door_out.jpg",
  ernie_free:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ernie_free.jpg",
  new_warden:"https://raw.githubusercontent.com/akbole/ernie-assets/main/new_warden.jpg",
  ending_together:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ending_together.jpg",
  tower_crumble:"https://raw.githubusercontent.com/akbole/ernie-assets/main/tower_crumble.jpg",
  ending_silence:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ending_silence.jpg",
  // ПРЕДМЕТЫ
  item_drawing:"https://raw.githubusercontent.com/akbole/ernie-assets/main/item_drawing.jpg",
  item_coffee:"https://raw.githubusercontent.com/akbole/ernie-assets/main/item_coffee.jpg",
  item_ticket:"https://raw.githubusercontent.com/akbole/ernie-assets/main/item_ticket.jpg",
  item_mask:"https://raw.githubusercontent.com/akbole/ernie-assets/main/item_mask.jpg",
  item_book:"https://raw.githubusercontent.com/akbole/ernie-assets/main/item_book.jpg",
  item_photo:"https://raw.githubusercontent.com/akbole/ernie-assets/main/item_photo.jpg",
  // ДЕМОНЫ
  demon_hallway:"https://raw.githubusercontent.com/akbole/ernie-assets/main/demon_hallway.jpg",
  demon_eye:"https://raw.githubusercontent.com/akbole/ernie-assets/main/demon_eye.jpg",
  demon_gate:"https://raw.githubusercontent.com/akbole/ernie-assets/main/demon_gate.jpg",
  // АВАТАРКИ
  ava_barista:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ava_barista.jpg",
  ava_raven:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ava_raven.jpg",
  ava_ernie:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ava_ernie.jpg",
  ava_cat:"https://raw.githubusercontent.com/akbole/ernie-assets/main/ava_cat.jpg",
};

// PRELOAD ALL IMAGES — with fallback for missing
(function(){
    var keys=Object.keys(I);var loaded=0;
    // SVG placeholder для отсутствующих картинок
    var placeholder="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='720' height='1280' viewBox='0 0 720 1280'%3E%3Crect fill='%23080810' width='720' height='1280'/%3E%3Ccircle cx='360' cy='640' r='3' fill='%23c8a848' opacity='.15'/%3E%3C/svg%3E";
    var placeholderSm="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'%3E%3Crect fill='%230a0a14' width='128' height='128' rx='64'/%3E%3Ccircle cx='64' cy='64' r='2' fill='%23c8a848' opacity='.2'/%3E%3C/svg%3E";
    var FAILED_IMGS={};
    keys.forEach(function(k){
        var img=new Image();
        img.src=I[k];
        img.onload=function(){loaded++};
        img.onerror=function(){
            loaded++;
            FAILED_IMGS[k]=true;
            // Заменяем URL на placeholder
            if(k.indexOf("ava_")===0)I[k]=placeholderSm;
            else I[k]=placeholder;
        };
    });
    window.FAILED_IMGS=FAILED_IMGS;
})();
            // === SETTINGS ===
            function showRavenPop(text){$("ravenPopImg").src=I.ava_raven;$("ravenPopText").textContent=text;$("ravenPopup").classList.add("show");if(ravenTimer)clearTimeout(ravenTimer);ravenTimer=setTimeout(function(){closeRavenPop()},8000)}
            function closeRavenPop(){$("ravenPopup").classList.remove("show");if(ravenTimer){clearTimeout(ravenTimer);ravenTimer=null}}
            function $(id) { return document.getElementById(id) }
            var notifQueue=[];var notifBusy=false;
            function notify(t, tp) {
                notifQueue.push({t:t,tp:tp});
                if(!notifBusy)drainNotif();
            }
            function drainNotif(){
                if(notifQueue.length===0){notifBusy=false;return}
                notifBusy=true;var n=notifQueue.shift();
                var e = $("notif");
                e.textContent = n.t;
                e.className = "notif " + (n.tp === "bad" ? "nb" : "ng") + " show";
                if(n.tp==="bad"){doShake()}
                setTimeout(function() { e.classList.remove("show"); setTimeout(drainNotif,400) }, 5200);
            }
            
            var SETT={sfx:true,music:true,rain:true,vibro:true,textSpeed:2,imgBright:2};
            function openSettings(){$("settingsOverlay").classList.add("show")}
            function closeSettings(){$("settingsOverlay").classList.remove("show")}
            function toggleSetting(el,key){
                SETT[key]=!SETT[key];
                if(SETT[key])el.classList.add("on");else el.classList.remove("on");
                if(key==="music"){
                    if(!SETT.music){stopMusic();}
                    else if(MUS.currentTheme)startMusic(MUS.currentTheme);
                }
                if(key==="rain"){
                    if(!SETT.rain)stopRain();
                    else if(G.currentFloor===1||G.currentFloor===0)startRain();
                }
                if(key==="sfx"&&!SETT.sfx){
                    // Тихо
                }
                try{localStorage.setItem("ernie_sett",JSON.stringify(SETT))}catch(e){}
            }
            function setTextSpeed(v){
                SETT.textSpeed=+v;
                try{localStorage.setItem("ernie_sett",JSON.stringify(SETT))}catch(e){}
            }
            function setImgBright(v){
                SETT.imgBright=+v;
                var br=[.6,.85,1.1][+v-1];
                document.querySelectorAll(".g-imgw img").forEach(function(img){img.style.filter="brightness("+br+")"});
                try{localStorage.setItem("ernie_sett",JSON.stringify(SETT))}catch(e){}
            }
            // Загрузка настроек
            (function(){try{var s=localStorage.getItem("ernie_sett");if(s){SETT=JSON.parse(s);
                if(!SETT.sfx&&$("stSfx"))$("stSfx").classList.remove("on");
                if(!SETT.music&&$("stMus"))$("stMus").classList.remove("on");
                if(!SETT.rain&&$("stRain"))$("stRain").classList.remove("on");
                if(!SETT.vibro&&$("stVib"))$("stVib").classList.remove("on");
                if($("stSpd"))$("stSpd").value=SETT.textSpeed||2;
                if($("stBr"))$("stBr").value=SETT.imgBright||2;
            }}catch(e){}})();



            // === ERNIE THEME — 3 ноты ===
            function ernieThree(){
                if(!AC||!SETT.sfx)return;
                // E-B-E: тихая, тёплая, печальная
                var notes=[{f:330,d:.8,t:0},{f:494,d:1,t:.9},{f:165,d:1.5,t:2}];
                notes.forEach(function(n){
                    setTimeout(function(){
                        var o=AC.createOscillator();var g=AC.createGain();
                        o.type="sine";o.frequency.value=n.f;
                        g.gain.setValueAtTime(0,AC.currentTime);
                        g.gain.linearRampToValueAtTime(.03,AC.currentTime+.1);
                        g.gain.setValueAtTime(.03,AC.currentTime+n.d*.6);
                        g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+n.d);
                        o.connect(g);g.connect(AC.destination);
                        o.start();o.stop(AC.currentTime+n.d+.1);
                    },n.t*1000);
                });
            }

            // === ВЫДЕРЖИ ТИШИНУ ===
            function silenceTest(cb,failCb){
                var passed=false;var failed=false;
                var overlay=document.createElement("div");
                overlay.style.cssText="position:fixed;inset:0;background:#000;z-index:600;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 2s;cursor:pointer";
                var txt=document.createElement("div");
                txt.style.cssText="font-family:Raleway,sans-serif;font-size:13px;color:rgba(230,225,210,.3);font-style:italic;text-align:center;transition:opacity 2s";
                txt.textContent="...";
                overlay.appendChild(txt);
                document.body.appendChild(overlay);
                setTimeout(function(){overlay.style.opacity="1"},50);
                // Если тапнет — провалил
                overlay.onclick=function(){
                    if(passed)return;
                    failed=true;
                    txt.textContent="Не выдержал.";
                    txt.style.color="rgba(176,80,80,.5)";
                    setTimeout(function(){overlay.style.opacity="0";setTimeout(function(){overlay.remove();if(failCb)failCb()},2000)},1500);
                };
                // 10 секунд — прошёл
                setTimeout(function(){
                    if(failed)return;
                    passed=true;
                    txt.textContent=G.playerName||"...";
                    txt.style.color="rgba(200,168,72,.6)";
                    txt.style.fontSize="18px";
                    ernieThree();
                    setTimeout(function(){overlay.style.opacity="0";setTimeout(function(){overlay.remove();if(cb)cb()},2000)},3000);
                },10000);
            }
            // === WATCHER GAZE ===
            function watcherGaze(){
                var failed=false;var passed=false;
                var timer=setTimeout(function(){
                    if(!failed){passed=true;G.karma+=5;updH();notify("👁 Выдержал взгляд","gold");addEcho(8,"взгляд")}
                },10000);
                var handler=function(e){
                    if(passed)return;
                    failed=true;clearTimeout(timer);
                    G.lives-=1;G.perfectRun=false;vibrateDeath();updH();flashDamage();addDread(10);
                    notify("👁 Смотритель увидел -1♥","bad");
                    document.removeEventListener("click",handler);
                };
                document.addEventListener("click",handler);
                setTimeout(function(){document.removeEventListener("click",handler)},11000);
            }
            // === FAKE CRASH ===
            function fakeCrash(){
                stopMusic(); sShock();
                var ov=document.createElement("div");
                ov.style.cssText="position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;opacity:0;transition:opacity .5s;font-family:monospace";
                var lines=[
                    {text:"FATAL ERROR", color:"rgba(176,80,80,.8)", size:"14px", delay:800},
                    {text:"Код: 847", color:"rgba(176,80,80,.5)", size:"11px", delay:1500},
                    {text:"entity_ERNIE: not found", color:"rgba(100,100,100,.4)", size:"10px", delay:2500},
                    {text:"tower_connection: terminated", color:"rgba(100,100,100,.3)", size:"10px", delay:3200},
                    {text:"souls_remaining: 0", color:"rgba(100,100,100,.2)", size:"10px", delay:3800},
                    {text:"Приложение остановлено.", color:"rgba(176,80,80,.4)", size:"12px", delay:5000}
                ];
                lines.forEach(function(l){
                    var d=document.createElement("div");
                    d.style.cssText="font-size:"+l.size+";color:"+l.color+";opacity:0;transition:opacity 1s;letter-spacing:1px";
                    d.textContent=l.text; ov.appendChild(d);
                    setTimeout(function(){d.style.opacity="1"},l.delay);
                });
                document.body.appendChild(ov);
                setTimeout(function(){ov.style.opacity="1"},50);
                setTimeout(function(){
                    // All fade
                    Array.from(ov.children).forEach(function(ch){ch.style.opacity="0"});
                    setTimeout(function(){
                        var w=document.createElement("div");
                        w.style.cssText="font-family:Raleway,sans-serif;font-size:14px;color:rgba(200,168,72,.3);font-style:italic;opacity:0;transition:opacity 3s";
                        w.textContent="...Шучу. Но тебе стало страшно?";ov.appendChild(w);
                        setTimeout(function(){w.style.opacity="1";ernieThree();addEcho(5,"испуг")},500);
                        setTimeout(function(){ov.style.opacity="0";setTimeout(function(){ov.remove();startMusic("city");G.dread=Math.max(G.dread-30,0)},2000)},5000);
                    },1500);
                },7000);
            }
            
            // === COMBO SYSTEM ===
            var COMBOS_FOUND = {};
            function checkCombo(npc) {
                // Book + Raven = secret
                if(npc==="raven" && G.items.indexOf("book")>=0 && !COMBOS_FOUND.bookRaven) {
                    COMBOS_FOUND.bookRaven=true; G.secrets++;
                    addEcho(15, "СЕКРЕТ");
                    setTimeout(function(){
                        showGhostPop("ВОРОН", I.ava_raven, "...Откуда ты это взял.");
                        setTimeout(function(){notify("📖+🐦 Ворон узнал свою автобиографию","gold")},3000);
                    }, 2000);
                }
                // Mask + Lika = secret
                if(npc==="lika" && G.items.indexOf("mask")>=0 && !COMBOS_FOUND.maskLika) {
                    COMBOS_FOUND.maskLika=true; G.secrets++;
                    addEcho(15, "СЕКРЕТ");
                    setTimeout(function(){
                        notify("🎭+👧 Лика: «Ты тоже прячешь лицо?»","gold");
                    }, 2000);
                }
                // Coffee + Trumpeter = secret
                if(npc==="trumpeter" && G.items.indexOf("coffee")>=0 && !COMBOS_FOUND.coffeeTrump) {
                    COMBOS_FOUND.coffeeTrump=true; G.secrets++;
                    addEcho(15, "СЕКРЕТ");
                    setTimeout(function(){
                        notify("☕+🎺 Трубач: «Мне бы тоже... Но руки заняты.»","gold");
                    }, 2000);
                }
                // Photo + Floor 9 ERNIE = secret
                if(npc==="ernie9" && G.items.indexOf("photo")>=0 && !COMBOS_FOUND.photoErnie) {
                    COMBOS_FOUND.photoErnie=true; G.secrets++;
                    addEcho(20, "СЕКРЕТ");
                    setTimeout(function(){
                        notify("📷+👻 ERNIE узнал себя на фото","gold");
                    }, 2000);
                }
                // Cat + Guardian = already handled in guardCat
            }

            
            // === ITEM LIFE SYSTEM ===
            var ITEM_TIMERS = {};
            function startItemLife() {
                // Coffee cools down
                ITEM_TIMERS.coffee = setTimeout(function coffeeCheck(){
                    if(G.items.indexOf("coffee")>=0) {
                        notify("☕ Кофе остывает...", "gold");
                        ITEM_TIMERS.coffee2 = setTimeout(function(){
                            if(G.items.indexOf("coffee")>=0) {
                                notify("☕ Кофе остыл. Холодный. Как всё в башне.", "gold");
                            }
                        }, 180000); // 3 min later
                    }
                }, 120000); // 2 min
                // Mask whispers
                ITEM_TIMERS.mask = setTimeout(function maskCheck(){
                    if(G.items.indexOf("mask")>=0) {
                        notify("🎭 Маска шепчет что-то неразборчивое", "gold");
                        ITEM_TIMERS.mask2 = setTimeout(function(){
                            if(G.items.indexOf("mask")>=0) {
                                notify("🎭 Маска: «...надень меня...»", "gold");
                            }
                        }, 150000);
                    }
                }, 90000); // 1.5 min
                // Book opens itself
                ITEM_TIMERS.book = setTimeout(function(){
                    if(G.items.indexOf("book")>=0) {
                        notify("📖 Книга открылась сама. Страница 847.", "gold");
                    }
                }, 200000); // 3.3 min
            }

            
            // === TIMED CHOICE SYSTEM (Papers Please) ===
            var TIMED = {timer:null, el:null};
            function timedChoice(choices, seconds, defaultIdx, ernieComment) {
                showCh(choices);
                G.timedChoicesMade++;
                var bar = document.createElement("div");
                bar.id = "timedBar";
                bar.style.cssText = "position:fixed;bottom:120px;left:10%;width:80%;height:3px;background:rgba(200,168,72,.15);z-index:600;border-radius:2px;overflow:hidden";
                var fill = document.createElement("div");
                fill.style.cssText = "width:100%;height:100%;background:var(--gold);transition:width "+seconds+"s linear;border-radius:2px";
                bar.appendChild(fill);
                document.body.appendChild(bar);
                var countEl = document.createElement("div");
                countEl.id = "timedCount";
                countEl.style.cssText = "position:fixed;bottom:126px;right:10%;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold);opacity:.6;z-index:601";
                countEl.textContent = seconds + "с";
                document.body.appendChild(countEl);
                setTimeout(function(){fill.style.width="0"},50);
                var remaining = seconds;
                TIMED.timer = setInterval(function(){
                    remaining--;
                    countEl.textContent = remaining + "с";
                    if(remaining<=3) countEl.style.color="var(--red)";
                    if(remaining<=0){
                        clearInterval(TIMED.timer);
                        bar.remove(); countEl.remove();
                        // ERNIE chooses for you
                        var defFn = choices[defaultIdx||0].fn;
                        if(typeof defFn === "string") eval(defFn);
                        else if(typeof defFn === "function") defFn();
                        if(ernieComment) {
                            setTimeout(function(){
                                notify("⏱ "+ernieComment, "gold");
                            }, 1500);
                        }
                    }
                }, 1000);
                TIMED.el = bar;
            }
            function clearTimedChoice(){
                if(TIMED.timer){clearInterval(TIMED.timer);TIMED.timer=null}
                var b=$("timedBar");if(b)b.remove();
                var c=$("timedCount");if(c)c.remove();
            }

            // === DREAD SYSTEM ===
            function addDread(n){G.dread=Math.min(100,Math.max(0,(G.dread||0)+n));applyDread()}
            function applyDread(){
                var d=G.dread||0;
                if(d>=20){document.querySelectorAll(".d-txt").forEach(function(el){el.style.textShadow=d>60?"0 0 "+(d/10)+"px rgba(176,80,80,.3)":""})}
                if(d>=40){document.querySelectorAll(".ch-btn").forEach(function(b){if(Math.random()<.3)b.style.animation="btnTremble .1s ease "+(Math.floor(Math.random()*3))+"s 3"})}
                if(d>=60&&Math.random()<.1){sWhisper()}
                if(d>=80){var btns=document.querySelectorAll(".ch-btn");if(btns.length>1&&Math.random()<.25){var i=Math.floor(Math.random()*btns.length);var orig=btns[i].textContent;var lies=["Не нажимай","Это ложь","Он врёт","Ты уверен?","...","Н̷е̷т̷"];btns[i].textContent=lies[Math.floor(Math.random()*lies.length)];setTimeout(function(){btns[i].textContent=orig},1200)}}
                if(d>=100&&!G._fakeCrashed){G._fakeCrashed=true;fakeCrash()}
            }
            // === DRAMATIC SOUNDS ===
            function sShock(){if(!AC||!SETT.sfx)return;tone(80,.8,"sawtooth",.06);setTimeout(function(){tone(40,1.2,"square",.04)},100)}
            function sDrone(){if(!AC||!SETT.sfx)return;var o=AC.createOscillator();var g=AC.createGain();o.type="sawtooth";o.frequency.value=55;g.gain.setValueAtTime(.02,AC.currentTime);g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+4);o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+4)}
            function sWhisper(){if(!AC||!SETT.sfx)return;for(var i=0;i<3;i++){(function(j){setTimeout(function(){tone(800+Math.random()*400,.3,"sine",.003)},j*200)})(i)}}
            function sHeartSingle(){if(!AC||!SETT.sfx)return;tone(50,.15,"sine",.06);setTimeout(function(){tone(45,.2,"sine",.04)},180)}

            // === AMBIENT SCARES ===
            var AMBIENT_CHANCE=0.2;
            function ambientScare(){
                if(Math.random()>AMBIENT_CHANCE)return;
                var scares=[
                    function(){flashScreen();tone(50,.8,"sine",.02);setTimeout(function(){notify("👁 Что-то смотрит...",null)},500)},
                    function(){var el=$("gI");if(el){el.style.filter="brightness(0.3)";setTimeout(function(){el.style.filter=""},800)}tone(100,.3,"triangle",.01)},
                    function(){notify("🌬 Холодно.",null);vibrate(30)},
                    function(){tone(200,.1,"square",.03);setTimeout(function(){tone(180,.1,"square",.03)},150);notify("💧 Капля.",null)},
                    function(){var el=$("gI");if(el){el.style.transition="transform .3s";el.style.transform="scale(1.02)";setTimeout(function(){el.style.transform="";el.style.transition=""},500)}notify("🫧 Стены дышат.",null)},
                ];
                if(G.hasCat)scares.push(function(){catReact("alert");notify("🐱 "+(G.catName||"Кошка")+" шипит в пустоту",null)});
                // Редкие события
                var rare=Math.random();
                if(rare<0.005){
                    // 0.5% — неизвестный этаж мелькает
                    var fl=document.createElement("div");
                    fl.style.cssText="position:fixed;top:12px;left:50%;transform:translateX(-50%);font-family:Raleway,sans-serif;font-size:11px;color:rgba(176,80,80,.5);z-index:500;pointer-events:none;letter-spacing:3px";
                    fl.textContent="ЭТАЖ ?";
                    document.body.appendChild(fl);
                    setTimeout(function(){fl.remove()},800);
                    return;
                }
                if(rare<0.01){
                    // 0.5% — кот шипит в пустоту
                    if(G.hasCat){notify("🐱 "+(G.catName||"Кошка")+" шипит в пустой угол","bad");catReact("danger");return}
                }
                if(rare<0.015){
                    // 0.5% — текст задом наперёд
                    var el=document.querySelector(".d-txt");
                    if(el){var orig=el.textContent;el.style.direction="rtl";el.style.unicodeBidi="bidi-override";setTimeout(function(){el.style.direction="";el.style.unicodeBidi=""},1500)}
                    return;
                }
                // 1% — мальчик 14 лет стоит в углу
                if(Math.random()<0.01){
                    var boy=document.createElement("div");
                    boy.style.cssText="position:fixed;bottom:20%;right:15%;font-size:40px;opacity:0;z-index:500;pointer-events:none;filter:blur(1px) brightness(.5);transition:opacity 2s";
                    boy.textContent="🧍";
                    document.body.appendChild(boy);
                    setTimeout(function(){boy.style.opacity=".25"},100);
                    setTimeout(function(){boy.style.opacity="0";setTimeout(function(){boy.remove()},2000)},4000);
                    return;
                }
                // 1% — призрак прошлого игрока
                if(Math.random()<0.01){
                    var ghostN=["Марина","Дима","Катя","Артём","Ольга"];
                    notify("👻 "+ghostN[Math.floor(Math.random()*ghostN.length)]+" был тут. Недавно.","bad");
                    return;
                }
                // 1% — неизвестный этаж мелькает
                if(Math.random()<0.01){
                    var uf=document.createElement("div");
                    uf.style.cssText="position:fixed;top:8px;left:50%;transform:translateX(-50%);font-family:Raleway,sans-serif;font-size:11px;color:rgba(176,80,80,.4);opacity:0;transition:opacity 1s;z-index:600;pointer-events:none";
                    uf.textContent="ЭТАЖ ???";
                    document.body.appendChild(uf);
                    setTimeout(function(){uf.style.opacity="1"},50);
                    setTimeout(function(){uf.style.opacity="0";setTimeout(function(){uf.remove()},1000)},2000);
                    return;
                }
                // 1% — ERNIE шепчет имя
                if(Math.random()<0.01&&G.playerName){
                    sWhisper();notify("🔇 «"+G.playerName+"...»","bad");
                    return;
                }
                scares[Math.floor(Math.random()*scares.length)]();
            }

            // === PRESSURE SYSTEM ===
            var PRESSURE={timer:null,level:0};
            function startPressure(){
                stopPressure();
                PRESSURE.level=0;
                PRESSURE.timer=setInterval(function(){
                    if($("gNav")&&$("gNav").style.display!=="none")return;
                    PRESSURE.level++;
                    // Тихое нарастание — без спама
                    if(PRESSURE.level===8){flashScreen();catReact&&catReact("alert")}
                    if(PRESSURE.level>=16){G.lives--;screenShake();updH();flashDamage();vibrate(100);sShock();PRESSURE.level=0}
                },25000);
            }
            function stopPressure(){if(PRESSURE.timer){clearInterval(PRESSURE.timer);PRESSURE.timer=null}PRESSURE.level=0}
            function resetPressure(){PRESSURE.level=0}
            function flashScreen(){var fl=document.createElement("div");fl.style.cssText="position:fixed;inset:0;background:rgba(90,50,50,.12);z-index:500;pointer-events:none;transition:opacity 1s";document.body.appendChild(fl);setTimeout(function(){fl.style.opacity="0";setTimeout(function(){fl.remove()},1000)},100)}

            var AC=null;
            function iA() {
                if (!AC)
                    try {
                        AC = new (window.AudioContext || window.webkitAudioContext)()
                    } catch (e) {}
            }

            // ============================================================
            // === МУЗЫКАЛЬНЫЙ ДВИЖОК v5.0 — ПРОЦЕДУРНЫЙ AMBIENT ===
            // ============================================================
            var MUS={active:false,nodes:[],masterGain:null,floorTheme:null,reverb:null,currentTheme:null};
            

            // === РЕАЛИСТИЧНЫЙ ЗВУК ДОЖДЯ ===
            var RA={on:false,master:null,noise:null,noiseG:null,dropTmr:null,heavyTmr:null};
            function rainAudioOn(){
                if(!AC||RA.on)return;RA.on=true;
                RA.master=AC.createGain();
                RA.master.gain.setValueAtTime(0,AC.currentTime);
                RA.master.gain.linearRampToValueAtTime(1,AC.currentTime+4);
                RA.master.connect(AC.destination);
                // Браун-шум — основа дождя (природный, не белый)
                var len=AC.sampleRate*4,buf=AC.createBuffer(2,len,AC.sampleRate);
                for(var ch=0;ch<2;ch++){var d=buf.getChannelData(ch);var v=0;for(var i=0;i<len;i++){v+=(Math.random()*2-1)*0.02;v*=0.998;d[i]=v}}
                RA.noise=AC.createBufferSource();RA.noise.buffer=buf;RA.noise.loop=true;
                // Фильтры — убираем низы и верхи → звучит как дождь за окном
                var hp=AC.createBiquadFilter();hp.type="highpass";hp.frequency.value=300;
                var lp=AC.createBiquadFilter();lp.type="lowpass";lp.frequency.value=3000;lp.Q.value=0.4;
                RA.noiseG=AC.createGain();RA.noiseG.gain.value=0.15;
                RA.noise.connect(hp);hp.connect(lp);lp.connect(RA.noiseG);RA.noiseG.connect(RA.master);
                RA.noise.start();
                // Капли — короткие щелчки на разных частотах
                RA.dropTmr=setInterval(function(){
                    if(!RA.on)return;
                    var n=2+Math.floor(Math.random()*4);
                    for(var i=0;i<n;i++)setTimeout(function(){
                        if(!RA.on||!AC)return;
                        var b=AC.createBuffer(1,Math.floor(AC.sampleRate*0.02),AC.sampleRate);
                        var dd=b.getChannelData(0);
                        var freq=0.3+Math.random()*0.7;
                        for(var j=0;j<dd.length;j++)dd[j]=Math.sin(j*freq*0.5)*(Math.random()*0.3)*Math.exp(-j/(dd.length*0.15));
                        var s=AC.createBufferSource();s.buffer=b;
                        var g=AC.createGain();g.gain.value=0.02+Math.random()*0.04;
                        var f=AC.createBiquadFilter();f.type="bandpass";f.frequency.value=2000+Math.random()*5000;f.Q.value=0.8;
                        // Панорамирование — капли слева и справа
                        var pan=AC.createStereoPanner?AC.createStereoPanner():null;
                        if(pan){pan.pan.value=(Math.random()*2-1)*0.7;s.connect(f);f.connect(g);g.connect(pan);pan.connect(RA.master)}
                        else{s.connect(f);f.connect(g);g.connect(RA.master)}
                        s.start();
                    },Math.random()*250);
                },300);
                // Тяжёлые капли — редкие
                RA.heavyTmr=setInterval(function(){
                    if(!RA.on||!AC||Math.random()>0.35)return;
                    var b=AC.createBuffer(1,Math.floor(AC.sampleRate*0.05),AC.sampleRate);
                    var dd=b.getChannelData(0);
                    for(var j=0;j<dd.length;j++)dd[j]=(Math.random()*2-1)*Math.exp(-j/(AC.sampleRate*0.008));
                    var s=AC.createBufferSource();s.buffer=b;
                    var g=AC.createGain();g.gain.value=0.03+Math.random()*0.03;
                    var f=AC.createBiquadFilter();f.type="bandpass";f.frequency.value=600+Math.random()*1500;f.Q.value=1.2;
                    s.connect(f);f.connect(g);g.connect(RA.master);s.start();
                },1200);
            }
            function rainAudioOff(){
                if(!RA.on)return;RA.on=false;
                clearInterval(RA.dropTmr);clearInterval(RA.heavyTmr);
                if(RA.master)try{RA.master.gain.linearRampToValueAtTime(0,AC.currentTime+2)}catch(e){}
                setTimeout(function(){try{if(RA.noise)RA.noise.stop()}catch(e){};RA.noise=null;RA.master=null;RA.noiseG=null},2200);
            }
            function rainIndoor(yes){
                if(!RA.master||!RA.noiseG)return;
                var t=AC.currentTime;
                if(yes){
                    RA.noiseG.gain.linearRampToValueAtTime(0.03,t+0.8);
                    RA.master.gain.linearRampToValueAtTime(0.15,t+0.8);
                }else{
                    RA.noiseG.gain.linearRampToValueAtTime(0.15,t+0.8);
                    RA.master.gain.linearRampToValueAtTime(1,t+0.8);
                }
            }

            function createReverb(ac,duration,decay){
                var rate=ac.sampleRate,len=rate*duration,imp=ac.createBuffer(2,len,rate);
                for(var c=0;c<2;c++){var d=imp.getChannelData(c);for(var i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay)}
                var conv=ac.createConvolver();conv.buffer=imp;return conv;
            }

            function startMusic(theme){if(!SETT.music){MUS.currentTheme=theme;return}
                if(!AC||MUS.currentTheme===theme)return;
                stopMusic();
                MUS.currentTheme=theme;
                MUS.active=true;
                MUS.masterGain=AC.createGain();
                MUS.masterGain.gain.setValueAtTime(0,AC.currentTime);
                MUS.masterGain.gain.linearRampToValueAtTime(.06,AC.currentTime+3);
                MUS.reverb=createReverb(AC,3,.8);
                MUS.masterGain.connect(MUS.reverb);
                MUS.reverb.connect(AC.destination);
                MUS.masterGain.connect(AC.destination);

                var themes={
                    city:cityTheme,library:libraryTheme,theater:theaterTheme,
                    lab:labTheme,garden:gardenTheme,mirror:mirrorTheme,
                    voices:voicesTheme,void9:voidTheme,roof:roofTheme,danger:dangerTheme,
                    cafe:cafePianoTheme,station:stationTheme,trumpet:trumpetTheme
                };
                if(themes[theme])themes[theme]();
            }

            function stopMusic(){
                if(!MUS.masterGain)return;
                try{MUS.masterGain.gain.linearRampToValueAtTime(0,AC.currentTime+2)}catch(e){}
                setTimeout(function(){
                    MUS.nodes.forEach(function(n){try{n.stop()}catch(e){}});
                    MUS.nodes=[];MUS.active=false;MUS.currentTheme=null;
                },2100);
            }

            function musNode(f,tp,v,detune){
                if(!AC||!MUS.masterGain)return null;
                var o=AC.createOscillator(),g=AC.createGain();
                o.type=tp||"sine";o.frequency.value=f;if(detune)o.detune.value=detune;
                g.gain.setValueAtTime(v||.015,AC.currentTime);
                o.connect(g);g.connect(MUS.masterGain);o.start();MUS.nodes.push(o);return {o:o,g:g};
            }

            function musLFO(node,rate,depth,target){
                if(!AC||!node)return;
                var lfo=AC.createOscillator(),lg=AC.createGain();
                lfo.frequency.value=rate;lg.gain.value=depth;
                lfo.connect(lg);lg.connect(target||node.o.frequency);
                lfo.start();MUS.nodes.push(lfo);
            }

            // ГОРОД ЭХО — только дождь, без дрона
            function cityTheme(){}

            // БИБЛИОТЕКА — почти тишина, скрежет
            function libraryTheme(){
                musNode(41,"sine",.025);musNode(61.5,"triangle",.015,8);musNode(82,"sine",.006);
                var n=musNode(123,"sine",.004,-12);if(n)musLFO(n,.03,0.3);
                // Шёпоты книг — случайные
                function libWhisper(){
                    if(!MUS.active||MUS.currentTheme!=="library")return;
                    if(Math.random()<0.4)sWhisper();
                    if(Math.random()<0.2)sPageTurn();
                    setTimeout(libWhisper,4000+Math.random()*6000);
                }
                setTimeout(libWhisper,3000);
            }

            // ТЕАТР — призрачная мелодия
            function theaterTheme(){
                var notes=[196,220,247,196,220];var idx=0;
                function playNote(){
                    if(!MUS.active||MUS.currentTheme!=="theater")return;
                    var n=musNode(notes[idx%notes.length],"sine",.025);
                    if(n){n.g.gain.setValueAtTime(.025,AC.currentTime);n.g.gain.linearRampToValueAtTime(0,AC.currentTime+2.5)}
                    idx++;setTimeout(playNote,2800+Math.random()*1200);
                }
                musNode(55,"sine",.018);setTimeout(playNote,1000);
            }

            // ЛАБОРАТОРИЯ — механический, тревожный
            function labTheme(){
                musNode(40,"sawtooth",.01);musNode(60,"sawtooth",.008,7);
                var n=musNode(80,"square",.005);if(n){musLFO(n,4,2)}
                // Тик-так
                function tick(){
                    if(!MUS.active||MUS.currentTheme!=="lab")return;
                    tone(1200,.04,"square",.02);setTimeout(function(){tone(900,.04,"square",.015)},500);
                    setTimeout(tick,1000+Math.random()*200);
                }
                setTimeout(tick,2000);
            }

            // САД — красивый, тихий
            function gardenTheme(){
                var scale=[196,220,261,294,329,349];var i=0;
                function chime(){
                    if(!MUS.active||MUS.currentTheme!=="garden")return;
                    var f=scale[Math.floor(Math.random()*scale.length)];
                    var n=musNode(f,"sine",.03);
                    if(n){n.g.gain.setValueAtTime(.03,AC.currentTime);n.g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+3)}
                    setTimeout(chime,1500+Math.random()*2500);
                }
                musNode(65,"sine",.015);chime();
                // Капли воды — фонтан
                function waterDrop(){
                    if(!MUS.active||MUS.currentTheme!=="garden")return;
                    var freq=3000+Math.random()*3000;
                    var o=AC.createOscillator();var g=AC.createGain();
                    o.type="sine";o.frequency.value=freq;
                    o.frequency.exponentialRampToValueAtTime(freq*0.7,AC.currentTime+0.08);
                    g.gain.setValueAtTime(.02,AC.currentTime);
                    g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+0.1);
                    o.connect(g);g.connect(MUS.masterGain);o.start();o.stop(AC.currentTime+0.12);
                    MUS.nodes.push(o);
                    setTimeout(waterDrop,600+Math.random()*1500);
                }
                setTimeout(waterDrop,1000);
            }

            // ЛАБИРИНТ — зеркальный, дезориентирующий
            function mirrorTheme(){
                var n1=musNode(110,"sine",.02);var n2=musNode(110.5,"sine",.02,-5);
                if(n1)musLFO(n1,.2,3);if(n2)musLFO(n2,.18,2.5);
                musNode(55,"triangle",.015);
            }

            // ГОЛОСА — хаотичный шёпот
            function voicesTheme(){
                musNode(80,"sine",.015);musNode(160,"sine",.008);musNode(240,"triangle",.005);
                var n=musNode(55,"sawtooth",.012);if(n)musLFO(n,.5,8);
            }

            // ПУСТОТА — ничего кроме тишины
            function voidTheme(){
                var n=musNode(27.5,"sine",.03);if(n)musLFO(n,.02,0.5);
                musNode(55,"sine",.01,12);
            }

            // КРЫША — рассвет, надежда
            function roofTheme(){
                var melody=[392,440,392,349,392,440,523];var i=0;
                function playMelody(){
                    if(!MUS.active||MUS.currentTheme!=="roof")return;
                    var n=musNode(melody[i%melody.length],"sine",.035);
                    if(n){n.g.gain.setValueAtTime(.035,AC.currentTime);n.g.gain.linearRampToValueAtTime(0,AC.currentTime+1.5)}
                    i++;setTimeout(playMelody,1600);
                }
                musNode(98,"sine",.02);musNode(130,"triangle",.015);setTimeout(playMelody,500);
            }

            // ОПАСНОСТЬ
            function dangerTheme(){
                var n=musNode(60,"sawtooth",.025);if(n)musLFO(n,3,5);
                musNode(90,"square",.012);
            }

            // КАФЕ — тёплое пианино
            function cafePianoTheme(){
                // Тёплый pad фон
                var pad1=musNode(130.81,"sine",.015); // C3
                var pad2=musNode(164.81,"sine",.008); // E3
                var pad3=musNode(196,"sine",.006);     // G3
                if(pad1)musLFO(pad1,.05,0.5);
                if(pad2)musLFO(pad2,.07,0.3);
                // Пианино мелодия — медленная, печальная, тёплая
                // Am - C - F - G прогрессия, ноты мелодии сверху
                var melody=[
                    // Am (ля минор — тёплая печаль)
                    440, 0, 523.25, 0, 659.25, 0, 523.25, 0,
                    // C (до мажор — надежда)
                    523.25, 0, 659.25, 0, 783.99, 0, 659.25, 0,
                    // F (фа мажор — тепло)
                    349.23, 0, 440, 0, 523.25, 0, 440, 0,
                    // G (соль мажор — движение)
                    392, 0, 493.88, 0, 587.33, 0, 493.88, 0,
                    // Am повтор
                    440, 0, 0, 523.25, 0, 659.25, 0, 0,
                    // C
                    523.25, 0, 0, 783.99, 0, 0, 659.25, 0,
                    // Dm (ре минор — глубина)
                    293.66, 0, 349.23, 0, 440, 0, 0, 0,
                    // Am финал
                    440, 0, 0, 0, 523.25, 0, 0, 0
                ];
                var noteIdx=0;
                function playPianoNote(){
                    if(!MUS.active||MUS.currentTheme!=="cafe")return;
                    var freq=melody[noteIdx%melody.length];
                    noteIdx++;
                    if(freq>0){
                        // Пианино: sine + слабый обертон
                        var n1=musNode(freq,"sine",.035);
                        var n2=musNode(freq*2.01,"sine",.008);
                        var n3=musNode(freq*3,"sine",.003);
                        if(n1){
                            n1.g.gain.setValueAtTime(.035,AC.currentTime);
                            n1.g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+3);
                        }
                        if(n2){
                            n2.g.gain.setValueAtTime(.008,AC.currentTime);
                            n2.g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+2);
                        }
                        if(n3){
                            n3.g.gain.setValueAtTime(.003,AC.currentTime);
                            n3.g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+1.5);
                        }
                    }
                    // Темп: ~80 BPM, нота каждые 750мс + небольшой shuffle
                    var next=700+Math.random()*200;
                    setTimeout(playPianoNote,next);
                }
                setTimeout(playPianoNote,800);
            }

            // ВОКЗАЛ — эхо, металлический гул, далёкие объявления
            function stationTheme(){
                // Глубокий гул рельс
                musNode(41,"sine",.02);
                var n1=musNode(61.7,"triangle",.012,3);
                if(n1)musLFO(n1,.04,0.6);
                // Металлический резонанс
                var n2=musNode(185,"sine",.004);
                if(n2)musLFO(n2,.2,3);
                // Далёкое эхо — как пустой зал
                musNode(110,"sine",.003);
                var n3=musNode(146.83,"sine",.002,7);
                if(n3)musLFO(n3,.03,0.2);
                // Случайный скрежет рельс
                function railCreak(){
                    if(!MUS.active||MUS.currentTheme!=="station")return;
                    if(Math.random()>0.3){
                        var buf=AC.createBuffer(1,Math.floor(AC.sampleRate*0.3),AC.sampleRate);
                        var d=buf.getChannelData(0);
                        for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/(AC.sampleRate*0.05))*0.3;
                        var s=AC.createBufferSource();s.buffer=buf;
                        var f=AC.createBiquadFilter();f.type="bandpass";f.frequency.value=1200+Math.random()*800;f.Q.value=3;
                        var g=AC.createGain();g.gain.value=.003;
                        s.connect(f);f.connect(g);g.connect(MUS.masterGain);s.start();
                    }
                    setTimeout(railCreak,3000+Math.random()*5000);
                }
                setTimeout(railCreak,2000);
            }

            // ТРУБА в подвале — тёплая, хрипловатая, джазовая
            function trumpetTheme(){
                // Тёплый pad
                musNode(98,"sine",.01);
                musNode(146.83,"sine",.005);
                // Труба — sawtooth с фильтром = медный звук
                var melody=[220,247,262,294,330,294,262,247,220,0,196,220,262,294,330,0,349,330,294,262,220,0,0,0];
                var idx=0;
                function playTrumpet(){
                    if(!MUS.active||MUS.currentTheme!=="trumpet")return;
                    var freq=melody[idx%melody.length];
                    idx++;
                    if(freq>0){
                        var o=AC.createOscillator();var g=AC.createGain();
                        o.type="sawtooth";o.frequency.value=freq;
                        // Фильтр — убираем резкость, оставляем тепло
                        var f=AC.createBiquadFilter();f.type="lowpass";f.frequency.value=2000;f.Q.value=1;
                        g.gain.setValueAtTime(0,AC.currentTime);
                        g.gain.linearRampToValueAtTime(.06,AC.currentTime+.05);
                        g.gain.setValueAtTime(.06,AC.currentTime+.4);
                        g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+1.2);
                        o.connect(f);f.connect(g);g.connect(MUS.masterGain);
                        o.start();o.stop(AC.currentTime+1.3);MUS.nodes.push(o);
                        // Вибрато
                        var vib=AC.createOscillator();var vg=AC.createGain();
                        vib.frequency.value=5;vg.gain.value=3;
                        vib.connect(vg);vg.connect(o.frequency);
                        vib.start();vib.stop(AC.currentTime+1.3);MUS.nodes.push(vib);
                    }
                    setTimeout(playTrumpet,900+Math.random()*400);
                }
                setTimeout(playTrumpet,500);
            }

            // === ЗВУКОВЫЕ ЭФФЕКТЫ ===

            // Мурчание кошки — реалистичное
            function sPurr(){
                if(!AC)return;
                // Мурчание = низкая вибрация 25-30Hz + шум
                var dur=3;
                var o=AC.createOscillator();var g=AC.createGain();
                o.type="sine";o.frequency.value=27;
                g.gain.setValueAtTime(0,AC.currentTime);
                g.gain.linearRampToValueAtTime(.06,AC.currentTime+.3);
                g.gain.setValueAtTime(.06,AC.currentTime+dur-.5);
                g.gain.linearRampToValueAtTime(0,AC.currentTime+dur);
                o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+dur);
                // Второй обертон — чуть выше
                var o2=AC.createOscillator();var g2=AC.createGain();
                o2.type="sine";o2.frequency.value=54;
                g2.gain.setValueAtTime(0,AC.currentTime);
                g2.gain.linearRampToValueAtTime(.02,AC.currentTime+.3);
                g2.gain.linearRampToValueAtTime(0,AC.currentTime+dur);
                o2.connect(g2);g2.connect(AC.destination);o2.start();o2.stop(AC.currentTime+dur);
                // Шум дыхания
                var buf=AC.createBuffer(1,AC.sampleRate*dur,AC.sampleRate);
                var d=buf.getChannelData(0);
                for(var i=0;i<d.length;i++){
                    // Пульсация — вдох/выдох кошки
                    var pulse=Math.sin(i/(AC.sampleRate*0.15)*Math.PI);
                    d[i]=(Math.random()*2-1)*0.003*Math.abs(pulse);
                }
                var ns=AC.createBufferSource();ns.buffer=buf;
                var nf=AC.createBiquadFilter();nf.type="bandpass";nf.frequency.value=200;nf.Q.value=0.3;
                var ng=AC.createGain();ng.gain.value=.8;
                ns.connect(nf);nf.connect(ng);ng.connect(AC.destination);ns.start();
            }

            // Звук прибытия поезда — скрежет тормозов + пар
            function sTrainArrive(){
                if(!AC)return;
                // Скрежет тормозов — нисходящий filtered noise
                var len=AC.sampleRate*3;
                var buf=AC.createBuffer(1,len,AC.sampleRate);
                var d=buf.getChannelData(0);
                for(var i=0;i<len;i++){
                    var env=i<len*0.7?1:1-(i-len*0.7)/(len*0.3);
                    d[i]=(Math.random()*2-1)*env*0.5;
                }
                var s=AC.createBufferSource();s.buffer=buf;
                var f=AC.createBiquadFilter();f.type="bandpass";
                f.frequency.setValueAtTime(3000,AC.currentTime);
                f.frequency.linearRampToValueAtTime(800,AC.currentTime+2.5);
                f.Q.value=2;
                var g=AC.createGain();
                g.gain.setValueAtTime(0,AC.currentTime);
                g.gain.linearRampToValueAtTime(.03,AC.currentTime+.3);
                g.gain.setValueAtTime(.03,AC.currentTime+2);
                g.gain.linearRampToValueAtTime(0,AC.currentTime+3);
                s.connect(f);f.connect(g);g.connect(AC.destination);s.start();
                // Пар — шипение в конце
                setTimeout(function(){
                    var buf2=AC.createBuffer(1,AC.sampleRate*2,AC.sampleRate);
                    var d2=buf2.getChannelData(0);
                    for(var i=0;i<d2.length;i++)d2[i]=(Math.random()*2-1)*Math.exp(-i/(AC.sampleRate*0.3));
                    var s2=AC.createBufferSource();s2.buffer=buf2;
                    var f2=AC.createBiquadFilter();f2.type="highpass";f2.frequency.value=2000;
                    var g2=AC.createGain();g2.gain.value=.02;
                    s2.connect(f2);f2.connect(g2);g2.connect(AC.destination);s2.start();
                },2500);
                // Удар остановки
                setTimeout(function(){
                    tone(50,.3,"sine",.05);vibrate(100);
                },2800);
            }

            // Шёпоты книг (библиотека) — тихие голоса
            function sWhisper(){
                if(!AC)return;
                var buf=AC.createBuffer(1,AC.sampleRate*1.5,AC.sampleRate);
                var d=buf.getChannelData(0);
                // Шёпот = filtered noise с модуляцией
                for(var i=0;i<d.length;i++){
                    var mod=Math.sin(i/(AC.sampleRate*0.05)*Math.PI*2)*0.5+0.5;
                    d[i]=(Math.random()*2-1)*mod*0.15*Math.exp(-i/(AC.sampleRate*0.5));
                }
                var s=AC.createBufferSource();s.buffer=buf;
                var f=AC.createBiquadFilter();f.type="bandpass";f.frequency.value=1500+Math.random()*1500;f.Q.value=2;
                var g=AC.createGain();g.gain.value=.008;
                s.connect(f);f.connect(g);g.connect(AC.destination);s.start();
            }

            // Скрип страницы
            function sPageTurn(){
                if(!AC)return;
                var buf=AC.createBuffer(1,Math.floor(AC.sampleRate*0.15),AC.sampleRate);
                var d=buf.getChannelData(0);
                for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/(d.length*0.3))*0.4;
                var s=AC.createBufferSource();s.buffer=buf;
                var f=AC.createBiquadFilter();f.type="highpass";f.frequency.value=3000;
                var g=AC.createGain();g.gain.value=.015;
                s.connect(f);f.connect(g);g.connect(AC.destination);s.start();
            }

            // ============================================================
            // === СИСТЕМА ФЛЭШБЕКОВ ===
            // ============================================================
            var FLASHBACKS=[
                {year:"1824",text:"Мальчик 14 лет\nстоит у порога.\n\nМама говорит:\n«Ты вернёшься к обеду.»\n\nОн улыбается.\n\nОн не вернётся."},
                {year:"1840",text:"ERNIE ведёт первого посетителя.\nПосетитель №1.\nЕго звали Алексей.\n\nОн вышел живым.\n\nERNIE плакал.\nТогда ещё мог."},
                {year:"1891",text:"Посетитель №200.\nДевочка. 9 лет.\n\nСпросила:\n«Ты скучаешь по маме?»\n\nERNIE не ответил.\nНе потому что нельзя.\n\nПотому что да."},
                {year:"1967",text:"Башня дала ERNIE\nодин час свободы.\nОдин час снаружи.\n\nОн зашёл в кафе.\nЗаказал кофе.\nЗабыл, что не может пить.\n\nБыло не обидно.\nБыло — нормально."},
                {year:"2019",text:"Посетитель №846.\nЖенщина. 35 лет.\n\nОна почти дошла.\nДесятый этаж.\n\nSтраж закрыл дверь.\n\nERNIE смотрел.\nИ не мог помочь.\n\nВпервые почувствовал —\nвину."}
            ];

            function showFlashback(idx,cb){
                var fb=FLASHBACKS[idx%FLASHBACKS.length];
                $("flashbackYear").textContent=fb.year;
                $("flashbackContent").textContent="";
                $("flashbackScr").classList.add("show");
                setTimeout(function(){
                    tw($("flashbackContent"),fb.text,35,function(){
                        setTimeout(function(){
                            $("flashbackScr").classList.remove("show");
                            if(cb)setTimeout(cb,600);
                        },3500);
                    });
                },400);
            }

            // ============================================================
            // === ПИСЬМА ERNIE ===
            // ============================================================
            var ERNIE_LETTERS=[
                {title:"ПИСЬМО I",text:"Я пишу это,\nпотому что скучно.\n\nИли потому что хочу,\nчтобы кто-то знал.\n\nМне 14.\nПостоянно.\n\nЭто не жалоба.\nЭто просто факт.\n\nНо иногда —\nустаёшь быть\nодного возраста.\n\n— Э."},
                {title:"ПИСЬМО II",text:"Если ты читаешь это —\nты далеко зашёл.\n\nИли нашёл случайно.\nТогда молодец.\nИли нет.\n\nЯ не знаю.\n\nЯ хотел сказать:\nкошка тебя уже\nлюбит.\n\nДаже если молчит.\nОсобенно — молчит.\n\n— Э."},
                {title:"ПИСЬМО III",text:"Есть вещи,\nкоторые я не скажу вслух.\n\nПотому что башня слушает.\nВсегда слушает.\n\nНо здесь, в письме —\nможно.\n\nЯ хочу домой.\n\nВот всё.\n\nПросто хочу домой.\n\n— Э."}
            ];
            var lettersFound=[];

            function showLetter(idx,cb){
                var letter=ERNIE_LETTERS[idx];
                if(!letter){if(cb)cb();return}
                $("letterBody").innerHTML=letter.text+'\n<div class="ernie-letter-sig">'+letter.title+'</div>';
                $("letterScr").classList.add("show");
                $("letterScr")._cb=cb;
                if(lettersFound.indexOf(idx)<0)lettersFound.push(idx);
            }
            function closeLetter(){
                var cb=$("letterScr")._cb;
                $("letterScr").classList.remove("show");
                $("letterScr")._cb=null;
                if(cb)setTimeout(cb,300);
            }

            // ============================================================
            // === СИСТЕМА ТИХИХ МОМЕНТОВ ===
            // ============================================================
            // В ключевые моменты — ERNIE замолкает. Пауза больше говорит.
            var silentMoments=0;
            function trackSilence(){silentMoments++}

            // ============================================================
            // === ПРОГРЕСС ЭТАЖЕЙ ===
            // ============================================================
            
            function updateTowerMap(){
                var m=$("towerMap");if(!m)return;
                var h="";
                for(var i=10;i>=1;i--){
                    var cls="tm-floor";
                    if(i===G.currentFloor)cls+=" active";
                    else if(i<G.currentFloor)cls+=" visited";
                    h+='<div class="'+cls+'" title="Этаж '+i+'"></div>';
                }
                m.innerHTML=h;
            }
function updateProgress(floor){updateTowerMap();setAmbient(floor);if(floor>1)addEcho(floor*2,"этаж "+floor);
                var pct=(floor/10)*100;
                $("floorProgress").style.width=pct+"%";
                // Мини-башня
                var tf=$("gTowerFill");var td=$("gTowerDot");
                if(tf){tf.style.height=pct+"%"}
                if(td){td.style.bottom=pct+"%"}
            }

            // ============================================================
            // === УЛУЧШЕННЫЕ ЗВУКИ ===
            // ============================================================
            function sStatic(){// Статика — глитч
                if(!AC)return;
                var buf=AC.createBuffer(1,AC.sampleRate*.1,AC.sampleRate);
                var d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=Math.random()*2-1;
                var src=AC.createBufferSource(),g=AC.createGain();
                src.buffer=buf;g.gain.value=.1;src.connect(g);g.connect(AC.destination);src.start();
                MUS.nodes.push(src);
            }

            function sReveal(){// Проявление — мягкое
                tone(523,.3,"sine",.02);tone(659,.5,"sine",.015);
            }

            function sHeartStop(){// Сердце останавливается
                tone(80,.2,"sine",.08);setTimeout(function(){tone(70,.3,"sine",.06)},250);
                setTimeout(function(){tone(60,.4,"sine",.04)},600);
            }

            function sDoor(){// Дверь
                tone(120,.1,"sawtooth",.03);setTimeout(function(){tone(80,.3,"sine",.05)},100);
            }

            function sMemory(){// Воспоминание — звон
                [523,659,784,1047].forEach(function(f,i){setTimeout(function(){tone(f,.8,"sine",.025)},i*200)});
            }

            // ============================================================
            // === ERNIE HP — ИНДИКАТОР СВЯЗИ ===
            // ============================================================
            function updateErnieBond(){
                var trust=G.trust||0;var maxTrust=8;var pct=Math.min(100,Math.max(5,(trust/maxTrust)*100));
                $("ernieHpFill").style.width=pct+"%";
                if(pct>70)$("ernieHpFill").style.background="var(--gold)";
                else if(pct>40)$("ernieHpFill").style.background="var(--blue)";
                else $("ernieHpFill").style.background="var(--red)";
            }
            function showErnieBond(){$("ernieHpBar").style.display="flex";updateErnieBond()}
            function hideErnieBond(){$("ernieHpBar").style.display="none"}

            // ============================================================
            // === СТАТИКА-ЭКРАН ===
            // ============================================================
            function flashStatic(ms){
                $("staticOverlay").style.display="block";
                setTimeout(function(){$("staticOverlay").style.display="none"},ms||150);
                sStatic();
            }

            // ============================================================
            // === НОВЫЕ ФУНКЦИИ ДЛЯ ГЛУБИНЫ ===
            // ============================================================
            function ernieMumble(){// ERNIE бормочет вне диалога
                if(!G.uc||G.trust<2)return;
                var mumbles=[
                    "...847...",
                    "...скоро...",
                    "...не уходи...",
                    "...мама...",
                    "...ещё немного..."
                ];
                var el=$("catBubble");// используем как воздух - можно расширить
                if(G.hasCat)return;// кошка перекрывает
                // Тихое уведомление
                if(Math.random()<0.3){
                    notify("ERNIE: «"+mumbles[Math.floor(Math.random()*mumbles.length)]+"»","gold");
                }
            }

            // ============================================================
            // === СИСТЕМА ПОСЛЕДСТВИЙ (Butterfly Effect) ===
            // ============================================================
            // Отслеживаем важные выборы
            var CHOICES={
                answeredMom:false,// Ответил маме
                triedToLeave:false,// Пытался уйти
                readBurnedDiary:false,// Прочитал сожжённый дневник
                wateredFlower:false,// Полил цветок
                trustedFakeErnie:false,// Доверился ложному ERNIE
                namedCat:false,// Назвал кошку
                satWithGhost:false// Сидел с призраком
            };

            function trackChoice(key){CHOICES[key]=true;G.uc[key]=true;addEcho(1)}

            // Функция: ERNIE знает о твоих выборах — говорит об этом позже
            function ernieRecallChoice(key){
                var recalls={
                    answeredMom:{spk:"ERNIE",cls:"er",txt:"«Ты ответил маме.\nЯ слышал её голос.\nСпасибо.»"},
                    wateredFlower:{spk:"ERNIE",cls:"er",txt:"«Ты полил цветок.\nОн снова живой.\nМинуту — но живой.»"},
                    trustedFakeErnie:{spk:"ERNIE",cls:"er",txt:"«Ты доверился\nложному мне.\nЯ не злюсь.\nМне было бы то же самое.»"},
                    namedCat:{spk:"ERNIE",cls:"er",txt:"«"+G.catName+"...\nХорошее имя.\nОна приходила ко мне раньше.\nБез имени.\nС тобой — другая.»"}
                };
                return recalls[key]||null;
            }


            function tone(f, d, tp, v) {
                if (!AC||!SETT.sfx)
                    return;
                var o = AC.createOscillator()
                  , g = AC.createGain();
                o.type = tp || "sine";
                o.frequency.value = f;
                g.gain.setValueAtTime(v || .04, AC.currentTime);
                g.gain.exponentialRampToValueAtTime(.001, AC.currentTime + d);
                o.connect(g);
                g.connect(AC.destination);
                o.start();
                o.stop(AC.currentTime + d)
            }
            function sG() { tone(80, .08, "sawtooth", .03) }
            function sB() { tone(60, .3, "sine", .07); tone(200, .15, "sine", .03) }
            function sP() { tone(220, .8, "sine", .05); setTimeout(function() { tone(165, .6, "sine", .03) }, 100) }
            function sPr() { tone(65, .5, "sine", .05) }
            function sS() { tone(100 + Math.random() * 40, .06, "sine", .02) }
            function sGl() { tone(800, .15, "sine", .02) }
            // Новые звуки
            function sHeart() { tone(80,.3,"sine",.06);setTimeout(function(){tone(80,.3,"sine",.06)},300) }
            function sWind() { tone(40,.8,"sawtooth",.02);tone(60,.6,"sawtooth",.015) }
            function sChime() { tone(523,.5,"sine",.04);setTimeout(function(){tone(659,.4,"sine",.03)},150);setTimeout(function(){tone(784,.6,"sine",.04)},300) }
            // ERNIE Leitmotif — играет в ключевых эмоциональных моментах
            function ernieTheme(){
                // Play MP3 ernie theme
                
                if(!AC)return;
                var trust=G.trust||0;
                // Низкое доверие: минорная, холодная
                // Высокое: тёплая, мажорная
                var notes,vol;
                if(trust<=2){
                    notes=[220,196,174,165];vol=.02;// Am — печально
                }else if(trust<=4){
                    notes=[220,247,261,294];vol=.025;// Тепло, но с тоской
                }else{
                    notes=[261,294,330,392];vol=.03;// C мажор — свет
                }
                notes.forEach(function(f,i){
                    setTimeout(function(){
                        var o=AC.createOscillator();var g=AC.createGain();
                        o.type="sine";o.frequency.value=f;
                        g.gain.setValueAtTime(vol,AC.currentTime);
                        g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+1.5);
                        o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+2);
                    },i*500);
                });
            }
            function sReveal(){ tone(440,.1,"sine",.04);setTimeout(function(){tone(660,.15,"sine",.04)},120);setTimeout(function(){tone(880,.3,"sine",.04)},260) }
            
            function sClick(){ tone(900,.04,"square",.01) }
            function sMemory(){ tone(220,.4,"sine",.03);setTimeout(function(){tone(330,.4,"sine",.025)},200);setTimeout(function(){tone(440,.6,"sine",.02)},400) }
            // Звук шагов (при переходе между этажами)
            function sFootstep(){if(!AC)return;for(var i=0;i<4;i++){setTimeout(function(){var buf=AC.createBuffer(1,AC.sampleRate*.05,AC.sampleRate);var d=buf.getChannelData(0);for(var j=0;j<d.length;j++)d[j]=(Math.random()*2-1)*.3;var src=AC.createBufferSource();var g=AC.createGain();var f=AC.createBiquadFilter();f.type="lowpass";f.frequency.value=600;src.buffer=buf;g.gain.value=.04;src.connect(f);f.connect(g);g.connect(AC.destination);src.start()},i*400)}}
            // Скрип двери
            function sCreak(){if(!AC)return;var o=AC.createOscillator();var g=AC.createGain();o.type="sawtooth";o.frequency.setValueAtTime(150,AC.currentTime);o.frequency.exponentialRampToValueAtTime(300,AC.currentTime+.3);g.gain.setValueAtTime(.02,AC.currentTime);g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.5);o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+.6)}
            // Микро-звук тапа на кнопку
            function sTap(){if(!AC||!SETT.sfx)return;tone(200+Math.random()*100,.03,"sine",.015)}
            // Мурчание кошки
            function sPurr(){if(!AC||!SETT.sfx)return;var t=AC.currentTime;for(var i=0;i<6;i++){var o=AC.createOscillator();var g=AC.createGain();o.type="sine";o.frequency.value=25+Math.random()*10;g.gain.setValueAtTime(0,t+i*.15);g.gain.linearRampToValueAtTime(.02,t+i*.15+.05);g.gain.linearRampToValueAtTime(0,t+i*.15+.15);o.connect(g);g.connect(AC.destination);o.start(t+i*.15);o.stop(t+i*.15+.15)}}
            // Шёпот ERNIE — тихий ветер
            function sErnieWhisper(){if(!AC||!SETT.sfx)return;var buf=AC.createBuffer(1,AC.sampleRate*.4,AC.sampleRate);var d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1);var src=AC.createBufferSource();src.buffer=buf;var f=AC.createBiquadFilter();f.type="bandpass";f.frequency.value=1200;f.Q.value=5;var g=AC.createGain();g.gain.setValueAtTime(0,AC.currentTime);g.gain.linearRampToValueAtTime(.008,AC.currentTime+.1);g.gain.linearRampToValueAtTime(0,AC.currentTime+.4);src.connect(f);f.connect(g);g.connect(AC.destination);src.start();src.stop(AC.currentTime+.5)}
            // Звук опасности — низкий гул
            function sDanger(){if(!AC||!SETT.sfx)return;var o=AC.createOscillator();var g=AC.createGain();o.type="sine";o.frequency.value=55;g.gain.setValueAtTime(.03,AC.currentTime);g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.8);o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+1)}
            // Звук свободы NPC — тёплый аккорд
            function sFree(){if(!AC||!SETT.sfx)return;[262,330,392].forEach(function(f,i){setTimeout(function(){tone(f,.8,"sine",.02)},i*100)});}

            // Мяуканье кошки
            function sMeow(){if(!AC)return;var o=AC.createOscillator();var g=AC.createGain();o.type="sine";o.frequency.setValueAtTime(500,AC.currentTime);o.frequency.linearRampToValueAtTime(700,AC.currentTime+.1);o.frequency.linearRampToValueAtTime(400,AC.currentTime+.3);g.gain.setValueAtTime(.03,AC.currentTime);g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.4);o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+.5)}
            // Капли воды (подвал/библиотека)
            function sDrip(){if(!AC)return;var o=AC.createOscillator();var g=AC.createGain();o.type="sine";o.frequency.setValueAtTime(1200,AC.currentTime);o.frequency.exponentialRampToValueAtTime(800,AC.currentTime+.05);g.gain.setValueAtTime(.02,AC.currentTime);g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.15);o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+.2)}
            // Фоновые капли (цикл)
            var dripTimer=null;
            function startDrips(){stopDrips();function drip(){sDrip();dripTimer=setTimeout(drip,3000+Math.random()*5000)}drip()}
            function stopDrips(){if(dripTimer){clearTimeout(dripTimer);dripTimer=null}}
            // Сердцебиение (опасность, непрерывное)
            var heartTimer=null;
            function startHeartbeat(){stopHeartbeat();var count=0;function beat(){if(count>=6){stopHeartbeat();return}sHeart();count++;heartTimer=setTimeout(beat,900)}beat()}
            function stopHeartbeat(){if(heartTimer){clearTimeout(heartTimer);heartTimer=null}}

            // ============================================================
            // === AMBIENT MUSIC SYSTEM ===
            // ============================================================
            var AMB = {
                node: null, gainNode: null, filter: null, oscillators: [], intervals: [],
                currentTheme: null, masterGain: 0.06
            };
            var AMB_THEMES = {
                city:    { notes:[130,155,174,196], pad:[65,87],  speed:4000, mood:"melancholy" },
                station: { notes:[138,165,185,207], pad:[69,92],  speed:3500, mood:"waiting" },
                library: { notes:[146,174,195,220], pad:[73,97],  speed:5000, mood:"ancient" },
                theater: { notes:[155,185,207,233], pad:[77,103], speed:3000, mood:"dramatic" },
                control: { notes:[120,143,160,180], pad:[60,80],  speed:2500, mood:"tense" },
                garden:  { notes:[164,196,220,247], pad:[82,109], speed:6000, mood:"peaceful" },
                voices:  { notes:[110,131,147,165], pad:[55,73],  speed:4500, mood:"haunted" },
                void:    { notes:[87,104,116,131],  pad:[43,58],  speed:8000, mood:"empty" },
                roof:    { notes:[196,233,261,294], pad:[98,130], speed:5000, mood:"transcendent" }
            };
            function startAmb(theme) {
                if(!AC) return;
                if(AMB.currentTheme === theme) return;
                stopMusic();
                AMB.currentTheme = theme;
                var cfg = AMB_THEMES[theme];
                if(!cfg) return;
                AMB.gainNode = AC.createGain();
                AMB.gainNode.gain.setValueAtTime(0, AC.currentTime);
                AMB.gainNode.gain.linearRampToValueAtTime(AMB.masterGain, AC.currentTime + 3);
                AMB.filter = AC.createBiquadFilter();
                AMB.filter.type = "lowpass";
                AMB.filter.frequency.value = 800;
                AMB.gainNode.connect(AMB.filter);
                AMB.filter.connect(AC.destination);

                // Pad drone
                cfg.pad.forEach(function(f, i) {
                    var osc = AC.createOscillator();
                    var g2 = AC.createGain();
                    osc.type = "sine";
                    osc.frequency.value = f + (i * 0.3); // slight detune
                    g2.gain.value = 0.015;
                    osc.connect(g2);
                    g2.connect(AMB.gainNode);
                    osc.start();
                    AMB.oscillators.push(osc);
                });

                // Melodic notes
                var ni = 0;
                function playNote() {
                    if(!AC || AMB.currentTheme !== theme) return;
                    var freq = cfg.notes[ni % cfg.notes.length];
                    ni++;
                    var osc = AC.createOscillator();
                    var env = AC.createGain();
                    osc.type = "sine";
                    osc.frequency.value = freq;
                    env.gain.setValueAtTime(0, AC.currentTime);
                    env.gain.linearRampToValueAtTime(0.025, AC.currentTime + 0.3);
                    env.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + 2.5);
                    osc.connect(env);
                    env.connect(AMB.gainNode);
                    osc.start();
                    osc.stop(AC.currentTime + 3);
                    var delay = cfg.speed + (Math.random() - 0.5) * cfg.speed * 0.4;
                    AMB.intervals.push(setTimeout(playNote, delay));
                }
                playNote();
            }
            function stopMusic() {
                // Stop MUS oscillator system
                if(MUS.masterGain){
                    try{MUS.masterGain.gain.linearRampToValueAtTime(0,AC?AC.currentTime+1:0)}catch(e){}
                    setTimeout(function(){MUS.nodes.forEach(function(n){try{n.stop()}catch(e){}});MUS.nodes=[];MUS.active=false;MUS.currentTheme=null;},1100);
                }
                // Stop AMB oscillator system
                if(!AC) return;
                AMB.currentTheme = null;
                AMB.oscillators.forEach(function(o){try{o.stop()}catch(e){}});
                AMB.oscillators = [];
                AMB.intervals.forEach(function(t){clearTimeout(t)});
                AMB.intervals = [];
                if(AMB.gainNode) {
                    AMB.gainNode.gain.linearRampToValueAtTime(0, AC.currentTime + 1.5);
                }
                setTimeout(function(){
                    try{if(AMB.gainNode)AMB.gainNode.disconnect()}catch(e){}
                    try{if(AMB.filter)AMB.filter.disconnect()}catch(e){}
                },2000);
            }

            // ============================================================
            // === RAIN SYSTEM ===
            // ============================================================
            var RAIN = { active: false, drops: [], canvas: null, ctx: null, raf: null };
            function initRain() {
                var c = document.getElementById("rainCanvas");
                RAIN.canvas = c;
                RAIN.ctx = c.getContext("2d");
                function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
                resize();
                window.addEventListener("resize", resize);
                for(var i=0;i<80;i++) {
                    RAIN.drops.push({
                        x: Math.random()*window.innerWidth,
                        y: Math.random()*window.innerHeight,
                        l: 8+Math.random()*18,
                        s: 4+Math.random()*8,
                        a: 0.1+Math.random()*0.3
                    });
                }
            }
            function startRain() {if(!SETT.rain)return;
                if(RAIN.active) return;
                RAIN.active = true;
                document.getElementById("rainCanvas").classList.add("on");
                rainAudioOn();
                function loop() {
                    if(!RAIN.active) return;
                    var c=RAIN.canvas, ctx=RAIN.ctx;
                    ctx.clearRect(0,0,c.width,c.height);
                    RAIN.drops.forEach(function(d){
                        ctx.beginPath();
                        ctx.moveTo(d.x,d.y);
                        ctx.lineTo(d.x+1,d.y+d.l);
                        ctx.strokeStyle="rgba(174,210,230,"+d.a+")";
                        ctx.lineWidth=0.5;
                        ctx.stroke();
                        d.y+=d.s;
                        if(d.y>c.height){ d.y=-d.l; d.x=Math.random()*c.width; }
                    });
                    RAIN.raf=requestAnimationFrame(loop);
                }
                loop();
            }
            function stopRain() {
                RAIN.active=false;
                cancelAnimationFrame(RAIN.raf);
                document.getElementById("rainCanvas").classList.remove("on");
                rainAudioOff();
            }
            initRain();

            // ============================================================
            // === DODGE GAME (Undertale-style bullet hell) ===
            // ============================================================
            var DG = {
                active: false, playerX:140, playerY:150, hp:3, maxHp:3,
                bullets:[], time:0, maxTime:10, raf:null, timer:null,
                onWin:null, onLose:null, touch:{x:null,y:null},
                title:"", msg:"", phase:0
            };
            var DG_PATTERNS = {
                guardian: {
                    time:12,
                    spawn: function(t){
                        var b=[];
                        // Waves from sides
                        if(t%60===0){ for(var i=0;i<5;i++) b.push({x:0,y:20+i*36,vx:2.5,vy:0,r:5,c:"rgba(200,168,72,.8)"}) }
                        if(t%80===30){ for(var i=0;i<5;i++) b.push({x:280,y:20+i*36,vx:-2.5,vy:0,r:5,c:"rgba(200,168,72,.8)"}) }
                        // Slow aimed bullet
                        if(t%120===60){
                            var dx=DG.playerX-140,dy=DG.playerY-100;
                            var d=Math.sqrt(dx*dx+dy*dy)||1;
                            b.push({x:140,y:100,vx:dx/d*1.5,vy:dy/d*1.5,r:7,c:"rgba(90,127,160,.9)"});
                        }
                        return b;
                    }
                },
                shadow: {
                    time:15,
                    spawn: function(t){
                        var b=[];
                        // Spiral - slower
                        if(t%25===0){
                            var a = (t/25)*0.8;
                            b.push({x:140,y:100,vx:Math.cos(a)*2.2,vy:Math.sin(a)*2.2,r:4,c:"rgba(130,100,180,.9)"});
                            b.push({x:140,y:100,vx:Math.cos(a+Math.PI)*2.2,vy:Math.sin(a+Math.PI)*2.2,r:4,c:"rgba(130,100,180,.9)"});
                        }
                        // Random falling - slower
                        if(t%50===25) b.push({x:Math.random()*260+10,y:0,vx:0,vy:2,r:5,c:"rgba(180,80,80,.8)"});
                        return b;
                    }
                },
                ernie: {
                    time:8,
                    spawn: function(t){
                        var b=[];
                        // Gentle — mostly avoidable
                        if(t%90===0){ for(var i=0;i<3;i++) b.push({x:i*90+45,y:0,vx:0,vy:2,r:4,c:"rgba(90,127,160,.6)"}) }
                        if(t%120===60){ b.push({x:0,y:100,vx:2.2,vy:0,r:4,c:"rgba(200,168,72,.5)"}) }
                        return b;
                    }
                }
            };
            function startDodge(patternKey, title, msg, onWin, onLose){
                startMusic("danger");
                if(!DG_PATTERNS[patternKey]) { onWin&&onWin(); return; }
                var pat = DG_PATTERNS[patternKey];
                DG.active=true; DG.playerX=140; DG.playerY=170;
                // Кошка = +1 жизнь (щит). Низкая карма = -1 жизнь
                var baseHp=3;
                if(G.hasCat||G.catName)baseHp=4;
                if(G.karma<=0)baseHp=Math.max(1,baseHp-1);
                DG.hp=DG.maxHp=baseHp;
                // Низкое доверие = быстрее (1.3x)
                DG.speedMod=(G.trust<2)?1.3:1;
                DG.bullets=[]; DG.time=0; DG.phase=0; DG.onWin=onWin; DG.onLose=onLose;
                DG.maxTime=pat.time; DG.title=title||"ИСПЫТАНИЕ";
                // Кошка: подсказка
                if(G.hasCat)setTimeout(function(){notify("🐱 Кошка рядом · +1♥","gold")},1000);
                var el=$("dodgeGame");
                el.classList.add("on");
                $("dodgeTitle").textContent=DG.title;
                $("dodgeMsg").textContent=msg||"";
                updDodgeHUD();

                var canvas=$("dodgeCanvas");
                var ctx=canvas.getContext("2d");
                // Touch/mouse controls
                function getPos(e){
                    var r=canvas.getBoundingClientRect();
                    var cx,cy;
                    if(e.touches){cx=e.touches[0].clientX;cy=e.touches[0].clientY;}
                    else{cx=e.clientX;cy=e.clientY;}
                    return{x:(cx-r.left)*(280/r.width),y:(cy-r.top)*(200/r.height)};
                }
                canvas.onmousemove=function(e){var p=getPos(e);DG.playerX=Math.max(8,Math.min(272,p.x));DG.playerY=Math.max(8,Math.min(192,p.y));};
                canvas.ontouchmove=function(e){e.preventDefault();var p=getPos(e);DG.playerX=Math.max(8,Math.min(272,p.x));DG.playerY=Math.max(8,Math.min(192,p.y));};

                var frame=0;
                var timerInterval=setInterval(function(){
                    DG.time++;
                    $("dodgeTimer").textContent=Math.max(0,DG.maxTime-DG.time);
                    if(DG.time>=DG.maxTime){ clearInterval(timerInterval); winDodge(); }
                },1000);
                DG.timer=timerInterval;

                function loop(){
                    if(!DG.active) return;
                    frame++;
                    ctx.clearRect(0,0,280,200);
                    // Background
                    ctx.fillStyle="rgba(5,5,12,0.95)";
                    ctx.fillRect(0,0,280,200);
                    // Border glow
                    ctx.strokeStyle="rgba(90,127,160,0.15)";
                    ctx.lineWidth=1;
                    ctx.strokeRect(2,2,276,196);
                    // Time bar
                    var pct = 1 - DG.time/DG.maxTime;
                    ctx.fillStyle="rgba(200,168,72,0.15)";
                    ctx.fillRect(4,4,272,4);
                    ctx.fillStyle="rgba(200,168,72,0.6)";
                    ctx.fillRect(4,4,Math.max(0,272*pct),4);

                    // Spawn bullets
                    var newB = pat.spawn(frame);
                    newB.forEach(function(b){DG.bullets.push(b)});

                    // Update and draw bullets
                    DG.bullets=DG.bullets.filter(function(b){
                        b.x+=b.vx*(DG.speedMod||1); b.y+=b.vy*(DG.speedMod||1);
                        if(b.x<-20||b.x>300||b.y<-20||b.y>220) return false;
                        // Collision with player
                        var dx=b.x-DG.playerX,dy=b.y-DG.playerY;
                        var dist=Math.sqrt(dx*dx+dy*dy);
                        if(dist<b.r+5){
                            DG.hp--;
                            updDodgeHUD();
                            vibrate(80);
                            sDanger();
                            if(DG.hp<=0){ clearInterval(timerInterval); loseDodge(); return false; }
                            return false;
                        }
                        ctx.beginPath();
                        ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
                        ctx.fillStyle=b.c;
                        ctx.fill();
                        // Glow
                        ctx.beginPath();
                        ctx.arc(b.x,b.y,b.r+3,0,Math.PI*2);
                        ctx.fillStyle=b.c.replace(".9","0.15").replace(".8","0.12").replace(".6","0.1");
                        ctx.fill();
                        return true;
                    });

                    // Player heart
                    ctx.save();
                    ctx.translate(DG.playerX,DG.playerY);
                    // Draw heart shape
                    ctx.beginPath();
                    ctx.moveTo(0,-7);
                    ctx.bezierCurveTo(7,-12,12,-5,0,5);
                    ctx.bezierCurveTo(-12,-5,-7,-12,0,-7);
                    ctx.fillStyle=DG.hp>1?"rgba(200,80,80,0.9)":"rgba(200,80,80,0.4)";
                    ctx.fill();
                    ctx.restore();

                    DG.raf=requestAnimationFrame(loop);
                }
                loop();
            }
            function updDodgeHUD(){
                $("dodgeHP").textContent="♥".repeat(Math.max(0,DG.hp))+"♡".repeat(Math.max(0,DG.maxHp-DG.hp));
                $("dodgeTimer").textContent=Math.max(0,DG.maxTime-DG.time);
            }
            function winDodge(){
                if(!DG.active)return;
                DG.active=false;
                cancelAnimationFrame(DG.raf);
                clearInterval(DG.timer);
                sFree();
                $("dodgeMsg").textContent="Ты прошёл.";
                setTimeout(function(){
                    $("dodgeGame").classList.remove("on");
                    if(DG.onWin) DG.onWin();
                },1500);
            }
            function loseDodge(){
                if(!DG.active)return;
                DG.active=false;
                cancelAnimationFrame(DG.raf);
                clearInterval(DG.timer);
                vibrate([100,50,100]);
                $("dodgeMsg").textContent="Тени быстрее.\nПопробуй снова.";
                G.lives=Math.max(0,G.lives-1);
                updH();
                setTimeout(function(){
                    $("dodgeGame").classList.remove("on");
                    if(DG.onLose) DG.onLose();
                    else if(G.lives<=0) gameOver();
                },2000);
            }

            // ============================================================
            // === MEMORY FLASH EFFECT ===
            // ============================================================
            function memFlash(){
                var d=document.createElement("div");
                d.className="mem-flash";
                document.body.appendChild(d);
                setTimeout(function(){d.remove()},400);
            }
            // ПАМЯТЬ БАШНИ - roguelite persistence
            var TM = {deaths:0, runs:0, lastDeath:"", bestFloor:0, choices:{}, drink:"", npcs:[], totalEcho:0, bestEcho:0, combosFound:0, secretsFound:0, allItems:[], playTime:0};
            try { var saved = localStorage.getItem("ernie_memory"); if(saved) TM = JSON.parse(saved) } catch(e){}
            TM.runs++; try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}
            var IS_REPLAY = TM.runs > 1;

            // === REPLAY AWARENESS (Undertale-style) ===
            function getReplayGreeting() {
                if(!IS_REPLAY) return null;
                var greetings = [
                    "«О. Ты вернулся.»",
                    "«Опять ты.»",
                    "«"+REPLAY_RUN+"-й раз. Я считаю.»",
                    "«Помнишь меня? Я помню тебя.»"
                ];
                if(TM.catName) greetings.push("«"+TM.catName+" тоже ждала.»");
                if(TM.endings && TM.endings.indexOf("b")>=0) greetings.push("«В прошлый раз ты забрал меня с собой. Спасибо. Но вот — я снова тут.»");
                if(TM.endings && TM.endings.indexOf("c")>=0) greetings.push("«В прошлый раз ты остался вместо меня. Зачем вернулся?»");
                if(TM.bestEcho && TM.bestEcho > 50) greetings.push("«Твой рекорд — "+TM.bestEcho+" Эхо. Побьёшь?»");
                return greetings[Math.floor(Math.random()*greetings.length)];
            }
            function getReplayBaristaLine() {
                if(!IS_REPLAY) return null;
                if(TM.drink) return "«О, снова ты. В прошлый раз заказывал "+TM.drink+". Сегодня то же?»";
                return "«Лицо знакомое. Был тут раньше?»";
            }

            var REPLAY_RUN = TM.runs;
            function towerRemember(cause,floor){TM.deaths++;TM.lastDeath=cause;if(floor>TM.bestFloor)TM.bestFloor=floor;if(G.catName)TM.catName=G.catName;if(G.playerName)TM.playerName=G.playerName;try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}}
            function saveTM(){
                TM.totalEcho=(TM.totalEcho||0)+G.echo;
                if(G.echo>(TM.bestEcho||0))TM.bestEcho=G.echo;
                TM.combosFound=(TM.combosFound||0)+G.combos;
                TM.secretsFound=(TM.secretsFound||0)+G.secrets;
                TM.playTime=(TM.playTime||0)+Math.floor((Date.now()-G.startTime)/60000);
                try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}
            }
            function saveTM(){
                TM.totalEcho=(TM.totalEcho||0)+G.echo;
                if(G.echo>(TM.bestEcho||0))TM.bestEcho=G.echo;
                TM.combosFound=(TM.combosFound||0)+G.combos;
                TM.secretsFound=(TM.secretsFound||0)+G.secrets;
                TM.playTime=(TM.playTime||0)+Math.floor((Date.now()-G.startTime)/60000);
                try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}
            }

            // === ВИЗУАЛЬНЫЕ ЭФФЕКТЫ ===
            
            function setAmbient(f){
                var sg=document.getElementById("sg");if(!sg)return;
                var t={
                    1:["rgba(200,168,72,.04)","rgba(90,127,160,.02)"],
                    2:["rgba(90,127,160,.03)","rgba(100,80,140,.02)"],
                    3:["rgba(180,160,100,.03)","rgba(200,180,120,.02)"],
                    4:["rgba(212,160,212,.03)","rgba(200,168,72,.02)"],
                    5:["rgba(96,216,216,.03)","rgba(60,100,120,.02)"],
                    6:["rgba(80,160,80,.04)","rgba(120,180,100,.02)"],
                    7:["rgba(160,180,200,.03)","rgba(200,200,220,.02)"],
                    8:["rgba(20,20,40,.01)","rgba(10,10,20,.01)"],
                    9:["rgba(176,80,80,.03)","rgba(100,40,40,.02)"],
                    10:["rgba(220,180,100,.05)","rgba(200,160,80,.03)"]
                }[f]||["rgba(200,168,72,.03)","rgba(90,127,160,.02)"];
                sg.style.setProperty("--ambient1",t[0]);
                sg.style.setProperty("--ambient2",t[1]);
            }
function setFx(fx){
                var sg=$("sg");
                sg.classList.remove("fx-flicker","fx-ghost","fx-void","fx-shadow");
                if(fx)sg.classList.add("fx-"+fx);
            }
            var G = { karma: 0, lives: 5, echo: 0, combos: 0, secrets: 0, timedChoicesMade: 0, hasCat: false, items: [], vis: {}, uc: {}, trust: 0, metRaven: false, dread: 0, catTrust: 50, playerName: "Странник", saved: {}, startTime: Date.now(), petCount: 0, notesFound: [], perfectRun: true, choiceStats: {}, _tapsDuringCountdown:0, _wasPatient:true };
            // CHANGE 8: ERNIE KNOWS TIME
            var _ernieTimeComment=null;
            function getTimeComment(){
                var h=new Date().getHours();
                if(h>=1&&h<5) return "«Ты тоже не спишь?»";
                if(h>=5&&h<7) return "«Рассвет. Тебе не спится.»";
                if(h>=23||h===0) return "«Поздно. Тебе завтра не нужно?»";
                return null;
            }
            function getReturnComment(){
                if(!TM.lastVisit) return null;
                var diff=Date.now()-TM.lastVisit;
                var hours=diff/3600000;
                if(hours>72) return "«"+Math.floor(hours/24)+" дней. Я считал.»";
                if(hours>24) return "«Вчера тебя не было.»";
                return null;
            }
            TM.lastVisit=Date.now();
            try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}
            // Roguelite бонус
            if(TM.deaths>=5)G.lives=6;
            function addItem(it){if(G.items.indexOf(it)<0){G.items.push(it);updInv()}}

            // === КОШКА-КОМПАНЬОН ===
            var CAT={visible:false,state:"breathe",bubbleTimer:null,idleTimer:null};
            function showCat(){setAmb("warm");updInv();
                if(!G.hasCat)return;
                CAT.visible=true;
                $("catComp").style.display="flex";
                catState("breathe");
                catStartIdle();
            }
            function hideCat(){
                CAT.visible=false;
                $("catComp").style.display="none";
                if(CAT.idleTimer){clearTimeout(CAT.idleTimer);CAT.idleTimer=null}
            }
            function catState(s,duration){
                if(!CAT.visible)return;
                CAT.state=s;
                var el=$("catComp");
                el.className="cat-"+s;
                if(CAT.stateTimer)clearTimeout(CAT.stateTimer);if(duration){CAT.stateTimer=setTimeout(function(){if(CAT.state===s)catState("breathe")},duration)}
            }
            function catSay(txt,dur){
                if(!CAT.visible)return;
                var b=$("catBubble");
                b.textContent=txt;
                b.classList.add("show");
                if(CAT.bubbleTimer)clearTimeout(CAT.bubbleTimer);
                CAT.bubbleTimer=setTimeout(function(){b.classList.remove("show")},dur||2500);
            }
            function catStartIdle(){
                if(CAT.idleTimer)clearTimeout(CAT.idleTimer);
                CAT.idleTimer=setTimeout(function(){
                    if(!CAT.visible)return;
                    var idle=["Мяу?","...","Мрр","*зевает*","*смотрит*"];
                    catSay(idle[Math.floor(Math.random()*idle.length)],2000);
                    catStartIdle();
                },25000+Math.random()*20000);
            }
            // Реакции кошки
            var petCount=0;
            function petCat(){sPurr();
                if(!CAT.visible)return;
                petCount++;
                if(petCount<=2)sMeow();else sPurr();
                vibrate(20);
                var sprite=$("catSprite");
                sprite.style.animation="catPurrWiggle .5s ease";
                setTimeout(function(){sprite.style.animation="";catStartIdle()},600);
                var msgs=["Мрррр...","*мурчит*","*трётся*","Прр...","*довольна*"];
                if(petCount>=5)msgs.push("*засыпает на руках*");
                if(petCount>=10)msgs.push("*ты ей нравишься*");
                catSay(msgs[Math.floor(Math.random()*msgs.length)],2500);
                if(petCount===20){notify("🐱 "+(G.catName||"Кошка")+" любит тебя","gold");G.karma+=1;updH()}
            }
            function catReact(type){updateCatInteract();if(type==="purr"||type==="good")sMeow();
                if(!CAT.visible)return;
                catStartIdle();// сбрасываем idle таймер
                if(type==="good"){catState("purr",3000);catSay("Мрр...",2000)}
                else if(type==="danger"){catState("hiss",2000);catSay("Шшш!",1500)}
                else if(type==="item"){catState("play",2000);catSay("Мяу!",1500)}
                else if(type==="sad"){catState("breathe");catSay("...",3000)}
                else if(type==="alert"){catState("alert",3000);catSay("?!",1500)}
                else if(type==="wait"){catState("wait");catSay("*ждёт*",3000)}
                else if(type==="sleep"){catState("sleep")}
                else if(type==="hide"){hideCat()}
                else if(type==="mom"){catState("alert",8000);catSay("Мяу...",3000)}
            }
            var ravenMsgs={
                4:["Театр масок.\nВсе лица — чужие.\nВключая твоё.","Актёр играет 200 лет.\nЗабыл последнюю реплику.\nТеперь импровизирует."],
                5:["Смотритель не спит.\nНикогда.\nОн завидует тем,\nкто может.","Камеры видят всё.\nКроме правды.\nПравда прячется\nв слепых зонах."],
                6:["Сад помнит то,\nчто все забыли.\nДаже башня.","Цветок у таблички —\nне просто цветок.\nЭто последнее,\nчто он посадил."],
                7:["Зеркала врут.\nНо иногда —\nговорят правду.\nЭто хуже.","Не доверяй\nсвоему отражению.\nОно хочет\nтвоё место."],
                8:["Голоса хотят,\nчтобы ты остался.\nНе слушай.\nОсобенно — маму.","847 голосов.\nНи один не нашёл\nвыход.\nТы — 848-й.\nУдиви меня."],
                9:["Почти.\nОсталось немного.\nНе оглядывайся."]
            };
            function ravenNotify(floor){
                if(!G.metRaven)return;
                var msgs=[
                    "Кар.",
                    "Двойной кар.",
                    "Кар в минорной тональности.",
                    "Кар. (С сарказмом.)",
                    "Кар? (Вопросительно.)",
                    "...Кар. (Задумчиво.)",
                    "КАР. (Громко. Зачем-то.)",
                    "Кар кар кар. (Это поэма.)",
                    "Неправда.",
                    "Кар."
                ];
                var ravenI=(G.uc._ravenI||0);
                if(Math.random()>0.4)return;
                G.uc._ravenI=(ravenI+1)%msgs.length;
                var msg=msgs[ravenI];
                if(msg==="Неправда."){
                    setTimeout(function(){
                        notify("🐦‍⬛ Ворон: «"+msg+"»","gold");
                        setTimeout(function(){notify("💭 ERNIE: «Он не умеет говорить.»",null)},2000);
                        setTimeout(function(){notify("🐦‍⬛ Ворон: «Кар.»","gold")},4000);
                    },3000);
                } else {
                    setTimeout(function(){notify("🐦‍⬛ Ворон: «"+msg+"»","gold")},2000+Math.random()*3000);
                }
            }
            function drainNotif(){
                if(notifQueue.length===0){notifBusy=false;return}
                notifBusy=true;var n=notifQueue.shift();
                var e = $("notif");
                e.textContent = n.t;
                e.className = "notif " + (n.tp === "bad" ? "nb" : "ng") + " show";
                if(n.tp==="bad"){doShake()}
                setTimeout(function() { e.classList.remove("show"); setTimeout(drainNotif,400) }, 5200);
            }
            // === CAT ON TEXT ===
            var catOnTextCount=0;
            function maybeCatOnText(){
                if(!G.hasCat)return;catOnTextCount++;
                if(catOnTextCount%3!==0||Math.random()>0.5)return;
                var ov=document.createElement("div");
                ov.style.cssText="position:fixed;top:35%;left:38%;font-size:52px;z-index:999;pointer-events:none;transition:opacity .5s";
                ov.textContent="🐱";ov.id="catOnText";document.body.appendChild(ov);
                setTimeout(function(){
                    notify("ERNIE: «Убери кошку с текста. Пожалуйста.»","gold");
                    setTimeout(function(){var c=$("catOnText");if(c){c.style.opacity="0";setTimeout(function(){if(c&&c.parentNode)c.remove()},600)}
                    notify("ERNIE: «Спасибо.»","gold")},4000);
                },2000);
            }
            
            // === АВТОСОХРАНЕНИЕ ===
            function saveGame(){
                try{
                    var save={G:JSON.parse(JSON.stringify(G)),floor:G.currentFloor,ts:Date.now()};
                    localStorage.setItem("ernie_save",JSON.stringify(save));
                }catch(e){}
            }
            function loadGame(){
                try{
                    var s=localStorage.getItem("ernie_save");
                    if(!s)return null;
                    return JSON.parse(s);
                }catch(e){return null}
            }
            function clearSave(){localStorage.removeItem("ernie_save")}
            // Автосохранение каждые 30 секунд
            setInterval(function(){if(G.currentFloor>=1)saveGame()},30000);
// === GHOST POPUP (Бариста на этажах) ===
            function showGhostPop(name,img,text){
                $("ghostPopName").textContent=name;
                $("ghostPopText").textContent=text;
                $("ghostPopImg").src=img||"";
                $("ghostPopup").style.display="block";
                $("ghostPopup").style.opacity="1";
                $("ghostPopup").style.transform="translateY(0)";
                setTimeout(function(){closeGhostPop()},7000);
            }
            function closeGhostPop(){$("ghostPopup").style.opacity="0";$("ghostPopup").style.transform="translateY(20px)";setTimeout(function(){$("ghostPopup").style.display="none"},500)}
            function ghostNotify(floor){
                if(Math.random()>0.15)return;
                var msgs=[];
                if(floor>=2&&!G.saved.barista)msgs.push("☕ Бариста: «Кофе стынет! Ну, если бы он мог стыть.»");
                if(floor>=3&&!G.saved.conductor)msgs.push("🚂 Кондуктор: «Следующая станция: этаж "+(floor+1)+". Прибытие: скоро. Наверное.»");
                if(floor>=4&&!G.saved.actor)msgs.push("🎭 Актёр: «Второй акт! Все на сцену! ...Один я.»");
                if(floor>=6&&!G.saved.trumpeter)msgs.push("🎺 Трубач: «До.» Пауза. «...Нет. Не до. Ре? Нет.»");
                if(floor>=2&&!G.saved.lika)msgs.push("🎨 Лика: «Я нарисовала дверь. Она не открывается. Пока.»");
                if(floor>=5)msgs.push("📢 Объявление: «Лифт не работает. Причина: метафизический ужас. Спасибо за понимание.»");
                if(floor>=7)msgs.push("📢 Объявление: «Зеркала на этаже 7 врут. Но красиво.»");
                if(msgs.length>0){
                    setTimeout(function(){notify(msgs[Math.floor(Math.random()*msgs.length)],"gold")},4000+Math.random()*6000);
                }
            }
            function fadeIn(cb) {
                // Тишина. Атмосфера создаётся молчанием, не уведомлениями.
                if(G.uc&&G.uc.cqLeftDoor&&Math.random()<0.1){setTimeout(function(){notify("«Ты обещал...»","bad")},6000)}
                $("fade").classList.add("on");
                setTimeout(function() { cb(); setTimeout(function() { $("fade").classList.remove("on") }, 300) }, 500)
            }
            function goS(id) { document.querySelectorAll(".scr").forEach(function(s) { s.classList.remove("on") }); $(id).classList.add("on") }
            function updH() {
                var oldK=parseInt($("hK").textContent)||0;
                var oldH=parseInt($("hH").textContent)||5;
                $("hK").textContent = (G.karma > 0 ? "+" : "") + G.karma;
                $("hH").textContent = G.lives;
                // HUD — минимально
                var hud=document.querySelector(".g-hud");if(hud){hud.classList.add("active");clearTimeout(G._hudTimer);G._hudTimer=setTimeout(function(){hud.classList.remove("active")},2000)}
                // Сердца — показываем ТОЛЬКО при потере, потом скрываем
                if(G.lives!==oldH){
                    var hW=$("hHWrap");hW.style.opacity="1";
                    var hEl=$("hH").parentNode;hEl.style.transition="none";hEl.style.color=G.lives<oldH?"var(--red)":"var(--gold)";hEl.style.transform="scale(1.3)";
                    setTimeout(function(){hEl.style.transition="all .5s ease";hEl.style.color="";hEl.style.transform=""},50);
                    clearTimeout(G._heartFade);G._heartFade=setTimeout(function(){hW.style.opacity="0"},4000);
                }
                updInv();
                var v=$("vigDiv");if(v){v.className="vignette vig-"+Math.max(0,Math.min(5,G.lives))}
                if(G.lives<=0){gameOver()}
                // Карма влияет на атмосферу
                if(G.karma>=15){document.documentElement.style.setProperty("--bg","#080a05")}
                else if(G.karma<=-5){document.documentElement.style.setProperty("--bg","#0a0508")}
                else{document.documentElement.style.setProperty("--bg","#050508")}
                if($("ernieHpBar").style.display==="flex")updateErnieBond();
            }
            
            // === ECHO POINTS SYSTEM (Balatro-inspired) ===
            function addEcho(n, label) {
                G.echo += n;
                $("hE").textContent = G.echo;
                // Тихо. Игрок не видит очки.
            }

            function doShake(){catReact("danger");vibrate(100);var el=$("gImgW")||document.body;el.classList.add("shake");setTimeout(function(){el.classList.remove("shake")},400)}
            function flashDamage(){setAmb("red");setTimeout(function(){setAmb(null)},3000);tgHaptic("error");vibrate(200);var f=document.createElement("div");f.style.cssText="position:fixed;inset:0;background:rgba(176,50,50,.25);z-index:999;pointer-events:none;animation:dmgFlash .5s ease forwards";document.body.appendChild(f);setTimeout(function(){f.remove()},600);doShake()}
            function gameOver(){
                // Кот спасает — один раз
                if(G.hasCat && !G.catSaved){
                    G.catSaved=true;G.catDead=true;G.hasCat=false;
                    hideCat();sShock();
                    GUILT.add((G.catName||"Кошка")+" погибла за тебя",5);
                    EMOTION.add(-50);
                    HEARTBEAT.start("fast");
                    startD([
                        {pause:3,stage:true,txt:(G.catName||"Кошка")+" прыгает."},
                        {pause:2,stage:true,txt:"Между тобой и тьмой."},
                        {pause:3,stage:true,txt:""},
                        {pause:3,stage:true,txt:"Тишина."},
                        {pause:3,stage:true,txt:(G.catName||"Кошка")+" не двигается.",fn:function(){sI(I.cat_sacrifice);ernieThree()}},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«...Нет.»",spd:60},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Нет, нет, нет.»",spd:50},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Она знала.\nОна всегда знала.»",spd:40},
                        {pause:3,stage:true,txt:""}
                    ],function(){
                        G.lives=1;updH();
                        notify("🐱 "+(G.catName||"Кошка")+" спасла тебя","bad");
                        addDiary((G.catName||"Кошка")+" погибла.\nЗа тебя.\nОна знала.","letter",G.currentFloor||1);
                        showLocs&&showLocs()||location.reload();
                    });
                    return;
                }towerRemember("death",G.currentFloor||1);var dNum=848+TM.deaths;setTimeout(function(){fadeIn(function(){$("gCh").style.display="none";$("gBar").style.display="none";sI(I.void9);sF("GAME OVER");startD([{stage:true,txt:"Темнота."},{stage:true,txt:"Холод."},{spk:"ERNIE",cls:"er",txt:"«Нет... нет...»"},{stage:true,txt:"Ты стал тенью.\nЕщё одна тень\nна скамейке."},{spk:"ERNIE",cls:"er",txt:"«Прости.\nЯ не смог\nтебя спасти.»"},{narr:true,txt:"GAME OVER"},{narr:true,txt:"«"+dNum+" из "+dNum+"\nне дошли.»"}],function(){showCh([{icon:"🔄",text:"Начать заново",fn:"location.reload()",id:"rl"}])})})},500)}
            function updInv() {
                var el = $("inv");
                var h = "";
                var bh = "";
                G.items.forEach(function(it) {
                    var m = ITEMS_META[it];
                    if(!m) return;
                    var emoji = m.emoji || "📦";
                    h += '<div class="inv-i" onclick="invClick(\''+it+'\')">'+emoji+'</div>';
                    var imgSrc = m.img ? I[m.img] : "";
                    var label = (m.getName && G.catName) ? G.catName : m.name;
                    if(imgSrc){
                        bh += '<div class="bag-item" onclick="invClick(\''+it+'\')"><img src="'+imgSrc+'" alt="'+m.name+'"><div class="bag-name">'+label+'</div></div>';
                    } else {
                        bh += '<div class="bag-item" onclick="invClick(\''+it+'\')" style="font-size:24px;justify-content:center;height:80px">'+emoji+'<div class="bag-name">'+label+'</div></div>';
                    }
                });
                if (G.hasCat) {
                    var catLabel = G.catName || "КОШКА";
                    var catImg = I.cat || "";
                    h += '<div class="inv-i cat-glow" onclick="invClick(\'cat\')">🐱</div>';
                    if(catImg){
                        bh += '<div class="bag-item" onclick="invClick(\'cat\')"><img src="'+catImg+'" alt="Кошка"><div class="bag-name">'+catLabel+'</div></div>';
                    } else {
                        bh += '<div class="bag-item" onclick="invClick(\'cat\')" style="font-size:24px;justify-content:center;height:80px">🐱<div class="bag-name">'+catLabel+'</div></div>';
                    }
                }
                el.innerHTML = h;
                el.style.display = "none";
                $("bagBtn").style.display = (G.currentFloor>=1 ? "flex" : "none");
                $("bagItems").innerHTML = bh || '<div style="color:var(--txtd);font-size:12px">пусто</div>';
                // Update bag count badge
                var itemCount=G.items.length+(G.hasCat?1:0);
                var badge=$("bagCount");
                if(badge){
                    if(itemCount>0){badge.textContent=itemCount;badge.style.display="flex"}
                    else{badge.style.display="none"}
                }
            }
            var bagOpen=false;
            function toggleBag(){
                var o=$("bagOverlay");
                if(o.style.display==="flex"){
                    o.style.display="none";
                    bagOpen=false;
                    // Возобновляем tw если был на паузе
                    if(twPaused&&twPausedFn){twPausedFn();twPaused=false;twPausedFn=null}
                }else{
                    o.style.display="flex";
                    // ERNIE comments on bag
                    if(Math.random()<0.3&&G.currentFloor>=2){
                        var bagComments=["«Зачем тебе всё это?»","«Маска. Книга. Кофе.\nНабор выживальщика.»","«У меня нет сумки.\nУ меня нет вещей.\nУ меня нет карманов.»","«Кофе в сумке.\nГениально.\nОн уже остыл.»","«Фото в сумке.\nМоё фото.\nНе помню\nкогда улыбался.»"];
                        setTimeout(function(){notify("💭 ERNIE: "+bagComments[Math.floor(Math.random()*bagComments.length)].replace(/«|»|\n/g," ").substring(0,50),null)},800);
                    }
                    bagOpen=true;
                    // Паузим tw
                    if(twI){clearTimeout(twI);twI=null;twPaused=true}
                }
            }
            var twPaused=false,twPausedFn=null;
            var ITEMS_META = {
                knife:{name:"НОЖ",icon:"🔪",emoji:"🔪",img:"cat_closeup",desc:"Старый. Ржавый. Но острый."},
                coffee:{name:"КОФЕ",emoji:"☕",desc:"Горячий. Настоящий.\nОт Баристы.",img:"item_coffee"},
                drawing:{name:"РИСУНОК",emoji:"🎨",desc:"Семья. Солнце.\nЛика нарисовала 200 лет назад.",img:"item_drawing"},
                ticket:{name:"БИЛЕТ «ТУДА»",emoji:"🎫",desc:"Вагон 8, место 47. Обратной стороны нет.",img:"item_ticket"},
                book:{name:"ПУСТАЯ КНИГА",emoji:"📖",desc:"На обложке — твоё имя.\nСтраницы ждут.",img:"item_book"},
                photo:{name:"ФОТО",emoji:"📷",desc:"Мальчик, 14 лет.\nУ башни. Улыбается.",img:"item_photo"},
                mask:{name:"МАСКА",emoji:"🎭",desc:"Половина смеётся.\nПоловина плачет.",img:"item_mask"},
                cat:{name:"КОШКА",emoji:"🐱",desc:"Рыжая. Живая.\nЕдинственное живое в башне.",img:"cat",getName:true}
            };
            function showItemPop(key){var m=ITEMS_META[key];if(!m||!m.img)return;$("itemPopImg").src=I[m.img];$("itemPopName").textContent=m.getName&&G.catName?G.catName.toUpperCase():m.name;$("itemPopDesc").textContent=m.desc;$("itemPopup").classList.add("show");spawnParticles();vibrate(30)}
            function spawnParticles(){var c=document.createElement("div");c.style.cssText="position:fixed;inset:0;pointer-events:none;z-index:999";document.body.appendChild(c);for(var i=0;i<12;i++){var p=document.createElement("div");var x=40+Math.random()*20;var y=40+Math.random()*20;var dx=(Math.random()-.5)*120;var dy=(Math.random()-.5)*120;var clr=["var(--gold)","var(--blue)","#fff"][Math.floor(Math.random()*3)];p.style.cssText="position:absolute;left:"+x+"%;top:"+y+"%;width:4px;height:4px;border-radius:50%;background:"+clr+";opacity:1;transition:all .8s ease;box-shadow:0 0 6px "+clr;c.appendChild(p);setTimeout(function(el,ddx,ddy){el.style.transform="translate("+ddx+"px,"+ddy+"px)";el.style.opacity="0"},(i*30),p,dx,dy)}setTimeout(function(){c.remove()},1000)}
            function closeItemPop(){$("itemPopup").classList.remove("show")}
            function showNote(title,text){$("noteInner").querySelector(".note-title").textContent=title;$("noteText").textContent=text;$("notePopup").classList.add("show")}
            var twI = null;
            function tw(el, txt, spd, cb) {el.classList.add("tw-cursor");el.classList.remove("tw-done");
                spd = spd || 28;
                // Настройка скорости: 1=медленно(×1.5), 2=нормально, 3=быстро(×0.5)
                var spdMult=[1.5,1,.5][((SETT&&SETT.textSpeed)||2)-1];
                spd=Math.round(spd*spdMult);
                if (twI) clearTimeout(twI);
                el.textContent = "";
                if(!txt||txt.length===0){if(cb)setTimeout(cb,300);return}
                var i = 0;
                function tick(){
                    if(i>=txt.length){twI=null;if(cb)setTimeout(cb,300);return}
                    el.textContent+=txt[i];
                    var ch=txt[i];
                    var delay=spd;
                    // Паузы на знаках препинания
                    if(ch==='.'||ch==='!'||ch==='?'||ch==='»')delay=spd*6;
                    else if(ch===','||ch===';'||ch===':')delay=spd*3;
                    else if(ch==='—'||ch==='…')delay=spd*4;
                    else if(ch==='\n')delay=spd*2;
                    i++;
                    twI=setTimeout(tick,delay);
                }
                tick();
            }
            // Вибрация
            function vibrate(ms){if(!SETT.vibro||!window._userGesture)return;try{if(navigator.vibrate)navigator.vibrate(ms||50)}catch(e){}}
            function vibratePattern(pattern){if(!SETT.vibro||!window._userGesture)return;try{if(navigator.vibrate)navigator.vibrate(pattern)}catch(e){}}
            function vibrateHeartbeat(){vibratePattern([100,80,100,400,100,80,100])}
            function vibrateDeath(){vibratePattern([200,100,200,100,400])}
            function vibratePhone(){vibratePattern([150,100,150,100,150,100,150,100,150])}
            function vibrateFree(){vibratePattern([50,50,50,50,200])}
            var DL = [], DI = 0, awReady = false;
            var npcImages=[I.boris,I.lika,I.librarian,I.actor,I.conductor,I.guardian,I.ernie_visible,I.ernie_free,I.cat,I.cat_bye];
            // === SPLASH SCREEN ===
            var splashEl=$("splash");
            if(splashEl){
                var si=$("splashImg");if(si&&I.tower_inside)si.style.backgroundImage="url("+I.tower_inside+")";
                setTimeout(function(){if(si)si.style.opacity="1"},200);
                var allImgs=Object.values(I).filter(function(v){return typeof v==="string"&&v.indexOf("http")===0&&v.indexOf(".mp4")<0});
                var loaded=0;var total=allImgs.length;
                var splashBar=$("splashBar");
                allImgs.forEach(function(src){
                    var img=new Image();
                    img.onload=img.onerror=function(){
                        loaded++;
                        if(splashBar)splashBar.style.width=(loaded/total*100)+"%";
                        if(loaded>=total){setTimeout(function(){
                            splashEl.style.opacity="0";
                            setTimeout(function(){splashEl.style.display="none"},800);
                        },500)}
                    };
                    img.src=src;
                });
                // Таймаут на случай если картинки не грузятся
                setTimeout(function(){
                    if(splashEl.style.display!=="none"){
                        splashEl.style.opacity="0";
                        setTimeout(function(){splashEl.style.display="none"},800);
                    }
                },8000);
            }
            function sI(src) {
                var oldVid=$("gVid");
                if(oldVid)oldVid.remove();
                var img=$("gI");
                img.style.display="block";
                if(src&&src!==img.src){
                    img.style.opacity="0";
                    img.src=src;
                    img.onload=function(){img.style.transition="opacity .3s ease";img.style.opacity="1"};
                    img.onerror=function(){
                        // Graceful fallback — тёмный placeholder
                        img.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='720' height='1280'%3E%3Crect fill='%23080810' width='720' height='1280'/%3E%3C/svg%3E";
                        img.style.transition="opacity .3s ease";img.style.opacity="1";
                    };
                }else if(!src){img.src="";}
                // Призрачное мерцание для NPC
                if(src&&npcImages.indexOf(src)>=0){
                    $("gImgW").classList.add("npc-ghost");
                }else{
                    $("gImgW").classList.remove("npc-ghost");
                }
            }
            function sF(t) { $("gFl").textContent = t }
            function clearDlg() {
                $("topSpk").textContent = ""; $("topTxt").textContent = "";
                $("botSpk").textContent = ""; $("botTxt").textContent = "";
                $("topSpk").className = "d-spk"; $("botSpk").className = "d-spk";
                $("topTxt").className = "d-txt"; $("botTxt").className = "d-txt"
            }
            function advance() {
                if(!DL||!DL.length)return;
                if (twI) { clearTimeout(twI); twI = null; var it = DL[DI]; if(it){if (it.cls === "er" || it.spk === "ERNIE") { $("botTxt").textContent = it.txt } else { $("topTxt").textContent = it.txt }} return }
                if (DI < DL.length - 1) { DI++; var next=DL[DI]; if(!next){return} if(next.pause){clearDlg();setTimeout(function(){showD(DI)},next.pause*1000);return} showD(DI) }
                else { $("gBotW").onclick = null; $("gTop").onclick = null; $("gImgW").onclick = null; $("gTap").style.display = "none"; if (DL._c) showCh(DL._c); if (DL._d) DL._d() }
            }
            function startD(items, done, choices, img) {
                DL = items; DI = 0; DL._d = done; DL._c = choices;
                if (img) sI(img);
                hideErnieBond();
                $("gCh").style.display = "none"; $("gCh").innerHTML = ""; $("gBar").style.display = "none"; $("riddleW").style.display = "none";
                $("gNav").style.display = "flex"; $("gTap").style.display = "block";
                $("gTop").style.display = "block"; $("gBotW").style.display = "flex"; $("gImgW").style.display = "block";
                showD(0);
                $("gBotW").onclick = advance; $("gTop").onclick = advance; $("gImgW").onclick = advance
            }
            function showD(i) {
                var it = DL[i]; clearDlg();
                if (it.stage || it.narr) { $("topTxt").className = "d-txt " + (it.stage ? "stage" : "narr"); tw($("topTxt"), it.txt, it.spd || (it.stage?18:28)) }
                else if (it.cls === "er" || it.spk === "ERNIE") { $("gBot").classList.add("er-active");sErnieWhisper();setAmb("gold");$("botSpk").className = "d-spk spk-er"; $("botSpk").textContent = "ERNIE"; tw($("botTxt"), ernieGlitch(it.txt), it.spd || (G.currentFloor>=9?45:G.currentFloor>=7?38:33)) }
                else { $("gBot").classList.remove("er-active");$("topSpk").className = "d-spk spk-" + (it.cls || "bo"); $("topSpk").textContent = it.spk || "???"; $("topTxt").className = it.cls==="sm" ? "d-txt glitch" : "d-txt"; tw($("topTxt"), it.txt, it.spd || 28) }
                $("nL").disabled = (i <= 0); $("nR").disabled = (i >= DL.length - 1);
                var _vc=0,_vt=0;for(var _vi=0;_vi<DL.length;_vi++){if(DL[_vi].txt!==""||DL[_vi].spk){_vt++;if(_vi<=i)_vc++}}
                if(_vt<1){_vt=DL.length;_vc=i+1}if(_vc<1)_vc=1;
                $("navC").textContent=_vc+"/"+_vt;
                if (it.sfx) it.sfx();
                if (it.fn) it.fn();
                // ERNIE deleted message — brief flash then auto-advance
                if (it.del) {
                    var delEl = it.cls==="er" ? $("botTxt") : $("topTxt");
                    delEl.classList.add("ernie-del");
                    setTimeout(function(){ advance() }, 2000);
                }
            }
            function nP() { if (DI > 0) { DI--; showD(DI) } }
            function nN() { 
                var now=Date.now();
                if(G._lastClick&&now-G._lastClick<400){G._fastClicks=(G._fastClicks||0)+1}else{G._fastClicks=0}
                G._lastClick=now;
                // 5 быстрых кликов — ERNIE замечает
                if(G._fastClicks>=5&&!G._skipWarned){
                    G._skipWarned=true;G._fastClicks=0;
                    var savedDL=DL,savedDI=DI;
                    stopPressure();
                    startD([
                        {spk:"ERNIE",cls:"er",txt:"«Ты не читаешь.»"},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Я вижу.»",spd:50},
                        {pause:3,stage:true,txt:"ERNIE замолкает."},
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«...Продолжим.»",spd:60}
                    ],function(){
                        DL=savedDL;DI=savedDI;
                        showD(DI);
                        $("gBotW").onclick=advance;$("gTop").onclick=advance;$("gImgW").onclick=advance;
                    });
                    return;
                }
                if (DI < DL.length - 1) { DI++; showD(DI) } 
            }
            function showCh(ch) { updInv();
                // Интерфейс врёт при низкой карме
                if(G.karma<=-5 && ch.length>=2 && Math.random()<0.15 && !G._btnLied){
                    G._btnLied=true;
                    // Меняем текст двух кнопок местами (но fn остаётся!)
                    var a=0,b=1;
                    var tmp=ch[a].text;ch[a].text=ch[b].text;ch[b].text=tmp;
                    var tmpI=ch[a].icon;ch[a].icon=ch[b].icon;ch[b].icon=tmpI;
                    // Через 3 секунды — мигание, текст возвращается
                    setTimeout(function(){
                        var btns=document.querySelectorAll(".ch-btn");
                        btns.forEach(function(b){b.style.animation="glitch .3s ease"});
                        setTimeout(function(){
                            // Тексты обратно, но fn уже мог сработать
                        },300);
                    },3000);
                }applyDread();
                $("gTop").style.display = "none"; $("gBotW").style.display = "none"; $("gNav").style.display = "none";
                $("gCh").innerHTML = ""; $("gCh").style.display = "flex";
                ch.forEach(function(c, idx) {
                    var btn = document.createElement("button");
                    btn.className = "g-cb" + (G.uc[c.id] ? " used" : "");
                    // Цвет рамки по весу решения
                    if(c.w) btn.setAttribute("data-w",c.w);
                    if(c.w==="heavy"){
                        btn.setAttribute("data-fn",c.fn);
                        btn.onclick = function(e){ /* blocked - hold only */ e.preventDefault(); };
                    } else {
                        btn.onclick = function(){ sS(); vibrate(10); resetPressure(); eval(c.fn) };
                    }
                    btn.innerHTML = '<span class="cb-icon">' + c.icon + '</span> ' + c.text;
                    btn.style.opacity = "0";
                    btn.style.transform = "translateY(10px)";
                    btn.style.transition = "opacity .4s ease, transform .4s ease";
                    $("gCh").appendChild(btn);
                    setTimeout(function(){
                        btn.style.opacity = "1";
                        btn.style.transform = "translateY(0)";
                    }, 150 + idx * 120);
                });
                // Scroll к кнопкам
                setTimeout(function(){$("gCh").scrollIntoView({behavior:"smooth",block:"nearest"})},400);
            }
            function showBar(t, fn) { $("gBar").style.display = "block"; var btn=document.createElement("button");btn.onclick=function(){eval(fn)};btn.textContent=t;btn.style.opacity="0";btn.style.transition="opacity .6s ease";$("gBar").innerHTML="";$("gBar").appendChild(btn);setTimeout(function(){btn.style.opacity="1"},200) }
            // Предупреждение ERNIE если не все локации пройдены
            function tryGo(floor,locs,goFn){
                var visited=0;var total=locs.length;
                locs.forEach(function(k){if(G.vis[k])visited++});
                if(visited>=total){eval(goFn);return}
                var left=total-visited;
                $("gBar").style.display="none";
                startD([
                    {spk:"ERNIE",cls:"er",txt:"«Подожди.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Ты не всё видел.\n"+(left===1?"Осталось одно место.":"Осталось "+left+" места.")+"»"},
                    {spk:"ERNIE",cls:"er",txt:"«Каждая встреча\nменяет то,\nчто ждёт выше.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Уверен,\nчто хочешь уйти?»"}
                ],null,[
                    {icon:"⬆️",text:"Подняться",fn:goFn,id:"go_yes"},
                    {icon:"🔍",text:"Остаться",fn:"backF"+floor+"()",id:"go_no"}
                ])
            }
            function showLocs() {
                // Онбординг
                if(!G.uc._onboarded){G.uc._onboarded=true;setTimeout(function(){notify("Исследуй. Предметы пригодятся позже.",null)},1500)}
                if(G.currentFloor>=3)startPressure();
                // Мяуканье тизер — кошка ждёт у фонаря
                // Имя на стене при возврате
                if(TM.runs>1&&TM.playerName&&!G._wallNameShown){
                    G._wallNameShown=true;
                    setTimeout(function(){
                        notify("📜 На стене — новая надпись: «"+TM.playerName+". Был тут. Не дошёл.»","gold");
                    },5000);
                }
                // Кошка мяукает из переулка — первый тизер
                if(!G._catTeased){
                    G._catTeased=true;
                    setTimeout(function(){
                        sMeow();notify("🐱 Мяуканье из переулка...",null);
                    },3000);
                }
                $("gBotW").onclick = null; $("gTop").onclick = null; $("gImgW").onclick = null;
                $("gTap").style.display = "none"; $("gNav").style.display = "none"; $("gTop").style.display = "none"; $("gBotW").style.display = "none";
                sI(I.city);
                var ch = $("gCh"); ch.innerHTML = "";
                var w = document.createElement("div"); w.className = "g-locs";
                [{id:"cafe",i:"☕",n:"Кафе",h:"свет в окне"},{id:"apt",i:"🏠",n:"Квартира",h:"дверь приоткрыта"},{id:"wall",i:"📜",n:"Стена Эхо",h:"надписи"},{id:"lamp",i:"💡",n:"Фонарь",h:"тусклый свет"},{id:"bsmt",i:"🎺",n:"Подвал",h:"музыка снизу"}].forEach(function(l) {
                    var b = document.createElement("button"); b.className = "g-loc" + (G.vis[l.id] ? " done" : "");
                    b.onclick = function() { openL(l.id) };
                    b.innerHTML = '<span class="g-loc-i">' + l.i + '</span><span class="g-loc-n">' + l.n + '</span><span class="g-loc-h">' + l.h + '</span>';
                    w.appendChild(b)
                });
                ch.appendChild(w); ch.style.display = "flex";
                if(Object.keys(G.vis).length>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 2 →","tryGoF1()")
            }
            function tryGoF1(){
                stopPressure();
                startD([
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Подожди.»"},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Выше — другие правила.»",spd:40},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Я не смогу\nзащитить тебя\nот всего.»",spd:35},
                    {pause:3,stage:true,txt:""}
                ],function(){
                    showCh([
                        {icon:"⬆️",text:"Подняться",fn:"tryGo(1,['cafe','apt','wall','lamp','bsmt'],'goF2()')",id:"go2"},
                        {icon:"🏠",text:"Остаться",fn:"stayCity()",id:"sc"}
                    ])
                })
            }
            function stayCity(){
                startD([
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Правда?»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ты остаёшься?»"},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Никто не оставался.\n847 человек.\nВсе шли выше.»",spd:40},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Спасибо.»"},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Но ты знаешь\nчто не сможешь\nостаться вечно.\nПравда?»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Башня не\nотпускает.»",spd:35},
                    {pause:3,stage:true,txt:"Дрожь.\nПол. Стены. Воздух."},
                    {stage:true,txt:"Город начинает\nтаять.\nПо краям."}
                ],function(){
                    G.karma+=5;G.trust+=3;updH();
                    addDiary("ERNIE попросил не подниматься.\nТы остался.\nГород начал исчезать.\nБашня не отпускает.","secret",1);
                    showCh([
                        {icon:"⬆️",text:"...Подняться",fn:"tryGo(1,['cafe','apt','wall','lamp','bsmt'],'goF2()')",id:"go2f"}
                    ])
                })
            }
            function backF1(){showLocs();updH()}
            function tryGoF2(){tryGo(2,["train","clock","phone","wait","tent"],"goF3()")}
            function tryGoF3(){tryGo(3,["reading","burned","rdoor","forbid"],"goF4()")}
            function tryGoF4(){tryGo(4,["stage","mirror","seats","pit","alisa"],"goF5()")}
            function tryGoF5(){tryGo(5,["panel","cam","labdoor","archv"],"goF6()")}
            function tryGoF6(){
                // ERNIE просит не открывать
                stopPressure();stopMusic();
                startD([
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Стой.»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Не открывай\nэту дверь.»",spd:35},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Пожалуйста.»",spd:60,fn:function(){ernieThree()}},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«За ней —\nзеркала.\nОни покажут тебе\nто, что ты\nне хочешь видеть.»",spd:35},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«И мне —\nтоже.»",spd:50},
                    {pause:3,stage:true,txt:""}
                ],function(){
                    // Кнопка "Открыть" гаснет через 5 сек
                    showCh([
                        {icon:"🚪",text:"Открыть дверь",fn:"ernieDoorOpen()",id:"edo"},
                        {icon:"⏳",text:"Подождать",fn:"ernieDoorWait()",id:"edw"}
                    ]);
                    // Кнопка гаснет
                    setTimeout(function(){
                        var btn=document.getElementById("edo");
                        if(btn){btn.style.transition="opacity 3s";btn.style.opacity=".2";btn.style.pointerEvents="none"}
                    },5000);
                    // Через 10 сек — появляется "Закрыть игру"
                    setTimeout(function(){
                        var ch=document.getElementById("gCh");
                        if(ch&&ch.style.display==="flex"){
                            var close=document.createElement("button");
                            close.className="ch-btn";
                            close.setAttribute("data-w","forbidden");
                            close.innerHTML='<span class="ch-i">✖</span><span class="ch-t">Закрыть игру</span>';
                            close.onclick=function(){
                                // Запоминаем что закрыл
                                G._closedForErnie=true;TM.closedForErnie=true;saveTM();
                                // Ложное закрытие
                                document.body.style.transition="opacity 2s";
                                document.body.style.opacity="0";
                                setTimeout(function(){
                                    document.body.innerHTML="";
                                    document.body.style.background="#000";
                                },2000);
                            };
                            ch.appendChild(close);
                        }
                    },10000);
                })
            }
            function ernieDoorOpen(){
                G.trust-=2;updH();
                startD([
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ладно.»",spd:60},
                    {pause:3,stage:true,txt:"Тишина.\nДлинная."},
                    {spk:"ERNIE",cls:"er",txt:"«848-й.\nТакой же\nкак все остальные.»",spd:40},
                    {pause:3,stage:true,txt:""}
                ],function(){tryGo(6,["memtree","fount","gaz","wilt"],"goF7()")})
            }
            function ernieDoorWait(){G._silentChoices=(G._silentChoices||0)+1;checkSilentPath();
                G.trust+=3;G.karma+=3;updH();
                startD([
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«...Ты ждёшь?»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Никто\nне ждал.»",spd:50},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«847 человек.\nВсе открывали\nсразу.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ты — первый\nкто...»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Спасибо.»",spd:60,fn:function(){ernieThree()}},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Но дверь\nвсё равно\nоткроется.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Башня не даёт\nвыбора.\nТолько иллюзию\nвыбора.»"},
                    {pause:3,stage:true,txt:"Дверь открывается.\nСама."}
                ],function(){
                    addDiary("ERNIE просил не открывать.\nЯ ждал.\nОн сказал — никто не ждал.\n847 человек. Все открывали сразу.","secret",6);
                    notify("💛 Ты подождал","gold");
                    tryGo(6,["memtree","fount","gaz","wilt"],"goF7()")
                })
            }
            function tryGoF7(){tryGo(7,["corridor","fakeer","dbl","momcall"],"goF8()")}
            

function showDoorF(num, label, cb) {saveGame();
                // Ghost floor number
                var gn=document.createElement("div");
                gn.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono',monospace;font-size:150px;font-weight:100;color:rgba(200,168,72,.04);z-index:0;pointer-events:none;transition:all 3s ease;letter-spacing:20px";
                gn.textContent=num;document.body.appendChild(gn);
                setTimeout(function(){gn.style.fontSize="250px";gn.style.color="rgba(200,168,72,0)"},200);
                setTimeout(function(){gn.remove()},4000);
                sB(); var d = $("door"); d.className = ""; $("doorLbl").style.opacity = "0"; $("doorLbl").textContent = label; $("doorHint").style.display = "none";
                setTimeout(function() { d.classList.add("glow"); $("doorHint").style.display = "block" }, 500);
                d.onclick = function() { d.onclick = null; sFootstep(); sCreak(); $("doorHint").style.display = "none"; d.classList.add("open"); tone(440, .8, "sine", .06);
                    // Лицо мальчика мелькает
                    
                    setTimeout(function() { $("doorLbl").style.opacity = "1" }, 600);
                    // Случайные события на лестнице
                    var ev=stairEvent(num);
                    if(ev){
                        if(ev.demon){setTimeout(function(){sI(I.demon_eye);showWallNote("👁",ev.text,"demon",num)},1200)}
                        else{setTimeout(function(){notify(ev.text||ev,"gold")},1200)}
                    }
                    setTimeout(function() { if (cb) cb() }, ev?5000:4000) }
            }
            // Случайные события между этажами
            function stairEvent(floor){
                if(Math.random()>0.55)return null;// 55% шанс события
                var events=[
                    "Шёпот на лестнице. Не разобрать.",
                    "На стене: «847 рецептов. Все одинаковые. — Б.»",
                    "Записка: «847 представлений. Все провальные. — А.»",
                    "На ступеньке мелом: «847». Кто-то зачеркнул. Написал «848».",
                    "Табличка на стене: «Лифт не работает. Причина: метафизический ужас. — Администрация»",
                    "Объявление: «Wi-Fi: БАШНЯ_5G. Пароль: 847. Скорость: 0 кбит/с»",
                    "Тень мелькнула на стене. Или показалось.",
                    "Ступенька скрипнула. Ты стоял на месте.",
                    "Запах дыма. Кто-то жёг письма.",
                    "На стене мелом: «НЕ ВЕРЬ ЛИФТУ»",
                    "На стене мелом: «БАРИСТА ЛУЧШИЙ»",
                    "Чей-то смех. Далёкий. Детский.",
                    "Записка на ступеньке: «Я дошёл до 4. Дальше не могу.»",
                    "Записка: «Кошка настоящая. Всё остальное — нет.»",
                    "Сквозняк. Откуда? Окон нет.",
                    "Звук падающей книги. Сверху.",
                    "Записка: «ERNIE плакал на 6 этаже. Я слышал.»",
                    "На перилах — засохший цветок.",
                    "Записка: «Пароль от WiFi — 847. Шутка.»",
                    "Эхо твоих шагов. Но шагов больше чем ног.",
                    "Записка: «Скажи Баристе что кофе вкусный. Он заплачет.»",
                    "На стене царапина: «ДЕНЬ 1». Ниже: «ДЕНЬ 847».",
                    "Холод. Резкий. Потом — ничего."
                ];
                // Этаж-специфичные
                if(floor>=2&&floor<=6){
                    var stations=["Следующая: Никуда. Прибытие: никогда.","Станция Сожаление. Выход слева.","Внимание. Поезд задерживается на 200 лет.","Станция Башня-Центральная. Пересадка на страх."];
                    events.push("📢 Кондуктор объявляет: «"+stations[Math.floor(Math.random()*stations.length)]+"»");
                }
                if(floor>=5)events.push("ERNIE: «Тише. Тут стены слушают.»");
                if(floor>=7)events.push("Голос Смотрителя: «Субъект поднимается. Протокол 7.»");
                if(floor>=8)events.push("Кто-то написал твоё имя на стене. Свежее.");
                if(floor>=6)events.push({text:"НЕ СПУСКАЙСЯ В ПОДВАЛ.",demon:true});
                if(floor>=7)events.push({text:"Царапины на стене.\nСнизу.\nКак будто что-то\nлезло вверх.",demon:true});
                if(floor>=8)events.push({text:"Под 1 этажом — они.\nНе призраки.\nХуже.",demon:true});
                if(floor>=9)events.push({text:"Шёпот снизу.\nНе человеческий.\nНе призрачный.\nДругое.",demon:true});
                if(G.hasCat){
                    var catBreak=[
                        "🐱 Кошка роняет что-то со стены. Звон.",
                        "🐱 Кошка опрокинула вазу. Призрачную вазу.",
                        "🐱 Кошка сбросила книгу с полки. Нарочно.",
                        "🐱 Кошка разбила лампу. Темнее не стало. Тут и так темно.",
                        "🐱 Кошка уронила портрет. ERNIE: «Это был мой.»",
                        "🐱 Кошка бежит впереди. Ждёт наверху.",
                        "🐱 Кошка точит когти о перила. Перила призрачные. Ей всё равно."
                    ];
                    events.push(catBreak[Math.floor(Math.random()*catBreak.length)]);
                }
                if(G.playerName&&G.playerName!=="Странник")events.push("На стене мелом: «"+G.playerName+"». Свежее.");
                if(G.catName)events.push("Царапины на стене. Похоже на «"+G.catName+"». Кошачьи.");
                maybeErnieThought();findNote(floor);return events[Math.floor(Math.random()*events.length)];
            }
            var catJokes=["«Она со мной\nне разговаривает.\n200 лет.»","«Я ей оставлял молоко.\nПризрачное.\nОна посмотрела.\nРазвернулась. Ушла.»","«Но с тобой мурчит.\nЗа 5 минут.\nНенавижу кошек.»","«Это неправда.»","«Она однажды села\nмне на голову.\nЯ призрак.\nОна прошла сквозь.»","«Обидно.»","«Кошки видят\nпризраков.\nОна меня видит.\nИ игнорирует.\nВдвойне обидно.»","«Однажды принесла\nмне мёртвую мышь.\nПризрачную мышь.\nЭто был подарок.\nНаверное.\nИли угроза.»","«Я пытался\nеё погладить.\nРука прошла\nсквозь.\nОна посмотрела\nс таким презрением.»","«Она ест.\nПризрачную еду.\nОткуда?!\nЯ не понимаю.»"];
            var catJokeIdx=0;
            function invClick(type) {
                event.stopPropagation();
                event.preventDefault();
                $("bagOverlay").style.display="none";
                bagOpen=false;
                if(type==="cat"){
                    secretCatClick();
                    catReact("purr");
                    G.petCount=(G.petCount||0)+1;
                    if(G.petCount===10&&!G.uc._pet10){G.uc._pet10=true;setTimeout(function(){startD([{spk:"ERNIE",cls:"er",txt:"«Она тебя любит\nбольше чем меня.»"},{spk:"ERNIE",cls:"er",txt:"«За 200 лет\nя гладил её 847 раз.»"},{spk:"ERNIE",cls:"er",txt:"«Она ни разу\nне мурчала.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Ни. Разу.»"},{stage:true,txt:"Он молчит.\nНо ты чувствуешь —\nулыбается."}])},500)}
                    var joke=catJokes[catJokeIdx%catJokes.length];
                    catJokeIdx++;
                    var mc=ITEMS_META.cat;
                    if(mc&&mc.img&&I[mc.img]){
                        $("itemPopImg").src=I[mc.img];
                        $("itemPopName").textContent=G.catName?G.catName.toUpperCase():"КОШКА";
                        $("itemPopDesc").textContent=joke.replace(/«|»/g,"").replace(/\n/g," ");
                        $("itemPopup").classList.add("show");vibrate(30);
                    } else {
                        notify("🐱 "+joke.replace(/«|»|\n/g," ").substring(0,40)+"...","gold");
                    }
                    return;
                }
                var m=ITEMS_META[type];
                if(m&&m.img&&I[m.img]){
                    showItemPop(type);
                } else if(m){
                    notify((m.emoji||"📦")+" "+m.name+": "+m.desc,"gold");
                }
            }
            var riddleTimer=null;
            function showRiddle(q,opts,correctIdx,reward,penalty,cb){
                $("gCh").style.display="none";$("gBar").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";
                var w=$("riddleW");w.style.display="flex";
                var h='<div class="riddle-q">'+q+'</div><div class="riddle-timer"><div class="riddle-bar" id="rBar"></div></div><div class="riddle-opts">';
                opts.forEach(function(o,i){h+='<button class="riddle-btn" data-ri="'+i+'" onclick="riddleAns('+i+','+correctIdx+')">'+o+'</button>'});
                h+='</div>';w.innerHTML=h;
                var timeLeft=10000,started=Date.now();
                if(riddleTimer)clearInterval(riddleTimer);
                riddleTimer=setInterval(function(){
                    var elapsed=Date.now()-started;var pct=Math.max(0,(timeLeft-elapsed)/timeLeft*100);
                    var bar=$("rBar");if(bar){bar.style.width=pct+"%";if(pct<30)bar.className="riddle-bar danger"}
                    if(elapsed>=timeLeft){clearInterval(riddleTimer);riddleTimer=null;riddleTimeout(correctIdx,penalty,cb)}
                },50);
                w._correct=correctIdx;w._reward=reward;w._penalty=penalty;w._cb=cb
            }
            function riddleAns(picked,correct){
                if(riddleTimer){clearInterval(riddleTimer);riddleTimer=null}
                var btns=$("riddleW").querySelectorAll(".riddle-btn");
                btns.forEach(function(b){b.onclick=null;b.disabled=true;b.style.pointerEvents="none";var i=parseInt(b.getAttribute("data-ri"));if(i===correct)b.classList.add("correct");else if(i===picked)b.classList.add("wrong")});
                var w=$("riddleW");
                if(picked===correct){
                    if(w._reward)w._reward();
                    setTimeout(function(){w.style.display="none";if(w._cb)w._cb(true)},1200)
                }else{
                    if(w._penalty)w._penalty();
                    setTimeout(function(){w.style.display="none";if(w._cb)w._cb(false)},1200)
                }
            }
            function riddleTimeout(correct,penalty,cb){
                var btns=$("riddleW").querySelectorAll(".riddle-btn");
                btns.forEach(function(b){b.onclick=null;b.disabled=true;b.style.pointerEvents="none";var i=parseInt(b.getAttribute("data-ri"));if(i===correct)b.classList.add("correct");else b.classList.add("wrong")});
                if(penalty)penalty();
                setTimeout(function(){$("riddleW").style.display="none";if(cb)cb(false)},1200)
            }
            // === СЕКРЕТНЫЕ ТРИГГЕРЫ ===
            var afkTimer=null;var afkCount=0;var catClickCount=0;
            function resetAfk(){
                if(afkTimer)clearTimeout(afkTimer);
                afkTimer=setTimeout(function(){
                    afkCount++;
                    if(afkCount===1)notify("ERNIE: «Ты ещё тут?»","gold");
                    else if(afkCount===2){notify("ERNIE: «...Хорошо.»","gold");setTimeout(function(){notify("ERNIE: «Я просто проверял.»","gold")},3000)}
                    else if(afkCount===3)notify("ERNIE: «Я никуда не денусь. Куда мне деться. Я призрак.»","gold");
                    else if(afkCount>=4&&Math.random()<0.3)notify("🐱 Кошка смотрит на тебя с осуждением.","gold");
                },30000);
            }
            document.addEventListener("click",resetAfk);
            document.addEventListener("touchstart",resetAfk);
            // Тройной клик кошки
            function secretCatClick(){
                catClickCount++;
                if(catClickCount===3){notify("🐱 Мррр... МРР... МРРРР!!!","gold");catClickCount=0;G.karma+=1;updH()}
                else if(catClickCount===5){notify("ERNIE: «Хватит тыкать в кошку.»","gold");catClickCount=0}
                else if(catClickCount===10){notify("🐱 Кошка укусила палец. Справедливо.","gold");catClickCount=0}
                setTimeout(function(){catClickCount=0},2000);
            }
            function startAw() {
                iA();stopRain();
                setTimeout(function(){var bg=document.querySelector(".aw-bg");if(bg)bg.classList.add("on")},500);
                var mWrap=$("messengerWrap");
                var mChat=$("messengerChat");
                var mType=$("mTyping");
                var mTap=$("mTapZone");
                var mStat=$("mStatus");
                // Возврат после закрытия ради ERNIE
                if(TM.closedForErnie){
                    TM.closedForErnie=false;saveTM();
                    setTimeout(function(){mWrap.style.opacity="1"},800);
                    mStat.textContent="ждал тебя";mStat.classList.add("online");
                    var retMsgs=[
                        {txt:"Ты вернулся.",delay:1500},
                        {txt:"Ты закрыл. Ради меня.",delay:2500},
                        {txt:"847 человек.",delay:2000},
                        {txt:"Никто не закрывал.",delay:2000},
                        {txt:"Спасибо.",delay:3000}
                    ];
                    mIntroSequence(retMsgs,mChat,mType,function(){
                        mShowTap(mTap,"ОТКРЫТЬ ДВЕРЬ",function(){
                            sB();fadeIn(function(){goS("s2");startQuickPrologue()})
                        });
                    });
                    return;
                }
                // Возврат — ERNIE помнит
                if(TM.runs>1 && TM.playerName){
                    setTimeout(function(){mWrap.style.opacity="1"},800);
                    mStat.textContent="в сети";mStat.classList.add("online");
                    var retMsgs2=[
                        {txt:"Опять ты.",delay:1500},
                        {txt:"Значит первый раз не ответил на что-то важное.",delay:3000}
                    ];
                    mIntroSequence(retMsgs2,mChat,mType,function(){
                        mShowTap(mTap,"ВОЙТИ СНОВА",function(){
                            sB();fadeIn(function(){goS("s2");startQuickPrologue()})
                        });
                    });
                    return;
                }
                // ========== ПЕРВЫЙ ЗАПУСК — ГЛАВНОЕ ИНТРО ==========
                // Фаза 0: Тишина. Чёрный экран. 2 секунды.
                setTimeout(function(){
                    mWrap.style.opacity="1";
                    // Фаза 1: Статус меняется — он онлайн
                    setTimeout(function(){
                        mStat.textContent="в сети";mStat.classList.add("online");vibrate(10);
                    },1200);
                    // Фаза 2: Messenger sequence
                    var msgs=[
                        {txt:"Наконец.",delay:2200},
                        {txt:"Я ждал.",delay:1800},
                        {txt:"847 до тебя.",delay:2200},
                        {txt:"Ни один не вышел из",del:true,delay:2800},
                        {txt:"Неважно.",delay:2000},
                        {txt:"Ты здесь. Этого достаточно.",delay:2500}
                    ];
                    setTimeout(function(){
                        mIntroSequence(msgs,mChat,mType,function(){
                            // Фаза 3: Экран трескается
                            setTimeout(function(){
                                mScreenCrack();vibrate(60);
                                if(typeof sDanger==="function")sDanger();
                                // Фаза 4: Последнее сообщение + кнопка
                                setTimeout(function(){
                                    mAddBubble(mChat,"Дверь открыта.",true);
                                    setTimeout(function(){
                                        mShowTap(mTap,"ВОЙТИ",function(){
                                            sB();
                                            fadeIn(function(){goS("s2");startQuickName()})
                                        });
                                    },800);
                                },1200);
                            },800);
                        });
                    },2000);
                },1500);
            }
            // === MESSENGER INTRO HELPERS ===
            function mAddBubble(chat,text,isGold){
                var b=document.createElement("div");
                b.className="mBubble ernie";
                if(isGold)b.style.borderColor="rgba(200,168,72,.25)";
                b.textContent=text;
                // CHANGE 9: 847 timestamp
                var ts=document.createElement("div");
                ts.className="mTime";ts.textContent="8:47";
                b.appendChild(ts);
                chat.appendChild(b);
                setTimeout(function(){b.classList.add("vis")},50);
                return b;
            }
            function mIntroSequence(msgs,chat,typeEl,done){
                var i=0;
                function next(){
                    if(i>=msgs.length){if(done)done();return}
                    var m=msgs[i];
                    // Показываем typing
                    typeEl.classList.add("vis");
                    var typeTime=800+Math.random()*600;
                    if(m.del)typeTime=1200;
                    setTimeout(function(){
                        typeEl.classList.remove("vis");
                        var bubble=mAddBubble(chat,m.txt);
                        if(m.del){
                            // ERNIE удаляет сообщение
                            setTimeout(function(){
                                bubble.classList.remove("vis");
                                bubble.classList.add("del");
                                setTimeout(function(){bubble.remove()},400);
                                i++;
                                setTimeout(next,600);
                            },1500);
                        }else{
                            if(i===0)vibrate(15);
                            i++;
                            setTimeout(next,m.delay||2000);
                        }
                    },typeTime);
                }
                next();
            }
            function mShowTap(tapZone,text,fn){
                tapZone.innerHTML="";
                var btn=document.createElement("button");
                btn.textContent=text;
                btn.onclick=function(){iA();sTap();vibrate(20);fn()};
                tapZone.appendChild(btn);
                tapZone.style.opacity="1";
                awReady=true;
            }
            function mScreenCrack(){
                var c=document.createElement("div");
                c.className="mCrack";
                c.innerHTML='<svg viewBox="0 0 400 800"><path d="M200 0 L195 120 L180 160 L210 220 L185 300 L215 380 L190 460 L220 520 L195 600 L210 700 L200 800" fill="none" stroke="rgba(200,168,72,.3)" stroke-width="1.5"/><path d="M195 120 L140 200 L120 240" fill="none" stroke="rgba(200,168,72,.2)" stroke-width="1"/><path d="M210 220 L260 280 L280 300" fill="none" stroke="rgba(200,168,72,.15)" stroke-width="1"/><path d="M185 300 L130 360" fill="none" stroke="rgba(200,168,72,.12)" stroke-width="1"/><path d="M215 380 L270 420 L290 450" fill="none" stroke="rgba(200,168,72,.1)" stroke-width="1"/></svg>';
                document.body.appendChild(c);
                screenShake();
                setTimeout(function(){c.classList.add("vis")},50);
                // Трещина остаётся на 15 секунд потом уходит
                setTimeout(function(){c.style.transition="opacity 3s";c.style.opacity="0";setTimeout(function(){c.remove()},3500)},15000);
            }
            // === QUICK NAME (заменяет медленный askName) ===
            function startQuickName(){
                $("door").style.display="none";$("doorHint").style.display="none";
                var w=document.createElement("div");
                w.style.cssText="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;z-index:5;background:#000";
                w.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:10px;color:var(--gold);letter-spacing:3px;margin-bottom:16px;opacity:0" id="qnLabel">ERNIE</div><div style="font-family:Raleway,sans-serif;font-size:15px;color:var(--txt);font-style:italic;line-height:1.8;margin-bottom:24px;opacity:0;max-width:260px" id="qnAsk">«Как тебя зовут?<br>Настоящее имя.<br>Ложь я почувствую.»</div><div style="opacity:0" id="qnInput"><input id="qnName" type="text" maxlength="16" placeholder="имя" style="background:var(--bg3);border:1px solid rgba(90,127,160,.15);color:var(--txt);font-size:18px;padding:10px 16px;border-radius:4px;text-align:center;width:180px;font-family:inherit;outline:none"><br><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button id="qnGo" style="padding:10px 24px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:11px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px;cursor:pointer">ВОЙТИ</button><button id="qnSkip" style="padding:10px 24px;background:transparent;border:1px solid rgba(90,127,160,.08);color:var(--txtd);font-size:11px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:1px;cursor:pointer">молчать</button></div></div>';
                $("s2").appendChild(w);
                G._qnWrap=w;
                // Анимация появления — быстро
                setTimeout(function(){$("qnLabel").style.transition="opacity .8s";$("qnLabel").style.opacity="1"},300);
                setTimeout(function(){$("qnAsk").style.transition="opacity .8s";$("qnAsk").style.opacity="1"},800);
                setTimeout(function(){$("qnInput").style.transition="opacity .8s";$("qnInput").style.opacity="1";$("qnName").focus()},1500);
                // Кнопки
                $("qnGo").onclick=function(){
                    var n=$("qnName").value.trim();
                    if(!n)return;
                    G.playerName=n;
                    qnReact(w,n,true);
                };
                $("qnSkip").onclick=function(){
                    G.playerName="Гость";
                    qnReact(w,"Гость",false);
                };
                $("qnName").addEventListener("keydown",function(e){
                    if(e.key==="Enter"){var n=$("qnName").value.trim();if(n){G.playerName=n;qnReact(w,n,true)}}
                });
                // Если молчит 15 секунд — ERNIE реагирует
                G._qnTimer=setTimeout(function(){
                    var hint=document.createElement("div");
                    hint.style.cssText="font-family:Raleway,sans-serif;font-size:12px;color:var(--gold);font-style:italic;opacity:0;transition:opacity 1s;margin-top:16px";
                    hint.textContent="«Можешь молчать. Я привык.»";
                    $("qnInput").appendChild(hint);
                    setTimeout(function(){hint.style.opacity="1"},100);
                },15000);
            }
            function qnReact(wrap,name,named){
                clearTimeout(G._qnTimer);
                wrap.style.transition="opacity .8s";wrap.style.opacity="0";
                var resp=document.createElement("div");
                resp.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:6;opacity:0;transition:opacity 1s;max-width:280px";
                if(named){
                    resp.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:10px;color:var(--gold);letter-spacing:2px;margin-bottom:12px">ERNIE</div><div style="font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);font-style:italic;line-height:1.8">«'+name+'.»</div><div style="font-family:Raleway,sans-serif;font-size:13px;color:var(--txtd);font-style:italic;line-height:1.8;margin-top:8px">Пауза.</div><div style="font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);font-style:italic;line-height:1.8;margin-top:8px">«Красивое. Жаль.»</div>';
                }else{
                    resp.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:10px;color:var(--gold);letter-spacing:2px;margin-bottom:12px">ERNIE</div><div style="font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);font-style:italic;line-height:1.8">«Ладно. Буду звать тебя 848-й.»</div>';
                    G.playerName="848-й";
                }
                $("s2").appendChild(resp);
                setTimeout(function(){resp.style.opacity="1"},900);
                // Быстро дальше
                setTimeout(function(){
                    resp.style.opacity="0";
                    setTimeout(function(){
                        resp.remove();if(wrap.parentNode)wrap.remove();
                        startQuickPrologue();
                    },800);
                },named?3500:2500);
            }
            // === БЫСТРЫЙ ПРОЛОГ (заменяет длинный startPrologue) ===
            function startQuickPrologue(){
                $("door").style.display="none";$("doorHint").style.display="none";
                var pw=document.querySelectorAll("#s2 > div:not(#door):not(#doorHint)");
                pw.forEach(function(el){el.remove()});
                var p=document.createElement("div");
                p.style.cssText="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;z-index:5;background:url('"+I.prologue_door+"') center/cover";
                var ov=document.createElement("div");ov.style.cssText="position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.95) 0%,rgba(0,0,0,.6) 8%,rgba(0,0,0,.6) 100%)";p.appendChild(ov);
                $("s2").appendChild(p);
                startRain();
                // Одна строка. Быстро.
                var txt=document.createElement("div");
                txt.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:16px;color:#fff;line-height:2;font-style:italic;opacity:0;transition:opacity 1.2s;text-shadow:0 0 20px #000";
                txt.textContent="Дверь. Тёплая.";
                p.appendChild(txt);
                setTimeout(function(){txt.style.opacity="1"},300);
                setTimeout(function(){
                    txt.style.opacity="0";
                    setTimeout(function(){
                        txt.textContent="Ты входишь.";
                        txt.style.opacity="1";
                        sCreak();sFootstep();vibrate(30);
                    },600);
                },2000);
                // Дверь хлопает
                setTimeout(function(){
                    vibrate(60);sDanger();screenShake();
                    var slam=document.createElement("div");
                    slam.style.cssText="position:fixed;inset:0;background:#fff;z-index:9999;opacity:.15;transition:opacity .3s";
                    document.body.appendChild(slam);
                    setTimeout(function(){slam.style.opacity="0";setTimeout(function(){slam.remove()},400)},50);
                    stopRain();
                },4200);
                // Переход в город
                setTimeout(function(){
                    p.style.transition="opacity 1s";p.style.opacity="0";
                    setTimeout(function(){
                        p.remove();
                        goS("sg");showErnieBond();startCity();
                    },1000);
                },5500);
            }
            function showTw(){
                $("twImg").src=I.tower_inside;sP();
                tw($("twT"),"Видишь свет наверху?\nЭто выход.\nДалеко.",30,function(){
                    $("twTap").style.display="block";
                    $("s1").onclick=function(){$("s1").onclick=null;fadeIn(function(){goS("s2");startPrologue()})}
                })
            }
            function askName(){
                var door=$("door");
                door.style.display="none";
                $("doorHint").style.display="none";
                var wrap=document.createElement("div");
                wrap.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:5";
                wrap.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:10px;letter-spacing:3px;color:var(--txtd);margin-bottom:20px">ERNIE СПРАШИВАЕТ:</div><div style="font-family:Raleway,sans-serif;font-size:16px;color:var(--txt);font-style:italic;margin-bottom:24px;line-height:1.6">«Как тебя зовут?\nНастоящее имя.\nЛожь тут не работает.»</div><input id="playerNameIn" type="text" maxlength="16" placeholder="имя" style="background:var(--bg3);border:1px solid rgba(90,127,160,.15);color:var(--txt);font-size:18px;padding:10px 16px;border-radius:4px;text-align:center;width:180px;font-family:inherit;outline:none"><br><button id="nameBtn" style="margin-top:14px;padding:10px 24px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:12px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px;opacity:0;transition:opacity .5s" onclick="submitName()">войти</button>';
                $("s2").appendChild(wrap);
                G._nameWrap=wrap;
                setTimeout(function(){$("nameBtn").style.opacity="1"},500);
                $("playerNameIn").focus();
            }
            function submitName(){
                var n=$("playerNameIn").value.trim();
                if(!n)return;
                G.playerName=n;
                if(G._nameWrap){G._nameWrap.remove();G._nameWrap=null}
                // ERNIE спрашивает — настоящее ли имя?
                var q=document.createElement("div");
                q.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:5;opacity:0;transition:opacity 1s";
                q.innerHTML='<div style="font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);font-style:italic;line-height:1.8;margin-bottom:20px">«Подожди.\n'+n+' — это твоё\nнастоящее имя?»</div><div style="display:flex;gap:12px;justify-content:center"><button class="g-cb" onclick="nameTrue(true)" style="padding:8px 24px">Да</button><button class="g-cb" onclick="nameTrue(false)" style="padding:8px 24px">Нет</button></div>';
                $("s2").appendChild(q);
                G._nameQ=q;
                setTimeout(function(){q.style.opacity="1"},100);
            }
            function nameTrue(real){
                var q=G._nameQ;if(q)q.remove();
                var r=document.createElement("div");
                r.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:5;opacity:0;transition:opacity 1s;max-width:280px";
                var txt;
                if(real){
                    G.uc.realName=true;
                    txt="«Хорошо.\n847 человек до тебя —\nникто не говорил правду\nс первого вопроса.»";
                }else{
                    txt="«Понимаю.\nЯ тоже иногда\nзабываю своё.»";
                }
                r.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:10px;color:var(--gold);letter-spacing:2px;margin-bottom:12px">ERNIE</div><div style="font-family:Raleway,sans-serif;font-size:14px;color:var(--txt);font-style:italic;line-height:1.8">'+txt+'</div>';
                $("s2").appendChild(r);
                setTimeout(function(){r.style.opacity="1"},100);
                setTimeout(function(){
                    r.style.opacity="0";
                    setTimeout(function(){r.remove();startPrologue()},1500);
                },4000);
            }
            function startPrologue(){
                $("door").style.display="none";
                $("doorHint").style.display="none";
                // Показываем пролог прямо в s2
                var p=document.createElement("div");
                p.id="prologWrap";
                p.style.cssText="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;z-index:5;background:url('"+I.prologue_door+"') center/cover";
                $("s2").appendChild(p);
                // Затемнение поверх картинки
                var pOv=document.createElement("div");pOv.style.cssText="position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.95) 0%,rgba(0,0,0,.55) 8%,rgba(0,0,0,.55) 100%);z-index:0";p.appendChild(pOv);
                startRain();
                var lines=[
                    {txt:"Дождь. Ночь.",pause:600},
                    {txt:"Дверь.\nТёплая на ощупь.",pause:800},
                    {txt:"За ней — голос.",pause:800}
                ];
                var idx=0;
                var txtEl=document.createElement("div");
                txtEl.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:15px;color:#fff;line-height:2;font-style:italic;opacity:0;transition:opacity 1s;white-space:pre-line;max-width:280px;text-shadow:0 0 10px #000,0 0 20px #000";
                p.appendChild(txtEl);
                function showLine(){
                    if(idx>=lines.length){showPrologChoice(p);return}
                    txtEl.style.opacity="0";
                    setTimeout(function(){
                        txtEl.textContent=lines[idx].txt;
                        txtEl.style.opacity="1";
                        idx++;
                        setTimeout(showLine,lines[idx-1].pause+1500);
                    },500);
                }
                setTimeout(showLine,800);
            }
            function showPrologChoice(wrap){
                var ch=document.createElement("div");
                ch.style.cssText="position:relative;z-index:1;margin-top:24px;display:flex;flex-direction:column;gap:10px;opacity:0;transition:opacity 1s";
                var btns=[
                    {txt:"Войти",fn:function(){prologEnter(wrap)}},
                    {txt:"Заглянуть",fn:function(){prologPeek(wrap,ch)}},
                    {txt:"Уйти",fn:function(){prologLeave(wrap)}}
                ];
                btns.forEach(function(b){
                    var btn=document.createElement("button");
                    btn.textContent="▸ "+b.txt;
                    btn.style.cssText="padding:10px 28px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:12px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px;cursor:pointer";
                    btn.onclick=function(){sTap();vibrate(10);b.fn()};
                    ch.appendChild(btn);
                });
                wrap.appendChild(ch);
                setTimeout(function(){ch.style.opacity="1"},100);
            }
            function prologPeek(wrap,chEl){
                wrap.style.background="url('"+I.prologue_peek+"') center/cover";chEl.remove();
                var txt=document.createElement("div");
                txt.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:14px;color:#fff;line-height:2;font-style:italic;opacity:0;transition:opacity 1s;white-space:pre-line;max-width:280px;margin-top:20px;text-shadow:0 0 10px #000,0 0 20px #000";
                txt.textContent="Прижимаешь глаз\nк щели.\n\nТёмный коридор.\nСвечи.\nДалеко — тень.\n\nТень поворачивается.\n\nСмотрит.";
                wrap.appendChild(txt);
                setTimeout(function(){txt.style.opacity="1"},100);
                setTimeout(function(){
                    var t2=document.createElement("div");
                    t2.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:13px;color:var(--gold);font-style:italic;opacity:0;transition:opacity 1s;margin-top:16px;text-shadow:0 0 10px #000";
                    t2.textContent="«Я тебя вижу.\nМожешь войти.»";
                    wrap.appendChild(t2);
                    setTimeout(function(){t2.style.opacity="1"},100);
                    setTimeout(function(){
                        var btn=document.createElement("button");
                        btn.textContent="▸ Войти";
                        btn.style.cssText="position:relative;z-index:1;margin-top:16px;padding:10px 28px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:12px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px;cursor:pointer;opacity:0;transition:opacity 1s";
                        btn.onclick=function(){sS();prologEnter(wrap)};
                        wrap.appendChild(btn);
                        setTimeout(function(){btn.style.opacity="1"},100);
                    },2000);
                },3000);
            }
            function prologLeave(wrap){
                wrap.style.background="url('"+I.prologue_street+"') center/cover";wrap.innerHTML="";
                var ov2=document.createElement("div");ov2.style.cssText="position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.95) 0%,rgba(0,0,0,.5) 8%,rgba(0,0,0,.5) 100%);z-index:0";wrap.appendChild(ov2);
                var txt=document.createElement("div");
                txt.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:14px;color:#fff;line-height:2;font-style:italic;opacity:0;transition:opacity 1s;white-space:pre-line;max-width:280px;text-shadow:0 0 10px #000,0 0 20px #000";
                txt.textContent="Разворачиваешься.\nТри шага.\nЧетыре. Пять.";
                wrap.appendChild(txt);
                setTimeout(function(){txt.style.opacity="1"},100);
                setTimeout(function(){
                    var t2=document.createElement("div");
                    t2.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:13px;color:#aaa;font-style:italic;opacity:0;transition:opacity 1s;margin-top:20px;white-space:pre-line;text-shadow:0 0 10px #000";
                    t2.textContent="Некуда идти.";
                    wrap.appendChild(t2);
                    setTimeout(function(){t2.style.opacity="1"},100);
                    setTimeout(function(){
                        var t3=document.createElement("div");
                        t3.style.cssText="position:relative;z-index:1;font-family:Raleway,sans-serif;font-size:13px;color:var(--gold);font-style:italic;opacity:0;transition:opacity 1s;margin-top:16px;text-shadow:0 0 10px #000";
                        t3.textContent="Дверь за спиной.\nВсё ещё открыта.";
                        wrap.appendChild(t3);
                        setTimeout(function(){t3.style.opacity="1"},100);
                        setTimeout(function(){
                            var btn=document.createElement("button");
                            btn.textContent="▸ ...Войти";
                            btn.style.cssText="position:relative;z-index:1;margin-top:16px;padding:10px 28px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:12px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px;cursor:pointer;opacity:0;transition:opacity 1s";
                            btn.onclick=function(){sS();G.uc.triedToLeave=true;prologEnter(wrap)};
                            wrap.appendChild(btn);
                            setTimeout(function(){btn.style.opacity="1"},100);
                        },2000);
                    },3000);
                },3500);
            }
            function prologEnter(wrap){
                wrap.style.transition="opacity 1.5s";
                wrap.style.opacity="0";
                stopRain();
                sCreak();sFootstep();vibrate(30);
                // Дверь закрывается за спиной
                setTimeout(function(){
                    vibrate(60);sDanger();screenShake();screenCrack(window.innerWidth/2,window.innerHeight/2);
                    var slam=document.createElement("div");
                    slam.style.cssText="position:fixed;inset:0;background:#fff;z-index:9999;opacity:.15;transition:opacity .3s";
                    document.body.appendChild(slam);
                    setTimeout(function(){slam.style.opacity="0";setTimeout(function(){slam.remove()},400)},50);
                },800);
                setTimeout(function(){
                    wrap.remove();
                    $("door").style.display="block";
                    showDoor();
                },1800);
            }
            function showDoor() {
                sB(); var d = $("door");
                setTimeout(function() { d.classList.add("glow"); $("doorHint").style.display = "block" }, 500);
                d.onclick = function() { d.onclick = null; sFootstep(); sCreak(); $("doorHint").style.display = "none"; d.classList.add("open"); tone(440, .8, "sine", .06);
                    // Лицо мальчика мелькает
                    
                    setTimeout(function() { $("doorLbl").style.opacity = "1" }, 600);
                    setTimeout(function() { fadeIn(function() { goS("sg");showErnieBond();startCity() }) }, 1500) }
            }
            function showEpigraph(){
                goS("sg");
                sI("");
                setFx(null);
                $("gImgW").style.display="none";
                $("gNav").style.display="none";
                $("gTap").style.display="none";
                $("gCh").style.display="none";
                $("gBar").style.display="none";
                $("gTop").style.display="none";
                $("gBotW").style.display="none";
                $("gFl").style.display="none";
                document.querySelector('.g-hud').style.display='none';
                $("sg").style.background="#000";
                var ep=document.createElement("div");
                ep.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:5;width:85%;max-width:340px";
                ep.innerHTML='<div style="font-family:Raleway,sans-serif;font-size:15px;color:rgba(230,225,210,.85);line-height:2.2;font-style:italic;opacity:0;transition:opacity 2s" id="epTxt">Каждый, кто вошёл —<br>хотел выйти.<br><br>Каждый, кто вышел —<br>хотел вернуться.</div><div style="font-family:JetBrains Mono,monospace;font-size:9px;color:rgba(230,225,210,.25);letter-spacing:2px;margin-top:32px;opacity:0;transition:opacity 2s 1s" id="epSrc">— Надпись на стене. Автор стёрт.</div>';
                $("sg").appendChild(ep);
                setTimeout(function(){$("epTxt").style.opacity="1";$("epSrc").style.opacity="1"},300);
                setTimeout(function(){
                    $("epTxt").style.opacity="0";
                    $("epSrc").style.opacity="0";
                    setTimeout(function(){
                        ep.remove();
                        $("sg").style.background="";
                        $("gImgW").style.display="block";
                        $("gFl").style.display="";
                        document.querySelector('.g-hud').style.display='';
                        showErnieBond();
                        fadeIn(function(){startCity()});
                    },2500);
                },6000);
            }
            function startCity() {
                setFx("flicker"); startMusic("city"); startRain();
                sI(I.city); sF("ЭТАЖ 1 · ГОРОД ЭХО");
                // CHANGE 8: Time awareness
                var timeLines=[];
                var tc=getTimeComment();
                var rc=getReturnComment();
                if(rc&&TM.runs>1){timeLines.push({pause:2,spk:"ERNIE",cls:"er",txt:rc,spd:40})}
                if(tc&&TM.runs<=1){timeLines.push({pause:2,spk:"ERNIE",cls:"er",txt:tc,spd:40})}
                var memLines = [];
                if(TM.runs>1 && TM.deaths>0) {
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«...Ты кажешься знакомым.»"});
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«Нет. Показалось.»"});
                }
                if(TM.runs>2) {
                    memLines = [{spk:"ERNIE",cls:"er",txt:"«Опять ты.»"},{spk:"ERNIE",cls:"er",txt:"«Башня помнит.\nЯ — нет.\nНо что-то... не так.»"}];
                }
                // Roguelite: 5+ смертей — скрытый диалог
                if(TM.deaths>=5) {
                    memLines.push({pause:3,stage:true,txt:""});
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«Ты умирал.\nМного раз.»"});
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«Башня считает.\nОна думает,\nты сломаешься.»"});
                    memLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Но ты здесь.»"});
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«Знаешь что?\nВозьми это.»"});
                    memLines.push({stage:true,txt:"ERNIE протягивает\nчто-то невидимое."});
                    memLines.push({stage:true,txt:"Ощущение тепла\nв ладони."});
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«Не предмет.\nПросто... удача.\nНаверное.»"});
                }
                // Roguelite: 3+ прохождений — призрак игрока
                if(TM.runs>=3&&TM.playerName) {
                    memLines.push({pause:2,stage:true,txt:"У стены стоит\nполупрозрачная фигура."});
                    memLines.push({stage:true,txt:"Знакомая.\nТвоя."});
                    memLines.push({narr:true,txt:"«"+TM.playerName+".\nПрохождение "+(TM.runs-1)+".\nЯ не дошёл.»"});
                    memLines.push({stage:true,txt:"Фигура рассеивается."});
                    memLines.push({spk:"ERNIE",cls:"er",txt:"«...Это был ты.\nИз прошлого раза.»"});
                }
                startD(timeLines.concat(memLines).concat([
                    {stage:true,txt:"Фонари без электричества.\nСветят."},
                    {spk:"ERNIE",cls:"er",txt:"«~~Я рад, что ты пришёл~~»",del:true},
                    {spk:"ERNIE",cls:"er",txt:"«Город Эхо.\nДобро пожаловать.»",spd:35}
                ]), function() {
                    // Кошка сразу — первое живое существо
                    showCatIntro();
                })
            }

            function cityTrust(trust){
                if(trust){
                    G.trust+=2;G.karma+=2;updH();
                    startD([{pause:4,spk:"ERNIE",cls:"er",txt:"«...»",spd:80},{pause:3,spk:"ERNIE",cls:"er",txt:"«Зря.»",spd:60}],function(){showLocs()})
                }else{
                    G.uc.saidNoTrust=true;G.trust-=1;updH();
                    startD([{pause:4,spk:"ERNIE",cls:"er",txt:"«...»",spd:80},{pause:3,spk:"ERNIE",cls:"er",txt:"«Правильно.»",spd:60}],function(){showLocs()})
                }
            }
            function citySilent(){G._silentChoices=(G._silentChoices||0)+1;checkSilentPath();
                startD([{pause:5,stage:true,txt:"Тишина."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Понял.»",spd:60}],function(){G.trust-=2;addDread(10);updH();showLocs()})
            }
            
            
            
            function ernieGlitch(txt){
                if(G.currentFloor>=7 && G.currentFloor<=8 && Math.random()<0.3){
                    var words=txt.split(" ");
                    var cut=Math.floor(words.length*0.6);
                    return words.slice(0,cut).join(" ")+"...";
                }
                return txt;
            }

            
            // ═══ REAL SOUND ASSETS (replace URLs with actual mp3s from freesound.org) ═══
            // When ready, uncomment and add URLs:
            // var SOUNDS={
            //   rain: "rain.mp3",
            //   door_creak: "door_creak.mp3",  
            //   footstep_stone: "footstep.mp3",
            //   cat_purr: "cat_purr.mp3",
            //   cup_clink: "cup_clink.mp3",
            //   train_hum: "train.mp3",
            //   echo_hall: "echo.mp3",
            //   heartbeat: "heartbeat.mp3",
            //   wind: "wind.mp3",
            //   piano_ambient: "piano.mp3"
            // };
            // function playReal(key,loop){
            //   if(!SETT.sfx)return;
            //   var a=new Audio(SOUNDS[key]);
            //   a.volume=0.3;a.loop=!!loop;a.play().catch(function(){});
            //   return a;
            // }

            
            // ═══ MUSIC TRACKS (replace with Suno/Udio generated tracks) ═══
            // var MUSIC_TRACKS={
            //   cafe: "cafe_piano.mp3",      // Тихое фортепиано
            //   maze: "maze_tension.mp3",     // Напряжённый эмбиент
            //   finale: "finale_emotional.mp3",// Эмоциональный финал
            //   garden: "garden_calm.mp3"     // Спокойный сад
            // };

            
            // ═══ IMAGE STYLE GUIDE ═══
            // Master prompt for ALL new images:
            // "dark atmospheric digital illustration, detailed ink linework,
            //  muted teal-green and navy palette with warm amber-gold accents,
            //  dust particles, fog, cinematic lighting, concept art, 16:9"
            //
            // Priority images to regenerate:
            // 1. NPC portraits (Barista, Lika, Conductor, Actor, Trumpeter)
            // 2. Key locations (cafe, station, library, theater, garden, maze)
            // 3. Salvation moments (5 images)
            // 4. Ending scenes (door_out, sunrise, tower_crumble, ernie_free)

            // === PARTICLE SYSTEM ===
            var _particleBox=null;
            function initParticles(){
                if(_particleBox)_particleBox.remove();
                _particleBox=document.createElement("div");
                _particleBox.className="particles-container";
                document.body.appendChild(_particleBox);
            }
            function spawnParticle(type){
                if(!_particleBox)initParticles();
                var p=document.createElement("div");
                p.className="particle particle-"+type;
                p.style.left=Math.random()*100+"%";
                p.style.animationDuration=(8+Math.random()*12)+"s";
                p.style.animationDelay=Math.random()*5+"s";
                _particleBox.appendChild(p);
                setTimeout(function(){p.remove()},25000);
            }
            var _particleInterval=null;
            function setParticles(type){
                if(_particleInterval)clearInterval(_particleInterval);
                if(!type){if(_particleBox)_particleBox.innerHTML="";return}
                _particleInterval=setInterval(function(){
                    if(_particleBox&&_particleBox.children.length<15)spawnParticle(type);
                },1200);
            }

            
            function screenShake(){document.body.classList.add("screen-shake");setTimeout(function(){document.body.classList.remove("screen-shake")},400)}

            function updateProgressBar(){
                var p=$("progressLine");
                if(p){var pct=Math.min(100,((G.currentFloor||1)/10)*100);p.style.width=pct+"%"}
            }

            function showSalvation(name,text){
                var el=document.createElement("div");
                el.style.cssText="position:fixed;top:20%;left:50%;transform:translateX(-50%) scale(.8);z-index:999;text-align:center;opacity:0;transition:all 1.5s cubic-bezier(.4,0,.2,1);pointer-events:none";
                el.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:8px;letter-spacing:4px;color:rgba(200,168,72,.5);margin-bottom:12px">✦ ДУША СВОБОДНА ✦</div><div style="font-family:Raleway,sans-serif;font-size:15px;color:rgba(200,168,72,.8);font-weight:300;margin-bottom:8px">'+name+'</div><div style="font-family:Raleway,sans-serif;font-size:11px;color:rgba(200,168,72,.4);font-style:italic;max-width:200px;line-height:1.6">'+text+'</div>';
                document.body.appendChild(el);
                setTimeout(function(){el.style.opacity="1";el.style.transform="translateX(-50%) scale(1)"},50);
                setTimeout(function(){el.style.opacity="0";el.style.transform="translateX(-50%) translateY(-30px) scale(1.1)"},4000);
                setTimeout(function(){el.remove()},6000);
                sFree();setParticles("ember");vibrateFree();
            }

            function sCoffee(){if(!AC||!SETT.sfx)return;
                // Bubbling coffee sound
                for(var i=0;i<5;i++){setTimeout(function(){tone(200+Math.random()*100,.05,"sine",.02)},i*200)}
            }

            // Cat leaves if not interacted with for 5 minutes
            var _catLastInteract=Date.now();
            var _catLeftAlone=false;
            function updateCatInteract(){_catLastInteract=Date.now();_catLeftAlone=false}
            function checkCatAlone(){
                if(!G.hasCat||_catLeftAlone||G.currentFloor>=9)return;
                // Don't interrupt if choices or locations are showing
                var ch=$("gCh");if(ch&&ch.innerHTML&&ch.style.display!=="none")return;
                if(Date.now()-_catLastInteract>300000){// 5 min
                    _catLeftAlone=true;
                    notify("🐱 "+(G.catName||"Кошка")+" отошла в тень.",null);
                    setTimeout(function(){
                        startD([{stage:true,txt:(G.catName||"Кошка")+" сидела рядом.\n5 минут.\nТы не погладил."},{pause:3,stage:true,txt:"Она ждала.\nТы — нет."},{pause:3,stage:true,txt:"Ушла.\nВ темноту."},{pause:4,spk:"ERNIE",cls:"er",txt:"«Она вернётся.\nОна всегда\nвозвращается.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«В отличие от\nостальных.»"}],function(){
                            _catLeftAlone=false;_catLastInteract=Date.now();
                            notify("🐱 "+(G.catName||"Кошка")+" вернулась","gold");
                        });
                    },2000);
                }
            }
            setInterval(checkCatAlone,60000);// Check every minute

            function getDevice(){
                var ua=navigator.userAgent||"";
                if(/iPhone/i.test(ua))return "iPhone";
                if(/iPad/i.test(ua))return "iPad";
                if(/Android/i.test(ua))return "Android";
                if(/Windows/i.test(ua))return "Windows";
                if(/Mac/i.test(ua))return "Mac";
                return "Устройство";
            }

            // Choice statistics — local simulation (no server needed)
            var CHOICE_DB={
                momAnswer:{yes:89,total:100},
                momIgnore:{yes:11,total:100},
                cqLeftDoor:{yes:34,total:100},
                cqStayDoor:{yes:66,total:100},
                dblLook:{yes:42,total:100},
                dblDodge:{yes:38,total:100},
                dblPass:{yes:20,total:100},
                endA:{yes:28,total:100},
                endB:{yes:35,total:100},
                endC:{yes:12,total:100},
                endD:{yes:15,total:100},
                endE:{yes:10,total:100}
            };
            function getChoicePct(id){
                var d=CHOICE_DB[id];
                if(!d)return null;
                // Add some randomness to feel real
                var noise=Math.floor(Math.random()*5)-2;
                return Math.max(1,Math.min(99,d.yes+noise));
            }
            function showChoiceStats(choiceId,btnEl){
                var pct=getChoicePct(choiceId);
                if(pct!==null){
                    setTimeout(function(){
                        showChoiceStat(btnEl,pct);
                    },800);
                }
            }

            // Collectible notes system
            var ALL_NOTES=[
                {id:"n1",floor:1,text:"День 1. Дверь закрылась. Голос сказал — не бойся. Я боюсь."},
                {id:"n2",floor:1,text:"Кошка смотрит на меня. Как будто знает что-то."},
                {id:"n3",floor:2,text:"Кондуктор считает. Не знаю что. Не хочу знать."},
                {id:"n4",floor:2,text:"Поезд гудел всю ночь. Потом я понял — тут нет ночи."},
                {id:"n5",floor:3,text:"Книги меняют текст когда не смотришь. Проверял."},
                {id:"n6",floor:3,text:"Нашёл книгу с моим именем. Последняя страница пуста."},
                {id:"n7",floor:4,text:"Актёр играет для пустого зала. Но аплодисменты настоящие."},
                {id:"n8",floor:4,text:"За кулисами — зеркало. В нём другая сцена. Другой актёр."},
                {id:"n9",floor:5,text:"Камеры записывают. Кто смотрит записи?"},
                {id:"n10",floor:5,text:"Смотритель не человек. Смотритель не призрак. Что он?"},
                {id:"n11",floor:6,text:"Цветы в саду — воспоминания. Мой засох на третий день."},
                {id:"n12",floor:6,text:"Лика рисует без остановки. Её руки прозрачные."},
                {id:"n13",floor:7,text:"Зеркала показывают не тебя. А того, кем ты был."},
                {id:"n14",floor:7,text:"Двойник знает мои мысли. Потому что он — мои мысли."},
                {id:"n15",floor:8,text:"Голоса. Все 847. Каждый звал маму."},
                {id:"n16",floor:8,text:"Кошка шипит на стены. На ЧТО она шипит?"},
                {id:"n17",floor:9,text:"ERNIE устал. Я вижу. Призраки устают?"},
                {id:"n18",floor:9,text:"Осталось мало. Он это знает. Поэтому молчит."},
                {id:"n19",floor:10,text:"Крыша. Небо. Впервые за 10 этажей — небо."},
                {id:"n20",floor:10,text:"Последняя записка. Моя. Я оставлю её для следующего."}
            ];
            function findNote(floor){
                if(Math.random()>0.4)return;// 40% chance per location
                var available=ALL_NOTES.filter(function(n){return n.floor===floor&&G.notesFound.indexOf(n.id)<0});
                if(available.length===0)return;
                var note=available[Math.floor(Math.random()*available.length)];
                G.notesFound.push(note.id);
                setTimeout(function(){
                    notify("📜 Записка #"+G.notesFound.length+"/20","gold");
                    startD([{stage:true,txt:"На полу — записка.\nПожелтевшая.\nЧерновой почерк."},{narr:true,txt:"«"+note.text+"»"},{stage:true,txt:"Кладёшь обратно.\nИли нет."}]);
                },1500);
            }

            function getSessionMinutes(){return Math.floor((Date.now()-(G.startTime||Date.now()))/60000)}

            function screenCrack(x,y){
                var el=document.createElement("div");
                el.className="crack-overlay";
                el.style.setProperty("--cx",x+"px");
                el.style.setProperty("--cy",y+"px");
                // Draw crack lines
                for(var i=0;i<5;i++){
                    var line=document.createElement("div");
                    line.className="crack-line";
                    var angle=Math.random()*360;
                    var len=30+Math.random()*60;
                    line.style.cssText="left:"+x+"px;top:"+y+"px;width:"+len+"px;height:1px;transform:rotate("+angle+"deg);opacity:"+(0.05+Math.random()*0.1);
                    el.appendChild(line);
                }
                document.body.appendChild(el);
                vibrate(20);
                setTimeout(function(){el.style.opacity="0";el.style.transition="opacity 2s"},1500);
                setTimeout(function(){el.remove()},4000);
            }

            // New Game+ — подвал открывается после первого прохождения
            function isNGPlus(){return TM.runs>1}
            function hasSecretEnding(){return (G.notesFound||[]).length>=15}

            // Analytics via Telegram Bot API (set your bot token)
            var ANALYTICS_BOT="";// Set bot token for analytics
            var ANALYTICS_CHAT="";// Set chat ID
            function trackEvent(event,data){
                // Local tracking
                var events=JSON.parse(localStorage.getItem("ernie_events")||"[]");
                events.push({e:event,d:data,t:Date.now(),f:G.currentFloor});
                localStorage.setItem("ernie_events",JSON.stringify(events.slice(-100)));
                // Remote tracking (if bot configured)
                if(ANALYTICS_BOT&&ANALYTICS_CHAT){
                    var msg="🎮 "+event+(data?" | "+JSON.stringify(data):"")+" | F"+G.currentFloor+" | "+(getSessionMinutes())+"min";
                    try{fetch("https://api.telegram.org/bot"+ANALYTICS_BOT+"/sendMessage?chat_id="+ANALYTICS_CHAT+"&text="+encodeURIComponent(msg))}catch(e){}
                }
            }

            // Telegram Stars monetization (skeleton)
            function canUseTGStars(){return typeof Telegram!=="undefined"&&Telegram.WebApp&&Telegram.WebApp.openInvoice}
            function buyCosmetic(item,price){
                if(!canUseTGStars()){notify("Доступно в Telegram","bad");return}
                // Telegram.WebApp.openInvoice(invoiceUrl) — needs bot backend
                notify("⭐ Скоро: "+item,"gold");
            }

            // Global counter simulation
            function getGlobalSaved(){
                var base=12847;// Simulated base
                var local=parseInt(localStorage.getItem("ernie_global_saved")||"0");
                return base+local;
            }
            function incrementGlobalSaved(){
                var v=parseInt(localStorage.getItem("ernie_global_saved")||"0");
                localStorage.setItem("ernie_global_saved",String(v+countSaved()));
            }

            // Beforeunload — ERNIE's last words
            var _canLeave=false;
            window.addEventListener("beforeunload",function(e){
                if(_canLeave||G.currentFloor<3)return;
                trackEvent("leave_attempt",{floor:G.currentFloor});
                e.preventDefault();
                e.returnValue="ERNIE ждёт.";
                return "ERNIE ждёт.";
            });

            // Tab visibility — cat reacts when you come back
            var _lastHidden=0;
            document.addEventListener("visibilitychange",function(){
                if(document.hidden){
                    _lastHidden=Date.now();
                } else {
                    var away=(Date.now()-_lastHidden)/1000;
                    if(away>30&&G.hasCat&&G.currentFloor>=2&&G.currentFloor<=9){
                        notify("🐱 "+(G.catName||"Кошка")+" ждала тебя "+(Math.floor(away))+" сек","gold");
                        catReact("purr");
                    }
                    if(away>120&&G.currentFloor>=5){
                        setTimeout(function(){
                            startD([{spk:"ERNIE",cls:"er",txt:"«Ты ушёл\nна "+Math.floor(away/60)+" мин.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Я считал.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«200 лет —\nя умею считать.»"}]);
                        },2000);
                    }
                }
            });

            // Random ERNIE thoughts
            var ERNIE_IDLE=[
                "«Бу.»",
                "«Тихо. Подозрительно тихо.»",
                "«Ты ещё тут? Хорошо.»",
                "«Мне было 14.\nСейчас... 214?\nЕсть ли призрачное\nсовершеннолетие?»",
                "«Я забыл как\nвыглядит небо.\nОно голубое?»",
                "«Однажды пытался\nсчитать ступеньки.\nСбился на 847.»",
                "«Если устал —\nотдохни.\n200 лет ждал.\n5 минут — мелочь.»",
                "«Интересно,\nкошки видят цвета?\nПризраки — нет.\nВсё серое.\nКроме неё.»",
                "«Иногда я слышу\nкак кто-то поёт.\nПотом понимаю —\nэто я.»",
                "«У меня был\nлюбимый цвет.\nЗабыл какой.\nНаверное, синий.\nВсе говорят синий.»",
                "«Знаешь что хуже\nчем быть призраком?\nБыть призраком\nбез хобби.»",
                "«Я пробовал\nвести дневник.\nКаждый день\nодна запись:\n«Ничего».»",
                "«Где-то внизу\nбариста роняет\nстакан. Слышишь?\nТретий за сегодня.»"
            ];
            var _lastErnieThought=Date.now();
            function maybeErnieThought(){
                if(Date.now()-_lastErnieThought<90000)return;// Not more than every 90 sec
                if(Math.random()>0.3)return;
                _lastErnieThought=Date.now();
                var thought=ERNIE_IDLE[Math.floor(Math.random()*ERNIE_IDLE.length)];
                notify("💭 ERNIE: "+thought.replace(/«|»|\n/g," ").substring(0,50)+"...","gold");
            }

            // Cosmetic shop (Telegram Stars)
            var COSMETICS={
                catSkin:{name:"Скин кошки: Золотой",price:10,type:"catColor",value:"gold"},
                ernieColor:{name:"Цвет ERNIE: Синий",price:15,type:"ernieColor",value:"#5a7fa0"},
                darkMode:{name:"Режим: Полная тьма",price:5,type:"theme",value:"abyss"},
                directors:{name:"Режиссёрская версия",price:50,type:"content",value:"directors_cut"}
            };
            function showShop(){
                if(!canUseTGStars()){notify("Магазин доступен в Telegram","bad");return}
                var html='<div style="text-align:center;padding:12px"><div style="font-family:JetBrains Mono,monospace;font-size:9px;letter-spacing:3px;color:var(--gold);margin-bottom:12px">⭐ МАГАЗИН</div>';
                for(var k in COSMETICS){
                    var item=COSMETICS[k];
                    html+='<div style="padding:8px;margin:4px 0;border:1px solid rgba(200,168,72,.1);border-radius:3px;cursor:pointer" onclick="buyCosmetic(\''+k+'\','+item.price+')"><span style="font-size:12px;color:var(--txt2)">'+item.name+'</span><span style="font-size:10px;color:var(--gold);margin-left:8px">⭐'+item.price+'</span></div>';
                }
                html+='</div>';
                // Show as popup — reuse existing popup system
                notify("⭐ Магазин скоро!","gold");
            }

            // === CAFE MENU ===
            function openCafeMenu(){rotateCafeNote();$("cafeMenu").classList.add("show");sTap();vibrate(20)}
            function closeCafeMenu(){$("cafeMenu").classList.remove("show")}
            var _drinkJokes={
                espresso:["«ЭСПРЕССО!\nКлассика!»","«9 бар давления.\nКак жизнь.»"],
                latte:["«Латте.\nДля тех кто\nбоится кофе.»","«Молоко призрачное.\nНо пенка настоящая.\nКак-то так.»"],
                cappuccino:["«Капучино!\nПенка — мой\nшедевр.»","«Она исчезает\nчерез 3 секунды.\nКак и я.»"],
                americano:["«Американо.\nКофе + вода.\nКак разбавить\nгоре водой.\nНе работает.»","«Но пьётся\nлегче.»"],
                hotchoc:["«Нет.»","«Это для Лики.\nОна ждёт\n200 лет.»","«Закажи что-то\nдругое.»"],
                tea:["«Чай?\nВ МОЁМ кафе?»","«Шучу.\nЧая нет.\nНикогда не было.\nНе будет.»","«Я призрак,\nне варвар.»"],
                water:["«Вода.\nТы пришёл\nв кафе.\nЗаказать воду.»","«847 человек\nдо тебя.\nНи один\nне заказывал\nводу.»","«Ты — особенный.\nВ плохом смысле.»"]
            };
            function orderDrink(type){
                closeCafeMenu();
                var jokes=_drinkJokes[type]||["«Интересный выбор.»"];
                var lines=jokes.map(function(j){return {spk:"БАРИСТА",cls:"bo",txt:j}});
                if(type==="espresso"||type==="latte"||type==="cappuccino"||type==="americano"){
                    lines.push({stage:true,txt:"Возня за стойкой.\nГрохот.\nТишина."});
                    lines.push({stage:true,txt:"Кофе готов."});
                    if(type!=="espresso"){
                        lines.push({spk:"ERNIE",cls:"er",txt:"«Как ты отличаешь\nлатте от капучино\nесли оба призрачные?»"});
                        lines.push({spk:"БАРИСТА",cls:"bo",txt:"«Верой.»"});
                    }
                    G.karma+=1;updH();
                }
                if(type==="hotchoc"){
                    lines.push({spk:"ERNIE",cls:"er",txt:"«Он серьёзно\nнасчёт Лики.»"});
                    lines.push({spk:"ERNIE",cls:"er",txt:"«Не трогай\nшоколад.»"});
                }
                startD(lines,function(){cafeRem()},null,I.boris);
            }

            // Running gag: ERNIE "Бу"
            var _booCount=0;
            function ernieBoo(){
                _booCount++;
                var boos=[
                    [{spk:"ERNIE",cls:"er",txt:"«Бу.»"},{pause:2,stage:true,txt:"Молчание."},{spk:"ERNIE",cls:"er",txt:"«Ладно.\nЯ плохой призрак.»"}],
                    [{spk:"ERNIE",cls:"er",txt:"«Бу.»"},{pause:1,spk:"ERNIE",cls:"er",txt:"«Опять не работает.»"}],
                    [{spk:"ERNIE",cls:"er",txt:"«...Бу.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Однажды получится.\nСтатистически.»"}],
                    [{spk:"ERNIE",cls:"er",txt:"«Бу.»",spd:60},{pause:3,stage:true,txt:"Тишина."},{pause:2,stage:true,txt:"Кошка зевает."}],
                    [{spk:"ERNIE",cls:"er",txt:"«Бу.»",spd:80}]
                ];
                var idx=Math.min(_booCount-1,boos.length-1);
                return boos[idx];
            }

            // Player performs on stage — Actor's reaction
            function actorPullOnStage(){
                startD([
                    {spk:"АКТЁР",cls:"ak",txt:"«НА СЦЕНУ!»"},
                    {stage:true,txt:"Он тянет тебя\nза руку.\nРука проходит\nсквозь."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Неважно.\nИди сам.»"},
                    {stage:true,txt:"Прожектор.\nНа тебе."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Говори!\nЧто угодно!»"},
                    {stage:true,txt:"«...Привет?»"},
                    {pause:2,spk:"АКТЁР",cls:"ak",txt:"«БРАВО!»"},
                    {stage:true,txt:"Хлопает.\nОдин.\nВ пустом зале."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Худшее выступление\nза 200 лет!»"},
                    {pause:1,spk:"АКТЁР",cls:"ak",txt:"«Именно то\nчто нужно.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Я видел хуже.»"},
                    {spk:"АКТЁР",cls:"ak",txt:"«Когда?»"},
                    {spk:"ERNIE",cls:"er",txt:"«Каждый день.\nТвои выступления.»"},
                    {pause:2,spk:"АКТЁР",cls:"ak",txt:"«...Справедливо.»"}
                ],function(){
                    G.karma+=2;updH();
                    notify("🎭 Дебют состоялся","gold");
                    back();
                },null,I.theater);
            }

            // Rotate cafe menu note
            var _menuNotes=[
                "Все напитки призрачные.<br>Побочный эффект: лёгкая прозрачность.",
                "Wi-Fi: КАФЕ_847<br>Пароль: 847<br>Скорость: призрачная",
                "Часы работы: всегда.<br>Потому что время тут не идёт.",
                "Жалобная книга на стойке.<br>847 страниц. Все пустые.",
                "Чаевые приветствуются.<br>Принимаем: благодарность, молчание, кошек.",
                "Сегодня в меню: всё то же.<br>Как вчера. Как 200 лет назад.",
                "Бариста дня: единственный бариста.<br>Бариста года: он же."
            ];
            function rotateCafeNote(){
                var el=$("cafeMenuNote");
                if(el)el.innerHTML=_menuNotes[Math.floor(Math.random()*_menuNotes.length)];
            }

            // ERNIE reacts to inactivity
            var _lastAction=Date.now();
            function resetInactivity(){_lastAction=Date.now()}
            document.addEventListener("click",resetInactivity);
            document.addEventListener("touchstart",resetInactivity);
            setInterval(function(){
                if(G.currentFloor<2||G.currentFloor>=10)return;
                var idle=(Date.now()-_lastAction)/1000;
                if(idle>45&&idle<50){
                    var idles=[
                        "«Ты стоишь.\nИнтересная стратегия.»",
                        "«Заснул?»",
                        "«Я тоже молчу.\nМы оба молчим.\nОтлично проводим\nвремя.»",
                        "«847 до тебя\nтоже стояли.\nПотом перестали.»",
                        "«Кошка тоже ждёт.\nНо терпеливее.»"
                    ];
                    var msg=idles[Math.floor(Math.random()*idles.length)];
                    notify("💭 ERNIE: "+msg.replace(/«|»|\n/g," ").substring(0,50),null);
                }
            },10000);
function setAmb(type){
                document.body.classList.remove("amb-gold","amb-red","amb-warm","amb-cold");
                if(type)document.body.classList.add("amb-"+type);
            }
function saveNPC(id,name){
                G.saved[id]=true;
                var count=Object.keys(G.saved).length;
                G.karma+=5;G.trust+=2;updH();
                EMOTION.add(30);// Мощный позитивный момент
                if(count>=3)HEARTBEAT.start("normal");
                setTimeout(function(){HEARTBEAT.stop()},5000);
                var msgs={barista:"Фартук на стойке. Пустая чашка. Закрыто.",lika:"Рисунок оживает. Она уходит в него.",conductor:"Билет. Поезд. Впервые за 200 лет.",actor:"Последний акт. Поклон. Аплодисменты из темноты.",trumpeter:"Ноты в линиях. Полная мелодия. Свободен."};
                showSalvation(name,msgs[id]||"Свободен.");
                notify("✦ "+name+" свободен · "+count+"/5","gold");
                addDiary(name+" ушёл. Свободен.\\nВпервые за 200 лет.","secret",G.currentFloor);
            }
            function countSaved(){return Object.keys(G.saved).length}

            function showChoiceStat(btnEl,pct){
                var s=document.createElement("span");
                s.style.cssText="display:block;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txtd);margin-top:2px;opacity:0;transition:opacity .5s";
                s.textContent=pct+"% игроков";
                btnEl.appendChild(s);
                setTimeout(function(){s.style.opacity="1"},300);
            }
function showCatIntro(){
                sI(I.city);
                startD([
                    {stage:true,txt:"Два глаза.\nЗолотых.\nИз темноты.",spd:40},{pause:2,stage:true,txt:"Мяуканье.\nТихое. Рядом."},
                    {stage:true,txt:"У стены — кошка.\nСмотрит.\nНе боится."},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«...»",spd:80}
                ],null,[
                    {icon:"🐱",text:"Подойти",fn:"catIntroTouch()",id:"ci1"},
                    {icon:"🚶",text:"Не подходить",fn:"catIntroIgnore()",id:"ci2"}
                ],I.city);
            }
            function catIntroTouch(){sPurr();
                G.hasCat=true;G.karma+=2;
                PROMISES.add("Я позабочусь о "+(G.catName||"кошке"));EMOTION.add(20);
                startD([
                    {stage:true,txt:"Тёплая.\nМурчит."},
                    {stage:true,txt:"Идёт за тобой."},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Как назовёшь?»"}
                ],function(){
                    updH();showCat();
                    // Спросить имя кошки
                    var ch=$("gCh");ch.innerHTML="";ch.style.display="flex";
                    var w=document.createElement("div");
                    w.style.cssText="text-align:center;padding:12px";
                    w.innerHTML='<input id="catNameIn" type="text" maxlength="12" placeholder="имя кошки" style="background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--txt);font-size:18px;padding:10px 16px;border-radius:4px;text-align:center;width:180px;font-family:inherit;outline:none"><br><button onclick="submitCatName()" style="margin-top:10px;padding:8px 24px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:12px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px">назвать</button>';
                    ch.appendChild(w);
                    setTimeout(function(){$("catNameIn").focus()},300);
                },null,I.city);
            }
            function catIntroIgnore(){
                G.uc.ignoredCat=true;
                startD([
                    {stage:true,txt:"Проходишь мимо."},
                    {pause:3,stage:true,txt:"Мяуканье за спиной.\nТише.\nТише."},
                    {pause:4,stage:true,txt:"Тишина."}
                ],function(){
                    trustQuestion();
                },null,I.city);
            }
            function askNameF3(){
                startD([
                    {stage:true,txt:"Тишина.\nПыль.\nПолки до потолка."},
                    {spk:"БИБЛИОТЕКАРЬ",cls:"bi",txt:"«Новый гость.»"},
                    {spk:"БИБЛИОТЕКАРЬ",cls:"bi",txt:"«Мне нужно имя.\nДля книги учёта.»"},
                    {spk:"БИБЛИОТЕКАРЬ",cls:"bi",txt:"«Настоящее.\nКниги не любят\nкогда врут.»"}
                ],function(){
                    var ch=$("gCh");ch.innerHTML="";ch.style.display="flex";
                    var w=document.createElement("div");
                    w.style.cssText="text-align:center;padding:12px";
                    w.innerHTML='<input id="nameInF3" type="text" maxlength="16" placeholder="имя" style="background:var(--bg3);border:1px solid rgba(160,200,160,.15);color:var(--txt);font-size:18px;padding:10px 16px;border-radius:4px;text-align:center;width:180px;font-family:inherit;outline:none"><br><button onclick="submitNameF3()" style="margin-top:10px;padding:8px 24px;background:var(--bg3);border:1px solid rgba(160,200,160,.15);color:#a0c8a0;font-size:12px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px">записать</button>';
                    ch.appendChild(w);
                    setTimeout(function(){$("nameInF3").focus()},300);
                },null,I.library);
            }
            function submitNameF3(){
                var n=$("nameInF3").value.trim();
                if(!n)return;
                G.playerName=n;
                startD([
                    {spk:"БИБЛИОТЕКАРЬ",cls:"bi",txt:"«"+n+".»"},
                    {stage:true,txt:"Записывает.\nМедленно.\nКрасивым почерком."},
                    {spk:"БИБЛИОТЕКАРЬ",cls:"bi",txt:"«Красивое имя.\n848 имён в этой книге.\nКаждое — настоящее.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Теперь башня\nзнает тебя.\nЭто и хорошо\nи плохо.»"}
                ],function(){
                    notify("📖 Имя записано: "+n,"gold");
                    // Продолжаем этаж 3 нормально
                    startF3();
                },null,I.library);
            }
            
            function submitCatName(){
                var n=$("catNameIn").value.trim();
                if(!n){n=["Тень","Дым","Мурка","Пепел"][Math.floor(Math.random()*4)]}
                G.catName=n;
                var nl=n.toLowerCase();
                var lines;
                if(nl==="эрни"||nl==="ernie"||nl==="ерни"||nl==="эрнест"||nl==="ernest"){
                    lines=[
                        {spk:"ERNIE",cls:"er",txt:"«...»"},
                        {pause:2,spk:"ERNIE",cls:"er",txt:"«Серьёзно?»"},
                        {spk:"ERNIE",cls:"er",txt:"«200 лет одиночества.\nИ вот —\nменя назвали.\n\nВ честь кошки.»"},
                        {stage:true,txt:n+" мурчит.\nНе понимает иронии."},
                        {spk:"ERNIE",cls:"er",txt:"«Ладно.\nОна красивее меня.\nЗаслужила.»"}
                    ];
                } else if(nl==="кошка"||nl==="кот"||nl==="cat"){
                    lines=[
                        {spk:"ERNIE",cls:"er",txt:"«Назвал кошку...\nкошкой.»"},
                        {spk:"ERNIE",cls:"er",txt:"«Креативно.»"},
                        {stage:true,txt:n+" не возражает."}
                    ];
                } else {
                    var jokes=[
                        "«Хорошее имя.\nПоследний гость\nназвал кошку «Пффф».\nЯ не шучу.»",
                        "«"+n+".\nЗнаешь, у меня\nбыл хомяк.\nНазвал его Башня.\nОн сбежал.\nИрония.»"
                    ];
                    var joke=jokes[Math.floor(Math.random()*jokes.length)];
                    lines=[
                        {spk:"ERNIE",cls:"er",txt:joke},
                        {stage:true,txt:n+" мурчит.\nЗнает своё имя."}
                    ];
                }
                startD(lines,function(){
                    notify("🐱 "+n+" идёт за тобой","gold");
                    trustQuestion();
                },null,I.city);
            }
function trustQuestion(){
                startD([
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Вопрос.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ты мне доверяешь?»",spd:40},
                    {pause:3,stage:true,txt:"Тишина.\nОн ждёт."}
                ],function(){
                    showCh([
                        {icon:"✋",text:"«Нет»",fn:"cityTrust(false)",id:"ct0"},
                        {icon:"🤝",text:"«Да»",fn:"cityTrust(true)",id:"ct1"},
                        {icon:"🤫",text:"Промолчать",fn:"citySilent()",id:"ct2"}
                    ]);
                });
            }

            function catMeetPet(){G.catTrust=Math.min(100,(G.catTrust||50)+15);
                G.hasCat=true;G.karma+=3;updH();showCat();
                startD([
                    {stage:true,txt:"Урчание становится громче."},
                    {stage:true,txt:"Прыгает на плечо.\nЛёгкая. Почти невесомая."},
                    {spk:"ERNIE",cls:"er",txt:"«Осторожно.\nОна царапается.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Или нет.\nЯ не помню.\nПоследний раз\nкто-то её гладил —\nэто был...»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Неважно.»",spd:60},
                    {stage:true,txt:"Кошка мурчит.\nГлаза закрыты."},
                    {pause:3,stage:true,txt:"Доверие.\nМаленькое. Хрупкое.\nНо настоящее."}
                ],function(){notify("🐱 Кошка с тобой","gold");showCh([{icon:"📛",text:"Дать имя",fn:"catMeetName()",id:"cmn"},{icon:"🔪",text:"Нож",fn:"lampKnife()",id:"lk"},{icon:"🚶",text:"Уйти",fn:"back()",id:"bk"}])})
            }
            function catMeetName(){
                if(!G.hasCat){G.hasCat=true;showCat()}
                $("gBotW").style.display="none";$("gNav").style.display="none";$("gTap").style.display="none";
                $("gTop").style.display="none";
                var ch=$("gCh");ch.innerHTML="";ch.style.display="flex";
                var w=document.createElement("div");
                w.style.cssText="display:flex;flex-direction:column;align-items:center;gap:14px;padding:20px;width:100%";
                var lbl=document.createElement('div');lbl.style.cssText='font-family:Raleway,sans-serif;font-size:14px;color:rgba(230,225,210,.6);font-style:italic';lbl.textContent='Как назовёшь?';
                var inp2=document.createElement('input');inp2.id='catNI';inp2.type='text';inp2.maxLength=16;inp2.placeholder='Имя...';inp2.style.cssText='background:rgba(200,168,72,.08);border:1px solid rgba(200,168,72,.3);border-radius:8px;padding:10px 16px;color:var(--gold);font-family:Raleway,sans-serif;font-size:15px;text-align:center;width:180px;outline:none';
                var btn2=document.createElement('button');btn2.className='ch-btn';btn2.textContent='Назвать';btn2.onclick=function(){doCatName()};
                w.appendChild(lbl);w.appendChild(inp2);w.appendChild(btn2);
                ch.appendChild(w);
                setTimeout(function(){var i=document.getElementById("catNI");if(i)i.focus()},200);
            }
            function doCatName(){
                var inp=document.getElementById("catNI");
                var n=inp?inp.value.trim():"";
                if(!n){notify("Введи имя","bad");return}
                G.catName=n;TM.catName=n;saveTM();updH();
                startD([{spk:"ERNIE",cls:"er",txt:"«"+n+".»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Подходит.»"},{pause:2,stage:true,txt:n+" мяукает.\nКак будто знает\nэто имя.\nКак будто ждала\nименно его."}],function(){notify("🐱 "+n+" с тобой","gold");showLocsReal()})
            }
            function catMeetIgnore(){G.catTrust=Math.max(0,(G.catTrust||50)-20);
                startD([
                    {stage:true,txt:"Проходишь мимо."},
                    {pause:3,stage:true,txt:"Кошка смотрит вслед."},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Мяукает.\nТихо.\nОдин раз."},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Ты серьёзно.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Кошка выбрала тебя\nвпервые за 200 лет.\nА ты прошёл мимо.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Ладно.\nТвоё право.»",spd:50}
                ],function(){G.karma-=2;addDread(10);updH();showLocsReal()})
            }
            function showLocsReal(){showLocs()}

            function checkSilentPath(){
                if((G._silentChoices||0)>=3&&!G._silentReward){G._silentReward=true;
                    setTimeout(function(){startD([
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Ты молчишь.»",spd:50},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Все говорят.\nТы — молчишь.»"},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Мама тоже молчала.»",spd:40},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Приходила вечером.\nСадилась рядом.\nНичего не говорила.\nПросто — была.»",spd:35},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Я забыл её лицо.\nНо помню\nкак она молчала.»",spd:40},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Ты молчишь так же.»",spd:50},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«...Спасибо.»",spd:60}
                    ],function(){G.trust+=5;G.karma+=5;updH();addDiary("ERNIE про маму.\nОна молчала рядом.\nОн забыл лицо.\nНо помнит молчание.","secret",G.currentFloor||1);notify("💛 Тихий путь","gold")})},3000)}}
            function openL(id) { if (G.vis[id]) return; G.vis[id] = true; sS(); rainIndoor(true); if (id==="cafe") openCafe(); else if (id==="apt") openApt(); else if (id==="wall") openWall(); else if (id==="bsmt") openBasement(); else openLamp() }
            function back() { 
                rainIndoor(false); startMusic("city"); 
                // Кот обижается если долго игнорируешь
                G._backCount=(G._backCount||0)+1;
                if(G.hasCat && G._backCount%4===0 && !G.catAngry){
                    G.catAngry=true;
                    startD([
                        {stage:true,txt:(G.catName||"Кошка")+" отворачивается."},
                        {pause:3,stage:true,txt:"Хвост дёргается.\nНедовольно."},
                        {spk:"ERNIE",cls:"er",txt:"«Кажется, "+(G.catName||"кошка")+"\nобиделась.»"},
                        {spk:"ERNIE",cls:"er",txt:"«Ты давно\nне обращал внимания.»"}
                    ],function(){notify("🐱 "+(G.catName||"Кошка")+" обиделась","bad");showLocs()});
                    return;
                }
                if(G.catAngry && G.hasCat && G._backCount%6===0){
                    G.catAngry=false;G.hasCat=false;hideCat();
                    startD([
                        {pause:3,stage:true,txt:(G.catName||"Кошка")+" уходит."},
                        {pause:3,stage:true,txt:"Тихо. Без оглядки."},
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«...Она ушла.»"},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Они всегда уходят\nкогда перестаёшь\nзамечать.»",spd:40}
                    ],function(){notify("🐱 "+(G.catName||"Кошка")+" ушла","bad");G.karma-=3;updH();showLocs()});
                    return;
                }
                showLocs(); updH() 
            }
            function openCafe() {
                sGl();stopRain();sI(I.cafe_inside);startMusic("cafe");
                var introLines=[{stage:true,txt:"За стойкой — призрак.\nПротирает стакан\nодержимо."},{spk:"БАРИСТА",cls:"bo",txt:"«Закрыто.»"}];
                if(TM.runs>1&&TM.bestFloor>=1){
                    introLines.push({stage:true,txt:"Замирает."});
                    introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Ты. Опять.»"});
                    if(TM.catName){introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Где "+TM.catName+"?\nОна приходила после тебя.\nЖдала.»"})}
                    if(TM.bestFloor>=7){introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Ты был на седьмом.\nЗеркала. Я вижу по глазам.»"})}
                    if(TM.deaths>=3){introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Ты умирал "+TM.deaths+" раз.\nИ всё равно пьёшь кофе.\nУважаю.»"})}
                    introLines.push({spk:"ERNIE",cls:"er",txt:"«Бариста, ты каждому\nэто говоришь.»"});
                    introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Нет. Этот — другой.\nУ него глаза\nкак у того мальчика.»"});
                }else{
                    introLines.push({stage:true,txt:"Роняет стакан.\nОсколки зависают\nв воздухе."});
                    introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Ты... живой?!\nЖИВОЙ!\nРебята, тут живой!»"});
                    introLines.push({stage:true,txt:"Никто не приходит."});
                    introLines.push({spk:"БАРИСТА",cls:"bo",txt:"«Привыкли\nк моим крикам.»",spd:35});
                }
                startD(introLines, null, [{icon:"💬",text:"«Кто вы?»",fn:"cafeWho()",id:"cw"},{icon:"☕",text:"«Можно кофе?»",fn:"cafeCof()",id:"cc"},{icon:"📋",text:"Меню",fn:"openCafeMenu()",id:"cm"},{icon:"📜",text:"«Он оставил что-то?»",fn:"cafeNote()",id:"cn"},{icon:"👋",text:"«Мне пора.»",fn:"cafeBye()",id:"cb"}], I.boris)
            }
            function cafeWho() { G.uc.cw=true;G._cafeN=(G._cafeN||0)+1; var catLine=G.hasCat?[{spk:"БАРИСТА",cls:"bo",txt:"«О. "+(G.catName||"Кошка")+".»"},{spk:"БАРИСТА",cls:"bo",txt:"«Если разобьёт чашку —\nты платишь.\nЧем — не знаю.\nТут нет денег.»"}]:[];startD([{spk:"БАРИСТА",cls:"bo",txt:"«Бариста. 17 лет.\nИли 217. Сбился.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Мечта — открыть\nкофейню. Настоящую.\nС вывеской.»"},{spk:"БАРИСТА",cls:"bo",txt:"«73 тысячи рецептов\nв блокноте.\nВсе одинаковые.\nЗабыл вкус молока\n150 лет назад.»"},{spk:"ERNIE",cls:"er",txt:"«Это не смешно.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Немного смешно.»"}].concat(catLine).concat([{spk:"БАРИСТА",cls:"bo",txt:"«Кстати. Девочка наверху.\nЛика. Обещал ей\nгорячий шоколад.»"},{spk:"ERNIE",cls:"er",txt:"«Ты не умеешь\nделать шоколад.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Она не знает.»"}]), function() { cafeRem() }, null, I.boris) }
            function cafeCof() {sCoffee(); catReact("good");G.uc.cc=true;G._cafeN=(G._cafeN||0)+1; G.karma+=3; startD([{spk:"БАРИСТА",cls:"bo",txt:"«КОФЕ?!\n200 ЛЕТ НИКТО\nНЕ ПРОСИЛ!»"},{stage:true,txt:"Хватает турку.\nРоняет. Поднимает.\nРоняет."},{spk:"ERNIE",cls:"er",txt:"«Как ты протираешь\nстакан если руки\nпроходят сквозь?»"},{spk:"БАРИСТА",cls:"bo",txt:"«НЕ ЗАДАВАЙ\nСЛОЖНЫХ ВОПРОСОВ.»"},{stage:true,txt:"Кофе готов.\nКаким-то образом."},{spk:"БАРИСТА",cls:"bo",txt:"«Молоко? Сахар?\nСмысл жизни?\nПервые два есть.»"}], function() { addItem("coffee"); showItemPop("coffee"); updH(); cafeRem() }, null, I.boris) }
            function cafeBye() { G.uc.cb=true;G._cafeN=(G._cafeN||0)+1; G.karma-=1;addDread(5); startD([{spk:"БАРИСТА",cls:"bo",txt:"«Всем пора.\nНикому не до Баристы.»"},{pause:3,stage:true,txt:"Стакан в руках.\nПустой."}], function() { updH(); cafeRem() }, null, I.boris) }
            function cafeNote(){G.uc.cn=true;startD([{spk:"БАРИСТА",cls:"bo",txt:"«Кто — он?»"},{stage:true,txt:"«ERNIE.\\nОн что-нибудь оставил?»"},{pause:3,spk:"БАРИСТА",cls:"bo",txt:"«...»"},{pause:3,spk:"БАРИСТА",cls:"bo",txt:"«Под стойкой.\\nДавно лежит.»"},{stage:true,txt:"Бумага жёлтая. Ветхая.\\nНо буквы чёткие."},{pause:3,stage:true,txt:"«"+(G.playerName||"...").toUpperCase()+"»"},{pause:4,stage:true,txt:"Твоё имя.\\nНа бумаге,\\nкоторой 200 лет."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Я не писал\\nникакой записки.»"},{pause:3,stage:true,txt:"Переворачиваешь."},{pause:3,stage:true,txt:"На обороте:\\n«Останься.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Я сказал —\\nя не писал.»",spd:40}],function(){addDiary("Записка. Твоё имя. 200 лет.\\nERNIE говорит не писал.\\nГолос дрожит.","letter",1);G.karma+=3;updH();cafeRem()},null,I.boris)}
            function cafeRem() { G._cafeN=G._cafeN||0;var r=[]; var maxCh=2;if(G._cafeN<maxCh){if(!G.uc.cw) r.push({icon:"💬",text:"«Кто вы?»",fn:"cafeWho()",id:"cw"}); if(!G.uc.cc) r.push({icon:"☕",text:"«Кофе?»",fn:"cafeCof()",id:"cc"}); if(!G.uc.cb) r.push({icon:"👋",text:"«Мне пора.»",fn:"cafeBye()",id:"cb"});}if(!G.uc.cq&&(G.uc.cw||G.uc.cc)) r.push({icon:"❓",text:"«Вопрос?»",fn:"cafeQuest()",id:"cq"}); r.push({icon:"📋",text:"Меню",fn:"openCafeMenu()",id:"cm"});if(!G.uc.cr&&G.uc.cq) r.push({icon:"🧩",text:"«Ещё загадка?»",fn:"cafeRiddle2()",id:"cr"}); if(G.uc._baristaNoteFound&&!G.saved.barista) r.push({icon:"📜",text:"Отдать записку",fn:"cafeSaveBarista()",id:"csb"}); r.push({icon:"🚪",text:"Вернуться",fn:"back()",id:"bk"}); showCh(r) }
            function cafeSaveBarista(){
                startD([
                    {stage:true,txt:"Достаёшь записку.\nСтарую. Помятую."},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Что это?»"},
                    {stage:true,txt:"Читает."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Руки перестают дрожать.\nВпервые."},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Она написала...»"},
                    {pause:3,spk:"БАРИСТА",cls:"bo",txt:"«...что кофе был\nневкусный.»"},
                    {pause:2,stage:true,txt:"Смеётся.\nПлачет.\nОдновременно."},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Закрыто.\nНаконец-то закрыто.»"},
                    {stage:true,txt:"Снимает фартук.\nКладёт на стойку."},
                    {stage:true,txt:"Свет в кафе гаснет.\nТихо."},
                    {spk:"ERNIE",cls:"er",txt:"«...Он ушёл.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Первый за 200 лет.»"}
                ],function(){
                    saveNPC("barista","Бариста");
                    showCh([{icon:"🚪",text:"Вернуться",fn:"back()",id:"bk"}]);
                },null,I.boris);
            }
            function cafeRiddle2(){G.uc.cr=true;startD([{spk:"БАРИСТА",cls:"bo",txt:"«О! Ещё хочешь?\nХорошо.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Я готовлю кофе\n200 лет.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Сколько чашек\nя сделал?»"},{spk:"ERNIE",cls:"er",txt:"«Ноль.\nТы призрак.\nКофе проходит\nсквозь чашку.»"},{spk:"БАРИСТА",cls:"bo",txt:"«НЕПРАВИЛЬНО!\nОтвет: БЕСКОНЕЧНОСТЬ.»"},{spk:"ERNIE",cls:"er",txt:"«Это не загадка.\nЭто абсурд.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Абсурд — это\nпризрак, который\nкритикует другого\nпризрака за то,\nчто тот варит\nпризрачный кофе.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«...Справедливо.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Ладно. Настоящая.\nСлушай.»"}],function(){showRiddle("БАРИСТА:\n«Что видит слепой,\nслышит глухой,\nа если съешь —\nумрёшь?»",["💀 Яд","🚫 Ничего","👻 Призрак"],1,function(){G.karma+=3;updH()},function(){G.karma-=1;updH()},function(win){startD(win?[{spk:"БАРИСТА",cls:"bo",txt:"«Ничего!\nСлепой видит ничего.\nГлухой слышит ничего.\nСъешь ничего — умрёшь.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Ты умный.\nИли гуглишь.\nВ башне нет WiFi,\nтак что верю.»"},{spk:"ERNIE",cls:"er",txt:"«В башне есть WiFi.»"},{spk:"БАРИСТА",cls:"bo",txt:"«ЧТО?!\nПароль?!»"},{spk:"ERNIE",cls:"er",txt:"«847.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Это не пароль.\nЭто количество\nмёртвых.»"},{spk:"ERNIE",cls:"er",txt:"«Я знаю.\nПароль смешнее\nкогда знаешь\nконтекст.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Это не смешно.»"},{spk:"ERNIE",cls:"er",txt:"«Немного смешно.»"}]:[{spk:"БАРИСТА",cls:"bo",txt:"«Нет.\nОтвет — ничего.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Но не расстраивайся.\nГлавное — участие.\nИ кофе.»"}],function(){cafeRem()},null,I.boris)})})}
            // === ЗАГАДКА БАРИСТЫ ===
            var cafeQTimer=null;
            function cafeQuest(){
                G.uc.cq=true;
                startD([
                    {stage:true,txt:"Бариста ставит стакан."},
                    {stage:true,txt:"Медленно.\nНепривычно."},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Подожди.\nСядь.»"},
                    {stage:true,txt:"Голос другой.\nНе весёлый.\nТихий."},
                    {pause:2,narr:true,txt:"✦ ЗАГАДКА БАРИСТЫ ✦"},
                    {spk:"БАРИСТА",cls:"bo",txt:"«За дверью\nплачет ребёнок.»"},
                    {pause:2,spk:"БАРИСТА",cls:"bo",txt:"«Если войдёшь —\nне выйдешь.»"},
                    {pause:3,spk:"БАРИСТА",cls:"bo",txt:"«Что делаешь?»"}
                ],function(){
                    showCh([
                        {icon:"🚪",text:"Войти",fn:"cqEnter()",id:"cqe"},
                        {icon:"🏃",text:"Уйти",fn:"cqLeave()",id:"cql"}
                    ]);
                    // Скрытый третий путь — молчание 20 сек
                    cafeQTimer=setTimeout(function(){
                        if(!G.uc.cqe&&!G.uc.cql){
                            G.uc.cqsilence=true;
                            cqSilence();
                        }
                    },20000);
                },null,I.boris)
            }
            function cqEnter(){
                G.uc.cqe=true;
                if(cafeQTimer){clearTimeout(cafeQTimer);cafeQTimer=null}
                G.karma+=2;
                startD([
                    {pause:2,stage:true,txt:"Бариста смотрит."},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Храбро.»"},
                    {pause:2,spk:"БАРИСТА",cls:"bo",txt:"«Или глупо.»"},
                    {pause:2,spk:"БАРИСТА",cls:"bo",txt:"«Все герои\nговорят так.\nДо того,\nкак остаются.»"},
                    {stage:true,txt:"Берёт стакан.\nПротирает.\nКак раньше."}
                ],function(){updH();notify("🚪 ","gold");cafeRem()},null,I.boris)
            }
            function cqLeave(){
                G.uc.cql=true;
                if(cafeQTimer){clearTimeout(cafeQTimer);cafeQTimer=null}
                G.karma+=1;
                startD([
                    {pause:2,stage:true,txt:"Бариста кивает."},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Честно.»"},
                    {pause:2,spk:"БАРИСТА",cls:"bo",txt:"«Это больнее,\nчем храбрость.»"},
                    {pause:2,spk:"БАРИСТА",cls:"bo",txt:"«Но честнее.»"},
                    {stage:true,txt:"Отворачивается.\nПродолжает протирать."}
                ],function(){updH();notify("🏃 ","gold");G.uc.cqLeftDoor=true;cafeRem()},null,I.boris)
            }
            function cqSilence(){
                G.karma+=3;G.trust+=1;
                catReact("good");
                startD([
                    {pause:3,stage:true,txt:"Бариста ждёт."},
                    {pause:3,stage:true,txt:""},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Ты молчишь.»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"БАРИСТА",cls:"bo",txt:"«Я тоже молчал.\n200 лет.»",spd:40},
                    {pause:3,spk:"БАРИСТА",cls:"bo",txt:"«Потому что\nправильного ответа\nнет.»",spd:40},
                    {pause:3,spk:"БАРИСТА",cls:"bo",txt:"«Есть только тот,\nс которым живёшь.»",spd:40},
                    {pause:3,stage:true,txt:"Берёт стакан.\nРуки дрожат.\nВпервые за 200 лет."}
                ],function(){updH();notify("🤫 Бариста запомнил тишину +3","gold");cafeRem()},null,I.boris)
            }
            
            function likaSelf(){checkCombo("lika");
                if(G.saved.lika)return;
                startD([
                    {stage:true,txt:"Лика замирает."},
                    {spk:"ЛИКА",cls:"li",txt:"«Себя?»"},
                    {spk:"ЛИКА",cls:"li",txt:"«Я не...\nЯ никогда...»"},
                    {pause:3,stage:true,txt:"Берёт карандаш.\nРука дрожит."},
                    {stage:true,txt:"Рисует.\nМедленно."},
                    {pause:3,stage:true,txt:"Рисунок оживает.\nДевочка на бумаге —\nулыбается."},
                    {spk:"ЛИКА",cls:"li",txt:"«Это я?»"},
                    {stage:true,txt:"Касается рисунка."},
                    {stage:true,txt:"Свет.\nТихий.\nТёплый."},
                    {stage:true,txt:"Лика исчезает.\nРисунок остаётся.\nНа нём — она.\nСчастливая."},
                    {spk:"ERNIE",cls:"er",txt:"«Она ушла\nв свой рисунок.»"},
                    {spk:"ERNIE",cls:"er",txt:"«847 человек\nпросили нарисовать их.\nНи один не сказал —\nнарисуй себя.»"}
                ],function(){
                    saveNPC("lika","Лика");
                    addItem("drawing");showItemPop("drawing");
                    showCh([{icon:"🚪",text:"Вернуться",fn:"back()",id:"bk"}]);
                },null,I.lika_drawing);
            }
function openApt() { var likaIntro;if(TM.runs>1&&TM.bestFloor>=1){likaIntro=[{stage:true,txt:"Комната. Рисунки."},{stage:true,txt:"Девочка поднимает\nголову."},{spk:"ЛИКА",cls:"li",txt:"«Ты вернулся.»"},{pause:2,spk:"ЛИКА",cls:"li",txt:"«Я нарисовала тебя\nв прошлый раз.\nРисунок исчез\nкогда ты ушёл.»"},{spk:"ЛИКА",cls:"li",txt:"«Не уходи\nснова.\nЛадно?»"},{spk:"ЛИКА",cls:"li",txt:"«Смотри.\nЯ нарисовала солнце.»"},{spk:"ERNIE",cls:"er",txt:"«Оно квадратное.»"},{spk:"ЛИКА",cls:"li",txt:"«А оно разве\nне такое?»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«...Может, и такое.\nЯ тоже забыл."}]}else{likaIntro=[{stage:true,txt:"Комната.\nРисунки на стенах.\nСолнце квадратное.\nМама с шестью руками."},
{pause:2,stage:true,txt:"Рисунки.\nВезде.\nНа стенах. На полу.\nНа потолке."},
{stage:true,txt:"Глаза.\nВсе рисунки —\nглаза.\nОни смотрят на тебя."},
{pause:3,stage:true,txt:"В центре —\nдевочка.\nПрозрачная.\nНо рисует\nнастоящими красками."},{spk:"ERNIE",cls:"er",txt:"«Она... особенная.»"},{spk:"ЛИКА",cls:"li",txt:"«Ты новый?»"},{spk:"ЛИКА",cls:"li",txt:"«Он присылает вас.»"}]}if(G.hasCat){likaIntro.push({stage:true,txt:(G.catName||"Кошка")+" подходит\nк Лике."});likaIntro.push({spk:"ЛИКА",cls:"li",txt:"«Кошка!»"});likaIntro.push({stage:true,txt:"Глаза загораются.\nПервая настоящая\nулыбка."});likaIntro.push({spk:"ЛИКА",cls:"li",txt:"«Можно погладить?»"});likaIntro.push({stage:true,txt:(G.catName||"Кошка")+" запрыгивает\nк ней на колени.\nМурчит."});likaIntro.push({spk:"ЛИКА",cls:"li",txt:"«"+(G.catName?"Как зовут?»\n\n«"+G.catName+"? Красивое имя.":"Тёплая.»")+"»"});likaIntro.push({spk:"ERNIE",cls:"er",txt:"«...Она давно\nне улыбалась так.»",spd:40})}startD(likaIntro, null, [{icon:"💬",text:"«Кто — он?»",fn:"likaW()",id:"lw"},{icon:"🎨",text:"«Красивый рисунок.»",fn:"likaD()",id:"ld"},{icon:"📝",text:"«Что рисуешь?»",fn:"likaQ()",id:"lq"}], I.lika) }
            function likaW() { G.uc.lw=true; startD([{spk:"ЛИКА",cls:"li",txt:"«Не знаешь?»"},{stage:true,txt:"Огромные глаза."},{spk:"ЛИКА",cls:"li",txt:"«Он. ERNIE.\nИли как он себя\nназывает.»"},{spk:"ERNIE",cls:"er",txt:"«Лика...»"},{spk:"ЛИКА",cls:"li",txt:"«Он хороший.\nНо не может\nтебя спасти.\nОн сам в ловушке.»"},{spk:"ERNIE",cls:"er",txt:"«Лика, хватит.»"},{spk:"ЛИКА",cls:"li",txt:"«Передай ему...\nчто я скучаю.\nОн поймёт.»"},{pause:3,stage:true,txt:"ERNIE молчит.\n5 секунд.\nСамое долгое\nмолчание в игре."},{spk:"ERNIE",cls:"er",txt:"«Идём.\nТут больше нечего делать.»"}], function() { likaRem() }, null, I.lika) }
            function likaD() { G.uc.ld=true; G.karma+=3; startD([{spk:"ЛИКА",cls:"li",txt:"«Правда?\nМама говорила плохо.»"},{spk:"ЛИКА",cls:"li",txt:"«Нарисую тебя?»"},{stage:true,txt:"Рисует...",fn:function(){sI(I.lika_drawing)}},{spk:"ЛИКА",cls:"li",txt:"«Готово!\nУ тебя добрые глаза.»"},{spk:"ЛИКА",cls:"li",txt:"«Ты настоящий.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Ей было 7.\nКогда она пришла.»",spd:40},{pause:2,spk:"ERNIE",cls:"er",txt:"«Она рисовала\nвсех, кто приходил.\nЧтобы помнить лица.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Она не помнит\nсвоё.»",spd:40},{pause:3,stage:true,txt:""}], function() { addItem("drawing"); showItemPop("drawing"); updH(); notify("🎨 Рисунок +3","gold"); likaMemory() }, null, I.lika) }

            function likaMemory(){
                // Лика проверяет — ты смотрел?
                startD([{pause:2,spk:"ЛИКА",cls:"li",txt:"«Подожди.»"},{spk:"ЛИКА",cls:"li",txt:"«Я проверю.\nТы правда смотрел?»"},{pause:2,stage:true,txt:"Она закрывает рисунок\nруками."},{spk:"ЛИКА",cls:"li",txt:"«Что было\nна рисунке?»"}],function(){
                    showCh([
                        {icon:"👤",text:"Мальчик с кошкой",fn:"likaMemAns('a')",id:"lma"},
                        {icon:"🏰",text:"Башня без дверей",fn:"likaMemAns('b')",id:"lmb"},
                        {icon:"👁",text:"Глаза",fn:"likaMemAns('c')",id:"lmc"}
                    ])
                },null,I.lika)
            }
            function likaMemAns(a){
                // Правильный — "Глаза" (она сказала "у тебя добрые глаза")
                if(a==='c'){
                    G.karma+=5;updH();
                    startD([{pause:3,spk:"ЛИКА",cls:"li",txt:"«Ты смотрел.»"},{pause:3,spk:"ЛИКА",cls:"li",txt:"«Никто не смотрит.\nОни все смотрят\nна башню.\nНе на рисунок.»",spd:35},{pause:3,stage:true,txt:""},{spk:"ЛИКА",cls:"li",txt:"«Спасибо.»",spd:50}],function(){notify("🎨 Лика запомнит","gold");likaRem()},null,I.lika)
                }else{
                    startD([{pause:3,spk:"ЛИКА",cls:"li",txt:"«Нет.»"},{pause:3,spk:"ЛИКА",cls:"li",txt:"«Ты не смотрел.»",spd:40},{pause:3,stage:true,txt:"Опускает глаза."},{pause:3,stage:true,txt:""}],function(){likaRem()},null,I.lika)
                }
            }
            function likaQ() { G.uc.lq=true; startD([{spk:"ЛИКА",cls:"li",txt:"«Башню. Человечка.»"},{spk:"ЛИКА",cls:"li",txt:"«Может — ты.»"},{spk:"ERNIE",cls:"er",txt:"«...Идём.»"}], function() { likaRem() }, null, I.lika) }
            function likaRem() { var r=[]; var chosen=G.uc.lw||G.uc.ld||G.uc.lq;if(!chosen){if(!G.uc.lw) r.push({icon:"💬",text:"«Кто — он?»",fn:"likaW()",id:"lw"}); if(!G.uc.ld) r.push({icon:"🎨",text:"«Красивый рисунок.»",fn:"likaD()",id:"ld"}); if(!G.uc.lq) r.push({icon:"📝",text:"«Что рисуешь?»",fn:"likaQ()",id:"lq"})}else{if(!G.uc.ld&&!G.uc.lw)r.push({icon:"🎨",text:"«Рисунок.»",fn:"likaD()",id:"ld"});} r.push({icon:"🚪",text:"Назад",fn:"back()",id:"bk"}); showCh(r) }
            function openWall() { var ghostNames=["Марина, 25","Дима, 19","Катя, 31","Артём, 16","Ольга, 42","Лёша, 22","Аня, 14"];
                var ghostMsgs=["Не дошёл. Этаж 4.","Взяла нож. Зря.","Доверился зеркалу.","Кошка спасла. Почти.","Не ответила на звонок. Жалею.","Бариста — единственный друг.","ERNIE плакал. Я видела."];
                var gi=Math.floor(Math.random()*ghostNames.length);
                var ghostLine={narr:true,txt:"«"+ghostNames[gi]+".\n"+ghostMsgs[gi]+"»"};
                var echoLines=[{stage:true,txt:"Длинная стена.\nДесятки надписей."},{stage:true,txt:"Одна — внизу.\nДетский почерк.\nЦарапины."},{narr:true,txt:"«Мама, я выйду.\nЖди.»"},{pause:3,stage:true,txt:"ERNIE молчит."},{pause:3,stage:true,txt:""},ghostLine,{narr:true,txt:"«НЕ ПОДНИМАЙСЯ ВЫШЕ.\nТУТ НЕЧЕГО ИСКАТЬ.\nУХОДИ ПОКА МОЖЕШЬ.»"},{spk:"ERNIE",cls:"er",txt:"«Не слушай.\nОни все так пишут.»"},{narr:true,txt:"«Я был тут.\nНе верь голосу.»"},{narr:true,txt:"«Бариста делает лучший\nкофе в мире.\nИ он мёртв.»"},{narr:true,txt:"«На 7-м этаже\nне отвечай на звонок.»"},{narr:true,txt:"«Тут был Вася.\n1847 год.»"},{spk:"ERNIE",cls:"er",txt:"«Вася дошёл\nдо третьего этажа.\nПотом попросил\nвернуть деньги\nза билет.»"},{spk:"ERNIE",cls:"er",txt:"«У него не было\nбилета.»"},{spk:"ERNIE",cls:"er",txt:"«У Васи был план.\nПлан не сработал.»"},{narr:true,txt:"«Привет из 2026.\nБереги кошку.»"},{narr:true,txt:"«ERNIE ВРЁТ»\n«ERNIE СПАСЁТ»\n— рядом."}];if(TM.catName&&TM.runs>1){echoLines.push({narr:true,txt:"«Кошку назвали\n"+TM.catName+".\nПомним.»"});echoLines.push({spk:"ERNIE",cls:"er",txt:"«...Откуда они\nзнают имя?»"})}if(TM.bestFloor>=5&&TM.runs>1){echoLines.push({narr:true,txt:"«Смотритель знает всё.\nНо молчит о главном.»"})}if(TM.playerName&&TM.runs>1){echoLines.push({narr:true,txt:"«"+TM.playerName+" был тут.\nНе помню лица.\nПомню имя.»"})}echoLines.push({spk:"ERNIE",cls:"er",txt:"«Фанаты. У каждого\nсвоё мнение.»"});echoLines.push({stage:true,txt:"Внизу.\nПочти стёртое.\nДетский почерк."});echoLines.push({narr:true,txt:"«Э., 14 лет.\nДень первый.»"});startD(echoLines, null, [{icon:"👆",text:"Потрогать надпись",fn:"wallT()",id:"wt"},{icon:"👣",text:"Пройти мимо",fn:"wallP()",id:"wp"}], I.wall) }
            function wallT() { G.uc.wt=true; addDiary("«Э., 14 лет. День первый.»","lore",1);addDiary("«ERNIE ВРЁТ» «ERNIE СПАСЁТ» — рядом.","wall",1);addDiary("«На 7-м этаже не отвечай на звонок.»","wall",1);startD([{spk:"ERNIE",cls:"er",txt:"«Не трогай это.»"},{stage:true,txt:"Резко.\nГолос дрогнул."},{pause:3,stage:true,txt:"Тишина."},{spk:"ERNIE",cls:"er",txt:"«Пожалуйста.»",spd:50},{pause:2,stage:true,txt:"Палец на стене.\nБуквы тёплые."},{stage:true,txt:"«Э.» — Эрнест.\n14 лет.\nОн был тут.\nКАК ИГРОК."},{stage:true,txt:"Он тоже стоял\nу этой стены.\nТоже читал чужие\nнадписи.\nИ написал свою."},{pause:2,spk:"ERNIE",cls:"er",txt:"«Это был я.\nДавно.\nДругой я.»",spd:40},{spk:"ERNIE",cls:"er",txt:"«Идём.\nТут больше нечего\nсмотреть.»"}], function() { G.trust+=1;updH();showWallNote("📜","Э., 14 лет.\nДень первый.\n\nБуквы тёплые.\nОн писал их живой рукой.","lore",1);var r=[]; if(!G.uc.wp) r.push({icon:"👣",text:"Мимо",fn:"wallP()",id:"wp"}); r.push({icon:"🚪",text:"Назад",fn:"back()",id:"bk"}); showCh(r) }, null, I.wall) }
            function wallP() { G.uc.wp=true; startD([{narr:true,txt:"Мимо."},{spk:"ERNIE",cls:"er",txt:"«Не всё нужно трогать.»"}], function() { var r=[]; if(!G.uc.wt) r.push({icon:"👆",text:"Тронуть",fn:"wallT()",id:"wt"}); r.push({icon:"🚪",text:"Назад",fn:"back()",id:"bk"}); showCh(r) }, null, I.wall) }
            function openBasement(){sGl();sI(I.basement_stairs);
                // Туман в подвале
                var fog=document.createElement("div");fog.id="basementFog";fog.style.cssText="position:fixed;bottom:0;left:0;right:0;height:30%;background:linear-gradient(transparent,rgba(100,120,140,.15));z-index:50;pointer-events:none;animation:fogDrift 4s ease infinite alternate";
                document.body.appendChild(fog);
                setTimeout(function(){var f=document.getElementById("basementFog");if(f)f.remove()},30000);startMusic("trumpet");startD([{stage:true,txt:"Ступеньки вниз.\nСырые стены."},{stage:true,txt:"Музыка.\nДжаз. Настоящий."},{stage:true,txt:"В углу — старик.\nИграет на невидимой трубе.\nЗвучит реальный звук."},{spk:"ERNIE",cls:"er",txt:"«Это Трубач.\nНастоящее имя — Трубач.\nТут дольше всех.\nКроме меня.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«ERNIE, ты опять\nпривёл ребёнка?»"},{spk:"ERNIE",cls:"er",txt:"«Не ребёнка,\nа посетителя.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Ребёнка.\nЯ 400 лет смотрю\nна людей.\nВсе — дети.»"}],null,[{icon:"🎵",text:"«Сыграйте ещё»",fn:"trumpPlay()",id:"tp"},{icon:"🐱",text:"«Вы видели кошку?»",fn:"trumpCat()",id:"tc"}].concat(G.items.indexOf("drawing")>=0&&!G.saved.trumpeter?[{icon:"🎨",text:"Показать рисунок Лики",fn:"trumpSave()",id:"ts"}]:[]).concat([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}]),I.trumpeter)}
            
            function trumpSave(){
                startD([
                    {stage:true,txt:"Показываешь рисунок."},
                    {spk:"ТРУБАЧ",cls:"bo",txt:"«Что это?»"},
                    {stage:true,txt:"Смотрит. Долго."},
                    {spk:"ТРУБАЧ",cls:"bo",txt:"«Ноты.\nВ линиях рисунка —\nноты.»"},
                    {stage:true,txt:"Берёт невидимую трубу."},
                    {stage:true,txt:"Играет.\nНе одну ноту.\nМелодию. Полную."},
                    {pause:3,stage:true,txt:"Стены вибрируют.\nТеплеют."},
                    {spk:"ТРУБАЧ",cls:"bo",txt:"«400 лет —\nодна нота.\nИ вот.\nЦелая мелодия.»"},
                    {stage:true,txt:"Опускает трубу.\nУлыбается."},
                    {spk:"ТРУБАЧ",cls:"bo",txt:"«Не люблю прощания.\nЯ джазмен.\nМы просто\nперестаём играть.»"},
                    {stage:true,txt:"Тишина.\nОн ушёл.\nМелодия остаётся."},
                    {spk:"ERNIE",cls:"er",txt:"«Он играл 400 лет.\nОдну ноту.\nЖдал вторую.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Лика дала ему\nцелую мелодию.»"}
                ],function(){
                    saveNPC("trumpeter","Трубач");
                    showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}]);
                },null,I.trumpeter);
            }
function trumpPlay(){G.uc.tp=true;checkCombo("trumpeter");G.karma+=5;startD([{spk:"ERNIE",cls:"er",txt:"«Красиво.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Спасибо.»"},{spk:"ERNIE",cls:"er",txt:"«Это был сарказм.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Я знаю.\nНо за 200 лет\nпринимаю любые\nкомплименты.»"},{stage:true,txt:"Мелодия теплеет."},{pause:3,spk:"ТРУБАЧ",cls:"bo",txt:"«Какая у тебя\nлюбимая мелодия?»"},{pause:3,stage:true,txt:"Неважно что ответишь."},{stage:true,txt:"Он уже играет\nчто-то своё."},{pause:3,spk:"ТРУБАЧ",cls:"bo",txt:"«Это похоже.\nНемного.»",spd:40},{pause:3,stage:true,txt:"Замолкает.\nБольше не играет."},{spk:"ТРУБАЧ",cls:"bo",txt:"«Хочешь —\nсыграю твою любимую?»"},{spk:"ERNIE",cls:"er",txt:"«У меня нет\nлюбимой.»"},{stage:true,txt:"Трубач играет."},{pause:3,stage:true,txt:"ERNIE замолкает.\nДолго."},{spk:"ERNIE",cls:"er",txt:"«...Откуда ты\nеё знаешь?»",spd:40},{spk:"ТРУБАЧ",cls:"bo",txt:"«Башня помнит всё.\nДаже то,\nчто ты забыл.»"},{pause:3,stage:true,txt:"Кошка подходит\nк Трубачу.\nЛожится."},{spk:"ТРУБАЧ",cls:"bo",txt:"«Она помнит\nмелодию.\nЯ играл, когда...»"},{spk:"ERNIE",cls:"er",txt:"«Когда что, Трубач?»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Когда тот мальчик\nзашёл в башню.\nЯ играл на улице.\nОн остановился.\nСлушал 10 минут.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Сказал:\n«Дядя, когда вырасту,\nтоже хочу делать\nчто-то красивое.»»"},{pause:2,stage:true,txt:"Пауза."},{spk:"ТРУБАЧ",cls:"bo",txt:"«Он не вырос.»"},{pause:3,stage:true,txt:"ERNIE молчит."}],function(){updH();notify("🎵 Мелодия Трубача","gold");silenceTest(function(){G.karma+=5;updH();notify("🤫 Выдержал тишину","gold");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},function(){showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])})},null,I.trumpeter)}
            function trumpCat(){G.uc.tc=true;startD([{spk:"ТРУБАЧ",cls:"bo",txt:"«Эту? Нет.\nПохожую — да.\nУ того мальчика.\nРыжая.\nХодила за ним по пятам.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Когда он стал голосом...\nкошка бродила по башне.\nГоды.\nПотом исчезла.»"},{spk:"ERNIE",cls:"er",txt:"«Хватит, Трубач.»"},{spk:"ТРУБАЧ",cls:"bo",txt:"«Что, больно?\nЗначит, правда.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.trumpeter)}
            function openLamp(){sGl();
                // Кошка встреча — у фонаря
                var catLines=[];
                var catChoices=[];
                if(!G.hasCat && !G._catMet){
                    catLines=[
                        {stage:true,txt:"Тусклый фонарь.\nПод ним — что-то рыжее."},
                        {stage:true,txt:"Кошка.\nХудая. Один глаз не открывается."},
                        {stage:true,txt:"Смотрит на тебя.\nРешает."},
                        {stage:true,txt:"Подходит. Трётся о ногу.",fn:function(){sMeow()}},
                        {spk:"ERNIE",cls:"er",txt:"«Она не делала этого 200 лет.»",spd:40},
                        {stage:true,txt:"Под фонарём — записка и нож."}
                    ];
                    catChoices=[
                        {icon:"🐱",text:"Погладить кошку",fn:"catMeetPet()",id:"cmp"},
                        {icon:"📛",text:"Назвать её",fn:"catMeetName()",id:"cmn"},
                        {icon:"🔪",text:"Взять нож",fn:"lampKnife()",id:"lk"},
                        {icon:"🚶",text:"Уйти",fn:"back()",id:"bk"}
                    ];
                    G._catMet=true;
                } else {
                    catLines=[
                        {stage:true,txt:"Тусклый фонарь.\nПод ним — записка."},
                        {stage:true,txt:"«Тот кто читает это —\nуже внутри.\nВыход стоит дорого.»"},
                        {stage:true,txt:"Нож. Старый. Ржавый.\nНо острый."},
                        {spk:"ERNIE",cls:"er",txt:"«Не бери.»"}
                    ];
                    catChoices=[
                        {icon:"🔪",text:"Взять нож",fn:"lampKnife()",id:"lk"},
                        {icon:"🪢",text:"Потянуть верёвку",fn:"lampRope()",id:"lr"},
                        {icon:"📢",text:"Позвать на помощь",fn:"lampScream()",id:"ls",w:"forbidden"},
                        {icon:"🚶",text:"Уйти",fn:"back()",id:"bk"}
                    ];
                }
                startD(catLines,null,catChoices,I.cat)}

            function lampScream(){addDread(15);
                // ЗАПРЕЩЁННАЯ КНОПКА — наказание
                sShock();vibrate(300);flashDamage();
                document.body.style.filter="invert(1)";
                setTimeout(function(){document.body.style.filter=""},300);
                G.lives-=2;G.karma-=3;
                startD([
                    {stage:true,txt:"КРИК."},
                    {pause:2,stage:true,txt:"Твой."},
                    {pause:3,stage:true,txt:"Эхо возвращается.\nНо голос — не твой.\nГолосов — сотни."},
                    {pause:3,stage:true,txt:"Фонарь гаснет."},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Темнота.\nПолная.\n5 секунд.\n10."},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«ЗАЧЕМ.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Зачем ты это сделал.»"},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Теперь они знают\nчто ты здесь.\nВСЕ знают.»"},
                    {pause:3,stage:true,txt:"Фонарь загорается.\nМедленно."},
                    {stage:true,txt:"На стене —\nновая надпись.\nСвежая."},
                    {narr:true,txt:"«Зря позвал.»"},
                    {pause:3,stage:true,txt:"Почерк — твой.\nТы не писал."}
                ],function(){updH();notify("💀 -2♥ · Башня слышит","bad");addDiary("Позвал на помощь.\nПришла темнота.\nНа стене — мой почерк.\nЯ не писал.","letter",1);back()})
            }
            function lampKnife(){G.uc.lk=true;G.hasKnife=true;addItem("knife");startD([{stage:true,txt:"Берёшь.\nХолодный."},{spk:"ERNIE",cls:"er",txt:"«Зачем тебе нож\nв башне призраков?»"},{stage:true,txt:"Не отвечаешь."},{spk:"ERNIE",cls:"er",txt:"«...Ладно.\nНо я запомнил.»",spd:40}],function(){notify("🔪 Нож","gold");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.cat)}
            function lampRope(){G.uc.lr=true;startD([{stage:true,txt:"Тянешь."},{stage:true,txt:"Верёвка натягивается."},{stage:true,txt:"Где-то далеко —\nзвук."},{stage:true,txt:"Колокол."},{stage:true,txt:"Один удар."},{pause:3,stage:true,txt:"Тишина."},{spk:"ERNIE",cls:"er",txt:"«Что ты сделал?»"},{spk:"ERNIE",cls:"er",txt:"«Этот колокол...\nон не звонил 200 лет.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Теперь они знают\nчто ты здесь.»",spd:40},{spk:"ERNIE",cls:"er",txt:"«ВСЕ знают.»"}],function(){G._bellRung=true;AMBIENT_CHANCE=0.35;notify("🔔 Колокол прозвучал","bad");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.cat)}

            function showCatName(){$("gCh").innerHTML='<div style="text-align:center;padding:20px"><div style="font-family:Raleway,sans-serif;font-size:16px;color:var(--txt);margin-bottom:16px;font-style:italic">Как назовёшь?</div><input id="catNameIn" type="text" maxlength="12" placeholder="имя" style="background:var(--bg3);border:1px solid rgba(74,107,138,.15);color:var(--txt);font-size:18px;padding:10px 16px;border-radius:4px;text-align:center;width:160px;font-family:inherit;outline:none"><br><button style="margin-top:12px;padding:10px 24px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:14px;border-radius:4px;font-family:JetBrains Mono,monospace;letter-spacing:2px" onclick="nameCat()">назвать</button></div>';$("gCh").style.display="flex";$("gTop").style.display="none";$("gBotW").style.display="none"}
            function nameCat(){var n=$("catNameIn").value.trim();if(!n)return;G.catName=n;G.hasCat=true;var nl=n.toLowerCase();var isRyzhik=nl==="рыжик"||nl==="ryzhik";var isErnie=nl==="эрнест"||nl==="эрни"||nl==="ernie"||nl==="ernest";if(isErnie){startD([{pause:4,stage:true,txt:"ERNIE молчит."},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Ты...\nназвал кошку...\nмоим именем?»",spd:60},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Зачем?»",spd:60},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Я...»",spd:60},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Никто никогда\nне...»",spd:50},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»",spd:60,fn:function(){ernieTheme()}},{pause:3,spk:"ERNIE",cls:"er",txt:"«Она лучше меня\nзаслуживает\nэто имя.»",spd:40}],function(){G.karma+=10;G.trust+=3;updH();showCat();addDiary("Ты назвал кошку Эрнест.\nERNIE заплакал.\nПризраки не могут плакать.\nНо он пытался.","letter",1);notify("🐱 "+n+" ·","gold");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.cat)}else if(isRyzhik){startD([{pause:3,stage:true,txt:"ERNIE молчит."},{pause:3,stage:true,txt:"Долго."},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»",spd:60,fn:function(){ernieTheme()}},{pause:2,spk:"ERNIE",cls:"er",txt:"«И прости.»",spd:60}],function(){G.karma+=8;updH();showCat();notify("🐱 "+n+" ·","gold");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.cat)}else if(nl==="847"||nl==="848"){startD([{pause:3,stage:true,txt:"ERNIE замирает."},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Ты знаешь число.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Откуда?»",spd:60},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Неважно.\nНе называй кошку\nчислом мёртвых.»",spd:40},{pause:2,spk:"ERNIE",cls:"er",txt:"«Пожалуйста.»",spd:60}],function(){G.karma+=5;G.trust+=2;updH();showCat();notify("🐱 "+n+" ·","gold");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.cat)}else{startD([{spk:"ERNIE",cls:"er",txt:"«"+n+".»"},{pause:1,spk:"ERNIE",cls:"er",txt:"«Хорошее имя.»"},{stage:true,txt:n+" мурлычет.\nВпервые."}],function(){G.karma+=3;updH();showCat();notify("🐱 "+n,"gold");showCh([{icon:"🚪",text:"Назад",fn:"back()",id:"bk"}])},null,I.cat)}}
            function goF2() { fadeIn(function() { sI(I.city); startD([{stage:true,txt:"Бариста машет.\nЛика рисует."},{spk:"ERNIE",cls:"er",txt:"«Выше.»"}], function() { fadeIn(function() { goS("s2"); showDoorF(2,"ЭТАЖ 2 · ВОКЗАЛ НИКУДА",function() { fadeIn(function() { goS("sg"); startF2() }) }) }) }) }) }
            document.addEventListener("click", function() { iA() }, { once: true });document.addEventListener("touchstart", function() { iA() }, { once: true });document.addEventListener("visibilitychange",function(){if(document.hidden&&typeof DG!=="undefined"&&DG.active){DG._paused=true;DG.active=false}else if(!document.hidden&&typeof DG!=="undefined"&&DG._paused){DG._paused=false;DG.active=true}});

            // === SECRET KEYBOARD CODES ===
            var secretCode=[], konamiCheck=["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","b","a"];
            document.addEventListener("keydown",function(e){
                iA();
                secretCode.push(e.key);
                if(secretCode.length>10)secretCode.shift();
                if(JSON.stringify(secretCode)===JSON.stringify(konamiCheck)){
                    secretCode=[];
                    sChime();
                    notify("✦ ERNIE СЛЫШИТ ВСЕХ ✦ · Секретный режим активирован","gold");
                    setTimeout(function(){
                        G.karma+=5;G.lives=Math.min(7,G.lives+2);updH();
                        startD([{spk:"ERNIE",cls:"er",txt:"«...Ты нашёл код.»"},{spk:"ERNIE",cls:"er",txt:"«200 лет.\nНикто не нашёл.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Это что,\nигровая вещь?»"},{stage:true,txt:"ERNIE гуглит\n«Konami code»\nна призрачном\nтелефоне."},{spk:"ERNIE",cls:"er",txt:"«Ааа.\nВот значит как.»"},{spk:"ERNIE",cls:"er",txt:"«Ну держи\nбонус.\nЗаслужил.»"}],function(){updH()});
                    },500);
                }
                // Secret word: "башня"
                var recentKeys=secretCode.join("").toLowerCase();
                if(recentKeys.endsWith("башня")||recentKeys.endsWith("tower")){
                    secretCode=[];
                    catReact("alert");
                    notify("🏗 Башня слышит тебя.","gold");
                }
            });

            startAw();

            // === FLOOR 2: TRAIN STATION ===
            function startF2() { stopRain(); stopDrips(); setFx("shadow"); startMusic("station"); sTrainArrive(); G.currentFloor=2; updateProgress(2); sI(I.station); sF("ЭТАЖ 2 · ВОКЗАЛ НИКУДА"); startD([{pause:3,stage:true,txt:"Скрежет.\nТормоза.\nМеталл."},{stage:true,txt:"Поезд.\nС последним вздохом пара."},{spk:"ERNIE",cls:"er",txt:"Не садись в поезд.\nПожалуйста."}], function() { showF2Locs() }) }
            function showF2Locs() { updH(); stopRain(); $("gBotW").onclick=null;$("gTop").onclick=null;$("gImgW").onclick=null;$("gTap").style.display="none";$("gNav").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";sI(I.station);var ch=$("gCh");ch.innerHTML="";var w=document.createElement("div");w.className="g-locs";[{id:"train",i:"🚂",n:"Поезд",h:"кто-то внутри"},{id:"clock",i:"🕐",n:"Часы",h:"идут назад"},{id:"phone",i:"📞",n:"Телефон",h:"звонит"},{id:"wait",i:"🪑",n:"Зал ожидания",h:"тень на скамейке"},{id:"tent",i:"🥧",n:"Палатка",h:"крик и пирожки"}].forEach(function(l){var b=document.createElement("button");b.className="g-loc"+(G.vis[l.id]?" done":"");b.onclick=function(){openF2(l.id)};b.innerHTML='<span class="g-loc-i">'+l.i+'</span><span class="g-loc-n">'+l.n+'</span><span class="g-loc-h">'+l.h+'</span>';w.appendChild(b)});ch.appendChild(w);ch.style.display="flex";var cnt=0;["train","clock","phone","wait"].forEach(function(k){if(G.vis[k])cnt++});if(cnt>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 3 →","tryGoF2()") }
            function backF2(){showF2Locs();updH()}
            function openF2(id){if(G.vis[id])return;G.vis[id]=true;sS();if(id==="train")openTrain();else if(id==="clock")openClock();else if(id==="phone")openPhone();else if(id==="tent")openTent();else openWait()}
            function openTent(){sGl();startD([{stage:true,txt:"Палатка у перрона.\nЗапах пирожков.\nПризрачных, но настоящий."},{spk:"НОРА",cls:"bo",txt:"«ПИРОЖКИ!\nГОРЯЧИЕ!»"},{spk:"НОРА",cls:"bo",txt:"«О! ЖИВОЙ!\nСАДИСЬ! КУШАЙ!»"},{spk:"ERNIE",cls:"er",txt:"«Не ешь.»"},{spk:"НОРА",cls:"bo",txt:"«С чем хочешь?\nМясо, капуста, пустота?»"},{spk:"ERNIE",cls:"er",txt:"«Она 200 лет продаёт.\nНикто не покупает.»"},{spk:"НОРА",cls:"bo",txt:"«СВЕЖИЕ!\nТОЛЬКО ИСПЕКЛА!»"},{spk:"ERNIE",cls:"er",txt:"«В 1823 году.»"},{spk:"НОРА",cls:"bo",txt:"«КЛИЕНТ!\nНЕ МЕШАЙ!»"}],null,[{icon:"🥧",text:"Купить пирожок",fn:"tentBuy()",id:"tb2"},{icon:"💬",text:"«Секреты?»",fn:"marSecret()",id:"ms"},{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}],I.nora)}
            function tentBuy(){G.uc.tb2=true;G.karma+=1;startD([{stage:true,txt:"Берёшь пирожок."},{stage:true,txt:"Рука проходит\nсквозь него."},{stage:true,txt:"Ещё раз."},{stage:true,txt:"И ещё."},{spk:"НОРА",cls:"bo",txt:"«Кушай, кушай!\nВкусно?!»"},{spk:"ERNIE",cls:"er",txt:"«Ты не можешь\nего взять.\nОн призрачный.»"},{stage:true,txt:"Нора счастлива.\nСчитает невидимые\nмонеты."},{spk:"ERNIE",cls:"er",txt:"«Ты сделал её день.\nОна думает\nчто сейчас вторник\n1823 года.»"},{spk:"ERNIE",cls:"er",txt:"«Не будем\nеё расстраивать.»"}],function(){updH();showCh([{icon:"💬",text:"«Секреты?»",fn:"marSecret()",id:"ms"},{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.nora)}
            function marSecret(){G.uc.ms=true;startD([{spk:"НОРА",cls:"bo",txt:"«Секреты?\nМилый, я ВСЁ знаю.»"},{stage:true,txt:"Наклоняется.\nШёпотом."},{spk:"НОРА",cls:"bo",txt:"«Тень — не монстр.»"},{spk:"НОРА",cls:"bo",txt:"«Бывший голос башни.\n500 лет один.\nСошёл с ума.»"},{spk:"НОРА",cls:"bo",txt:"«ERNIE заменил его.\nТень хочет обратно.»"},{spk:"ERNIE",cls:"er",txt:"«...Откуда она знает?»"},{spk:"НОРА",cls:"bo",txt:"«Я торгую секретами,\nмилый.\nИ пирожками.\nНо секреты вкуснее.»"},{spk:"НОРА",cls:"bo",txt:"«А ещё я знаю\nчто Бариста\nне умеет варить кофе.»"},{spk:"НОРА",cls:"bo",txt:"«Он просто машет\nруками над туркой\nи надеется на лучшее.»"},{spk:"ERNIE",cls:"er",txt:"«...Это объясняет\nвкус.»"}],function(){addDiary("Тень — бывший голос башни.\n500 лет один. Сошёл с ума.\nERNIE заменил его.\nТень хочет обратно.","secret",2);notify("🥧 Секрет Тени","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.nora)}
            
            function trainSaveConductor(){
                startD([
                    {stage:true,txt:"Достаёшь билет.\nНастоящий."},
                    {spk:"КОНДУКТОР",cls:"ko",txt:"«...»"},
                    {spk:"КОНДУКТОР",cls:"ko",txt:"«Настоящий?»"},
                    {stage:true,txt:"Берёт. Руки дрожат.\nКомпостирует."},
                    {spk:"КОНДУКТОР",cls:"ko",txt:"«200 лет.\nПервый билет.»"},
                    {stage:true,txt:"Поезд гудит.\nВпервые — не уезжает.\nЖдёт."},
                    {spk:"КОНДУКТОР",cls:"ko",txt:"«Мне?\nМне можно сесть?»"},
                    {stage:true,txt:"Садится.\nДвери закрываются."},
                    {stage:true,txt:"Поезд уезжает.\nВпервые за 200 лет."},
                    {spk:"ERNIE",cls:"er",txt:"«...Он уехал.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Куда — не знаю.\nНо уехал.»"}
                ],function(){
                    var idx=G.items.indexOf("ticket");if(idx>=0)G.items.splice(idx,1);
                    saveNPC("conductor","Кондуктор");
                    showCh([{icon:"🚪",text:"Вернуться",fn:"backF2()",id:"bk"}]);
                },null,I.train_inside);
            }
function openTrain(){sGl();sI(I.train_inside);var intro=[{stage:true,txt:"Вагон. Пыльные сиденья.\nКто-то сидит — но когда\nсмотришь прямо, пусто."},{stage:true,txt:"В конце вагона — КОНДУКТОР.\nПризрак. Фуражка, компостер."}];if(TM.runs>1){intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«Опять ты.»"});intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«Проход №"+TM.runs+".\nЯ считал.»"});intro.push({spk:"ERNIE",cls:"er",txt:"«Ты всё считаешь.»"});intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«Это моя работа.\nСчитать.\nПассажиров.\nСекунды.\nРазочарования.»"})}else{intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«Билет.»"});intro.push({stage:true,txt:"Смотрит сквозь тебя."});intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«У вас нет билета.»"});intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«За 200 лет —\nни одного билета.»"});intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«Заткнись, голос.»"});intro.push({spk:"ERNIE",cls:"er",txt:"«Я ничего не сказал.»"});intro.push({spk:"КОНДУКТОР",cls:"ko",txt:"«Заткнись заранее.»"})}startD(intro,null,[{icon:"💬",text:"«Куда едет поезд?»",fn:"trainWhere()",id:"tw"},{icon:"🎫",text:"«Можно билет?»",fn:"trainTicket()",id:"tt"},{icon:"👋",text:"«Мне не нужен поезд.»",fn:"trainBye()",id:"tb"}],I.train_inside);setTimeout(function(){if(G.items.indexOf("ticket")>=0&&!G.saved.conductor){var btns=document.querySelectorAll(".g-cb");var last=btns[btns.length-1];if(last){var nb=last.cloneNode(true);nb.querySelector(".cb-icon").textContent="🎫";nb.childNodes[1].textContent="Отдать свой билет";nb.onclick=function(){trainSaveConductor()};last.parentNode.insertBefore(nb,last)}}},500);}
            function trainWhere(){G.uc.tw=true;G._trainN=(G._trainN||0)+1;startD([{spk:"КОНДУКТОР",cls:"ko",txt:"«Туда.»"},{stage:true,txt:"Указывает в стену."},{spk:"КОНДУКТОР",cls:"ko",txt:"«Или сюда.\nЗависит от расписания.»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«Расписание меняется\nкаждые 3 секунды.»"},{spk:"ERNIE",cls:"er",txt:"«Он считал. 200 лет.»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«2,104,000,000 раз.\nЯ веду учёт.»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«Знаешь, какой\nсейчас час?»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«Время пить чай.\nНо я не могу.\nРуки.»"},{spk:"ERNIE",cls:"er",txt:"«Призрачные.»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«Спасибо\nза напоминание.»"}],function(){trainRem()},null,I.conductor)}
            function trainTicket(){G.uc.tt=true;G._trainN=(G._trainN||0)+1;G.karma+=2;startD([{spk:"ERNIE",cls:"er",txt:"«Нет. Не бери.»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«Пожалуйста.\nМне нужно, чтобы\nкто-то ехал.»"},{stage:true,txt:"Мерцающий билет.\nНаписано: «ТУДА».\nВагон 8, место 47.\nОбратной стороны нет."},{spk:"ERNIE",cls:"er",txt:"«...Ладно.\nНо не используй его.»"}],function(){addItem("ticket");showItemPop("ticket");updH();notify("🎫 Билет «Туда» +2","gold");trainRem()},null,I.conductor)}
            function trainBye(){G.uc.tb=true;G._trainN=(G._trainN||0)+1;G.karma-=1;startD([{spk:"КОНДУКТОР",cls:"ko",txt:"«Всем нужен поезд.\nПросто не все знают.»"},{stage:true,txt:"Проверяет билеты у воздуха."}],function(){updH();trainRem()},null,I.conductor)}
            function trainRem(){G._trainN=G._trainN||0;var r=[];var maxCh=2;if(G._trainN<maxCh){if(!G.uc.tw)r.push({icon:"💬",text:"«Куда едет?»",fn:"trainWhere()",id:"tw"});if(!G.uc.tt&&!G.uc.tb)r.push({icon:"🎫",text:"«Билет?»",fn:"trainTicket()",id:"tt"});if(!G.uc.tb&&!G.uc.tt)r.push({icon:"👋",text:"«Не нужен.»",fn:"trainBye()",id:"tb"});}r.push({icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"});showCh(r)}
            function openClock(){startD([{stage:true,txt:"Часы. Огромные.\nСтрелки идут назад."},{spk:"ERNIE",cls:"er",txt:"«Не смотри долго.»"},{stage:true,txt:"Шёпот. Десятки голосов.\nВсе одновременно."},{spk:"ERNIE",cls:"er",txt:"«Те, кто был до тебя.\nИх слова застряли.»"},{spk:"ERNIE",cls:"er",txt:"«Однажды я пытался\nперевести их вперёд.\nВремя обиделось.»"},{spk:"ERNIE",cls:"er",txt:"«Часы показали\n13:00.\nНа часах 12 цифр.\nОни нашли 13-ю.»"},{spk:"ERNIE",cls:"er",txt:"«Из принципа.»"}],null,[{icon:"👂",text:"Прислушаться",fn:"clockListen()",id:"cl"},{icon:"🕐",text:"Перевести стрелки",fn:"clockPuzzle()",id:"cp"},{icon:"🔙",text:"Отойти",fn:"clockBack()",id:"cb2"}],I.clock)}
            function clockPuzzle(){
                G.uc.cp=true;
                startD([
                    {stage:true,txt:"Касаешься стрелок.\nОни останавливаются."},
                    {spk:"ERNIE",cls:"er",txt:"«Что ты делаешь?»"},
                    {stage:true,txt:"Циферблат мерцает.\nТри символа."},
                    {spk:"ERNIE",cls:"er",txt:"«Часы спрашивают.»"},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Когда ты\nбыл счастлив?»",spd:40}
                ],function(){
                    showCh([
                        {icon:"🌅",text:"Утро",fn:"clockChoice('morning')",id:"cm"},
                        {icon:"☀️",text:"День",fn:"clockChoice('day')",id:"cd"},
                        {icon:"🌙",text:"Ночь",fn:"clockChoice('night')",id:"cn"}
                    ])
                },null,I.clock)
            }
            function clockChoice(time){
                G.uc.clockTime=time;
                var resp;
                if(time==="morning"){
                    resp=[
                        {stage:true,txt:"Стрелки дёргаются.\nОстанавливаются на 7:00."},
                        {stage:true,txt:"Свет.\nЗапах каши.\nМамин голос\nиз кухни."},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Утро.\nКогда всё\nещё впереди.»"},
                        {pause:2,spk:"ERNIE",cls:"er",txt:"«Я тоже\nлюбил утро.»",spd:40},
                        {stage:true,txt:"Что-то выпадает\nиз часов.\nМаленькое. Тёплое."},
                        {narr:true,txt:"Осколок часов.\nТёплый, как память."}
                    ];
                    G.karma+=2;G.trust+=1;
                }else if(time==="day"){
                    resp=[
                        {stage:true,txt:"Стрелки дёргаются.\nОстанавливаются на 14:00."},
                        {stage:true,txt:"Школьный двор.\nСмех.\nМяч летит."},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«День.\nКогда ты не один.»"},
                        {pause:2,spk:"ERNIE",cls:"er",txt:"«Я не помню\nсвоих друзей.\nНикого.»",spd:40},
                        {stage:true,txt:"Часы гудят.\nЧто-то выпадает."},
                        {narr:true,txt:"Осколок часов.\nЗвенит, как смех."}
                    ];
                    G.karma+=2;
                }else{
                    resp=[
                        {stage:true,txt:"Стрелки дёргаются.\nОстанавливаются на 23:00."},
                        {stage:true,txt:"Одеяло. Тишина.\nКниги под фонариком.\nМир — только твой."},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Ночь.\nКогда никто\nне смотрит.»"},
                        {pause:2,spk:"ERNIE",cls:"er",txt:"«У меня\nвсегда ночь.\n200 лет.»",spd:40},
                        {stage:true,txt:"Часы замирают.\nЧто-то выпадает."},
                        {narr:true,txt:"Осколок часов.\nХолодный, как луна."}
                    ];
                    G.karma+=1;G.trust+=1;
                }
                startD(resp,function(){
                    updH();
                    notify("🕐 Часы запомнили","gold");
                    showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])
                },null,I.clock)
            }
            function clockListen(){G.uc.cl=true;startD([{narr:true,txt:"«...третий этаж...\nдверь справа...»"},{narr:true,txt:"«...не верь кондуктору...»"},{narr:true,txt:"«...мама? Мама, ты?..»"},{narr:true,txt:"«...ERNIE, пожалуйста,\nвыпусти...»"},{spk:"ERNIE",cls:"er",txt:"«Хватит.»"},{stage:true,txt:"Голоса обрываются."},{spk:"ERNIE",cls:"er",txt:"«Некоторые вещи\nлучше не слышать.»"},{stage:true,txt:"Но ты услышал:\nтретий этаж, дверь справа."}],function(){notify("🔮 Подсказка к этажу 3","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.clock)}
            function clockBack(){G.uc.cb2=true;startD([{stage:true,txt:"Стрелки идут назад."},{spk:"ERNIE",cls:"er",txt:"«Правильно.\nВремя тут — не друг.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.clock)}
            function openPhone(){startD([{stage:true,txt:"Телефонный автомат.\nСтарый. Красный."},{stage:true,txt:"Звонит."},{spk:"ERNIE",cls:"er",txt:"«Не бери.»"},{stage:true,txt:"Звонит."},{spk:"ERNIE",cls:"er",txt:"«Я серьёзно.\nНе бери трубку.»"},{stage:true,txt:"Звонит. Настойчиво."}],function(){G.phoneTimer=setTimeout(function(){if(!G.uc.pa&&!G.uc.pi){G.uc.pi=true;G.karma+=2;startD([{stage:true,txt:"Звонок затихает."},{stage:true,txt:"Сам."},{spk:"ERNIE",cls:"er",txt:"«Молодец.\nУ тебя крепкие нервы.»"},{spk:"ERNIE",cls:"er",txt:"«Большинство хватали\nтрубку на третьем\nзвонке.»"}],function(){updH();showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.phone)}},12000)},[{icon:"📞",text:"Взять трубку",fn:"phoneAnswer()",id:"pa"},{icon:"🚫",text:"Не брать",fn:"phoneIgnore()",id:"pi"}],I.phone)}
            function phoneAnswer(){if(G.phoneTimer)clearTimeout(G.phoneTimer);G.uc.pa=true;startD([{stage:true,txt:"Берёшь трубку."},{spk:"ERNIE",cls:"er",txt:"«НЕТ—»"},{stage:true,txt:"Тишина.\nПотом — знакомый голос."},{spk:"???",cls:"mm",txt:"«Сынок?»"},{stage:true,txt:"Мама.\nИли... звучит как мама."},{spk:"???",cls:"mm",txt:"«Ты где?\nЯ волнуюсь.»"},{spk:"ERNIE",cls:"er",txt:"«Это не она.\nПоложи трубку.»"},{spk:"???",cls:"mm",txt:"«Кто с тобой говорит?\nНе слушай его.»"},{spk:"ERNIE",cls:"er",txt:"«ПОЛОЖИ. ТРУБКУ.»"},{spk:"???",cls:"mm",txt:"«Он запер тебя.\nЯ могу помочь.\nСкажи, на каком этаже.»"},{stage:true,txt:"ERNIE молчит.\nВпервые — он боится."},{spk:"???",cls:"mm",txt:"«Сынок?..\nТы помнишь мой голос?»"},{stage:true,txt:"Трубка нагревается."},{spk:"ERNIE",cls:"er",txt:"«Брось. Сейчас.»"},{stage:true,txt:"Бросаешь.\nТрубка говорит,\nболтаясь на проводе."},{spk:"???",cls:"mm",txt:"«...я найду тебя...\nвсегда найду...»"},{stage:true,txt:"Голос затихает."},{spk:"ERNIE",cls:"er",txt:"«Это не твоя мама.»"},{spk:"ERNIE",cls:"er",txt:"«Башня умеет читать.\nНаходит то, что любишь.\nИ использует.»"}],function(){G.lives--;flashDamage();sDanger();updH();showCh([{icon:"🚪",text:"Уйти",fn:"backF2()",id:"bk"}])},null,I.phone)}
            function phoneIgnore(){if(G.phoneTimer)clearTimeout(G.phoneTimer);G.uc.pi=true;G.karma+=3;startD([{stage:true,txt:"Звонит. Звонит. Звонит."},{stage:true,txt:"Не берёшь."},{stage:true,txt:"Звонок прекращается."},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»"},{stage:true,txt:"Пауза."},{spk:"ERNIE",cls:"er",txt:"«Не всегда могу объяснить.\nНо спасибо,\nчто послушал.»"}],function(){updH();showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.phone)}
            function openWait(){var hasCat=G.hasCat;startD([{stage:true,txt:"Зал ожидания.\nСкамейки. Тусклый свет."},{stage:true,txt:"На скамейке — что-то."},{stage:true,txt:"Не призрак.\nПризраки светятся.\nЭто — поглощает свет."},{spk:"ERNIE",cls:"er",txt:"«Тень. Не подходи.»"}].concat(hasCat?[{stage:true,txt:(G.catName||"Кошка")+" шипит.\nШерсть дыбом.\nПрижимается к ноге."},{spk:"ERNIE",cls:"er",txt:"«"+(G.catName||"Кошка")+" чувствует. Уходи.»"}]:[]),null,[{icon:"👁",text:"Подойти к Тени",fn:"shadowGo()",id:"sg2"},{icon:"🚶",text:"Уйти",fn:"shadowLeave()",id:"sl"}],I.shadow)}
            function shadowGo(){G.uc.sg2=true;if(G.hasCat){startD([{stage:true,txt:"Шаг. Ещё шаг."},{stage:true,txt:"Тень поворачивается.\nНет лица. Но смотрит."},{stage:true,txt:"Кошка прыгает вперёд.\nШипит."},{stage:true,txt:"Тень отшатывается."},{spk:"ERNIE",cls:"er",txt:"«"+(G.catName||"Кошка")+" спасла тебя.»"},{stage:true,txt:"Тень рассеивается.\nНо на мгновение —\nв форме Тени\nмелькает силуэт.\nМальчик. Маленький.",fn:function(){sI(I.shadow_boy)}},{pause:3,spk:"ERNIE",cls:"er",txt:"«...»"},{spk:"ERNIE",cls:"er",txt:"«Это был\nпредыдущий проводник.\nДо меня.»"},{spk:"ERNIE",cls:"er",txt:"«500 лет один.\nЯ его заменил.\nОн стал... этим.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Через 500 лет\nя тоже стану\nтенью?»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Не отвечай.»",spd:40}],function(){notify("🐱 Кошка защитила!","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.shadow)}else{startD([{stage:true,txt:"Шаг. Ещё шаг."},{stage:true,txt:"Тень поворачивается.\nНет лица. Но смотрит."},{stage:true,txt:"Холод.\nДикий, невозможный."},{stage:true,txt:"Тень тянется к тебе."},{stage:true,txt:"ERNIE кричит —\nно ты не слышишь."},{stage:true,txt:"Темнота.\n...\nОчнулся. У двери."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Тень — это не монстр.\nЭто человек,\nкоторый забыл\nчто он человек.»"},{spk:"ERNIE",cls:"er",txt:"«Не злись на него.\nОн просто...\nодинок.»"},{spk:"ERNIE",cls:"er",txt:"«Как все тут.»"}],function(){G.lives--;flashDamage();sDanger();updH();showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.shadow)}}
            function shadowLeave(){G.uc.sl=true;startD([{stage:true,txt:"Отступаешь."},{spk:"ERNIE",cls:"er",txt:"«Тени — остатки.\nТех, кто не дошёл.»"},{spk:"ERNIE",cls:"er",txt:"«Не злые. Пустые.»"},{spk:"ERNIE",cls:"er",txt:"«Не становись\nодним из них.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF2()",id:"bk"}])},null,I.shadow)}
            function goF3(){stopRain();closeItemPop();fadeIn(function(){sI(I.station);startD([{stage:true,txt:"Вокзал позади."},{spk:"ERNIE",cls:"er",txt:"«Выше.»"}],function(){fadeIn(function(){goS("s2");showDoorF(3,"ЭТАЖ 3 · БИБЛИОТЕКА ЗАБЫТЫХ",function(){fadeIn(function(){goS("sg");startF3()})})})})})}

            // === FLOOR 3: LIBRARY ===
            function startF3(){setParticles("dust");stopRain();setFx("ghost");startDrips();catReact("sleep");ghostNotify(3);startMusic("library");G.currentFloor=3;updateProgress(3);sI(I.library);sF("ЭТАЖ 3 · БИБЛИОТЕКА ЗАБЫТЫХ");
                // Если имя ещё не спрошено — библиотекарь спрашивает
                if(G.playerName==="Странник"&&!G.uc._nameAsked){G.uc._nameAsked=true;askNameF3();return}var catSteal=G.hasCat&&G.items.indexOf("ticket")>=0&&!G.uc._catsteal;var intro=[{stage:true,txt:"Тишина.\nНастоящая тишина."},{pause:4,stage:true,txt:""},{pause:3,stage:true,txt:"ERNIE молчит."},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Извини.\nТут тихо.\nЯ забыл\nкак это — тихо.»",spd:40},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Библиотека.\nКаждая книга — чьё-то\nвоспоминание.»"},{spk:"ERNIE",cls:"er",txt:"«Некоторые пустые.\nНекоторые... кричат.»"},{spk:"ERNIE",cls:"er",txt:"«Не открывай всё подряд.»"},{pause:2,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Тут я впервые\nнаучился читать.\nТогда ещё — живой.»",spd:40},{pause:3,stage:true,txt:""}];if(catSteal){G.uc._catsteal=true;intro.push({stage:true,txt:(G.catName||"Кошка")+" хватает\nбилет из сумки."});intro.push({stage:true,txt:"Убегает."});intro.push({spk:"ERNIE",cls:"er",txt:"«Эй!»"});intro.push({stage:true,txt:"Бежит между полками.\nПрыгает на стол."});intro.push({spk:"ERNIE",cls:"er",txt:"«Верни.\nБилет.\nНемедленно.»"});intro.push({pause:2,stage:true,txt:(G.catName||"Кошка")+" роняет билет.\nНа голову Библиотекарю."});intro.push({spk:"БИБЛ.",cls:"bi",txt:"«Опять эта кошка.»"});intro.push({spk:"ERNIE",cls:"er",txt:"«Она делает это\nспециально.\nЯ уверен.»"});intro.push({stage:true,txt:"Подбираешь билет.\nМокрый.\nПризрачной слюной."});intro.push({spk:"ERNIE",cls:"er",txt:"«Не спрашивай\nоткуда у призрачной\nкошки слюна.»"})}
                // === DELAYED CONSEQUENCE: Cat choice ===
                if(G.uc.ignoredCat&&!G.uc._catEchoF3){
                    G.uc._catEchoF3=true;
                    intro.push({pause:4,stage:true,txt:""});
                    intro.push({stage:true,txt:"Между полками —\nчто-то рыжее."});
                    intro.push({pause:3,stage:true,txt:"Кошка.\nТа самая."});
                    intro.push({pause:3,stage:true,txt:"Не двигается."});
                    intro.push({pause:4,stage:true,txt:""});
                    intro.push({stage:true,txt:"Холодная."});
                    intro.push({pause:5,stage:true,txt:""});
                }
                startD(intro,function(){showF3Locs()})}
            function showF3Locs(){ updH();startPressure();$("gBotW").onclick=null;$("gTop").onclick=null;$("gImgW").onclick=null;$("gTap").style.display="none";$("gNav").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";sI(I.library);var ch=$("gCh");ch.innerHTML="";var w=document.createElement("div");w.className="g-locs";var locs=[{id:"reading",i:"📖",n:"Читальный зал",h:"кто-то за столом"},{id:"burned",i:"🔥",n:"Сожжённый отдел",h:"пепел и угли"},{id:"rdoor",i:"🚪",n:"Дверь справа",h:"та самая"},{id:"forbid",i:"🕸",n:"Запретная секция",h:"паутина"}];
            if(G.trust>=2&&!G.vis.ernie_corner){locs.push({id:"ernie_corner",i:"🕯",n:"Угол с книгами",h:"детский почерк"})}
            locs.forEach(function(l){var b=document.createElement("button");b.className="g-loc"+(G.vis[l.id]?" done":"");b.onclick=function(){openF3(l.id)};b.innerHTML='<span class="g-loc-i">'+l.i+'</span><span class="g-loc-n">'+l.n+'</span><span class="g-loc-h">'+l.h+'</span>';w.appendChild(b)});ch.appendChild(w);ch.style.display="flex";var cnt=0;["reading","burned","rdoor","forbid"].forEach(function(k){if(G.vis[k])cnt++});if(cnt>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 4 →","tryGoF3()")}
            function backF3(){rainIndoor(true);showF3Locs();updH()}
            function openF3(id){if(G.vis[id])return;G.vis[id]=true;sS();if(id==="reading")openReading();else if(id==="burned")openBurned();else if(id==="rdoor")openRDoor();else if(id==="ernie_corner")openErnieCorner();else openForbid()}
            function openErnieCorner(){G.trust+=1;sMemory();startD([{stage:true,txt:"Тихий угол.\nОгромная стопка книг."},{stage:true,txt:"На полу — подушка.\nПотёртая."},{stage:true,txt:"На книге сверху —\nдетский почерк:\n«Э.»"},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Это... моё место.»",spd:50},{spk:"ERNIE",cls:"er",txt:"«Тут я читал.\nКогда ещё не нужно\nбыло никого вести.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Книги не уходят.»",spd:40},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«В отличие от...»",spd:60},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Неважно.»",spd:40}],function(){updH();G.vis.ernie_corner=true;notify("🕯 Секретное место ERNIE","gold");showLetter(0,function(){showF3Locs()})},null,I.ernie_corner)}
            function openReading(){
                var dev=getDevice();
                var books=["«Как перестать быть призраком за 21 день»","«"+dev+": Руководство пользователя»","«847 рецептов одинокого бариста»","«Зеркала для начинающих»","«Кар: Автобиография»","«Башня: Жалобная книга (том 847)»","«Как приручить кошку, если ты прозрачный»"];
                var randomBook=books[Math.floor(Math.random()*books.length)];
                if(!G.uc._bookJoke){G.uc._bookJoke=true;setTimeout(function(){notify("📖 На полке: "+randomBook,"gold")},2000)}
                if(!G.uc._devBook){G.uc._devBook=true;setTimeout(function(){notify("📖 Книга: «"+dev+"». Последняя страница пуста.","gold")},3000)}sGl();var baristaHere=G.uc.cc||G.uc.cw;startD([{stage:true,txt:"Читальный зал.\nСвечи. Тишина."},{stage:true,txt:"За столом — БИБЛИОТЕКАРЬ.\nСтарая женщина.\nОчки, пучок, строгий взгляд."},{spk:"БИБЛ.",cls:"bi",txt:"«Тише.»"},{spk:"ERNIE",cls:"er",txt:"«Мы молчим.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Молчите громко.»"}].concat(baristaHere?[{stage:true,txt:"В углу — знакомая фигура.\nПротирает стакан."},{spk:"ERNIE",cls:"er",txt:"«Бариста?!\nТы работаешь\nна первом этаже!»"},{spk:"БАРИСТА",cls:"bo",txt:"«Перерыв.»"},{spk:"БИБЛ.",cls:"bi",txt:"«ТИШИНА\nВ БИБЛИОТЕКЕ!»"},{spk:"БАРИСТА",cls:"bo",txt:"«Я тихо протираю.»"},{spk:"ERNIE",cls:"er",txt:"«Как ты сюда попал?»"},{spk:"БАРИСТА",cls:"bo",txt:"«Двери.»"},{spk:"ERNIE",cls:"er",txt:"«Между этажами\nнет дверей.»"},{spk:"БАРИСТА",cls:"bo",txt:"«Тогда не знаю.\nЗагадка.»"},{stage:true,txt:"Протирает стакан."}]:[]).concat([{spk:"БИБЛ.",cls:"bi",txt:"«Новый читатель.\nДавно не было.»"},{spk:"ERNIE",cls:"er",txt:"«Она... безопасна.\nНаверное.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Наверное.\nМне нравится\nэто слово.»"}]),null,[{icon:"📖",text:"«Что за книги?»",fn:"readBooks()",id:"rb"},{icon:"💬",text:"«Вы знаете ERNIE?»",fn:"readErnie()",id:"re"},{icon:"👋",text:"Уйти",fn:"readBye()",id:"rby"}],I.librarian)}
            function readBooks(){G.uc.rb=true;startD([{spk:"БИБЛ.",cls:"bi",txt:"«Воспоминания.\nКаждый, кто был в башне,\nоставил книгу.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Некоторые — целые жизни.\nНекоторые — один день.»"},{stage:true,txt:"Достаёт книгу.\nНа обложке — твоё имя."},{spk:"БИБЛ.",cls:"bi",txt:"«Твоя. Пустая.\nТы ещё не написал\nсвою историю.»"},{spk:"ERNIE",cls:"er",txt:"«...Откуда она знает\nтвоё имя?»"},{spk:"БИБЛ.",cls:"bi",txt:"«Я знаю все имена.\nЭто моя работа.»"},{pause:3,stage:true,txt:"На самой верхней\nполке — книга.\nПыльная. Старая.\nОбложка — чёрная.\nБез названия."},{spk:"БИБЛ.",cls:"bi",txt:"«Не трогай.»"},{spk:"ERNIE",cls:"er",txt:"«Что в ней?»"},{spk:"БИБЛ.",cls:"bi",txt:"«Карты верхних\nэтажей.\nТех, что ПОД\nпервым.»"},{spk:"ERNIE",cls:"er",txt:"«Под первым\nнет этажей.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Есть.\nТолько не для\nпризраков.\nДля того,\nчто хуже.»"},{pause:2,spk:"БИБЛ.",cls:"bi",txt:"«Их называют\nпо-разному.\nДемоны.\nОсколки.\nТе-Кто-Внизу.»",spd:40},{spk:"ERNIE",cls:"er",txt:"«...Ты серьёзно?»"},{spk:"БИБЛ.",cls:"bi",txt:"«Я никогда\nне шучу.»"},{spk:"ERNIE",cls:"er",txt:"«Это правда.\nОна ни разу\nне шутила\nза 200 лет.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Книга закрыта.\nПока.»"}],function(){addItem("book");showItemPop("book");updH();addDiary("Библиотекарь: Под первым этажом есть другие. Демоны. Осколки. Те-Кто-Внизу.","demon",3);addDiary("Чёрная книга на верхней полке. Карты подземных этажей. Закрыта.","secret",3);notify("📖 Пустая книга","gold");readRem()},null,I.librarian)}
            function readErnie(){G.uc.re=true;startD([{spk:"БИБЛ.",cls:"bi",txt:"«Эрнест.»"},{stage:true,txt:"ERNIE молчит."},{spk:"БИБЛ.",cls:"bi",txt:"«14 лет.\n200 лет назад.\nХороший мальчик.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Плохие решения.»"},{spk:"ERNIE",cls:"er",txt:"«Мне было 14.\nУ всех в 14\nплохие решения.»"},{spk:"БИБЛ.",cls:"bi",txt:"«У тебя они были\nфатальные.»"},{spk:"ERNIE",cls:"er",txt:"«Спасибо.\nОчень помогаешь.»"},{pause:2,spk:"БИБЛ.",cls:"bi",txt:"«Он сжёг\nцелый отдел\nбиблиотеки.»"},{spk:"ERNIE",cls:"er",txt:"«Хватит.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Свои воспоминания.\nВсе до единого.\nЧтобы не помнить\nкак попал в башню.»"},{spk:"ERNIE",cls:"er",txt:"«Я СКАЗАЛ ХВАТИТ.»"},{pause:3,stage:true,txt:"Свечи мерцают.\nТишина."},{pause:3,stage:true,txt:""},{spk:"БИБЛ.",cls:"bi",txt:"«Пепел до сих пор\nна полу.\nЯ не подмела.\nНарочно.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Чтобы он помнил\nчто забыл.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Идём дальше.\nПожалуйста.»",spd:40}],function(){G.trust+=1;updH();addDiary("ERNIE сжёг свои воспоминания.\nВсе до единого.\nПепел до сих пор на полу.","lore",3);notify("🔥 Пепел","gold");readRem()},null,I.librarian)}
            function readBye(){G.uc.rby=true;startD([{spk:"БИБЛ.",cls:"bi",txt:"«Возвращайся.\nКниги ждут.»"}],function(){readRem()},null,I.librarian)}
            function readRem(){var r=[];if(!G.uc.rb)r.push({icon:"📖",text:"«Книги?»",fn:"readBooks()",id:"rb"});if(!G.uc.re)r.push({icon:"💬",text:"«Знаете ERNIE?»",fn:"readErnie()",id:"re"});if(!G.uc.rby)r.push({icon:"👋",text:"Уйти",fn:"readBye()",id:"rby"});if(!G.uc.br2&&(G.uc.rb||G.uc.re))r.push({icon:"🧩",text:"«Загадка?»",fn:"libRiddle()",id:"br2"});r.push({icon:"🚪",text:"Назад",fn:"backF3()",id:"bk"});showCh(r)}
            function libRiddle(){G.uc.br2=true;startD([{spk:"БИБЛ.",cls:"bi",txt:"«О.\nЛюбишь загадки.»"},{spk:"БИБЛ.",cls:"bi",txt:"«У меня тысячи книг.\nВ одной — правда.\nВ остальных — ложь.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Как отличить?»"}],function(){showRiddle("БИБЛИОТЕКАРЬ:\n«У меня 1000 книг.\nОдна — правда.\nОстальные — ложь.\nКак отличить?»",["📖 Прочитать все","🔥 Сжечь ложные","👃 По запаху"],2,function(){G.karma+=3;G.trust+=1;updH();notify("📚 Мудрость","gold")},function(){G.karma-=1;updH();notify("-1◆","bad")},function(win){startD(win?[{spk:"БИБЛ.",cls:"bi",txt:"«По запаху.\nПравда пахнет пылью.\nЛожь — типографской\nкраской.»"},{spk:"ERNIE",cls:"er",txt:"«Это бред.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Это поэзия.»"},{spk:"ERNIE",cls:"er",txt:"«Одно и то же.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Именно поэтому\nты никогда\nне сдашь книгу\nвовремя.»"},{spk:"ERNIE",cls:"er",txt:"«У меня нет рук!\nКак я верну книгу?!»"},{spk:"БИБЛ.",cls:"bi",txt:"«Отговорки.»"}]:[{spk:"БИБЛ.",cls:"bi",txt:"«Нет.\nПо запаху.\nНо не расстраивайся.\n847 до тебя\nтоже не угадали.»"},{spk:"ERNIE",cls:"er",txt:"«Я угадал.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Нет.\nТы подсмотрел.»"},{spk:"ERNIE",cls:"er",txt:"«...Справедливо.»"}],function(){readRem()},null,I.librarian)})})}
            function openBurned(){sI(I.ash_floor);startD([{stage:true,txt:"Обугленные полки.\nПепел. Запах гари."},{stage:true,txt:"Кто-то сжёг\nцелый раздел."},{spk:"ERNIE",cls:"er",txt:"«...»"},{stage:true,txt:"ERNIE молчит.\nВпервые — не комментирует."},{stage:true,txt:"На полу — обрывок.\nПолусгоревший дневник."}],null,[{icon:"📄",text:"Прочитать обрывок",fn:"burnRead()",id:"br"},{icon:"🚶",text:"Не трогать",fn:"burnLeave()",id:"bl"}],I.burned)}
            function burnRead(){G.uc.br=true;
                var pName=G.playerName||"Неизвестный";
                startD([
                    {stage:true,txt:"Открываешь.\nСтраницы рассыпаются.\nОсталось три."},
                    {pause:3,narr:true,txt:"«Субъект 847.\nДень 1.\nГолос назвал себя ERNIE.\nСмешной.»"},
                    {pause:3,narr:true,txt:"«День 4.\nБариста делает лучший\nкофе в мире.\nМёртвый бариста.\nЛучший кофе.\nАбсурд.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Не читай дальше.»"},
                    {pause:3,narr:true,txt:"«День 7.\nДевочка рисует.\nСказал — красивые рисунки.\nОна заплакала.\nОт радости.\nНикто не говорил\n200 лет.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Пожалуйста.\nНе читай.»",spd:40},
                    {pause:3,narr:true,txt:"«День 12. Этаж 10.\nДверь открыта.\nERNIE просит остаться.»"},
                    {pause:3,narr:true,txt:"«Я не могу.\nУ меня дома — мама.\nОна ждёт.»"},
                    {pause:4,stage:true,txt:"Последняя страница.\nПочерк дрожит."},
                    {pause:3,narr:true,txt:"«Простите.\nЯ не смог остаться.\nERNIE плакал.\nПризраки не плачут.\nНо он — плакал.»"},
                    {pause:4,stage:true,txt:""},
                    {pause:3,narr:true,txt:"«P.S. Кошку зовут "+(G.catName||"Мурка")+".\nОна выбрала меня.\nКак и тебя.»"},
                    {pause:4,stage:true,txt:"Почерк.\nТвой почерк.\nТочно твой."},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Они все\nпишут одинаково.»",spd:50},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Может, вы все —\nодин человек.\n847 раз по кругу.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Это не смешно.\nПочему я смеюсь.»"}
                ],function(){
                    addDiary("Дневник 847. Мой почерк.\nМоя кошка. Моя история.","secret",3);
                    G.karma+=3;updH();notify("📄 Дневник 847","gold");
                    showCh([{icon:"🚶",text:"Назад",fn:"backF3()",id:"bk"}])
                },null,I.burned)
            }
            function burnLeave(){G.uc.bl=true;G.karma+=2;startD([{stage:true,txt:"Оставляешь дневник."},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»"},{spk:"ERNIE",cls:"er",txt:"«Некоторые вещи\nдолжны остаться\nсожжёнными.»"}],function(){updH();showCh([{icon:"🚪",text:"Назад",fn:"backF3()",id:"bk"}])},null,I.burned)}
            function openRDoor(){sI(I.ernie_corner);startD([{stage:true,txt:"Дверь справа.\nТа самая, про которую\nшептали часы."},{stage:true,txt:"Маленькая комната.\nПыль. Свеча."},{stage:true,txt:"На стене — фотография.\nМальчик, 14 лет.\nСтоит у башни."},{spk:"ERNIE",cls:"er",txt:"«...»"},{stage:true,txt:"Это ERNIE.\nЖивой. Настоящий.\nУлыбается."},{spk:"ERNIE",cls:"er",txt:"«Не помню эту улыбку.»"},{stage:true,txt:"Рядом — второй человек.\nВзрослый. Лицо стёрто."}],null,[{icon:"❓",text:"«Кто рядом с тобой?»",fn:"doorAsk()",id:"da"},{icon:"📷",text:"Взять фото",fn:"doorTake()",id:"dt"},{icon:"🚶",text:"Уйти",fn:"doorLeave()",id:"dl3"}],I.door_room)}
            function doorAsk(){G.uc.da=true;startD([{spk:"ERNIE",cls:"er",txt:"«Не знаю.»"},{spk:"ERNIE",cls:"er",txt:"«Не помню.»"},{spk:"ERNIE",cls:"er",txt:"«Башня стирает.\nСначала лица.\nПотом имена.\nПотом — всё.»"},{stage:true,txt:"Пауза."},{spk:"ERNIE",cls:"er",txt:"«Я не помню\nсвоё настоящее имя.\nЭрнест — это...\nпридумано.»"}],function(){notify("💔 Имя стёрто","gold");doorRem()},null,I.door_room)}
            function doorTake(){G.uc.dt=true;G.karma+=2;startD([{stage:true,txt:"Берёшь фото."},{spk:"ERNIE",cls:"er",txt:"«Зачем тебе?»"},{stage:true,txt:"Молчишь."},{spk:"ERNIE",cls:"er",txt:"«...Ладно.\nМожет, кому-то нужно\nпомнить за меня.»"}],function(){addItem("photo");showItemPop("photo");updH();notify("📷 Фото ERNIE +2","gold");doorRem()},null,I.door_room)}
            function doorLeave(){G.uc.dl3=true;startD([{stage:true,txt:"Закрываешь дверь."},{spk:"ERNIE",cls:"er",txt:"«Спасибо.»"}],function(){doorRem()},null,I.door_room)}
            function doorRem(){var r=[];if(!G.uc.da)r.push({icon:"❓",text:"«Кто рядом?»",fn:"doorAsk()",id:"da"});if(!G.uc.dt)r.push({icon:"📷",text:"Взять фото",fn:"doorTake()",id:"dt"});if(!G.uc.dl3)r.push({icon:"🚶",text:"Уйти",fn:"doorLeave()",id:"dl3"});r.push({icon:"🚪",text:"Назад",fn:"backF3()",id:"bk"});showCh(r)}
            function openForbid(){ sI(I.demon_book);sI(I.demon_book);startD([{stage:true,txt:"Запретная секция.\nПаутина. Книги шевелятся."},{spk:"ERNIE",cls:"er",txt:"«Осторожно.\nНе все книги безобидны.»"},{stage:true,txt:"Одна книга на столе.\nСветится жёлтым.\nМанит."}],null,[{icon:"📖",text:"Открыть книгу",fn:"forbidOpen()",id:"fo"},{icon:"🚶",text:"Не трогать",fn:"forbidLeave()",id:"fl"}],I.forbidden)}
            function forbidOpen(){G.uc.fo=true;var hasTicket=G.items.indexOf("ticket")>=0;if(hasTicket){startD([{stage:true,txt:"Открываешь."},{stage:true,txt:"КРИК.\nКнига орёт.\nСтраницы хватают."},{stage:true,txt:"Билет в кармане\nвспыхивает."},{stage:true,txt:"Огонь поглощает крик.\nКнига замолкает."},{spk:"ERNIE",cls:"er",txt:"«Билет...\nон защитил тебя.»"},{stage:true,txt:"Билет сгорел.\nНо на последней странице\nкниги — слова:"},{narr:true,txt:"«Смотритель на 5-м этаже\nзнает выход.\nНо он не скажет.»"}],function(){var idx=G.items.indexOf("ticket");G.items.splice(idx,1);updH();notify("🎫→🔥 Билет сгорел · подсказка","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF3()",id:"bk"}])},null,I.forbidden)}else{startD([{stage:true,txt:"Открываешь."},{stage:true,txt:"КРИК.\nКнига орёт.\nСтраницы хватают."},{stage:true,txt:"Боль. Холод.\nКнига питается тобой."},{spk:"ERNIE",cls:"er",txt:"«ЗАКРОЙ ЕЁ!»"},{stage:true,txt:"Захлопываешь.\nРуки дрожат."},{spk:"ERNIE",cls:"er",txt:"«Я предупреждал.»"}],function(){G.lives--;flashDamage();sDanger();updH();showCh([{icon:"🚪",text:"Назад",fn:"backF3()",id:"bk"}])},null,I.forbidden)}}
            function forbidLeave(){G.uc.fl=true;G.karma+=1;startD([{stage:true,txt:"Проходишь мимо.\nКнига пульсирует."},{spk:"ERNIE",cls:"er",txt:"«Умно.\nНе всё нужно\nоткрывать.»"}],function(){updH();showCh([{icon:"🚪",text:"Назад",fn:"backF3()",id:"bk"}])},null,I.forbidden)}
            function goF4(){document.body.classList.add("ernie-fading");fadeIn(function(){sI(I.library);startD([{spk:"ERNIE",cls:"er",txt:"«Библиотека позади.»"},{spk:"БИБЛ.",cls:"bi",txt:"«Возвращайся.»",fn:function(){ernieTheme()}},{spk:"ERNIE",cls:"er",txt:"«Подожди.»"},{stage:true,txt:"ERNIE замолкает.\nНепривычно долго."},{spk:"ERNIE",cls:"er",txt:"«Хочу кое-что спросить.\nНе для башни.\nДля себя.»"}],function(){showRiddle("ERNIE:\n«У меня нет тела,\nно я устаю.\nУ меня нет глаз,\nно я вижу тебя.\nУ меня нет сердца,\nно мне больно.\nКто я?»",["👻 Призрак","🗣 Голос","🏚 Башня"],0,function(){G.trust+=2;G.karma+=3;updH();},function(){G.karma-=1;updH();},function(win){startD(win?[{spk:"ERNIE",cls:"er",txt:"«...Да.»"},{spk:"ERNIE",cls:"er",txt:"«Призрак.»"},{stage:true,txt:"Пауза."},{spk:"ERNIE",cls:"er",txt:"«Ты первый,\nкто ответил правильно.»"},{spk:"ERNIE",cls:"er",txt:"«847 до тебя.\nНикто не понял.»"},{stage:true,txt:"Что-то меняется\nв его голосе.\nТеплее."}]:[{spk:"ERNIE",cls:"er",txt:"«...Нет.»"},{stage:true,txt:"Молчание."},{spk:"ERNIE",cls:"er",txt:"«Ладно.\nНеважно.»"},{stage:true,txt:"Но ты чувствуешь —\nважно."}],function(){fadeIn(function(){goS("s2");showDoorF(4,"ЭТАЖ 4 · ТЕАТР МАСОК",function(){fadeIn(function(){goS("sg");startF4()})})})},null,I.library)})})})}

            // === FLOOR 4: THEATER ===
            function startF4(){setParticles("ember");stopRain();stopDrips();setFx("flicker");startMusic("theater");G.currentFloor=4;updateProgress(4);sI(I.theater);sF("ЭТАЖ 4 · ТЕАТР МАСОК");ravenNotify(4);ghostNotify(4);startD([{spk:"ERNIE",cls:"er",txt:"Театр.\nОдин актёр остался.\n200 лет играет Гамлета.\nЗал пуст."},{spk:"ERNIE",cls:"er",txt:"Маски на стенах.\nОни помнят лица."},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Мама... любила театр.»",spd:50},{pause:5,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«~~Она приходила каждое воскресенье и~~»",spd:35,del:true},{pause:2,spk:"ERNIE",cls:"er",txt:"«Не важно.»",spd:40}],function(){
                    // Ложный Game Over — один раз
                    if(!G._fakeGO){
                        G._fakeGO=true;
                        stopMusic();stopHeartbeat();
                        var fake=document.createElement("div");
                        fake.style.cssText="position:fixed;inset:0;background:#000;z-index:700;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 1.5s";
                        var t=document.createElement("div");
                        t.style.cssText="font-family:Raleway,sans-serif;font-size:14px;color:rgba(176,80,80,.6);text-align:center;letter-spacing:2px";
                        t.textContent="СВЯЗЬ ПОТЕРЯНА";
                        fake.appendChild(t);document.body.appendChild(fake);
                        setTimeout(function(){fake.style.opacity="1"},50);
                        // 5 секунд молчания — потом ERNIE шепчет
                        setTimeout(function(){
                            t.style.transition="all 2s";t.style.opacity="0";
                            setTimeout(function(){
                                t.style.color="rgba(200,168,72,.4)";
                                t.style.fontSize="12px";
                                t.style.fontStyle="italic";
                                t.textContent="«Ещё нет.»";
                                t.style.opacity="1";
                                ernieThree();
                            },1500);
                            setTimeout(function(){
                                fake.style.opacity="0";
                                setTimeout(function(){fake.remove();startMusic("theater");showF4Locs()},1500);
                            },4000);
                        },5000);
                        return;
                    }
                    showF4Locs()
                })}
            function showF4Locs(){ updH();startPressure();$("gBotW").onclick=null;$("gTop").onclick=null;$("gImgW").onclick=null;$("gTap").style.display="none";$("gNav").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";sI(I.theater);var ch=$("gCh");ch.innerHTML="";var w=document.createElement("div");w.className="g-locs";[{id:"stage",i:"🎭",n:"Сцена",h:"кто-то играет"},{id:"mirror",i:"💄",n:"Гримёрка",h:"зеркало"},{id:"seats",i:"🎪",n:"Зрительный зал",h:"аплодисменты"},{id:"pit",i:"🎵",n:"Оркестровая яма",h:"музыка"},{id:"alisa",i:"📚",n:"Уютная комната",h:"смех"}].forEach(function(l){var b=document.createElement("button");b.className="g-loc"+(G.vis[l.id]?" done":"");b.onclick=function(){openF4(l.id)};b.innerHTML='<span class="g-loc-i">'+l.i+'</span><span class="g-loc-n">'+l.n+'</span><span class="g-loc-h">'+l.h+'</span>';w.appendChild(b)});ch.appendChild(w);ch.style.display="flex";var cnt=0;["stage","mirror","seats","pit"].forEach(function(k){if(G.vis[k])cnt++});if(cnt>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 5 →","tryGoF4()")}
            function backF4(){rainIndoor(true);showF4Locs();updH()}
            function openF4(id){if(G.vis[id])return;G.vis[id]=true;sS();if(id==="stage")openStage();else if(id==="mirror")openMirror();else if(id==="seats")openSeats();else if(id==="alisa")openAlisa();else openPit()}
            function openStage(){sGl();var intro;if(TM.runs>1&&TM.bestFloor>=4){intro=[{stage:true,txt:"Сцена. Луч прожектора.\nПустое кресло."},{stage:true,txt:"Актёр уже на сцене.\nЖдёт."},{spk:"АКТЁР",cls:"ak",txt:"«А.\nВозвращение\nглавного героя.»"},{spk:"АКТЁР",cls:"ak",txt:"«Второй акт.\nСамый сложный.\nВсе знают\nчем кончится.»"},{spk:"ERNIE",cls:"er",txt:"«Откуда ты\nзнаешь что он\nбыл тут раньше?»"},{spk:"АКТЁР",cls:"ak",txt:"«Актёр всегда\nчувствует зрителя.»"},{spk:"АКТЁР",cls:"ak",txt:"«Этот — плакал\nна финале.\nИли смеялся.\nУ меня плохое\nзрение.»"}]}else{intro=[{stage:true,txt:"Сцена. Луч прожектора.\nПустое кресло."},{stage:true,txt:"Фигура выходит из-за\nкулис. Полупрозрачная."},{stage:true,txt:"АКТЁР. Лицо меняется\nкаждые несколько секунд.\nРадость. Гнев. Скорбь."},{spk:"АКТЁР",cls:"ak",txt:"«Зритель!\nНаконец-то!»"},{spk:"АКТЁР",cls:"ak",txt:"«Быть или не быть —\nвот в чём...\nв чём...»"},{stage:true,txt:"Забыл. Опять."},{spk:"ERNIE",cls:"er",txt:"«Он не опасен.\nПросто потерянный.»"}]}startD(intro,null,[{icon:"👏",text:"Аплодировать",fn:"stageClap()",id:"sc"},{icon:"🎭",text:"«Какое лицо настоящее?»",fn:"stageFace()",id:"sf"},{icon:"📝",text:"Подсказать реплику",fn:"stagePrompt()",id:"sp"},{icon:"🎬",text:"«Сыграем вместе»",fn:"stagePlay()",id:"spl"},{icon:"👋",text:"Уйти",fn:"stageBye()",id:"sb4"}],I.actor)}
            function stagePrompt(){
                G.uc.sp=true;
                startD([
                    {spk:"АКТЁР",cls:"ak",txt:"«Ты знаешь\nпоследнюю строку?!»"},
                    {stage:true,txt:"Лицо замирает.\nОдно.\nНадежда."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Монолог кончается\nсловами...\nсловами...»"},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Он ищет это\n200 лет.»"}
                ],function(){
                    showCh([
                        {icon:"💀",text:"«Конец.»",fn:"stageReply('end')",id:"sr1"},
                        {icon:"💡",text:"«Начало.»",fn:"stageReply('begin')",id:"sr2"},
                        {icon:"❤️",text:"«Прости.»",fn:"stageReply('sorry')",id:"sr3"}
                    ,{icon:"🎪",text:"Выйти на сцену",fn:"actorPullOnStage()",id:"aps"}])
                },null,I.actor)
            }
            function stageReply(r){
                // Нет правильного ответа — все "неправильные"
                var actorResp=[
                    {pause:2,stage:true,txt:"Актёр замолкает."},
                    {pause:3,stage:true,txt:"Лицо дрожит."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Нет.»"},
                    {pause:2,spk:"АКТЁР",cls:"ak",txt:"«Не то.»",spd:50},
                    {pause:3,stage:true,txt:"Садится на сцену.\nПрямо в луч прожектора."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Не то.\nНикогда не то.»",spd:40},
                    {pause:3,stage:true,txt:"Плачет.\nБез слёз.\nПризраки не могут."}
                ];
                if(r==="sorry"){
                    actorResp.push({pause:3,spk:"АКТЁР",cls:"ak",txt:"«Прости...»"});
                    actorResp.push({pause:2,stage:true,txt:"Встаёт."});
                    actorResp.push({spk:"АКТЁР",cls:"ak",txt:"«Это оно.\nВсё это время —\nодно слово.»"});
                    actorResp.push({stage:true,txt:"Кланяется.\nГлубоко."});
                    actorResp.push({stage:true,txt:"Аплодисменты.\nИз ниоткуда.\nГромкие."});
                    actorResp.push({stage:true,txt:"Прожектор гаснет.\nАктёр исчезает.\nС улыбкой."});
                    actorResp.push({spk:"ERNIE",cls:"er",txt:"«Он доиграл.\nНаконец.»"});
                    G._actorSaved=true;
                    G.karma+=2;
                }else{
                    actorResp.push({pause:3,spk:"ERNIE",cls:"er",txt:"«Он 200 лет\nищет слова.\nМожет их\nпросто нет.»"});
                    actorResp.push({spk:"ERNIE",cls:"er",txt:"«Не всё\nможно починить.»",spd:40});
                }
                actorResp.push({stage:true,txt:"Прожектор гаснет.\nТихо."});
                startD(actorResp,function(){
                    updH();
                    if(G._actorSaved){saveNPC("actor","Актёр")}
                    else{addItem("mask");showItemPop("mask");notify("🎭 Маска Актёра","gold")}
                    showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])
                },null,I.actor)
            }

            function stagePlay(){G.uc.spl=true;G._stageN=(G._stageN||0)+1;
                startD([
                    {spk:"АКТЁР",cls:"ak",txt:"«Вместе?!\n200 лет!\nНикто не предлагал!»"},
                    {spk:"АКТЁР",cls:"ak",txt:"«У меня есть пьеса.\nНенаписанная.\nПро мальчика.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Нет.»"},
                    {spk:"АКТЁР",cls:"ak",txt:"«Акт первый.\nМальчик входит в башню.\n14 лет. Улыбается.»"},
                    {stage:true,txt:"Прожектор.\nТень на сцене.\nМаленькая. Худая."},
                    {spk:"ERNIE",cls:"er",txt:"«Хватит.»",spd:40},
                    {spk:"АКТЁР",cls:"ak",txt:"«Акт второй.\nГод. Двери заперты.\nМальчик кричит.\nСначала громко.\nПотом — тихо.\nПотом — перестаёт.»",spd:35},
                    {spk:"ERNIE",cls:"er",txt:"«ЗАМОЛЧИ.»"},
                    {pause:3,stage:true,txt:"Тишина."},
                    {spk:"АКТЁР",cls:"ak",txt:"«Акт третий.\nМальчик — голос.\nНет рук. Ног. Лица.\nШутит.\nЧтобы не думать.»",spd:35},
                    {pause:3,spk:"АКТЁР",cls:"ak",txt:"«Каждый раз надеется —\nэтот останется.»",spd:40},
                    {spk:"АКТЁР",cls:"ak",txt:"«Никто не остаётся.»",spd:50},
                    {pause:4,stage:true,txt:""},
                    {spk:"АКТЁР",cls:"ak",txt:"«Конец пьесы.\nОна не закончена.\nТретий акт — всё ещё идёт.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Зачем ты это сделал.»",spd:40},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Это моя история.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Ты не имел права.»",spd:35},
                    {pause:3,spk:"АКТЁР",cls:"ak",txt:"«Имел. Я актёр.\nИстории — всё что есть.\nИ эта — лучшая.\nПотому что настоящая.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Мне было 14.\nЯ не улыбался. Я плакал.»",spd:40},
                    {spk:"АКТЁР",cls:"ak",txt:"«Знаю.\nНо в пьесе —\nулыбался.\nТак красивее.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Спасибо.\nЗа улыбку.»",spd:60},
                    {pause:3,stage:true,txt:"Маски на стенах\nплачут.\nВсе одновременно."}
                ],function(){G.trust+=3;G.karma+=5;updH();addDiary("Актёр сыграл историю ERNIE.\nМальчик 14 лет. Не улыбался.\nАктёр дал ему улыбку.","letter",4);notify("🎭 Пьеса ERNIE","gold");stageRem()},null,I.actor)
            }
            function stageClap(){G.uc.sc=true;G._stageN=(G._stageN||0)+1;G.karma+=3;startD([{stage:true,txt:"Хлопаешь."},{stage:true,txt:"Один раз. Два.\nЭхо заполняет зал."},{spk:"АКТЁР",cls:"ak",txt:"«НАКОНЕЦ!\nПУБЛИКА!»"},{spk:"АКТЁР",cls:"ak",txt:"«БЫТЬ ИЛИ НЕ—»"},{spk:"ERNIE",cls:"er",txt:"«Нет, нет,\nне надо—»"},{spk:"АКТЁР",cls:"ak",txt:"«О РОМЕО—»"},{spk:"ERNIE",cls:"er",txt:"«Это другая пьеса—»"},{spk:"АКТЁР",cls:"ak",txt:"«Критики.»"},{spk:"АКТЁР",cls:"ak",txt:"«Хорошо.\nМонолог.\nСвой.»"},{pause:2,spk:"АКТЁР",cls:"ak",txt:"«Я стою на сцене\n200 лет.\nЗал пустой.\nЛожа пустая.\nБуфет... тоже пустой.»"},{spk:"АКТЁР",cls:"ak",txt:"«Это хуже\nчем плохие отзывы.»"},{spk:"АКТЁР",cls:"ak",txt:"«Плохие отзывы —\nзначит кто-то\nсмотрел.»"},{spk:"ERNIE",cls:"er",txt:"«Я смотрел.\nКаждый день.\n200 лет.»"},{spk:"АКТЁР",cls:"ak",txt:"«Ты не считаешься.\nТы обязан.»"},{spk:"ERNIE",cls:"er",txt:"«Справедливо.»"},{pause:2,stage:true,txt:"Маски на стенах\nна мгновение улыбаются."},{spk:"АКТЁР",cls:"ak",txt:"«200 лет.\nОдин зритель —\nдостаточно.»"},{stage:true,txt:"Кланяется.\nСвет ярче."},{spk:"ERNIE",cls:"er",txt:"«Ему нужен был\nодин зритель.\nТы — достаточно.»"},{stage:true,txt:"Актёр растворяется\nв свете прожектора.\nУлыбается."}],function(){updH();notify("👏 Овации +3","gold");stageRem()},null,I.actor)}
            function stageFace(){sI(I.actor_real);G.uc.sf=true;G._stageN=(G._stageN||0)+1;startD([{spk:"АКТЁР",cls:"ak",txt:"«Настоящее?»"},{stage:true,txt:"Лицо замирает.\nВсе маски одновременно."},{spk:"АКТЁР",cls:"ak",txt:"«Я не помню.»"},{pause:3,spk:"АКТЁР",cls:"ak",txt:"«Был мальчик.\nПотом актёр.\nПотом — маски.»"},{spk:"АКТЁР",cls:"ak",txt:"«Маски стали мной.\nИли я стал ими.»"},{pause:2,spk:"АКТЁР",cls:"ak",txt:"«Знаешь самое страшное\nв масках?»"},{spk:"АКТЁР",cls:"ak",txt:"«Не то что ты\nзабываешь лицо.»"},{pause:3,spk:"АКТЁР",cls:"ak",txt:"«А то что лицу\nбольно\nкогда ты пытаешься\nего вспомнить.»",spd:40},{pause:3,stage:true,txt:"Молчание."},{spk:"ERNIE",cls:"er",txt:"«...Знакомо.»"},{spk:"АКТЁР",cls:"ak",txt:"«Конечно знакомо.\nТвой проводник\nтоже носит маску.\nТолько его —\nневидимая.»"},{spk:"ERNIE",cls:"er",txt:"«Хватит.»"},{spk:"АКТЁР",cls:"ak",txt:"«Он притворяется\nчто не боится.\nЧто шутит —\nпотому что смешно.\nА не потому что\nиначе — сломается.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Я сказал хватит.»",spd:40},{pause:3,stage:true,txt:"Актёр улыбается.\nВсеми масками\nодновременно."},{spk:"АКТЁР",cls:"ak",txt:"«Видишь?\nДаже сейчас —\nмаска.»"}],function(){notify("🎭 Маска ERNIE","gold");stageRem()},null,I.actor)}
            function stageBye(){G.uc.sb4=true;G._stageN=(G._stageN||0)+1;G.karma-=1;startD([{spk:"АКТЁР",cls:"ak",txt:"«Уже?\nНо третий акт...»"},{stage:true,txt:"Опускает голову.\nСвет гаснет."},{spk:"ERNIE",cls:"er",txt:"«...»"}],function(){updH();stageRem()},null,I.actor)}
            function stageRem(){G._stageN=G._stageN||0;var r=[];var maxCh=2;if(G._stageN<maxCh){if(!G.uc.sc)r.push({icon:"👏",text:"Аплодировать",fn:"stageClap()",id:"sc"});if(!G.uc.sf)r.push({icon:"🎭",text:"«Настоящее лицо?»",fn:"stageFace()",id:"sf"});if(!G.uc.sb4)r.push({icon:"👋",text:"Уйти",fn:"stageBye()",id:"sb4"});}r.push({icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"});showCh(r)}
            function openMirror(){startD([{stage:true,txt:"Гримёрка.\nСтарый столик. Пудра. Маски."},{stage:true,txt:"Зеркало.\nТреснутое, но целое."},{spk:"ERNIE",cls:"er",txt:"«Не смотри.»"},{stage:true,txt:"Но ты уже смотришь."},{stage:true,txt:"Отражение — ты.\nНо старый. Седой.\n50 лет в башне."}],null,[{icon:"👁",text:"Смотреть дальше",fn:"mirrorLook()",id:"ml"},{icon:"🔙",text:"Отвернуться",fn:"mirrorBack()",id:"mb4"}],I.mirror)}
            function mirrorLook(){sI(I.mirror_corridor);G.uc.ml=true;if(G.hasCat){startD([{stage:true,txt:"Смотришь.\nОтражение шевелит губами."},{stage:true,txt:"Кошка прыгает\nна столик."},{stage:true,txt:"УДАР.\nЗеркало разбивается."},{spk:"ERNIE",cls:"er",txt:"«Кошка знает лучше.»"},{stage:true,txt:"В осколках —\nтвоё настоящее лицо.\nМолодое."},{spk:"ERNIE",cls:"er",txt:"«Башня показывает\nне будущее.\nОна показывает страх.»"}],function(){notify("🐱 Кошка разбила зеркало","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.mirror)}else{startD([{stage:true,txt:"Смотришь.\nОтражение шевелит губами."},{stage:true,txt:"Шепчет:\n«Ты не выйдешь.»"},{stage:true,txt:"Присмотрись.\nОтражение —\nне твоё.\nМоложе.\n14 лет."},{pause:3,stage:true,txt:"Это ERNIE.\nЭто ты.\nРазницы нет."},{stage:true,txt:"Холод.\nОтражение улыбается.\nТы — нет."},{spk:"ERNIE",cls:"er",txt:"«Я СКАЗАЛ НЕ СМОТРИ.»"},{stage:true,txt:"Отворачиваешься.\nНо ощущение — осталось."}],function(){G.lives--;flashDamage();updH();showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.mirror)}}
            function mirrorBack(){G.uc.mb4=true;G.karma+=2;startD([{stage:true,txt:"Отворачиваешься."},{spk:"ERNIE",cls:"er",txt:"«Правильно.\nЗеркала в башне\nвсегда врут.»"},{spk:"ERNIE",cls:"er",txt:"«Показывают то,\nчего ты боишься.\nНе то, что будет.»"}],function(){updH();showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.mirror)}
            function openSeats(){startD([{stage:true,txt:"Зрительный зал.\nРяды пустых кресел."},{stage:true,txt:"Но — аплодисменты.\nГромкие. Отовсюду."},{stage:true,txt:"Призраки-зрители.\nПолупрозрачные.\nЖдут представление."},{spk:"ERNIE",cls:"er",txt:"«Они ждут 200 лет.\nДай им что-нибудь.»"}],null,[{icon:"🎭",text:"Выйти на сцену",fn:"seatsPlay()",id:"sp"},{icon:"🚶",text:"Пройти мимо",fn:"seatsPass()",id:"sps"}],I.audience)}
            function seatsPlay(){G.uc.sp=true;G.karma+=3;startD([{stage:true,txt:"Выходишь на сцену.\nПрожектор."},{stage:true,txt:"Не знаешь, что делать."},{stage:true,txt:"Просто стоишь."},{stage:true,txt:"Тишина."},{stage:true,txt:"Потом — овации.\nОглушительные."},{spk:"ERNIE",cls:"er",txt:"«Иногда достаточно\nпросто быть.»"},{stage:true,txt:"Призрак в первом ряду\nвстаёт. Протягивает маску."},{narr:true,txt:"Белая маска.\nОдна сторона смеётся.\nДругая плачет."},{spk:"ERNIE",cls:"er",txt:"«Маска Актёра.\nМожет пригодиться.»"}],function(){addItem("mask");showItemPop("mask");updH();notify("🎭 Маска Актёра +3","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.audience)}
            function seatsPass(){G.uc.sps=true;startD([{stage:true,txt:"Проходишь мимо.\nАплодисменты стихают."},{spk:"ERNIE",cls:"er",txt:"«Они подождут.\nОни терпеливые.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.audience)}
            function openAlisa(){sGl();startD([{stage:true,txt:"За сценой — дверь.\nТихий смех."},{stage:true,txt:"Комната.\nКресло, книги, лампа, плед.\nФотографии."},{spk:"АЛИСА",cls:"ak",txt:"«О. Новенький.\nERNIE, ты мог бы\nпредупредить.»"},{spk:"АЛИСА",cls:"ak",txt:"«Шучу.\nТут нечего убирать.\nВсё призрачное.\nКак я.»"}],null,[{icon:"📚",text:"«Что читаешь?»",fn:"alisaBook()",id:"ab"},{icon:"🐱",text:"«Тебе нравятся кошки?»",fn:"alisaCat()",id:"ac4"},{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}],I.alisa)}
            function alisaBook(){G.uc.ab=true;startD([{spk:"АЛИСА",cls:"ak",txt:"«Маленький принц».\nВ сотый раз."},{spk:"АЛИСА",cls:"ak",txt:"«Знаешь мою любимую?\n«Ты навсегда в ответе\nза тех, кого приручил.»»"},{stage:true,txt:"Смотрит вверх."},{spk:"АЛИСА",cls:"ak",txt:"«Он меня приручил.\nЯ пришла напуганная.\nА он рассказал шутку.\nГлупую, про лифт.»"},{spk:"АЛИСА",cls:"ak",txt:"«И я засмеялась.\nИ осталась тут —\nна том месте,\nгде засмеялась.»"},{spk:"ERNIE",cls:"er",txt:"«Алиса, не надо...»"},{spk:"АЛИСА",cls:"ak",txt:"«Почему?\nПусть знает.\nТы хороший, ERNIE.\nТы просто забыл\nоб этом.»"},{pause:2,stage:true,txt:"Тишина."},{spk:"АЛИСА",cls:"ak",txt:"«У меня был брат.\nМарк.\nОбещал прийти.\n3 года жду.»"},{spk:"АЛИСА",cls:"ak",txt:"«Если встретишь —\nскажи, что жду.»"}],function(){notify("📚 Алиса · Марк","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.alisa)}
            function alisaCat(){G.uc.ac4=true;if(!G.hasCat){startD([{spk:"АЛИСА",cls:"ak",txt:"«Обожаю.\nНо тут нет живых.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.alisa);return}startD([{stage:true,txt:(G.catName||"Кошка")+" подходит\nк Алисе.\nЛожится рядом.\nМурлычет."},{spk:"АЛИСА",cls:"ak",txt:"«Она тёплая.\nЯ... давно не\nчувствовала тёплого.»"},{stage:true,txt:"Гладит.\nРука проходит сквозь.\nНо "+(G.catName||"кошка")+" мурлычет."},{spk:"АЛИСА",cls:"ak",txt:"«Я не могу коснуться.\nНо она чувствует.\nКак?»"},{spk:"ERNIE",cls:"er",txt:"«Кошки —\nмежду мирами.\nВсегда были.»"}],function(){G.karma+=2;updH();notify("🐱 Тепло","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.alisa)}
            function openPit(){startD([{stage:true,txt:"Оркестровая яма.\nИнструменты играют сами."},{stage:true,txt:"Пианино. Флейта. Виолончель.\nПризрачные руки."},{stage:true,txt:"Одна скрипка молчит.\nЛежит отдельно. В луче."}],null,[{icon:"🎻",text:"Взять скрипку",fn:"pitViolin()",id:"pv"},{icon:"👂",text:"Просто слушать",fn:"pitListen()",id:"pl4"}],I.orchestra)}
            function pitViolin(){G.uc.pv=true;startD([{stage:true,txt:"Берёшь скрипку.\nОна тёплая."},{stage:true,txt:"Мелодия.\nНе ты играешь — она сама."},{stage:true,txt:"Грустная.\nДетская.\nКак колыбельная."},{spk:"ERNIE",cls:"er",txt:"«...»"},{stage:true,txt:"ERNIE молчит.\nДолго."},{spk:"ERNIE",cls:"er",txt:"«Это...\nмоя мелодия.»"},{spk:"ERNIE",cls:"er",txt:"«Мама играла.\nКогда я засыпал.»"},{spk:"ERNIE",cls:"er",txt:"«Я думал,\nзабыл.»"},{stage:true,txt:"Скрипка замолкает.\nТеперь — тишина.\nНо тёплая тишина."}],function(){notify("🎻 Мелодия ERNIE","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.orchestra)}
            function pitListen(){G.uc.pl4=true;G.karma+=1;startD([{stage:true,txt:"Сидишь. Слушаешь."},{stage:true,txt:"Призрачный оркестр\nиграет что-то\nбез названия."},{stage:true,txt:"Красиво.\nГрустно.\nКак воспоминание\nо чём-то, чего не было."},{spk:"ERNIE",cls:"er",txt:"«Музыка — единственное,\nчто башня не смогла\nиспортить.»"}],function(){updH();showCh([{icon:"🚪",text:"Назад",fn:"backF4()",id:"bk"}])},null,I.orchestra)}
            function goF5(){fadeIn(function(){sI(I.theater);startD([{stage:true,txt:"Маски спят."},{spk:"ERNIE",cls:"er",txt:"«Выше.»"}],function(){fadeIn(function(){goS("s2");showDoorF(5,"ЭТАЖ 5 · ЛАБОРАТОРИЯ СМОТРИТЕЛЯ",function(){fadeIn(function(){goS("sg");startF5()})})})})})}

            // === FLOOR 5: LABORATORY ===
            function startF5(){setParticles("dust");stopRain();setFx("flicker");startMusic("lab");sI(I.camera_wall);ravenNotify(5);ghostNotify(5);sI(I.camera_wall);sF("ЭТАЖ 5 · ЛАБОРАТОРИЯ СМОТРИТЕЛЯ");startD([{stage:true,txt:"Провода. Экраны. Гул."},{narr:true,txt:"«#512: ERNIE ПЛАКАЛ\nНА ЭТОМ ЭТАЖЕ»"},{spk:"ERNIE",cls:"er",txt:"«Не читай стены.\nТут все параноики.»"},{spk:"ERNIE",cls:"er",txt:"«Смотритель. Не говори\nс ним. А если скажет\nчто я красивый —\nтоже не верь.»"}],function(){showF5Locs()})}
            function showF5Locs(){ updH();startPressure();$("gBotW").onclick=null;$("gTop").onclick=null;$("gImgW").onclick=null;$("gTap").style.display="none";$("gNav").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";sI(I.lab);var ch=$("gCh");ch.innerHTML="";var w=document.createElement("div");w.className="g-locs";[{id:"panel",i:"🖥",n:"Пульт управления",h:"экраны мерцают"},{id:"cam",i:"📹",n:"Камера ERNIE",h:"надписи на стенах"},{id:"labdoor",i:"🚪",n:"Дверь наружу",h:"свет за дверью"},{id:"archv",i:"📊",n:"Архив",h:"847 папок"}].forEach(function(l){var b=document.createElement("button");b.className="g-loc"+(G.vis[l.id]?" done":"");b.onclick=function(){openF5(l.id)};b.innerHTML='<span class="g-loc-i">'+l.i+'</span><span class="g-loc-n">'+l.n+'</span><span class="g-loc-h">'+l.h+'</span>';w.appendChild(b)});ch.appendChild(w);ch.style.display="flex";var cnt=0;["panel","cam","labdoor","archv"].forEach(function(k){if(G.vis[k])cnt++});if(cnt>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 6 →","tryGoF5()")}
            function backF5(){rainIndoor(true);showF5Locs();updH()}
            function openF5(id){if(G.vis[id])return;G.vis[id]=true;sS();if(id==="panel")openPanel();else if(id==="cam")openCam();else if(id==="labdoor")openLabDoor();else openArchive()}
            function openPanel(){sGl();var ign=0;if(G.uc.pa)ign++;if(G.uc.fo)ign++;if(G.uc.tt)ign++;var prof=G.karma>=8?"сочувствующий":G.karma<=0?"холодный":ign>=2?"бунтарь":"осторожный";var bc=G.uc.cc||G.uc.cw;var nameQuote=G.playerName?"«"+G.playerName+".\nНастоящее имя.\nЛожь тут не работает.\nПомнишь?»":"«Субъект не назвал имя.»";startD([{stage:true,txt:"Пульт управления.\nЭкраны. Провода. Гул."},{stage:true,txt:"На экранах —\nкаждый этаж башни.\nВ реальном времени."}].concat(bc?[{stage:true,txt:"На третьем экране —\nБариста.\nМашет в камеру."},{spk:"ERNIE",cls:"er",txt:"«Он на первом.\nИ на третьем.\nОдновременно. КАК?!»"}]:[]).concat([{stage:true,txt:"За пультом —\nчто-то."},{stage:true,txt:"Не призрак.\nНе человек.\nГолова — экран.\nНа экране — твоё лицо."},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:nameQuote},{spk:"ERNIE",cls:"er",txt:"«Откуда ты...\nЭто было в начале.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Башня слышала\nс первой секунды.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Жизни: "+G.lives+".\nКарма: "+(G.karma>0?"+":"")+G.karma+".»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Совет ERNIE\nпроигнорирован: "+ign+" раз.\nПрофиль: "+prof+".»"},{spk:"ERNIE",cls:"er",txt:"«Это не смешно.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Данные объективны.\nДанные не смеются.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Проводник: ERNIE.\nСтатус: нестабильный.\nПричина: привязанность.»"},{spk:"ERNIE",cls:"er",txt:"«Не слушай его.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Проводник просит\nне слушать.\nСтрока 4, протокол 7.»"},{spk:"ERNIE",cls:"er",txt:"«Я НЕ ПРОТОКОЛ.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Именно это\nговорит строка 5.»"}]),null,[{icon:"💬",text:"«Где выход?»",fn:"panelExit()",id:"pe"},{icon:"💬",text:"«Кто такой ERNIE?»",fn:"panelErnie()",id:"pne"},{icon:"💬",text:"«Зачем башня?»",fn:"panelWhy()",id:"pw"}],I.watcher)}
            function panelExit(){G.uc.pe=true;startD([{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Выход существует.\nЭтаж 10. Крыша.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Но вы не дойдёте.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Статистика:\n0 из 847 субъектов\nдошли.»"},{spk:"ERNIE",cls:"er",txt:"«Ты будешь первым.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Вероятность: 0.12%.»"},{pause:3,stage:true,txt:""},{pause:3,spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«...Я тоже\nбыл субъектом.\nДавно.»",spd:50},{pause:3,stage:true,txt:"Тишина."},{spk:"ERNIE",cls:"er",txt:"«Достаточно.\nЯ однажды нашёл\nкофейные зёрна\nвнутри башни.\nВероятность этого\nбыла 0%.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Это был Бариста.»"},{spk:"ERNIE",cls:"er",txt:"«Не порть мне\nмотивационную речь.»"}],function(){notify("📊 0 из 847","gold");panelRem()},null,I.watcher)}
            function panelErnie(){G.uc.pne=true;startD([{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Субъект #1.\nПервый, кто вошёл.\nПоследний, кто остался.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Возраст на момент\nинтеграции: 14 лет,\n3 месяца, 11 дней.»"},{spk:"ERNIE",cls:"er",txt:"«Замолчи.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Функция: проводник.\nЗадача: вести субъектов\nглубже в башню.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Побочный эффект:\nсубъект #1 считает,\nчто защищает.\nБашня поощряет\nэто заблуждение.»"},{spk:"ERNIE",cls:"er",txt:"«ЭТО ЛОЖЬ.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Каждый раз, когда\nсубъект теряет жизнь —\nбашня получает 1 единицу.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«За текущую сессию\nбашня получила: "+(5-G.lives)+".»"},{stage:true,txt:"Тишина."},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Через кого?»"},{stage:true,txt:"ERNIE не отвечает."},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Через проводника.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Дополнительно:\nпамять субъекта #1\nкорректируется\nкаждые 365 циклов.»"},{spk:"ERNIE",cls:"er",txt:"«Что?..»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Стирание.\\nВыборочное.\\nДом. Лицо матери.\\nИмя кошки.\\nВкус еды.»"},{spk:"ERNIE",cls:"er",txt:"«Я... я не забывал...»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Именно так\\nработает стирание.\\nВы не помните,\\nчто забыли.»"},{stage:true,txt:"ERNIE молчит."},{stage:true,txt:"Долго."}],function(){notify("⚡ Правда?","gold");panelRem()},null,I.watcher)}
            function panelWhy(){G.uc.pw=true;startD([{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Башня собирает.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Воспоминания.\nЭмоции. Страхи.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Это её пища.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Каждый этаж —\nловушка.\nКаждый NPC — приманка.»"},{spk:"ERNIE",cls:"er",txt:"«Бариста — не приманка.\nЛика — не приманка.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Они были людьми.\nТеперь — функции.»"},{spk:"ERNIE",cls:"er",txt:"«Замолчи.»"}],function(){notify("🔍 Правда о башне","gold");panelRem()},null,I.watcher)}
            function panelRem(){var r=[];if(!G.uc.pe)r.push({icon:"💬",text:"«Где выход?»",fn:"panelExit()",id:"pe"});if(!G.uc.pne)r.push({icon:"💬",text:"«Кто ERNIE?»",fn:"panelErnie()",id:"pne"});if(!G.uc.pw)r.push({icon:"💬",text:"«Зачем башня?»",fn:"panelWhy()",id:"pw"});r.push({icon:"🚪",text:"Назад",fn:"backF5()",id:"bk"});showCh(r)}
            function openCam(){
                G.uc._camTap=(G.uc._camTap||0)+1;
                if(G.uc._camTap===3&&!G.uc._camSecret){
                    G.uc._camSecret=true;
                    startD([{stage:true,txt:"Камера мерцает."},{stage:true,txt:"Помехи. Статика."},{pause:2,stage:true,txt:"И — на секунду —\nлицо."},{pause:3,stage:true,txt:"Мальчик.\n14 лет.\nСмеётся."},{pause:4,stage:true,txt:"Запись обрывается."},{pause:3,spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Не надо было\nэто видеть.»",spd:50}]);
                    addDiary("Камера 5. Секретная запись.\nМальчик смеётся. 14 лет.\nERNIE молчит.","secret",5);
                    return;
                }sI(I.lika_drawing);startD([{stage:true,txt:"Комната. Кровать. Рисунки.\nПочерк 14-летнего."},{narr:true,txt:"«ДЕНЬ 100. ОН ГОВОРИТ\nЧТО Я ОСОБЕННЫЙ.»\n«ДЕНЬ 200. ВРАЛ.»"},{spk:"ERNIE",cls:"er",txt:"«...Не читай.»"}],null,[{icon:"📄",text:"Прочитать стены",fn:"camRead()",id:"cr"},{icon:"📹",text:"Включить запись",fn:"camVideo()",id:"cv5"},{icon:"📷",text:"Оставить фото",fn:"camPhoto()",id:"cp5"},{icon:"🚶",text:"Уйти",fn:"camLeave()",id:"cl5"}],I.ernie_room)}

            function camVideo(){G.uc.cv5=true;
                startD([
                    {stage:true,txt:"В углу — экран.\nСтарый. Треснувший."},
                    {pause:3,stage:true,txt:"Изображение.\nМальчик. 14 лет.\nХудой. Вихрастый."},
                    {pause:3,stage:true,txt:"Улыбается.\nНервно.\nКак когда страшно\nно не хочешь показывать."},
                    {pause:3,narr:true,txt:"«Меня зовут Эрнест.\nМне 14.\nМне сказали\nчто внутри — ответы.»"},
                    {pause:3,narr:true,txt:"«Мама говорит\nне ходи.\nНо мама всегда\nговорит не ходи.\nА потом — не ела три дня\nчтобы я поел.»"},
                    {pause:3,narr:true,txt:"«Я найду ответ.\nВернусь.\nКуплю ей...\nне знаю.\nЧто-нибудь тёплое.»"},
                    {pause:3,narr:true,txt:"«Если кто-то\nэто смотрит — привет.\nЯ не боюсь.»"},
                    {pause:3,narr:true,txt:"«Ладно. Немного боюсь.»"},
                    {narr:true,txt:"«Но совсем чуть-чуть.»"},
                    {pause:3,stage:true,txt:"Запись обрывается."},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Выключи.»",spd:40},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«...Я говорил как идиот.»",spd:50},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Что-нибудь тёплое.\n200 лет.\nТак и не купил.»",spd:40},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Она наверное давно...»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ладно. Идём.\nПожалуйста.»",spd:50}
                ],function(){G.trust+=3;G.karma+=5;updH();addDiary("Видео. Эрнест. 14 лет.\n«Куплю маме что-нибудь тёплое.»\n200 лет. Не купил.","secret",5);notify("📹 Запись Эрнеста","gold");camRem()},null,I.ernie_room)
            }
            function camRead(){G.uc.cr=true;startD([{narr:true,txt:"«ДЕНЬ 1.\nЯ нашёл башню.\nОна красивая.»"},{narr:true,txt:"«ДЕНЬ 14.\nГолос зовёт меня\nпо имени.»"},{narr:true,txt:"«ДЕНЬ 50.\nОн обещал показать\nкрышу. Я верю.»"},{narr:true,txt:"«ДЕНЬ 100.\nДвери исчезли.\nГолос говорит:\n«Ты дома.»"},{narr:true,txt:"«ДЕНЬ 365.\nЯ согласился.\nСтал проводником.\nМне было 14.\nЯ испугался.»"},{spk:"ERNIE",cls:"er",txt:"«Хватит.»"},{spk:"ERNIE",cls:"er",txt:"«Я был...»",spd:60},{pause:12,stage:true,txt:""},{pause:3,spk:"ERNIE",cls:"er",txt:"«Ладно.\nДальше.»",spd:50,fn:function(){ernieThree()}},{pause:3,stage:true,txt:"Он не договорил.\nОн никогда\nне договаривает."}],function(){notify("📜 История ERNIE","gold");camRem()},null,I.ernie_room)}
            function camPhoto(){G.uc.cp5=true;var hasPhoto=G.items.indexOf("photo")>=0;if(hasPhoto){G.karma+=3;G.trust+=2;startD([{stage:true,txt:"Кладёшь фото ERNIE\nна стол."},{stage:true,txt:"Мальчик 14 лет.\nУ башни. Улыбается."},{spk:"ERNIE",cls:"er",txt:"«...»"},{stage:true,txt:"Долгое молчание."},{spk:"ERNIE",cls:"er",txt:"«...Зачем?»"},{stage:true,txt:"«Чтобы ты помнил,\nчто был настоящим.»"},{spk:"ERNIE",cls:"er",txt:"«...»"},{spk:"ERNIE",cls:"er",txt:"«Спасибо.»"}],function(){updH();notify("📷 ","gold");camRem()},null,I.ernie_room)}else{startD([{stage:true,txt:"Нечего оставить."},{spk:"ERNIE",cls:"er",txt:"«Пойдём.»"}],function(){camRem()},null,I.ernie_room)}}
            function camLeave(){G.uc.cl5=true;startD([{stage:true,txt:"Закрываешь дверь тихо."},{spk:"ERNIE",cls:"er",txt:"«Спасибо,\nчто не стал читать.»"}],function(){camRem()},null,I.ernie_room)}
            function camRem(){var r=[];if(!G.uc.cr)r.push({icon:"📄",text:"Читать стены",fn:"camRead()",id:"cr"});if(!G.uc.cp5)r.push({icon:"📷",text:"Оставить фото",fn:"camPhoto()",id:"cp5"});if(!G.uc.cl5)r.push({icon:"🚶",text:"Уйти",fn:"camLeave()",id:"cl5"});r.push({icon:"🚪",text:"Назад",fn:"backF5()",id:"bk"});showCh(r)}
            function openLabDoor(){startD([{stage:true,txt:"Массивная металлическая\nдверь."},{stage:true,txt:"За ней — свет.\nНастоящий. Дневной."},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Дверь работает.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Код: количество шагов\nсубъекта #1\nот входа до крыши.»"},{spk:"ERNIE",cls:"er",txt:"«Я не помню.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Конечно не помните.\nВы стёрли это.»"}],null,[{icon:"🔢",text:"Ввести код",fn:"doorCode()",id:"dc"},{icon:"🚶",text:"Уйти",fn:"doorGo()",id:"dg5"}],I.lab_door)}
            function doorCode(){G.uc.dc=true;startD([{stage:true,txt:"Не знаешь код."},{stage:true,txt:"Набираешь наугад."},{spk:"ERNIE",cls:"er",txt:"«Попробуй 1234.»"},{stage:true,txt:"Красный свет.\nНеверно."},{spk:"ERNIE",cls:"er",txt:"«0000?»"},{stage:true,txt:"Неверно."},{spk:"ERNIE",cls:"er",txt:"«Дату моего рождения?»"},{stage:true,txt:"..."},{spk:"ERNIE",cls:"er",txt:"«Я не помню её.\nНо было бы\nкрасиво.»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Вернитесь на этаж 10.\nДверь будет ждать.\nОна терпеливая.»"},{spk:"ERNIE",cls:"er",txt:"«Терпеливая.\nВ отличие от меня.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF5()",id:"bk"}])},null,I.lab_door)}
            function doorGo(){G.uc.dg5=true;startD([{stage:true,txt:"Отходишь от двери."},{spk:"ERNIE",cls:"er",txt:"«Наверх.\nВсегда наверх.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF5()",id:"bk"}])},null,I.lab_door)}
            function openArchive(){sI(I.archive_folder);var pName=G.playerName?G.playerName.toUpperCase():"НЕИЗВЕСТНО";startD([{stage:true,txt:"Архив.\n847 папок.\nНа каждой — имя и дата."},{stage:true,txt:"Твоя — последняя.\nТонкая."},{stage:true,txt:"На обложке:\n«#848 · "+pName+" · 2026»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Да.\nОни знают\nтвоё имя.\nОни всегда\nзнают.»"},{stage:true,txt:"Открываешь.\nОдин лист.\n«В процессе.»"}],null,[{icon:"📖",text:"Папка ERNIE",fn:"archErnie()",id:"ae"},{icon:"📖",text:"Случайная папка",fn:"archRandom()",id:"ar5"},{icon:"🚶",text:"Не трогать",fn:"archLeave()",id:"al5"}],I.archive_folder)}
            function archErnie(){G.uc.ae=true;G.trust+=1;startD([{stage:true,txt:"Папка ERNIE.\nТолстая. Сотни страниц."},{stage:true,txt:"Последняя страница:"},{narr:true,txt:"«Статус: интегрирован.\nФункция: проводник.\nПримечание:\nаномальная привязанность\nк субъектам.»"},{spk:"ERNIE",cls:"er",txt:"«Аномальная привязанность.\nОни так это называют.\nЯ называю — человечность.»"}],function(){updH();notify("📋 Файл ERNIE","gold");archRem()},null,I.archive)}
            function archRandom(){G.uc.ar5=true;startD([{stage:true,txt:"Случайная папка."},{narr:true,txt:"«Субъект #412.\nИмя: Андрей.\nВозраст: 22.\nЭтаж гибели: 2.»"},{narr:true,txt:"«Причина: Тень.\nОстаток: на скамейке\nзала ожидания.»"},{spk:"ERNIE",cls:"er",txt:"«Тень на втором\nэтаже.\nЭто он.»"},{spk:"ERNIE",cls:"er",txt:"«Я не смог\nего спасти.»"}],function(){notify("💔 Субъект #412","gold");archRem()},null,I.archive)}
            function archLeave(){G.uc.al5=true;startD([{stage:true,txt:"Закрываешь шкаф."},{spk:"ERNIE",cls:"er",txt:"«Некоторые числа\nлучше не знать.»"}],function(){archRem()},null,I.archive)}
            function archRem(){var r=[];if(!G.uc.ae)r.push({icon:"📖",text:"Папка ERNIE",fn:"archErnie()",id:"ae"});if(!G.uc.ar5)r.push({icon:"📖",text:"Случайная",fn:"archRandom()",id:"ar5"});if(!G.uc.al5)r.push({icon:"🚶",text:"Не трогать",fn:"archLeave()",id:"al5"});r.push({icon:"🚪",text:"Назад",fn:"backF5()",id:"bk"});showCh(r)}
            function goF6(){fadeIn(function(){sI(I.lab);startD([{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«Удачи.»"}],function(){fadeIn(function(){goS("s2");showDoorF(6,"ЭТАЖ 6 · САД ПАМЯТИ",function(){fadeIn(function(){goS("sg");startF6()})})})})})}

            // === FLOOR 6: GARDEN OF MEMORY ===
            function startF6(){setParticles("dust");stopRain();setFx(null);startMusic("garden");catReact("good");ravenNotify(6);ghostNotify(6);G.currentFloor=6;updateProgress(6);sI(I.garden);sF("ЭТАЖ 6 · САД ПАМЯТИ");var sl=G.trust>=3?[{spk:"ERNIE",cls:"er",txt:"«Сад красивый.\nЯ тут часто сижу.»"},{spk:"ERNIE",cls:"er",txt:"«Один. Это не жалоба.\nПросто факт.»"},{pause:2,stage:true,txt:"Где-то играет труба.\nОдна нота.\nДо."},{pause:2,stage:true,txt:"Пауза."},{stage:true,txt:"Та же нота.\nДо."},{spk:"ERNIE",cls:"er",txt:"«Он забыл мелодию.\n200 лет — одна нота.\nДо."}]:[];var gardenLines=[{spk:"ERNIE",cls:"er",txt:"Каждый цветок —\nчьё-то воспоминание.\nМой давно засох."},{spk:"ERNIE",cls:"er",txt:"Зато не нужно\nполивать. Экономия."}];if(G.playerName&&G.playerName!=="Странник"){gardenLines.push({pause:2,stage:true,txt:"У одной клумбы —\nтабличка.\n«"+G.playerName+"».\nЦветок засох."});gardenLines.push({spk:"ERNIE",cls:"er",txt:"«Он появился\nкогда ты вошёл.\nИ сразу засох.»",spd:35});gardenLines.push({spk:"ERNIE",cls:"er",txt:"«Не принимай\nна свой счёт.»"})}
                if(!G.uc.ld){gardenLines.push({pause:2,stage:true,txt:"У одной клумбы —\nпустое место.\nТабличка: «Лика, 7 лет»."});gardenLines.push({spk:"ERNIE",cls:"er",txt:"«Её цветок... засох.»"});gardenLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Если бы кто-то\nсказал ей\nчто рисунки красивые...»",spd:40});gardenLines.push({spk:"ERNIE",cls:"er",txt:"«Может, он бы\nещё цвёл.»"})}if(!G.hasCat){gardenLines.push({stage:true,txt:"Сад кажется\nтемнее без кошки."});gardenLines.push({spk:"ERNIE",cls:"er",txt:"«Тут раньше\nбегала кошка.\nМежду цветами.\nТеперь — нет.»"})}startD(sl.concat(gardenLines),function(){showF6Locs()})}
            function showF6Locs(){ updH();startPressure();$("gBotW").onclick=null;$("gTop").onclick=null;$("gImgW").onclick=null;$("gTap").style.display="none";$("gNav").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";sI(I.garden);var ch=$("gCh");ch.innerHTML="";var w=document.createElement("div");w.className="g-locs";[{id:"memtree",i:"🌳",n:"Древо Памяти",h:"листья шепчут"},{id:"gaz",i:"🏛",n:"Беседка",h:"кто-то сидит"},{id:"wilt",i:"🥀",n:"Увядший цветок",h:"табличка: «Э., 14»"}].forEach(function(l){var b=document.createElement("button");b.className="g-loc"+(G.vis[l.id]?" done":"");b.onclick=function(){openF6(l.id)};b.innerHTML='<span class="g-loc-i">'+l.i+'</span><span class="g-loc-n">'+l.n+'</span><span class="g-loc-h">'+l.h+'</span>';w.appendChild(b)});ch.appendChild(w);ch.style.display="flex";var cnt=0;["memtree","gaz","wilt"].forEach(function(k){if(G.vis[k])cnt++});if(cnt>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 7 →","tryGoF6()")}
            function backF6(){rainIndoor(true);showF6Locs();updH()}
            function openF6(id){if(G.vis[id])return;G.vis[id]=true;sS();if(id==="memtree")openTree();else if(id==="fount")openFountain();else if(id==="gaz")openGazebo();else openWilted()}
            function openTree(){sI(I.tree_memory);var catDoorLines=[];if(G.hasCat){catDoorLines=[{pause:3,stage:true,txt:(G.catName||"Кошка")+" сидит\nперед закрытой дверью.\nНе той что ведёт вперёд.\nДругой."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Она всегда знала\nгде выход.\nПросто не уходит.»",spd:40},{pause:4,stage:true,txt:""}]}startD(catDoorLines.concat([{stage:true,txt:"Огромное дерево\nв центре сада.\nКорни уходят\nсквозь все этажи."},{stage:true,txt:"Листья шепчут.\nНа каждом — имя."},{stage:true,txt:"Находишь свой лист.\nОн зелёный.\nЕдинственный живой."}]),null,[{icon:"🍃",text:"Потрогать свой лист",fn:"treeTouch()",id:"tt6"},{icon:"🍂",text:"Найти лист ERNIE",fn:"treeErnie()",id:"te6"},{icon:"🚶",text:"Уйти",fn:"treeLeave()",id:"tl6"}],I.tree_memory)}
            function treeTouch(){G.uc.tt6=true;startD([{stage:true,txt:"Касаешься листа."},{stage:true,txt:"Воспоминание."},{stage:true,txt:"Тёплое.\nМама. Дом.\nЗапах блинов утром."},{stage:true,txt:"Всё настоящее.\nВсё далёкое."},{spk:"ERNIE",cls:"er",txt:"«Держись за это.»"},{spk:"ERNIE",cls:"er",txt:"«Башня попытается\nзабрать.»"}],function(){notify("🍃 Воспоминание","gold");treeRem()},null,I.tree)}
            function treeErnie(){G.uc.te6=true;G.trust+=1;startD([{stage:true,txt:"Ищешь лист ERNIE."},{stage:true,txt:"Сухой.\nМёртвый.\nРассыпается в руках."},{spk:"ERNIE",cls:"er",txt:"«Вот видишь.»"},{stage:true,txt:"Пыль сквозь пальцы."},{spk:"ERNIE",cls:"er",txt:"«Даже дерево\nменя забыло.»"}],function(){updH();notify("🍂 Лист ERNIE","gold");treeRem()},null,I.tree)}
            function treeLeave(){G.uc.tl6=true;startD([{stage:true,txt:"Уходишь от дерева."},{spk:"ERNIE",cls:"er",txt:"«Деревья терпеливые.»"}],function(){treeRem()},null,I.tree)}
            function treeRem(){var r=[];if(!G.uc.tt6)r.push({icon:"🍃",text:"Свой лист",fn:"treeTouch()",id:"tt6"});if(!G.uc.te6)r.push({icon:"🍂",text:"Лист ERNIE",fn:"treeErnie()",id:"te6"});if(!G.uc.tl6)r.push({icon:"🚶",text:"Уйти",fn:"treeLeave()",id:"tl6"});r.push({icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"});showCh(r)}
            function openFountain(){sI(I.fountain_vision);startD([{stage:true,txt:"Фонтан. Сухой.\nНе работает давно."},{stage:true,txt:"Чаша с трещинами.\nНо если бросить что-то —\nможет показать видение."}],null,[{icon:"☕",text:"Бросить кофе",fn:"fountCoffee()",id:"fc6"},{icon:"🎨",text:"Бросить рисунок",fn:"fountDraw()",id:"fd6"},{icon:"💧",text:"Ничего не бросать",fn:"fountNone()",id:"fn6"}],I.fountain)}
            function fountCoffee(){G.uc.fc6=true;var hasCof=G.items.indexOf("coffee")>=0;if(hasCof){startD([{stage:true,txt:"Выливаешь кофе\nв фонтан."},{stage:true,txt:"Вода появляется.\nНа секунду."},{stage:true,txt:"Видение:\nБариста. Живой.\nЗа стойкой настоящего кафе."},{stage:true,txt:"Смеётся.\nСолнце за окном.\nПосетители."},{spk:"ERNIE",cls:"er",txt:"«Все они были\nкем-то.»"},{stage:true,txt:"Видение гаснет."},{pause:3,stage:true,txt:"Нет.\nПодожди."},{stage:true,txt:"Ещё одно видение.\nМутное. Тёмное."},{stage:true,txt:"Лестница.\nВниз.\nПод первый этаж.",fn:function(){sI(I.fountain_vision)}},{stage:true,txt:""},{stage:true,txt:"Что-то там.\nКрасные огни.\nЦарапины на стенах."},{spk:"ERNIE",cls:"er",txt:"«Что... что это?»"},{stage:true,txt:"Видение обрывается."},{spk:"ERNIE",cls:"er",txt:"«Я никогда\nне видел этого.»",spd:40},{spk:"ERNIE",cls:"er",txt:"«Под первым этажом\nничего нет.\nТочно ничего.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«...Точно?»"},{stage:true,txt:"Кофе впитался."}],function(){var idx=G.items.indexOf("coffee");G.items.splice(idx,1);updH();showWallNote("👁","Видение: лестница вниз.\nПод первый этаж.\nКрасные огни.\nЦарапины на стенах.\n\nERNIE не знает что это.","demon",6);addDiary("Фонтан показал лестницу вниз. Красные огни. Царапины. ERNIE испугался.","demon",6);showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}])},null,I.fountain)}else{startD([{stage:true,txt:"Нет кофе."},{spk:"ERNIE",cls:"er",txt:"«Надо было\nвзять у Баристы.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}])},null,I.fountain)}}
            function fountDraw(){G.uc.fd6=true;var hasDr=G.items.indexOf("drawing")>=0;if(hasDr){G.karma+=3;startD([{stage:true,txt:"Кладёшь рисунок\nв фонтан."},{stage:true,txt:"Вода появляется."},{stage:true,txt:"Видение:\nЛика. С родителями.\nСмеётся."},{stage:true,txt:"Маленькая девочка\nв жёлтом платье.\nСчастливая."},{spk:"ERNIE",cls:"er",txt:"«Ей было 7.\nОна искала маму\nв башне.»"},{spk:"ERNIE",cls:"er",txt:"«Не нашла.»"},{stage:true,txt:"Видение гаснет.\nРисунок растворился."}],function(){var idx=G.items.indexOf("drawing");G.items.splice(idx,1);updH();notify("🎨 Видение Лики +3","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}])},null,I.fountain)}else{startD([{stage:true,txt:"Нет рисунка."},{spk:"ERNIE",cls:"er",txt:"«Попробуй\nчто-нибудь другое.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}])},null,I.fountain)}}
            function fountNone(){G.uc.fn6=true;startD([{stage:true,txt:"Фонтан сухой.\nМолчит."},{spk:"ERNIE",cls:"er",txt:"«Без жертвы —\nбез видения.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}])},null,I.fountain)}
            function openGazebo(){startD([{stage:true,txt:"Беседка в углу сада.\nВ ней — призрак."},{stage:true,txt:"Не говорит.\nСидит. Смотрит на сад."},{spk:"ERNIE",cls:"er",txt:"«Он тут дольше всех.\nДаже дольше меня.»"},{spk:"ERNIE",cls:"er",txt:"«Не помнит ничего.\nДаже что он — призрак.»"},{spk:"ERNIE",cls:"er",txt:"«Иногда завидую.\nЗабыть всё —\nзвучит как отпуск.»"}],null,[{icon:"🪑",text:"Сесть рядом",fn:"gazSit()",id:"gs6"},{icon:"🚶",text:"Уйти",fn:"gazLeave()",id:"gl6"}],I.gazebo_ghost)}
            function gazSit(){sI(I.gazebo_ghost);G.uc.gs6=true;G.karma+=2;startD([{stage:true,txt:"Садишься рядом."},{pause:3,stage:true,txt:""},{stage:true,txt:"Тишина.\nДолго."},{pause:3,stage:true,txt:""},{stage:true,txt:"Призрак поворачивается.\nМедленно."},{stage:true,txt:"Кладёт руку\nна твоё плечо.\nХолодно."},{stage:true,txt:"Но — не страшно."},{pause:3,stage:true,txt:"Вы сидите.\nВместе.\nМолча."},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Он помнит\nодно слово.»"},{stage:true,txt:"Призрак шепчет.\nТак тихо, что\nпочти не слышно."},{narr:true,txt:"«...домой...»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Все хотят\nодного и того же.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Я тоже.»",spd:40},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Только мне\nнекуда.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Не смотри на меня\nтак.\nЯ в порядке.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Просто...\nспасибо\nчто сел рядом.»",spd:40}],function(){updH();ernieTheme();notify("💛 Тишина ·","gold");
                    // Записка под скамейкой — для Баристы
                    if(!G.uc._baristaNoteFound){
                        setTimeout(function(){
                            startD([
                                {stage:true,txt:"Под скамейкой —\nбумажка. Старая."},
                                {stage:true,txt:"Почерк женский.\nАккуратный."},
                                {narr:true,txt:"«Кофе был невкусный.\nНо я приходила\nне ради кофе.\nПрости что не сказала.»"},
                                {spk:"ERNIE",cls:"er",txt:"«Это для Баристы.\nЕсли вернёшься —\nотдай ему.»"}
                            ],function(){
                                G.uc._baristaNoteFound=true;
                                notify("📜 Записка для Баристы","gold");
                                addDiary("Записка под скамейкой.\nЖенский почерк.\n«Кофе был невкусный.\nНо я приходила не ради кофе.»","letter",6);
                                showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}]);
                            });
                        },1500);
                    } else {
                        showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}]);
                    }
                },null,I.gazebo)}
            function gazLeave(){G.uc.gl6=true;startD([{stage:true,txt:"Проходишь мимо.\nПризрак не замечает."}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"}])},null,I.gazebo)}
            function openWilted(){startD([{stage:true,txt:"В углу сада.\nМаленький цветок."},{stage:true,txt:"Сухой. Мёртвый."},{stage:true,txt:"Табличка:\n«Э., 14 лет,\nпервый визит.»"},{spk:"ERNIE",cls:"er",txt:"«...Да. Мой.»"}],null,[{icon:"💧",text:"Полить",fn:"wiltWater()",id:"ww6"},{icon:"📷",text:"Показать фото",fn:"wiltPhoto()",id:"wp6"},{icon:"🚶",text:"Уйти",fn:"wiltLeave()",id:"wl6"}],I.wilted)}
            function wiltWater(){G.uc.ww6=true;G.karma+=3;G.trust+=1;trackChoice("wateredFlower");var ravenLines=G.metRaven?[{stage:true,txt:"Карканье сверху."},{spk:"ВОРОН",cls:"rv",txt:"«Башня стирает память.\nНо не любовь.»"},{spk:"ВОРОН",cls:"rv",txt:"«Кошка жива,\nпотому что он\nникогда не перестал\nлюбить.\nДаже забыв.»"},{spk:"ERNIE",cls:"er",txt:"«Откуда ты знаешь\nпро кошку?!»"},{spk:"ВОРОН",cls:"rv",txt:"«Я — память.\nЛетаю, вижу, помню.\nВ отличие от некоторых.»"},{stage:true,txt:"Улетает."}]:[];startD([{stage:true,txt:"Чем полить?\nНет воды."},{stage:true,txt:"Касаешься цветка.\nВспоминаешь дерево.\nЛист. Маму. Дом."},{stage:true,txt:"Тепло проходит\nсквозь руку."},{stage:true,txt:"Цветок оживает.\nНа секунду.\nЛепесток раскрывается."},{stage:true,txt:"Потом — снова вянет."},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»"},{spk:"ERNIE",cls:"er",txt:"«Даже секунда —\nэто много.»"}].concat(ravenLines),function(){updH();notify("🌸 ","gold");if(lettersFound.indexOf(1)<0)showLetter(1,function(){wiltRem()});else wiltRem()},null,I.wilted)}
            function wiltPhoto(){G.uc.wp6=true;var hasPhoto=G.items.indexOf("photo")>=0;if(hasPhoto){G.trust+=2;startD([{stage:true,txt:"Показываешь фото\nцветку."},{stage:true,txt:"Цветок реагирует.\nТянется к фото."},{stage:true,txt:"Дрожит."},{spk:"ERNIE",cls:"er",txt:"«...»"},{stage:true,txt:"Долгое молчание."},{spk:"ERNIE",cls:"er",txt:"«Я помню этот день.\nЕдинственный.»"},{spk:"ERNIE",cls:"er",txt:"«Мы шли к башне.\nС... кем-то.\nЯ не помню лицо.»"},{spk:"ERNIE",cls:"er",txt:"«Но помню —\nбыло тепло.»"}],function(){updH();notify("📷 +доверие","gold");wiltRem()},null,I.wilted)}else{startD([{stage:true,txt:"Нет фото."},{spk:"ERNIE",cls:"er",txt:"«Жаль.»"}],function(){wiltRem()},null,I.wilted)}}
            function wiltLeave(){G.uc.wl6=true;startD([{stage:true,txt:"Уходишь.\nЦветок не шевелится."}],function(){wiltRem()},null,I.wilted)}
            function wiltRem(){var r=[];if(!G.uc.ww6)r.push({icon:"💧",text:"Полить",fn:"wiltWater()",id:"ww6"});if(!G.uc.wp6)r.push({icon:"📷",text:"Показать фото",fn:"wiltPhoto()",id:"wp6"});if(!G.uc.wl6)r.push({icon:"🚶",text:"Уйти",fn:"wiltLeave()",id:"wl6"});r.push({icon:"🚪",text:"Назад",fn:"backF6()",id:"bk"});showCh(r)}
            function goF7(){fadeIn(function(){sI(I.garden);startD([{spk:"ERNIE",cls:"er",txt:"«~~Пожалуйста, не ходи туда~~»",del:true},{spk:"ERNIE",cls:"er",txt:"«Зеркала.»",spd:50},{pause:3,stage:true,txt:""}],function(){fadeIn(function(){goS("s2");showDoorF(7,"ЭТАЖ 7 · ЗЕРКАЛЬНЫЙ ЛАБИРИНТ",function(){fadeIn(function(){goS("sg");startF7()})})})})})}

            // === FLOOR 7: MIRROR LABYRINTH ===
            function startF7(){setParticles("cold");stopRain();
                // Кот уходит если catTrust < 30
                if(G.hasCat && (G.catTrust||50)<30 && !G._catVanished7){
                    G._catVanished7=true;G.hasCat=false;hideCat();
                    setTimeout(function(){
                        notify("🐱 "+(G.catName||"Кошка")+" исчезла","bad");
                        setTimeout(function(){
                            startD([{pause:3,stage:true,txt:"Пусто."},{pause:3,stage:true,txt:"Там где была "+(G.catName||"кошка")+"\n— ничего."},{pause:4,stage:true,txt:""},{narr:true,txt:"«Она ждала.\nНо ты не обернулся.»"}],function(){});
                        },2000);
                    },10000);
                }
setFx("shadow");startHeartbeat();startMusic("mirror");ravenNotify(7);ghostNotify(7);G.currentFloor=7;updateProgress(7);sI(I.mirror_corridor);sF("ЭТАЖ 7 · ЗЕРКАЛЬНЫЙ ЛАБИРИНТ");if(G.hasCat){notify("🐱 Кошка жмётся к ноге","gold")}startD([{spk:"ERNIE",cls:"er",txt:"Зеркала.\nНенавижу этот этаж."},{spk:"ERNIE",cls:"er",txt:"Они будут показывать\nтебя. Разных тебя.\nНе верь."},{spk:"ERNIE",cls:"er",txt:"И... они могут\nговорить моим голосом."},{spk:"ERNIE",cls:"er",txt:"Если услышишь\nменя дважды —\nодин из нас\nненастоящий."},{spk:"ERNIE",cls:"er",txt:"Подсказка:\nнастоящий я —\nтот, кто звучит\nболее уставшим."},{spk:"ERNIE",cls:"er",txt:"Это всегда я.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«И... иди направо.\nВсегда направо.\nЯ точно помню.»"},{pause:3,stage:true,txt:"..."},{spk:"ERNIE",cls:"er",txt:"«Нет. Подожди.\nНалево.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Или...\nЯ не помню.»",spd:40},{pause:3,spk:"ERNIE",cls:"er",txt:"«Прости.\nЯ тут 200 лет.\nИногда путаю.»"},{spk:"ERNIE",cls:"er",txt:"«Не смотри\nна меня так.\nВсе ошибаются.\nДаже призраки.»"},{spk:"ERNIE",cls:"er",txt:"«Особенно\nпризраки.»"}].concat(
                // === DELAYED CONSEQUENCE: Trust question from Floor 1 ===
                G.uc.saidNoTrust&&!G.uc._trustEchoF7?function(){G.uc._trustEchoF7=true;return[
                    {pause:4,stage:true,txt:""},
                    {stage:true,txt:"Зеркало мигает."},
                    {pause:3,stage:true,txt:"В отражении —\nERNIE.\nНастоящий."},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ты сказал\nчто не доверяешь мне.»",spd:40},
                    {pause:4,spk:"ERNIE",cls:"er",txt:"«Этаж 1.\nПомню.»",spd:50},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Ты был прав.»",spd:60},
                    {pause:5,stage:true,txt:""}
                ]}():[]),function(){showF7Locs()})}
            function showF7Locs(){ updH();startPressure();$("gBotW").onclick=null;$("gTop").onclick=null;$("gImgW").onclick=null;$("gTap").style.display="none";$("gNav").style.display="none";$("gTop").style.display="none";$("gBotW").style.display="none";sI(I.maze);var ch=$("gCh");ch.innerHTML="";var w=document.createElement("div");w.className="g-locs";var locs=[{id:"corridor",i:"🪞",n:"Зеркальный коридор",h:"бесконечные отражения"},{id:"fakeer",i:"🗣",n:"Голос",h:"знакомый, но другой"},{id:"dbl",i:"👤",n:"Двойник",h:"точная копия"},{id:"momcall",i:"📱",n:"Звонок",h:"вибрация"}];if(G.lives<=2&&!G.uc._deal7){locs.push({id:"_deal7",i:"🔮",n:"Зеркало шепчет",h:"сделка"})}locs.forEach(function(l){var b=document.createElement("button");b.className="g-loc"+(G.vis[l.id]?" done":"");b.onclick=function(){if(l.id==="_deal7")openDeal7();else openF7(l.id)};b.innerHTML='<span class="g-loc-i">'+l.i+'</span><span class="g-loc-n">'+l.n+'</span><span class="g-loc-h">'+l.h+'</span>';w.appendChild(b)});ch.appendChild(w);ch.style.display="flex";var cnt=0;["corridor","fakeer","dbl","momcall"].forEach(function(k){if(G.vis[k])cnt++});if(cnt>=2)showBar("ПОДНЯТЬСЯ НА ЭТАЖ 8 →","tryGoF7()")}
            function backF7(){
                // Ловушка зеркал — первый раз кнопка обманывает
                if(!G._mirrorTrick){
                    G._mirrorTrick=true;
                    flashScreen();tone(100,.3,"square",.03);
                    startD([{stage:true,txt:"Дверь закрыта."},{pause:2,stage:true,txt:"Была открыта.\\nСекунду назад."},{spk:"ERNIE",cls:"er",txt:"«Зеркала не отпускают\\nтак просто.»"},{stage:true,txt:"Отражение улыбается.\\nТы — нет."}],function(){showF7Locs()});
                    return;
                }
                rainIndoor(true);showF7Locs();updH()
            }
            function openF7(id){if(G.vis[id])return;G.vis[id]=true;sS();if(id==="corridor")openCorridor();else if(id==="fakeer")openFakeErnie();else if(id==="dbl")openDouble();else openMomCall()}
            function openDeal7(){G.uc._deal7=true;G.vis["_deal7"]=true;sI(I.black_mirror);startD([{stage:true,txt:"Зеркало.\nНо не как другие."},{stage:true,txt:"Это зеркало —\nчёрное.\nГладкое.\nТёплое."},{stage:true,txt:"Шёпот.\nНе ERNIE."},{narr:true,txt:"«Ты устал.\nЯ вижу.\nДва удара сердца\nосталось.»"},{spk:"ERNIE",cls:"er",txt:"«Отойди от него.»"},{narr:true,txt:"«Я могу помочь.\nТри жизни.\nПолных.\nНовых.»"},{spk:"ERNIE",cls:"er",txt:"«НЕ СЛУШАЙ.»"},{narr:true,txt:"«Цена?\nЕго воспоминания.\nОн всё равно\nих сжёг.\nЧто ему терять?»"},{pause:3,stage:true,txt:"ERNIE молчит."},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Это правда.\nЯ сжёг их.»",spd:40},{pause:3,spk:"ERNIE",cls:"er",txt:"«Но пепел —\nмой.»",spd:50},{narr:true,txt:"«Решай.\nОн или ты.»"}],null,[{icon:"🔮",text:"Принять сделку",fn:"deal7Accept()",id:"d7a"},{icon:"🚫",text:"Отказаться",fn:"deal7Refuse()",id:"d7r"}],I.maze)}
            function deal7Accept(){G.uc.d7a=true;G.lives+=3;G.trust-=3;G.karma-=5;trackChoice("betrayedErnie");startD([{stage:true,txt:"Касаешься зеркала."},{stage:true,txt:"Тепло.\nПотом — жар."},{stage:true,txt:"ERNIE кричит."},{spk:"ERNIE",cls:"er",txt:"«НЕТ—»"},{stage:true,txt:"Обрывается."},{pause:4,stage:true,txt:"Тишина."},{stage:true,txt:"Три удара сердца.\nНовых. Чистых."},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Я...\nне помню\nчто хотел сказать.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Странно.\nТут было что-то.\nНа кончике языка.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Ладно.\nИдём дальше.\nНаверное.»"},{pause:3,stage:true,txt:"Его голос\nизменился.\nЧуть тише.\nЧуть пустее."}],function(){flashDamage();updH();addDiary("Ты отдал воспоминания ERNIE.\nЗа 3 жизни.\nЕго голос стал тише.","secret",7);notify("💔 Предательство · +3♥ · -5◆","bad");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.black_mirror)}
            function deal7Refuse(){G.uc.d7r=true;G.trust+=2;G.karma+=3;startD([{stage:true,txt:"Отворачиваешься."},{narr:true,txt:"«Ошибка.\nТы пожалеешь.»"},{stage:true,txt:"Зеркало трескается.\nОсколки — на пол."},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Ты мог взять.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Три жизни.\nЗа мои пустые\nвоспоминания.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Почему не взял?»",spd:40},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»",spd:60},{pause:3,spk:"ERNIE",cls:"er",txt:"«Никто раньше\nне отказывался.»"}],function(){updH();addDiary("Башня предложила 3 жизни\nза воспоминания ERNIE.\nТы отказался.\nНикто раньше не отказывался.","letter",7);notify("💛 Верность ·","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.maze)}
            function openCorridor(){startD([{stage:true,txt:"Бесконечные отражения.\nКаждое зеркало —\nты, но другой."},{stage:true,txt:"Один — старый.\nОдин — злой.\nОдин — счастливый."},{stage:true,txt:"Ни один —\nне настоящий."}],null,[{icon:"👁",text:"Идти вперёд",fn:"corrGo()",id:"cg7"},{icon:"🎭",text:"Надеть маску",fn:"corrMask()",id:"cm7"},{icon:"🔙",text:"Вернуться",fn:"corrBack()",id:"cb7"}],I.maze)}
            function corrGo(){G.uc.cg7=true;sI(I.fork);startD([{stage:true,txt:"Идёшь вперёд."},{stage:true,txt:"Отражения начинают\nдвигаться независимо."},{stage:true,txt:"Один ты смеётся.\nДругой плачет.\nТретий бежит."},{stage:true,txt:"Жутко.\nНо безопасно."},{spk:"ERNIE",cls:"er",txt:"«Не смотри на них.\nСмотри вперёд.»"},{pause:3,stage:true,txt:"Тишина."},{pause:2,stage:true,txt:"Все отражения\nостанавливаются."},{pause:3,stage:true,txt:"Одновременно."},{pause:2,stage:true,txt:"Все поворачиваются\nк тебе."}],function(){
                // JUMP-SCARE
                vibrate(200);doShake();
                $("gImgW").style.filter="invert(1) hue-rotate(180deg)";
                $("topSpk").className="d-spk spk-sm";$("topSpk").textContent="???";
                $("topTxt").className="d-txt critical";$("topTxt").textContent="«Т Ы  Н Е  В Ы Й Д Е Ш Ь.»";
                $("gTop").style.display="block";
                tone(80,.5,"sawtooth",.15);
                setTimeout(function(){
                    $("gImgW").style.filter="";
                    startD([{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Что это было?»"},{spk:"ERNIE",cls:"er",txt:"«Я... не знаю.\nЭтого раньше\nне было.»",spd:40},{pause:2,spk:"ERNIE",cls:"er",txt:"«Башня злится.»"},{spk:"ERNIE",cls:"er",txt:"«Ты слишком\nдалеко зашёл.\nОна не хочет\nтебя отпускать.»"}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.maze)
                },2000);
            },null,I.maze)}
            function corrMask(){sI(I.actor_mask);G.uc.cm7=true;var hasMask=G.items.indexOf("mask")>=0;if(hasMask){startD([{stage:true,txt:"Надеваешь маску."},{stage:true,txt:"Отражения замирают."},{stage:true,txt:"Не видят тебя.\nТы — невидимка\nдля зеркал."},{spk:"ERNIE",cls:"er",txt:"«Маска Актёра.\nОн знал\nпро этот этаж.»"},{stage:true,txt:"Проходишь\nсквозь коридор.\nТишина."}],function(){notify("🎭 Маска защитила","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.maze)}else{startD([{stage:true,txt:"Нет маски."},{spk:"ERNIE",cls:"er",txt:"«Надо было\nвзять в театре.»"}],function(){corrGo()},null,I.maze)}}
            function corrBack(){G.uc.cb7=true;startD([{stage:true,txt:"Оборачиваешься."},{stage:true,txt:"Дверь исчезла."},{spk:"ERNIE",cls:"er",txt:"«Нет.\nТолько вперёд.»"},{stage:true,txt:"Идёшь вперёд.\nОтражения следят."}],function(){notify("🪞 Нет пути назад","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.maze)}
            function openFakeErnie(){catReact("alert");startD([{stage:true,txt:"Голос.\nЗнакомый."},{spk:"ЛОЖНЫЙ",cls:"fe",txt:"«Я нашёл выход!\nИди за моим голосом!»"},{spk:"ERNIE",cls:"er",txt:"«Это не я.\nНЕ ИДИ.»"},{spk:"ЛОЖНЫЙ",cls:"fe",txt:"«Он врёт.\nОн часть башни.\nЯ — настоящий.»"},{spk:"ERNIE",cls:"er",txt:"«СЛУШАЙ МЕНЯ.»"}],null,[{icon:"🔊",text:"Идти за ложным",fn:"fakeFol()",id:"ff7"},{icon:"🔇",text:"Идти за настоящим",fn:"fakeReal()",id:"fr7"},{icon:"🤔",text:"«Докажи»",fn:"fakeProve()",id:"fp7"}],I.false_ernie)}
            function fakeFol(){G.uc.ff7=true;G.lives--;G.karma-=2;startD([{stage:true,txt:"Идёшь за голосом."},{stage:true,txt:"Свет.\nТёплый."},{stage:true,txt:"Ловушка."},{stage:true,txt:"Пол проваливается.\nТемнота.\nХолод."},{stage:true,txt:"Очнулся."},{spk:"ERNIE",cls:"er",txt:"«Я же сказал.»"},{spk:"ERNIE",cls:"er",txt:"«Я ВСЕГДА\nзвучу уставшим.\nТот был слишком\nуверенным.»"},{spk:"ERNIE",cls:"er",txt:"«Когда я уверен\nв чём-то —\nбеспокойся.»"}],function(){updH();notify("🔊 Ловушка","bad");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.false_ernie)}
            function fakeReal(){G.uc.fr7=true;G.trust+=1;startD([{stage:true,txt:"Идёшь на голос ERNIE.\nТихий. Усталый."},{stage:true,txt:"Правильный."},{spk:"ERNIE",cls:"er",txt:"«Спасибо,\nчто узнал.»"},{spk:"ERNIE",cls:"er",txt:"«Мало кто\nотличает.»"},{stage:true,txt:"Ложный голос\nзатихает.\nОбижен."}],function(){updH();notify("✓ Настоящий ERNIE","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.false_ernie)}
            function fakeProve(){G.uc.fp7=true;G.trust+=2;var heardViolin=G.uc.pv;startD(heardViolin?[{spk:"ERNIE",cls:"er",txt:"«Мама играла\nколыбельную на скрипке.»"},{stage:true,txt:"Ты слышал это.\nВ оркестровой яме.\nЭтаж 4."},{spk:"ЛОЖНЫЙ",cls:"fe",txt:"«Я тоже\nэто знаю—»"},{spk:"ERNIE",cls:"er",txt:"«Нет.\nТы знаешь факты.\nЯ помню боль.»"},{stage:true,txt:"Ложный голос\nзамолкает."},{spk:"ERNIE",cls:"er",txt:"«Спасибо.»"}]:[{spk:"ERNIE",cls:"er",txt:"«Я... не знаю,\nкак доказать.»"},{spk:"ERNIE",cls:"er",txt:"«Просто...\nя устал.\nОн — нет.»"},{stage:true,txt:"Настоящий голос\nвсегда звучит усталым."},{spk:"ERNIE",cls:"er",txt:"«Пожалуйста.\nПоверь мне.»"}],function(){updH();notify("💎 +доверие","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.false_ernie)}
            function openDouble(){sHeart();vibrateHeartbeat();catReact("danger");startD([{stage:true,txt:"В зеркале — ты."},{stage:true,txt:"Но он выходит\nиз зеркала."},{stage:true,txt:"Стоит перед тобой.\nТочная копия."},{stage:true,txt:"Глаза — пустые."},{spk:"ERNIE",cls:"er",txt:"«Не смотри ему\nв глаза.»"}],null,[{icon:"👁",text:"Смотреть в глаза",fn:"dblLook()",id:"dl7"},{icon:"🧠",text:"Доказать кто ты",fn:"dblDodge()",id:"dd7"},{icon:"🚶",text:"Обойти",fn:"dblPass()",id:"dp7"}],I.double)}
            function dblDodge(){trackEvent("dbl_dodge");setTimeout(function(){notify("📊 "+getChoicePct("dblDodge")+"% доказывали","gold")},6000);
                catReact("hiss");
                G._dblScore=0;G._dblRound=0;
                startD([
                    {stage:true,txt:"Двойник не атакует.\nОн улыбается."},
                    {stage:true,txt:"Он знает всё о тебе.\nКаждый шаг.\nКаждый выбор."},
                    {spk:"ДВОЙНИК",cls:"sm",txt:"«Докажи,\nчто ты — настоящий.»"},
                    {spk:"ДВОЙНИК",cls:"sm",txt:"«Три вопроса.\nТри ответа.\nОшибёшься — я займу\nтвоё место.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Не слушай его.»"},
                    {spk:"ДВОЙНИК",cls:"sm",txt:"«Тихо, голос.\nЭто между мной\nи им.»"}
                ],function(){dblQ1()},null,I.double);
            }
            function dblQ1(){
                G._dblRound=1;
                // Вопрос 1: основан на выборах игрока
                var q,opts,correct;
                if(G.uc.cc){
                    q="«Что ты попросил\nу Баристы?»";
                    opts=[{icon:"☕",text:"Кофе",fn:"dblAns(1,0)",id:"da0"},{icon:"🍵",text:"Чай",fn:"dblAns(1,1)",id:"da1"},{icon:"🗣",text:"Поговорить",fn:"dblAns(1,2)",id:"da2"}];
                    correct=0;
                } else if(G.uc.ld){
                    q="«Что сделала\nдевочка на первом этаже?»";
                    opts=[{icon:"🎨",text:"Нарисовала меня",fn:"dblAns(1,0)",id:"da0"},{icon:"📖",text:"Читала книгу",fn:"dblAns(1,1)",id:"da1"},{icon:"🎵",text:"Пела песню",fn:"dblAns(1,2)",id:"da2"}];
                    correct=0;
                } else {
                    q="«Как звали голос,\nкоторый вёл тебя\nпо башне?»";
                    opts=[{icon:"🗣",text:"ERNIE",fn:"dblAns(1,0)",id:"da0"},{icon:"👤",text:"Страж",fn:"dblAns(1,1)",id:"da1"},{icon:"🏚",text:"Башня",fn:"dblAns(1,2)",id:"da2"}];
                    correct=0;
                }
                G._dblCorrect=correct;
                startD([{spk:"ДВОЙНИК",cls:"sm",txt:q}],null,opts,I.double);
            }
            function dblAns(round,pick){
                var win=(pick===G._dblCorrect);
                if(win)G._dblScore++;
                var react=win?
                    [{spk:"ДВОЙНИК",cls:"sm",txt:"«Знаешь.\nПока знаешь.»"}]:
                    [{spk:"ДВОЙНИК",cls:"sm",txt:"«Неправильно.\nТы уже забываешь\nкто ты.»"},{stage:true,txt:"Холод."}];
                if(round===1){
                    startD(react,function(){dblQ2()},null,I.double);
                } else if(round===2){
                    startD(react,function(){dblQ3()},null,I.double);
                } else {
                    // Финал
                    dblFinish();
                }
            }
            function dblQ2(){
                G._dblRound=2;
                var q,opts,correct;
                if(G.catName){
                    q="«Как ты назвал\nкошку?»";
                    var fakeName=["Мурка","Тень","Призрак"][Math.floor(Math.random()*3)];
                    var fakeN2=["Дымка","Ночь","Пепел"][Math.floor(Math.random()*3)];
                    var realIdx=Math.floor(Math.random()*3);
                    opts=[
                        {icon:"🐱",text:realIdx===0?G.catName:fakeName,fn:"dblAns(2,0)",id:"db0"},
                        {icon:"🐱",text:realIdx===1?G.catName:fakeN2,fn:"dblAns(2,1)",id:"db1"},
                        {icon:"🐱",text:realIdx===2?G.catName:(fakeName===fakeN2?"Луна":fakeN2),fn:"dblAns(2,2)",id:"db2"}
                    ];
                    correct=realIdx;
                } else if(G.hasKnife){
                    q="«Что ты взял\nу фонаря?»";
                    opts=[{icon:"🔪",text:"Нож",fn:"dblAns(2,0)",id:"db0"},{icon:"🔑",text:"Ключ",fn:"dblAns(2,1)",id:"db1"},{icon:"📜",text:"Записку",fn:"dblAns(2,2)",id:"db2"}];
                    correct=0;
                } else {
                    q="«Сколько этажей\nты прошёл?»";
                    var f=G.currentFloor||7;
                    var realIdx=Math.floor(Math.random()*3);
                    opts=[
                        {icon:"🔢",text:realIdx===0?f+"":((f+2)+""),fn:"dblAns(2,0)",id:"db0"},
                        {icon:"🔢",text:realIdx===1?f+"":((f-2)+""),fn:"dblAns(2,1)",id:"db1"},
                        {icon:"🔢",text:realIdx===2?f+"":((f+4)+""),fn:"dblAns(2,2)",id:"db2"}
                    ];
                    correct=realIdx;
                }
                G._dblCorrect=correct;
                startD([{spk:"ДВОЙНИК",cls:"sm",txt:q}],null,opts,I.double);
            }
            function dblQ3(){
                G._dblRound=3;
                // Последний вопрос — философский, нет правильного ответа
                startD([
                    {spk:"ДВОЙНИК",cls:"sm",txt:"«Последний вопрос.»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ДВОЙНИК",cls:"sm",txt:"«Зачем ты\nподнимаешься?»",spd:40}
                ],null,[
                    {icon:"💛",text:"Ради ERNIE",fn:"dblAns3('ernie')",id:"dc0"},
                    {icon:"🚪",text:"Хочу выйти",fn:"dblAns3('exit')",id:"dc1"},
                    {icon:"❓",text:"Не знаю",fn:"dblAns3('dunno')",id:"dc2"}
                ],I.double);
            }
            function dblAns3(ans){
                G._dblScore++;// Все ответы правильные
                var lines;
                if(ans==="ernie"){
                    lines=[{spk:"ДВОЙНИК",cls:"sm",txt:"«Ради голоса?\nОн даже не живой.»"},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Он прав.\nНо спасибо.»",spd:50}];
                } else if(ans==="exit"){
                    lines=[{spk:"ДВОЙНИК",cls:"sm",txt:"«Выхода нет.\nТы знаешь.»"},{spk:"ERNIE",cls:"er",txt:"«Есть. Наверху.»"},{spk:"ДВОЙНИК",cls:"sm",txt:"«Он врёт.»"},{spk:"ERNIE",cls:"er",txt:"«Может быть.\nНо я всё равно\nведу наверх.»"}];
                } else {
                    lines=[{spk:"ДВОЙНИК",cls:"sm",txt:"«Не знаешь.\nЧестно.»"},{pause:3,stage:true,txt:""},{spk:"ДВОЙНИК",cls:"sm",txt:"«Настоящие\nне знают.\nКопии — всегда\nуверены.»"},{spk:"ERNIE",cls:"er",txt:"«...Он только что\nпризнал,\nчто ты настоящий.»"}];
                }
                startD(lines,function(){dblFinish()},null,I.double);
            }
            function dblFinish(){
                var score=G._dblScore||0;
                if(score>=2){
                    G.karma+=3;G.trust+=1;
                    startD([
                        {stage:true,txt:"Двойник отступает."},
                        {stage:true,txt:"Его лицо\nразмывается."},
                        {spk:"ДВОЙНИК",cls:"sm",txt:"«Ты знаешь\nкто ты.\nПока.»"},
                        {stage:true,txt:"Рассыпается.\nОсколки зеркала\nна полу."},
                        {spk:"ERNIE",cls:"er",txt:"«Ты прошёл.\nНе силой.\nПамятью.»"},
                        {spk:"ERNIE",cls:"er",txt:"«Это важнее.»"}
                    ],function(){updH();notify("🪞 Двойник побеждён","gold");backF7()},null,I.double);
                } else {
                    G.lives=Math.max(0,G.lives-1);
                    startD([
                        {stage:true,txt:"Двойник улыбается\nшире."},
                        {spk:"ДВОЙНИК",cls:"sm",txt:"«Ты забываешь\nкто ты.\nКак все тут.»"},
                        {stage:true,txt:"Холод.\nТемнота.\nНа секунду —\nты не знаешь\nгде настоящий."},
                        {spk:"ERNIE",cls:"er",txt:"«Ты тут.\nЯ слышу.\nДержись.»"}
                    ],function(){flashDamage();updH();notify("👤 Двойник","bad");backF7()},null,I.double);
                }
            }
            function dblLook(){trackEvent("dbl_look");setTimeout(function(){notify("📊 "+getChoicePct("dblLook")+"% смотрели в глаза","gold")},6000);G.uc.dl7=true;var hasMask=G.items.indexOf("mask")>=0;if(hasMask){startD([{stage:true,txt:"Смотришь."},{stage:true,txt:"Двойник улыбается."},{stage:true,txt:"Маска на лице\nтрескается.\nНагревается."},{stage:true,txt:"Двойник рассыпается.\nОсколки зеркала."},{spk:"ERNIE",cls:"er",txt:"«Маска спасла.\nНо она разрушена.»"},{stage:true,txt:"Осколки маски\nна полу."}],function(){var idx=G.items.indexOf("mask");G.items.splice(idx,1);updH();notify("🎭→💥 Маска разрушена","bad");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.double)}else if(G.hasCat&&!hasMask){startD([{stage:true,txt:"Смотришь."},{stage:true,txt:"Двойник улыбается."},{stage:true,txt:"Холод.\nЛедяной.\nПронизывающий."},{stage:true,txt:"Мир плывёт.\nТемнеет."},{stage:true,txt:(G.catName||"Кошка")+" прыгает.",fn:function(){sI(I.cat_sacrifice)}},{pause:2,stage:true,txt:"Между тобой\nи двойником."},{stage:true,txt:"Свет."},{pause:3,stage:true,txt:"Тишина."},{pause:4,stage:true,txt:""},{stage:true,txt:(G.catName||"Кошка")+" лежит\nна полу."},{pause:3,stage:true,txt:"Не двигается."},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Нет.»",spd:60},{pause:3,spk:"ERNIE",cls:"er",txt:"«Нет, нет, нет.»",spd:40},{pause:4,stage:true,txt:""},{stage:true,txt:"Берёшь на руки.\nТёплая.\nЕщё тёплая."},{pause:3,stage:true,txt:""},{stage:true,txt:"Глаза закрыты."},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Она закрыла\nтебя собой.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Как...\nкак настоящая.»",spd:50},{pause:4,stage:true,txt:""},{stage:true,txt:"Кладёшь на пол.\nОсторожно."},{pause:3,stage:true,txt:""},{stage:true,txt:"Двойник исчез.\nОсколки зеркала вокруг."},{pause:3,stage:true,txt:"В одном осколке —\nотражение "+(G.catName||"кошки")+".\nЖивой.\nМурчит."},{pause:3,stage:true,txt:"Но это только\nотражение."}],function(){G.hasCat=false;G.catDead=true;hideCat();var idx=G.items.indexOf("cat");if(idx>=0)G.items.splice(idx,1);updH();addDiary((G.catName||"Кошка")+" закрыла тебя собой.\nОт двойника.\nОна больше не мурчит.","letter",7);notify("🐱💀 "+(G.catName||"Кошка"),"bad");showCh([{icon:"🚪",text:"...",fn:"backF7()",id:"bk"}])},null,I.double)}else{G.lives--;flashDamage();startD([{stage:true,txt:"Смотришь."},{stage:true,txt:"Двойник улыбается."},{stage:true,txt:"Холод.\nЛедяной.\nПронизывающий."},{stage:true,txt:"Мир плывёт.\nТемнеет."},{spk:"ERNIE",cls:"er",txt:"«ЗАКРОЙ ГЛАЗА!»"},{stage:true,txt:"Закрываешь.\nДвойник исчезает.\nНо след — остался."}],function(){updH();notify("👤 Двойник","bad");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.double)}}
            function dblPass(){G.uc.dp7=true;startD([{stage:true,txt:"Обходишь.\nНе смотришь."},{stage:true,txt:"Двойник поворачивает\nголову вслед."},{stage:true,txt:"И рассыпается."},{spk:"ERNIE",cls:"er",txt:"«Он хотел,\nчтобы ты посмотрел.\nСпасибо, что нет.»"}],function(){notify("✓ Двойник обойдён","gold");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,I.double)}
            function openMomCall(){vibratePhone();catReact("cling");startD([{stage:true,txt:"Пустой зал.\nТёмный.\nТишина.",fn:function(){sI(I.momcall)}},{pause:2,stage:true,txt:"Вибрация.",fn:function(){sHeart()}},{pause:1,narr:true,txt:"М А М А"},{pause:3,stage:true,txt:"ERNIE молчит.\nПолностью.\nНи слова."}],null,[{icon:"📞",text:"Ответить",fn:"momAnswer()",id:"ma7"},{icon:"🚫",text:"Не отвечать",fn:"momIgnore()",id:"mi7"}],I.momcall);
                    // ТАЙМЕР — 10 секунд или звонок обрывается навсегда
                    setTimeout(function(){
                        if(!G.uc.ma7&&!G.uc.mi7){
                            G.uc._momMissed=true;
                            $("gCh").innerHTML="";$("gCh").style.display="none";
                            sDanger();vibrate(40);
                            startD([
                                {stage:true,txt:"Звонок обрывается."},
                                {pause:3,stage:true,txt:"Тишина."},
                                {spk:"ERNIE",cls:"er",txt:"«Ты не выбрал.\\nЭто тоже выбор.»"},
                                {spk:"ERNIE",cls:"er",txt:"«Самый тяжёлый.»"}
                            ],function(){
                                addDiary("Мама звонила.\\nНе ответил. Не отклонил.\\nПросто — не успел.","letter",7);
                                showCh([{icon:"🚪",text:"...",fn:"backF7()",id:"bk"}]);
                            });
                        }
                    },10000);
                }
            function momAnswer(){G.choiceStats.momAnswer=true;trackEvent("mom_answer");setTimeout(function(){notify("📊 "+getChoicePct("momAnswer")+"% игроков ответили маме","gold")},8000);G.uc.ma7=true;if(G._momTimer)clearTimeout(G._momTimer);trackChoice("answeredMom");startD([{spk:"МАМА",cls:"mm",txt:"«Сынок?\nТы не выключил свет\nв ванной.»",spd:40},{pause:3,spk:"МАМА",cls:"mm",txt:"«Я звоню уже...\nсколько я звоню?»",fn:function(){sI(I.momcall)}},{pause:2,spk:"МАМА",cls:"mm",txt:"«Пожалуйста,\nвернись.\nТут холодно\nбез тебя.»"},{pause:2,spk:"МАМА",cls:"mm",txt:"«Я оставила свет\nна кухне.\nКак ты любишь.»",spd:40},{stage:true,txt:"Звонок обрывается."},{pause:3,stage:true,txt:"Тишина.",fn:function(){sI("")}},{pause:3,stage:true,txt:"Долгая."},{pause:3,stage:true,txt:"Абсолютная."},{spk:"ERNIE",cls:"er",txt:"«Я не мог подсказать.\nЭто был твой выбор.\nТолько твой.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Мне тоже звонила\nмама.\n200 лет назад.»",spd:40},{spk:"ERNIE",cls:"er",txt:"«Я не ответил.»"},{pause:3,stage:true,txt:""},{pause:3,spk:"ERNIE",cls:"er",txt:"«Думал — успею.»",spd:50},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«200 лет спустя —\nвсё ещё думаю.»",spd:40},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Не повторяй\nмоих ошибок.»"}],function(){G.uc.momAnswered=true;G.trust+=1;updH();addEcho(10,"мама");showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,null)}
            function momIgnore(){G.choiceStats.momIgnore=true;trackEvent("mom_ignore");setTimeout(function(){notify("📊 "+getChoicePct("momIgnore")+"% игроков не ответили","gold")},8000);G.uc.mi7=true;if(G._momTimer)clearTimeout(G._momTimer);startD([{stage:true,txt:"Звонит.",fn:function(){sI("")}},{pause:2,stage:true,txt:"Звонит."},{pause:2,stage:true,txt:"Звонит."},{pause:3,stage:true,txt:"Затихает."},{pause:3,stage:true,txt:"Тишина.\nДолгая."},{pause:3,spk:"ERNIE",cls:"er",txt:"«...Я бы ответил.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Если бы мог.»",spd:50}],function(){showCh([{icon:"🚪",text:"Назад",fn:"backF7()",id:"bk"}])},null,null)}
            function goF8(){document.body.classList.remove("ernie-fading");document.body.classList.add("ernie-glitch");fadeIn(function(){sI(I.maze);startD([{spk:"ERNIE",cls:"er",txt:"«Три этажа.»",spd:40},{stage:true,txt:"Смеётся.\nТихо.\nВ последний раз."}],function(){fadeIn(function(){goS("s2");showDoorF(8,"ЭТАЖ 8 · КОМНАТА ГОЛОСОВ",function(){fadeIn(function(){goS("sg");startF8()})})})})})}

            // === FLOOR 8: ROOM OF VOICES ===
            function startF8(){setParticles("ember");stopRain();setFx("ghost");startHeartbeat();startMusic("voices");catReact("alert");ravenNotify(8);ghostNotify(8);G.currentFloor=8;updateProgress(8);sI(I.voices);sF("ЭТАЖ 8 · КОМНАТА ГОЛОСОВ");if(G.hasCat){notify("🐱 "+(G.catName||"Кошка")+" шипит в темноту","gold")}startD([{stage:true,txt:"Темнота.\nАбсолютная."},{spk:"ERNIE",cls:"er",txt:"«Восьмой. Осталось два.»"},{spk:"ERNIE",cls:"er",txt:"«Приготовься.\nТут шумно.»"},{stage:true,txt:"Потом — голоса.\nВсе сразу."},{spk:"БАРИСТА",cls:"bo",txt:"«Ты живой!»"},{spk:"ЛИКА",cls:"li",txt:"«Это ты и дом!»"},{spk:"КОНДУКТОР",cls:"ko",txt:"«Билет!»"},{spk:"БИБЛ.",cls:"bi",txt:"«Твоя книга пуста!»"},{spk:"АКТЁР",cls:"ak",txt:"«Третий акт!»"},{spk:"СМОТРИТЕЛЬ",cls:"sm",txt:"«0 из 847.»"},{stage:true,txt:"И другие голоса.\nНе NPC.\nЛюди."},{narr:true,txt:"«...мне 22, я на\nвтором этаже,\nтут темно...»"},{narr:true,txt:"«...мама, забери\nменя домой...\nмне 9 лет...»"},{stage:true,txt:"847 голосов.\nКаждый — чья-то\nпоследняя запись.",fn:function(){sI(I.voices_crowd)}},{stage:true,txt:"Хочется закрыть уши.\nНо голоса — внутри."},{pause:5,spk:"ERNIE",cls:"er",txt:"«Бу.»",spd:80}],function(){f8Part2()})}
            function f8Part2(){sI(I.voices);
                // Момент без интерфейса — дыхание
                stopMusic();
                var breath=document.createElement("div");
                breath.style.cssText="position:fixed;inset:0;background:#000;z-index:600;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 2s";
                var dot=document.createElement("div");
                dot.style.cssText="width:6px;height:6px;border-radius:50%;background:rgba(200,168,72,.3);animation:breathDot 3s ease infinite";
                breath.appendChild(dot);
                document.body.appendChild(breath);
                setTimeout(function(){breath.style.opacity="1"},50);
                // 12 секунд дыхания, потом имя
                setTimeout(function(){
                    dot.remove();
                    var name=document.createElement("div");
                    name.style.cssText="font-family:Raleway,sans-serif;font-size:16px;color:rgba(200,168,72,.4);font-style:italic;opacity:0;transition:opacity 3s";
                    name.textContent=G.playerName||"...";
                    breath.appendChild(name);
                    setTimeout(function(){name.style.opacity="1"},100);
                    // Потом исчезает
                    setTimeout(function(){
                        breath.style.opacity="0";
                        setTimeout(function(){breath.remove();f8Part2Real()},2000);
                    },5000);
                },12000);
            }
            function f8Part2Real(){
                if(!G._wallsTruth){G._wallsTruth=true;stopMusic();
                    startD([
                        {pause:3,stage:true,txt:"Голоса стихают.\nОдин остаётся."},
                        {narr:true,txt:"«Помоги.\nЯ в стене.\nЯ — стена.»"},
                        {pause:3,stage:true,txt:"Касаешься стены.\nТёплая. Пульсирует.\nКак сердце."},
                        {pause:3,stage:true,txt:"Под штукатуркой —\nлицо.\nМолодое. Рот открыт\nв беззвучном крике."},
                        {pause:3,stage:true,txt:"Смотришь вокруг.\nЛица. Везде. Сотни."},
                        {pause:3,stage:true,txt:"847."},
                        {pause:3,stage:true,txt:"Они не ушли.\nОни — здесь.\nБашня построена из них."},
                        {pause:3,stage:true,txt:"Каждый кирпич — человек.\nКаждая ступенька — жизнь."},
                        {pause:3,stage:true,txt:"Ты шёл по ним.\nВсю игру."},
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Ты думал они ушли.»",spd:40},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Нет.\nОни тут.\nПод ногами.\nВсегда были.»",spd:35},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Я должен был\nсказать раньше.»"},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Но тогда бы ты\nне дошёл.»",spd:40},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Я знал.\nС первого этажа.\nС первого шага.\nИ вёл тебя по ним.\nШутил. Отвлекал.»",spd:35},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Потому что\nмне нужно\nчтобы кто-то дошёл.»",spd:40},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Не для башни.\nДля меня.\nМне одиноко.»",spd:40},
                        {pause:15,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Извини за честность.\nОбычно я шучу\nв таких моментах.»"},
                        {pause:3,spk:"ERNIE",cls:"er",txt:"«Но у меня\nкончились шутки.\nНа 200-м году\nони кончаются.»"}
                    ],function(){addDiary("847. Не ушли. Стены.\nERNIE знал. С первого шага.","secret",8);notify("💀 Правда","bad");G.karma+=5;G.trust+=3;updH();f8Part2Cont()});return}
                f8Part2Cont();}
            function f8Part2Cont(){
                // Мини-игра: мелькающие голоса + СТОП
                var voices847=[
                    "«Мне 22, Андрей.\nЕсли кто-то слышит —\nпожалуйста...»",
                    "«Зеркала врут.\nЗЕРКАЛА ВРУТ.»",
                    "«Мама, забери\nменя домой.\nМне 9 лет.»",
                    "«Бариста делает\nлучший кофе.\nИ он мёртв.»",
                    "«Не верь голосу.\nНе верь.»",
                    "«Я тут 3 года.\nИли 3 дня.\nНе помню.»",
                    "«Лика нарисовала\nмоё лицо.\nЯ его забыл.\nОна — нет.»",
                    "«Кошка жива.\nОна единственная\nкто жив.»",
                    "«Этаж 7 —\nне отвечай\nна звонок.»",
                    "«Привет из 2024.\nНикто не слышит.\nНикто.»",
                    "«Мне было 14.\nКак ему.\nКак всем.»",
                    "«На крыше —\nсвет.\nНе иди.\nСвет врёт.»",
                    "«Я любил маму.\nТеперь не помню\nеё лицо.»",
                    "«847.\nМы все тут.\nЖдём.»",
                    "«Ворон знает.\nСпроси ворона.»"
                ];
                startD([
                    {stage:true,txt:"Голоса.\n847 одновременно."},
                    {stage:true,txt:"Мелькают.\nСлишком быстро."},
                    {spk:"ERNIE",cls:"er",txt:"«Можешь остановить.\nОдин голос.\nТолько один.»"}
                ],function(){
                    // Показываем мелькающие голоса
                    $("gTop").style.display="block";
                    $("gBotW").style.display="none";
                    $("topSpk").textContent="";
                    $("topTxt").className="d-txt narr";
                    var vi=0;
                    var flashTimer=setInterval(function(){
                        $("topTxt").textContent=voices847[vi%voices847.length].replace(/«|»/g,"").replace(/\n/g," ");
                        vi++;
                    },400);
                    // Кнопка СТОП
                    showCh([{icon:"⏹",text:"СТОП",fn:"f8stop()",id:"f8s"}]);
                    // Сохраняем таймер
                    G._flashTimer=flashTimer;
                    G._voices847=voices847;
                    G._voiceIdx=function(){return vi%voices847.length};
                })
            }
            function f8stop(){
                if(G._flashTimer)clearInterval(G._flashTimer);
                var idx=G._voiceIdx?G._voiceIdx():0;
                var voice=G._voices847?G._voices847[idx]:"«...»";
                vibrate(50);
                startD([
                    {pause:2,stage:true,txt:"Тишина."},
                    {pause:2,stage:true,txt:"Один голос\nостался."},
                    {pause:3,narr:true,txt:voice},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Один из 847.»"},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Теперь ты знаешь\nего историю.\nНа одно предложение.»",spd:40},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Этого достаточно?»"}
                ],function(){
                    notify("⏹ Голос пойман","gold");
                    f8Part2b();
                })
            }
            function f8Part2b(){if(G.hasCat){startD([{stage:true,txt:"Мяуканье."},{stage:true,txt:"Тихое.\nНе как раньше."},{stage:true,txt:"Кошка сидит.\nСмотрит на тебя."},{stage:true,txt:"Не идёт дальше."},{spk:"ERNIE",cls:"er",txt:"«Она не может выше.»"},{spk:"ERNIE",cls:"er",txt:"«Восьмой этаж —\nпредел для живых.»"},{stage:true,txt:"Живых."},{stage:true,txt:"Она была единственным\nживым существом\nво всей башне."},{stage:true,txt:"Гладишь её.\nМурчит."},{stage:true,txt:"Все эти этажи —\nрядом. Шипела на тени.\nНе просила ничего."},{spk:"ERNIE",cls:"er",txt:"«Она ждёт тебя тут.»"},{stage:true,txt:"Пауза."},{spk:"ERNIE",cls:"er",txt:"«Возвращайся.»",fn:function(){ernieTheme()}},{stage:true,txt:"Встаёшь.\nОна мяукает.\nОдин раз.",spd:50},{stage:true,txt:"Не оглядываешься.",fn:function(){sI(I.cat_farewell)}},{stage:true,txt:"Но слышишь —\nмурчание затихает\nс каждым шагом.",spd:60,fn:function(){sPurr()}}],function(){G.hasCat=false;updH();notify("🐱 ...","bad");f8Part3()},null,I.cat_bye)}else{f8Part3()}}
            function f8Part3(){setTimeout(function(){showGhostPop("ERNIE",I.ava_ernie,"Я запомню каждый\nтвой шаг.")},5000);
                var h=new Date().getHours();var nightL=[];
                if(h>=23||h<5){nightL=[{pause:2,spk:"ERNIE",cls:"er",txt:"«Поздно.»"},{spk:"ERNIE",cls:"er",txt:"«Ты устал. Я вижу.»"},{spk:"ERNIE",cls:"er",txt:"«Может, закрой игру.\nСерьёзно.»",spd:40},{pause:4,spk:"ERNIE",cls:"er",txt:"«Ты остался.\nХрабро. Или упрямо.»"}]}
                var mem=nightL.slice();
                mem.push({spk:"ERNIE",cls:"er",txt:"«847 человек.\nЯ помню каждого.\nКаждое имя.\nКаждый выбор.\nКаждую шутку,\nнад которой смеялись.\nКаждую дверь.»"});
                // Динамические воспоминания — конкретные действия игрока
                if(G.uc.cc) mem.push({spk:"ERNIE",cls:"er",txt:"«На первом\nты попросил кофе\nу Баристы.\nОн был так счастлив.\n200 лет никто\nне просил.»"});
                if(G.uc.bk) mem.push({spk:"ERNIE",cls:"er",txt:"«Бариста сказал\nне доверять мне.\nТы запомнил?»"});
                if(G.uc.ld) mem.push({spk:"ERNIE",cls:"er",txt:"«Лика нарисовала тебя.\nОна не рисует\nвсех подряд.»"});
                if(G.uc.lw) mem.push({spk:"ERNIE",cls:"er",txt:"«Лика передала\n— что скучает.\nЯ слышал.\nЯ всегда слышу.»"});
                if(G.uc.wt) mem.push({spk:"ERNIE",cls:"er",txt:"«Ты тронул надпись\nна стене.\n«Э., 14 лет».\nМою надпись.»"});
                if(G.catName) mem.push({spk:"ERNIE",cls:"er",txt:"«Кошку назвал\n"+G.catName+".\n"+(G.catName.toLowerCase()==="рыжик"||G.catName.toLowerCase()==="ryzhik"?"Моим именем.\nЯ не забуду.":"Хорошее имя.\nЛучше, чем Рыжик.\nМожет быть.")+"»"});
                if(G.uc.tp) mem.push({spk:"ERNIE",cls:"er",txt:"«Слушал Трубача.\nОн играл мою мелодию.\nКоторую мама...\nНеважно.»"});
                if(G.uc.br) mem.push({spk:"ERNIE",cls:"er",txt:"«Прочитал мой дневник.\nТот, что я сжёг.\nА ты всё равно\nпрочитал.»"});
                if(G.uc.ms) mem.push({spk:"ERNIE",cls:"er",txt:"«Нора рассказала\nпро Тень.\nТеперь ты знаешь\nбольше, чем нужно.»"});
                if(G.uc.ab) mem.push({spk:"ERNIE",cls:"er",txt:"«Алиса рассказала\nпро лифт.\nЭто была моя шутка.\nГлупая.\nНо она засмеялась.»"});
                if(G.uc.pne) mem.push({spk:"ERNIE",cls:"er",txt:"«Узнал правду\nот Смотрителя.\nТеперь знаешь,\nкто я на самом деле.»"});
                if(G.uc.ma7) mem.push({spk:"ERNIE",cls:"er",txt:"«Ты ответил\nна звонок мамы.\nЯ не смог\nподсказать.\nИ не смог\nне слушать.»"});
                if(G.uc.mi7) mem.push({spk:"ERNIE",cls:"er",txt:"«Ты не ответил\nна звонок.\nМожет, правильно.\nМожет, нет.\nЯ не знаю.»"});
                mem.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Я запоминаю всё.\nЭто моя работа.\nИли проклятье.»"});
                mem.push({pause:2,spk:"ERNIE",cls:"er",txt:"«847 раз я говорил\n«Добро пожаловать».\n847 раз —\n«До свидания».\nНи разу —\n«Останься».»"});
                if(G.trust>=4){mem.push({pause:3,spk:"ERNIE",cls:"er",txt:"«Хотя...»",spd:60});mem.push({pause:4,stage:true,txt:""});mem.push({spk:"ERNIE",cls:"er",txt:"«Нет. Неважно.»",spd:40})}
                mem.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Пока.»"});
                startD(mem.concat([{stage:true,txt:"Голоса стихают\nодин за другим."},{stage:true,txt:"Бариста. Тишина.\nЛика. Тишина.\nКондуктор. Тишина."},{stage:true,txt:"Библиотекарь.\nАктёр.\nСмотритель."},{stage:true,txt:"Тишина."},{stage:true,txt:"Последним —"},{spk:"ERNIE",cls:"er",txt:"«Ты ещё тут?»"}]),function(){showCh([{icon:"💛",text:"Да",fn:"f8yes()",id:"f8y"}])})
            }
            function f8yes(){catReact("wait");PROMISES.add("Я ещё тут");EMOTION.add(15);HEARTBEAT.stop();var lines=[{pause:1,spk:"ERNIE",cls:"er",txt:"«Хорошо.»"}];if(G.uc.cqLeftDoor){lines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Бариста спрашивал\nпро дверь.»"});lines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Ты сказал —\nуйдёшь.»"});lines.push({pause:3,spk:"ERNIE",cls:"er",txt:"«Ты правда уйдёшь?»",spd:40});lines.push({pause:3,stage:true,txt:""})}lines=lines.concat([{spk:"ERNIE",cls:"er",txt:"«~~Я не хочу чтобы ты уходил~~»",del:true},{spk:"ERNIE",cls:"er",txt:"«Два этажа.\nПотом — крыша.»"},{spk:"ERNIE",cls:"er",txt:"«Мне нужно\nтебе кое-что сказать.»"},{spk:"ERNIE",cls:"er",txt:"«Но не здесь.\nНа девятом.»"}]);startD(lines,function(){showBar("ПОДНЯТЬСЯ НА ЭТАЖ 9 →","goF9()")})}
            function goF9(){fadeIn(function(){goS("s2");showDoorF(9,"ЭТАЖ 9 · ПУСТОТА",function(){fadeIn(function(){goS("sg");f9ErniePlea()})})})}

            // === FLOOR 9: THE VOID ===

            // === ЭТАЖ 9: ERNIE ПРОСИТ ЗАКРЫТЬ ===
            function f9ErniePlea(){
                stopMusic();stopPressure();sI(I.ernie_visible);
                startD([
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"\u00abСтой.\u00bb"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"\u00abПожалуйста.\nСтой.\u00bb",spd:50},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"\u00abЕсли ты откроешь\nэту дверь \u2014\nя исчезну.\u00bb",spd:35},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"\u00abНе умру.\nУмер давно.\u00bb"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"\u00abИсчезну.\nКак будто\nне было.\u00bb",spd:40},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"\u00abГолос.\n200 лет.\nВсё что от меня\nосталось.\u00bb",spd:35},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"\u00abИ ты это\nзаберёшь.\u00bb"},
                    {pause:3,stage:true,txt:""}
                ],function(){
                    var ch=document.getElementById("gCh");ch.innerHTML="";ch.style.display="flex";
                    var openBtn=document.createElement("button");
                    openBtn.className="ch-btn";openBtn.setAttribute("data-w","heavy");
                    openBtn.textContent="\ud83d\udeaa Открыть дверь";
                    openBtn.style.cssText="transition:opacity 8s;opacity:1";
                    openBtn.onclick=function(){
                        addDread(20);
                        startD([
                            {spk:"ERNIE",cls:"er",txt:"\u00abНЕТ\u2014\u00bb"},
                            {pause:3,stage:true,txt:"Тишина."},
                            {pause:3,stage:true,txt:""},
                            {stage:true,txt:"Пустота.\nТам, где был голос \u2014\nничего."},
                            {pause:4,stage:true,txt:""},
                            {pause:3,spk:"ERNIE",cls:"er",txt:"\u00ab...я ещё тут.\u00bb",spd:60},
                            {pause:3,spk:"ERNIE",cls:"er",txt:"\u00abНе знаю как.\nНо тут.\u00bb"},
                            {pause:3,spk:"ERNIE",cls:"er",txt:"\u00abСпасибо\nчто не закрыл.\u00bb"}
                        ],function(){startF9()});
                    };
                    ch.appendChild(openBtn);
                    setTimeout(function(){openBtn.style.opacity=".15"},100);
                    setTimeout(function(){
                        var closeBtn=document.createElement("button");
                        closeBtn.className="ch-btn";closeBtn.setAttribute("data-w","good");
                        closeBtn.style.cssText="opacity:0;transition:opacity 3s";
                        closeBtn.textContent="\u2716 Закрыть игру";
                        closeBtn.onclick=function(){
                            TM.closedForErnie=true;saveTM();
                            document.body.style.transition="opacity 2s";
                            document.body.style.opacity="0";
                            setTimeout(function(){
                                document.body.innerHTML='<div style="position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:Raleway,sans-serif;font-size:13px;color:rgba(200,168,72,.2);font-style:italic">До встречи.</div>';
                            },2500);
                        };
                        ch.appendChild(closeBtn);
                        setTimeout(function(){closeBtn.style.opacity="1"},50);
                    },8000);
                })
            }

            function startF9(){setParticles("cold");
                // ERNIE disappears
                var ernieGone=false;
                setTimeout(function(){
                    notify("⚠ ERNIE замолчал.",null);
                    ernieGone=true;
                },8000);
                setTimeout(function(){
                    notify("⚠ ...","bad");
                },15000);
                setTimeout(function(){
                    if(ernieGone){
                        notify("💛 ERNIE: «...Я тут.»","gold");
                        ernieGone=false;
                    }
                },25000);
                // Трубач popup
                if(G.uc.tp)setTimeout(function(){showGhostPop("ТРУБАЧ",I.trumpeter,"Последняя мелодия.\nДля мальчика\nкоторый не вырос.")},3000);
                // Трубач — последняя мелодия
                if(!G._trumpF9){G._trumpF9=true;
                    startD([
                        {pause:3,stage:true,txt:"На лестнице —\nзнакомый звук.\nТруба. Тихая."},
                        {spk:"ТРУБАЧ",cls:"bo",txt:"«Эй.\nТы ещё тут?»"},
                        {spk:"ERNIE",cls:"er",txt:"«Как ты... сюда?»"},
                        {spk:"ТРУБАЧ",cls:"bo",txt:"«Музыка не знает\nэтажей. Только ноты.»"},
                        {pause:3,spk:"ТРУБАЧ",cls:"bo",txt:"«Сыграю последнюю.\nДля мальчика\nкоторый не вырос.»"},
                        {pause:3,spk:"ТРУБАЧ",cls:"bo",txt:"«И для того\nкто идёт рядом.»"},
                        {pause:3,stage:true,txt:"Мелодия. Тихая.\nКак колыбельная.",fn:function(){ernieThree()}},
                        {pause:4,stage:true,txt:"Замолкает."},
                        {spk:"ТРУБАЧ",cls:"bo",txt:"«Всё.\n400 лет. Достаточно.»"},
                        {spk:"ТРУБАЧ",cls:"bo",txt:"«Не люблю прощания.\nЯ джазмен.\nМы просто\nперестаём играть.»"},
                        {pause:3,stage:true,txt:"Тишина. Навсегда."}
                    ],function(){notify("🎺 Последняя мелодия","gold");addDiary("Трубач сыграл последнюю.\nДля мальчика. Для меня.","letter",9);startF9Real()});return}
                startF9Real();}
            function startF9Real(){document.body.classList.add("void-mode");setFx("void");stopHeartbeat();startMusic("void9");hideCat();ravenNotify(9);G.currentFloor=9;updateProgress(9);sI(I.void9);sF("ЭТАЖ 9 · ПУСТОТА");var voidIntro=[{pause:8,stage:true,txt:""},{stage:true,txt:"Ничего.",spd:60},{pause:5,stage:true,txt:""},{stage:true,txt:"Белое.",spd:60},{pause:8,stage:true,txt:""}];if(TM.runs>1&&TM.bestFloor>=9){voidIntro.push({pause:3,stage:true,txt:""});voidIntro.push({spk:"ERNIE",cls:"er",txt:"«Ты уже стоял здесь.»",spd:50});voidIntro.push({pause:3,spk:"ERNIE",cls:"er",txt:"«И ушёл.»",spd:50});voidIntro.push({pause:3,stage:true,txt:""});voidIntro.push({spk:"ERNIE",cls:"er",txt:"«Зачем вернулся?»",spd:40});voidIntro.push({pause:3,stage:true,txt:""})}voidIntro=voidIntro.concat([{stage:true,txt:"Потом — свечение.\nТихое. Как свеча."},{stage:true,txt:"Мальчик.",fn:function(){sI(I.ernie_sitting)}},{stage:true,txt:"14 лет.\nХудой.\nВолосы в глаза.\nПрозрачный."},{stage:true,txt:"Стоит.\nРуки в карманах.\nНе смотрит на тебя."},{spk:"ERNIE",cls:"er",txt:"«...Привет.»",spd:60},{pause:2,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Вот я какой.»",fn:function(){ernieTheme()}},{spk:"ERNIE",cls:"er",txt:"«Ну.\nПришли.\nДевятый.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Подожди.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Ты же знаешь\nчто это игра.»",spd:45},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«И всё равно\nдошёл до сюда.»",spd:40},{pause:3,spk:"ERNIE",cls:"er",txt:"«Зачем?»",spd:60},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Спасибо.»",spd:50},{pause:3,stage:true,txt:""},{pause:5,spk:"ERNIE",cls:"er",txt:"«Мне нужно\nтебе кое-что\nрассказать.»",spd:40},{stage:true,txt:"Поднимает глаза.\nВпервые — видишь\nего лицо."},{stage:true,txt:"Обычный мальчик.\nОбычный.\nЭто самое страшное.»"}]);startD(voidIntro,function(){f9Truth()},null,I.ernie_visible)}
            function f9Truth(){checkCombo("ernie9");
                sI(I.ernie_truth);
                // Динамически добавляем воспоминания на основе выборов игрока
                var dynamicLines=[];
                if(G.uc.ww6||G.uc.wp6){dynamicLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Ты ухаживал\nза моим цветком.»",spd:40});dynamicLines.push({pause:3,spk:"ERNIE",cls:"er",txt:"«Никто так\nне делал.»",spd:50})}
                if(G.uc.ma7){dynamicLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Ты ответил маме.\nМоей — я не ответил.»",spd:40});dynamicLines.push({pause:3,stage:true,txt:""})}
                if(G.catName){dynamicLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«"+G.catName+" хорошее имя.\nЯ её видел.\nДо тебя.\nОна ждала.»",spd:40})}

                startD([
                    {spk:"ERNIE",cls:"er",txt:"«Я вошёл в башню\n200 лет назад.»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Мне было 14.»"},
                    {pause:4,stage:true,txt:""},
                    {stage:true,txt:"Садится.\nПрямо на белый пол.\nКак ребёнок."},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Голос сказал,\nчто я особенный.»",spd:40},
                    {spk:"ERNIE",cls:"er",txt:"«Что я единственный,\nкто дойдёт\nдо крыши.»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я не дошёл.»",spd:50},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Остановился\nна девятом этаже.\nЗдесь.\nВ этой пустоте.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Башня предложила\nсделку.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Стань проводником —\nи будешь жить.\nНе свободным.\nНо живым.»"},
                    {pause:3,stage:true,txt:"Смотрит на свои руки.\nПрозрачные."},
                    {spk:"ERNIE",cls:"er",txt:"«Я согласился.»",spd:40},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Мне.»",spd:60},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Было.»",spd:60},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«Четырнадцать.»",spd:60},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я просто\nиспугался.»",spd:40},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Я даже бриться\nне умел.»"},
                    {pause:2,spk:"ERNIE",cls:"er",txt:"«До сих пор не умею.\nПризраки не бреются.»"},
                    {spk:"ERNIE",cls:"er",txt:"«Это единственный\nплюс.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    // Флэшбек — только если высокое доверие
                ].concat(G.trust>=3?[
                    {pause:3,stage:true,txt:"Долгая пауза.\nПотом — тихо."},
                    {spk:"ERNIE",cls:"er",txt:"«Мама пришла\nчерез три дня.»",spd:40},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я видел её\nсквозь стену.»",spd:50},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Звала меня.»",spd:60},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я не вышел.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Не мог.\nБашня держала.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Или...»",spd:60},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Или — боялся\nеё увидеть.»",spd:40},
                    {pause:3,stage:true,txt:"Пауза.\nАбсолютная.\nДаже музыка\nперестала."},
                ]:[]).concat(dynamicLines),
                null,
                [{icon:"💬",text:"«Ты жалеешь?»",fn:"f9regret()",id:"r9"},{icon:"💬",text:"«Ты спас многих?»",fn:"f9saved()",id:"s9"}],
                I.ernie_visible)
            }
            function f9regret(){G.uc.r9=true;startD([{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Каждый день.»",spd:50},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«200 лет.\nКаждый день.»",spd:40},{pause:4,stage:true,txt:"Глаза блестят.\nОн не плачет.\nПризраки не могут."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Но я пытаюсь.»",spd:50}],function(){f9part2()},null,I.ernie_visible)}
            function f9saved(){G.uc.s9=true;startD([{pause:3,spk:"ERNIE",cls:"er",txt:"«Нет.»",spd:60},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«847 человек.\nНи один не дошёл.»",spd:40},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Я не спасал.\nЯ провожал.»",spd:40},{pause:3,spk:"ERNIE",cls:"er",txt:"«До тебя.»",spd:50}],function(){f9part2()},null,I.ernie_visible)}
            function f9part2(){startD([{spk:"ERNIE",cls:"er",txt:"«Смотритель прав.\nЯ — часть башни.»"},{spk:"ERNIE",cls:"er",txt:"«Когда кто-то\nтеряет жизнь —\nбашня получает.\nА я... помогаю.»"},{spk:"ERNIE",cls:"er",txt:"«Каждый раз,\nкогда я говорю\n«не ходи туда» —\nя правда не хочу,\nчтобы ты пострадал.»"},{spk:"ERNIE",cls:"er",txt:"«Но башня знает.\nОна знает, что\nесли ты мне\nдоверяешь —\nты пойдёшь дальше.»"}],null,[{icon:"💬",text:"«Я тебе верю»",fn:"f9trust()",id:"t9"},{icon:"💬",text:"«Ты использовал меня?»",fn:"f9used()",id:"u9"},{icon:"💬",text:"«Как мне выйти?»",fn:"f9exit()",id:"e9"}],I.ernie_visible)}
            function f9trust(){G.uc.t9=true;G.trust+=3;startD([{spk:"ERNIE",cls:"er",txt:"«Не надо.»"},{stage:true,txt:"Пауза."},{spk:"ERNIE",cls:"er",txt:"«Но... спасибо.»"},{stage:true,txt:"Он почти улыбается."}],function(){updH();notify("💛 Доверие · максимум","gold");addEcho(10,"доверие");f9Rem()},null,I.ernie_visible)}
            function f9used(){G.uc.u9=true;startD([{spk:"ERNIE",cls:"er",txt:"«Да.»"},{spk:"ERNIE",cls:"er",txt:"«И нет.»"},{spk:"ERNIE",cls:"er",txt:"«Я не знаю.»"},{spk:"ERNIE",cls:"er",txt:"«Может, башня\nиспользовала\nнас обоих.»"}],function(){f9Rem()},null,I.ernie_visible)}
            function f9exit(){G.uc.e9=true;startD([{spk:"ERNIE",cls:"er",txt:"«Крыша.\nДесятый этаж.\nТам — дверь.\nНастоящая.»"}],function(){f9Rem()},null,I.ernie_visible)}
            function f9Rem(){var r=[];if(!G.uc.t9)r.push({icon:"💬",text:"«Верю»",fn:"f9trust()",id:"t9"});if(!G.uc.u9)r.push({icon:"💬",text:"«Использовал?»",fn:"f9used()",id:"u9"});if(!G.uc.e9)r.push({icon:"💬",text:"«Выход?»",fn:"f9exit()",id:"e9"});if(r.length<=1){f9final()}else{r.push({icon:"➡️",text:"Дальше",fn:"f9final()",id:"f9f"});showCh(r)}}
            function f9final(){
                // CHANGE 10: ERNIE addresses the PLAYER directly
                startD([
                    {pause:5,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Подожди.»",spd:60},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я знаю что это телефон.»",spd:50},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Что ты сидишь где-то.\nЧитаешь буквы на экране.»",spd:40},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«И всё равно — ты здесь.»",spd:40},
                    {pause:6,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«~~Я люблю~~»",del:true},
                    {pause:10,stage:true,txt:""},
                ],function(){f9finalRaven()},null,I.ernie_visible);
            }
            function f9finalRaven(){G.ravenAnswers={};var ravenIntro=[{stage:true,txt:"Хлопанье крыльев.\nВорон садится на белое.",fn:function(){sI(I.raven_perch)}}];if(G.lives>=5){ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«Ни одной потери.\n5 из 5.»"});ravenIntro.push({pause:2,spk:"ВОРОН",cls:"rv",txt:"«Первый за 200 лет.\nЯ впечатлён.\nА я никогда\nне впечатляюсь.»"})}else if(G.uc.d7a){ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«Добрался.»"});ravenIntro.push({pause:3,spk:"ВОРОН",cls:"rv",txt:"«Я знаю\nчто ты сделал\nна седьмом.»",spd:40});ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«Зеркало.\nСделка.\nЕго воспоминания\nза твои жизни.»"});ravenIntro.push({pause:3,spk:"ВОРОН",cls:"rv",txt:"«Он не помнит.\nНо я — помню.»"})}else{ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«Добрался.\nЯ ставил 50 на 50.\nПроиграл сам себе.»"})}
// БАШНЯ ПОМНИТ — цитаты ранних выборов
var memories=[];if(G.uc.cc)memories.push("Ты пил кофе\nс мёртвым баристой.");if(G.uc.ld)memories.push("Девочка нарисовала\nтвоё лицо.");if(G.uc.wt)memories.push("Ты тронул надпись\n14-летнего мальчика.");if(G.catDead)memories.push((G.catName||"Кошка")+" умерла\nза тебя.");if(G.uc.sf)memories.push("Ты спросил актёра\nпро настоящее лицо.\nОн не ответил.");if(G.uc.d7r)memories.push("Тебе предложили\nтри жизни.\nТы отказался.");if(memories.length>0){ravenIntro.push({pause:3,spk:"ВОРОН",cls:"rv",txt:"«Я видел всё.\nБашня видела всё.»"});var picked=memories.slice(0,3);picked.forEach(function(m){ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«"+m+"»"})});ravenIntro.push({pause:3,spk:"ВОРОН",cls:"rv",txt:"«Каждый шаг.\nКаждый выбор.\nЗаписан.»",spd:40})}
ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«Три вопроса.\nПрежде чем дальше.»"});ravenIntro.push({spk:"ВОРОН",cls:"rv",txt:"«Первый.»"});startD(ravenIntro,function(){ravenQ1()})}
            function ravenQ1(){showCh([{icon:"💬",text:"Да",fn:"rQ1('yes')",id:"rq1y"},{icon:"💬",text:"Нет",fn:"rQ1('no')",id:"rq1n"}]);$("gTop").style.display="block";$("topSpk").className="d-spk spk-rv";$("topSpk").textContent="ВОРОН";$("topTxt").className="d-txt";$("topTxt").textContent="«Ты доверяешь голосу?»"}
            function rQ1(a){G.ravenAnswers.trust=a;startD([{spk:"ВОРОН",cls:"rv",txt:a==="yes"?"«Храбро.\nИли глупо.\nВремя покажет.»":"«Умно.\nИли трусливо.\nВремя покажет.»"},{spk:"ВОРОН",cls:"rv",txt:"«Второй.»"}],function(){ravenQ2()},null,I.raven_perch)}
            function ravenQ2(){showCh([{icon:"💬",text:"Да",fn:"rQ2('yes')",id:"rq2y"},{icon:"💬",text:"Нет",fn:"rQ2('no')",id:"rq2n"}]);$("gTop").style.display="block";$("topSpk").className="d-spk spk-rv";$("topSpk").textContent="ВОРОН";$("topTxt").className="d-txt";$("topTxt").textContent="«Ты веришь, что кошка жива?»"}
            function rQ2(a){G.ravenAnswers.cat=a;startD([{spk:"ВОРОН",cls:"rv",txt:a==="yes"?"«Вера — странная штука.\nИногда работает.»":"«Скептик.\nНо она мурлычет.\nДля мёртвой — громко.»"},{spk:"ВОРОН",cls:"rv",txt:"«Последний.»"}],function(){ravenQ3()},null,I.raven_perch)}
            function ravenQ3(){showCh([{icon:"💬",text:"ERNIE",fn:"rQ3('ernie')",id:"rq3e"},{icon:"💬",text:"Тень",fn:"rQ3('shadow')",id:"rq3s"},{icon:"💬",text:"Обоих",fn:"rQ3('both')",id:"rq3b"}]);$("gTop").style.display="block";$("topSpk").className="d-spk spk-rv";$("topSpk").textContent="ВОРОН";$("topTxt").className="d-txt";$("topTxt").textContent="«Если бы мог освободить\nодного — ERNIE или Тень?\nКого?»"}
            function rQ3(a){G.ravenAnswers.free=a;var resp;if(a==="both"){resp=[{spk:"ВОРОН",cls:"rv",txt:"«Обоих?»"},{pause:2,stage:true,txt:"Смеётся.\nВпервые."},{spk:"ВОРОН",cls:"rv",txt:"«Первый за 200 лет.\nЗапомню.»"}];G.karma+=3}else if(a==="ernie"){resp=[{spk:"ВОРОН",cls:"rv",txt:"«Предсказуемо.\nНо правильно.»"}]}else{resp=[{spk:"ВОРОН",cls:"rv",txt:"«Тень?\nИнтересно.\nТы знаешь что-то,\nчего не знаю я.\nИли ничего не знаешь.»"}]}startD(resp.concat([{pause:2,spk:"ВОРОН",cls:"rv",txt:"«Хм.\nТы не как остальные.\nИли как все.\nЕщё не решил.»"},{spk:"ВОРОН",cls:"rv",txt:"«На крыше — Страж.\nОн не враг.\nОн жертва.\nКак все мы.»"},{spk:"ВОРОН",cls:"rv",txt:"«Береги кошку.\nИ... его тоже.\nОн не попросит.\nНо ему нужно.»"},{stage:true,txt:"Расправляет крылья.\nУлетает вверх.\nК свету."},{pause:2,spk:"ERNIE",cls:"er",txt:"«На крыше\nбудет выбор.»"},{spk:"ERNIE",cls:"er",txt:"«Не мой.\nТвой.»"},{stage:true,txt:"Встаёт.\nОтряхивает колени.\nПо привычке.\nХотя пыли нет."},{spk:"ERNIE",cls:"er",txt:"«И...»"},{stage:true,txt:"Замолкает."},{stage:true,txt:"Открывает рот.\nЗакрывает.\nСнова открывает."},{spk:"ERNIE",cls:"er",txt:"«Если можешь...»"},{spk:"ERNIE",cls:"er",txt:"«Если карма...\nесли хватит...»"},{stage:true,txt:"Голос дрожит.\n14-летний мальчик.\n200 лет в одиночестве."},{spk:"ERNIE",cls:"er",txt:"«Забери меня\nс собой.»",spd:40,fn:function(){sI(I.ernie_please)}},{pause:3,stage:true,txt:""},{pause:3,stage:true,txt:""},{stage:true,txt:"Он не смотрит\nна тебя."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Пожалуйста.»",spd:60},{pause:4,stage:true,txt:""},{stage:true,txt:"Голос ломается\nна последнем слоге."}]),function(){updH();addDiary("ERNIE: «Забери меня с собой.\nПожалуйста.»\n\n14 лет. 200 лет в одиночестве.\nГолос ломается на последнем слоге.","letter",9);showBar("ПОДНЯТЬСЯ НА КРЫШУ →","goF10()")},null,I.ernie_visible)}
            function goF10(){fadeIn(function(){goS("s2");showDoorF(10,"ЭТАЖ 10 · КРЫША",function(){fadeIn(function(){goS("sg");startF10()})})})}

            // === FLOOR 10: THE ROOF ===
            function startF10(){
                trackEvent("floor10",{lives:G.lives,karma:G.karma,saved:countSaved(),perfect:G.perfectRun,minutes:getSessionMinutes()});
                if(G.perfectRun){setTimeout(function(){notify("💎 Идеально. Впервые за 848 раз.","gold")},5000)}
                // Смотритель — не смотри 10 секунд
                if(!G._watcherTest){
                    G._watcherTest=true;
                    stopMusic();stopHeartbeat();
                    var ov=document.createElement("div");
                    ov.style.cssText="position:fixed;inset:0;background:#000;z-index:600;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;opacity:0;transition:opacity 2s;cursor:pointer";
                    var eye=document.createElement("div");
                    eye.style.cssText="font-size:48px;animation:breathDot 3s ease infinite";
                    eye.textContent="👁";
                    var hint=document.createElement("div");
                    hint.style.cssText="font-family:Raleway,sans-serif;font-size:11px;color:rgba(176,80,80,.3);font-style:italic;opacity:0;transition:opacity 3s";
                    hint.textContent="Не смотри.";
                    ov.appendChild(eye);ov.appendChild(hint);document.body.appendChild(ov);
                    setTimeout(function(){ov.style.opacity="1";setTimeout(function(){hint.style.opacity="1"},2000)},50);
                    var failed=false;var passed=false;
                    ov.onclick=function(){
                        if(passed)return;failed=true;
                        eye.textContent="👁‍🗨";hint.textContent="Он заметил.";hint.style.color="rgba(176,80,80,.6)";
                        G.lives-=1;updH();vibrate(100);
                        setTimeout(function(){ov.style.opacity="0";setTimeout(function(){ov.remove();startF10Real()},1500)},2000);
                    };
                    setTimeout(function(){
                        if(failed)return;passed=true;
                        eye.style.transition="opacity 3s";eye.style.opacity="0";
                        hint.textContent="Прошёл.";hint.style.color="rgba(200,168,72,.4)";
                        G.karma+=3;updH();
                        setTimeout(function(){ov.style.opacity="0";setTimeout(function(){ov.remove();startF10Real()},1500)},2000);
                    },10000);
                    return;
                }
                startF10Real();
            }
            function startF10Real(){document.body.classList.remove("void-mode");
                var sc=countSaved();
                if(sc>0){
                    var names=[];
                    if(G.saved.barista)names.push("Бариста");
                    if(G.saved.lika)names.push("Лика");
                    if(G.saved.conductor)names.push("Кондуктор");
                    if(G.saved.actor)names.push("Актёр");
                    if(G.saved.trumpeter)names.push("Трубач");
                    notify("✦ "+sc+"/5 свободны: "+names.join(", "),"gold");
                }var catGhostLines=G.catDead?[{pause:3,stage:true,txt:"В углу —\nпустое место.\nТёплое."},{pause:3,stage:true,txt:""},{pause:3,stage:true,txt:"Она лежала тут."}]:[];startD(catGhostLines.concat([{stage:true,txt:"Небо.\nНастоящее небо."},{stage:true,txt:"Рассвет.\nОранжевый. Тёплый."},{stage:true,txt:"Первый свет\nза всю игру."},{pause:3,stage:true,txt:"Ветер.\nОн пахнет...\nтравой.\nЗемлёй.\nЖизнью."},{stage:true,txt:"Но перед дверью —\nфигура."},{stage:true,txt:"Огромная.\nНе страшная.\nПечальная."},{pause:3,stage:true,txt:"Присмотрись.\nПод бронёй.\nПод тьмой."},{stage:true,txt:"Мальчик.\nКогда-то — мальчик.\nПримерно как ERNIE.\nМожет, младше."},{spk:"СТРАЖ",cls:"gh",txt:"«Ещё один.»"},{pause:3,stage:true,txt:"На выступе —\nдетская кружка.\nСтарая. С трещиной."},{pause:3,stage:true,txt:"ERNIE смотрит на неё.\nОтводит взгляд."},{spk:"СТРАЖ",cls:"gh",txt:"«848.\nНаконец.»",spd:50},{pause:3,stage:true,txt:"Не злорадно.\nУстало."},{spk:"ERNIE",cls:"er",txt:"«Страж.\nСистема безопасности.\nНе пропускает.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Он был тут\nдо меня.\nКогда я пришёл —\nон уже стоял.»",spd:40},{spk:"СТРАЖ",cls:"gh",txt:"«Я не хочу\nостанавливать.\nНо должен.\nТаковы правила.»"},{pause:3,spk:"СТРАЖ",cls:"gh",txt:"«Мне было 12.\nКогда правила\nстали всем,\nчто у меня есть.»",spd:40,fn:function(){sI(I.guardian_mercy)}}]),function(){guardianChoice()},null,I.guardian)}
            function guardianChoice(){stopMusic();
                // ACT + MERCY система
                G._guardPhase=G._guardPhase||1;
                G._guardMercy=G._guardMercy||0;
                var ch=[];
                // ACT команды зависят от фазы
                if(G._guardPhase===1){
                    ch.push({icon:"💬",text:"Поговорить",fn:"guardAct1()",id:"ga1"});
                    ch.push({icon:"😔",text:"«Ты устал?»",fn:"guardAct2()",id:"ga2"});
                }else if(G._guardPhase===2){
                    ch.push({icon:"📜",text:"Рассказать про башню",fn:"guardAct3()",id:"ga3"});
                    if(G.catName)ch.push({icon:"🐱",text:"Позвать "+G.catName,fn:"guardCat()",id:"gc10"});
                    else if(G.hasCat)ch.push({icon:"🐱",text:"Кошка",fn:"guardCat()",id:"gc10"});
                }else if(G._guardPhase===3){
                    ch.push({icon:"🤝",text:"Протянуть руку",fn:"guardAct4()",id:"ga4"});
                    if(G.karma>=15)ch.push({icon:"💛",text:"Пощадить",fn:"guardMercy()",id:"gm"});
                }
                ch.push({icon:"⚔️",text:"Пройти силой",fn:"guardForce()",id:"gf10"});
                showCh(ch);
            }
            // ФАЗА 1: Знакомство
            function guardAct1(){G.uc.gt10=true;G._guardMercy++;startD([{spk:"СТРАЖ",cls:"gh",txt:"«Я стою тут\n200 лет.\nЧтобы никто\nне ушёл.»"},{spk:"СТРАЖ",cls:"gh",txt:"«Не потому что хочу.\nПотому что должен.»"},{spk:"СТРАЖ",cls:"gh",txt:"«Передай ему —\nтому, кто наверху.\nЧто я устал.»"},{spk:"ERNIE",cls:"er",txt:"«...Я знаю.»"}],function(){if(G.karma>=10){echoCombat()}else{G._guardPhase=2;guardianChoice()}},null,I.guardian)}
            function guardAct2(){G._guardMercy+=2;startD([{stage:true,txt:"«Ты устал?»"},{pause:3,stage:true,txt:"Страж замирает."},{spk:"СТРАЖ",cls:"gh",txt:"«...»"},{pause:3,spk:"СТРАЖ",cls:"gh",txt:"«Никто раньше\nне спрашивал.»",spd:40},{spk:"СТРАЖ",cls:"gh",txt:"«200 лет.\n847 человек.\nНи один не спросил\nкак я.»"},{spk:"СТРАЖ",cls:"gh",txt:"«Да.\nЯ устал.»"},{spk:"ERNIE",cls:"er",txt:"«Мы все тут\nустали.»"},{pause:2,stage:true,txt:"Что-то меняется\nв его позе.\nЧуть мягче."}],function(){G._guardPhase=2;notify("💛 Страж смягчился","gold");guardianChoice()},null,I.guardian)}
            // ФАЗА 2: Глубже
            function guardAct3(){G._guardMercy++;var lines=[{stage:true,txt:"Рассказываешь.\nПро Баристу.\nПро Лику.\nПро Кондуктора."}];if(G.uc.cc)lines.push({stage:true,txt:"Про кофе,\nкоторый не существует,\nно пахнет детством."});if(G.uc.ld)lines.push({stage:true,txt:"Про девочку,\nкоторая рисует башню\nизнутри."});if(G.uc.tp)lines.push({stage:true,txt:"Про мелодию,\nкоторую мальчик\nслушал 10 минут\nи запомнил навсегда."});lines.push({spk:"СТРАЖ",cls:"gh",txt:"«Они... скучают\nпо мне?»"});lines.push({spk:"ERNIE",cls:"er",txt:"«Они не знают\nчто ты тут.\nНо да.\nСкучают.»"});lines.push({pause:3,stage:true,txt:"Страж опускает\nголову."});startD(lines,function(){G._guardPhase=3;notify("💛 Страж колеблется","gold");guardianChoice()},null,I.guardian)}
            // ФАЗА 3: Финал
            function guardAct4(){sI(I.guardian_hand);G._guardMercy+=2;startD([{stage:true,txt:"Протягиваешь руку."},{pause:3,stage:true,txt:"Страж смотрит\nна неё."},{spk:"СТРАЖ",cls:"gh",txt:"«Моя рука\nпройдёт сквозь.»"},{stage:true,txt:"«Попробуй.»"},{pause:3,stage:true,txt:"Протягивает."},{pause:2,stage:true,txt:"Холод."},{stage:true,txt:"Но не сквозь."},{stage:true,txt:"Касание."},{spk:"СТРАЖ",cls:"gh",txt:"«...Как?»"},{spk:"ERNIE",cls:"er",txt:"«Потому что\nты хочешь\nчтобы кто-то\nдотронулся.»",spd:40},{pause:3,stage:true,txt:"Страж плачет.\nБез слёз.\nПризраки не плачут.\nНо он плачет."}],function(){if(G._guardMercy>=4){guardMercy()}else{G.karma+=3;updH();notify("💛","gold");guardianChoice()}},null,I.guardian)}
            function guardMercy(){stopPressure();startD([{stage:true,txt:"Страж опускает руки."},{spk:"СТРАЖ",cls:"gh",txt:"«Я... не хочу\nбольше стоять тут.»"},{spk:"СТРАЖ",cls:"gh",txt:"«200 лет я ждал\nчтобы кто-то\nсказал мне\nчто можно\nперестать.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Можно.»"},{pause:3,stage:true,txt:"Страж отступает."},{stage:true,txt:"Медленно."},{stage:true,txt:"Дверь открывается."},{spk:"СТРАЖ",cls:"gh",txt:"«Спасибо.\nИ... передай им.\nЧто я ушёл.\nНе сбежал.\nУшёл.»"},{pause:3,stage:true,txt:"Страж растворяется.\nНе исчезает.\nРастворяется.\nКак туман на рассвете."}],function(){G.karma+=5;updH();notify("🕊 Страж свободен ·","gold");addEcho(25,"освобождение");showEndings()},null,I.guardian)}
            // === ECHO COMBAT ===
            var EC={wave:0,hp:3,pressureTimer:null};
            function ecPressureStart(){
                if(EC.pressureTimer)clearTimeout(EC.pressureTimer);
                EC.pressureTimer=setTimeout(function(){
                    document.body.classList.add("fx-pressure");
                    vibrate(50);
                    // ERNIE предупреждает
                    var b=$("catBubble");
                    if(b){b.textContent="...";b.classList.add("show");setTimeout(function(){b.classList.remove("show")},2000)}
                    // Через ещё 10 сек — сильнее
                    EC.pressureTimer=setTimeout(function(){
                        vibrate(100);
                        notify("💀 Не молчи... они идут","bad");
                    },10000);
                },15000);
            }
            function ecPressureStop(){
                if(EC.pressureTimer){clearTimeout(EC.pressureTimer);EC.pressureTimer=null}
                document.body.classList.remove("fx-pressure");
            }
            function echoCombat(){
                EC.wave=0;EC.hp=3;
                startD([{stage:true,txt:"Страж закрывает глаза."},{stage:true,txt:"Голоса.\nИз стен."},{stage:true,txt:"Голоса прошлых\nпосетителей.\nВсе 847."},{spk:"СТРАЖ",cls:"gh",txt:"«Они не пустят тебя.\nОни тоже не вышли.\nПочему ты —\nдолжен?»"},{stage:true,txt:"Эхо атакует."}],function(){
                    // Before echoWave, offer dodge game
                    startD([{narr:true,txt:"✦ ИСПЫТАНИЕ БАШНИ ✦"},{stage:true,txt:"Тени материализуются.\nОни атакуют."},{stage:true,txt:"Уклонись — или прими удар."}],function(){
                        showCh([
                            {icon:"⚡",text:"Уклониться (мини-игра)",fn:"dodgePhase()",id:"dp"},
                            {icon:"🛡",text:"Выдержать (потерять ♥)",fn:"echoWave()",id:"ew"}
                        ]);
                    },null,I.guardian);
                },null,I.guardian)
            }
            function dodgePhase(){
                startDodge("guardian","ТЕНИ АТАКУЮТ","Двигайся — избегай снарядов",
                    function(){
                        // Win dodge
                        G.karma+=2;
                        notify("⚡ Уклонился!","gold");
                        echoWave();
                    },
                    function(){
                        // Lose dodge
                        G.lives=Math.max(0,G.lives-1);
                        updH();
                        echoWave();
                    }
                );
            }
            function echoWave(){
                var waves=[
                    {txt:"«УХОДИ.\nТУТ НИЧЕГО НЕТ.\nНИКТО НЕ ВЫЙДЕТ.»",items:["coffee"],resp:"Запах кофе.\nБариста улыбается.\nЭхо рассыпается."},
                    {txt:"«ОН ВРЁТ.\nERNIE ВРЁТ.\nОН ЧАСТЬ БАШНИ.\nТЫ ЕМУ НЕ НУЖЕН.»",items:["drawing"],resp:"Рисунок Лики.\nНа нём — ты.\nНастоящий.\nЭхо замолкает."},
                    {txt:"«СДАВАЙСЯ.\nБАШНЯ ВЕЧНА.\nТЫ — НЕТ.»",items:["book","photo"],resp:"Книга раскрывается.\nСтраницы светятся.\nИстория ERNIE —\nнастоящая.\nЭхо отступает."}
                ];
                if(EC.wave>=waves.length){echoWin();return}
                var w=waves[EC.wave];
                catReact("danger");
                startD([{narr:true,txt:w.txt,cls:"glitch"},{pause:2,stage:true,txt:"Голоса давят.\nХолодно.",fn:function(){doShake()}}],function(){
                    var ch=[];
                    var hasItem=false;
                    w.items.forEach(function(it){
                        if(G.items.indexOf(it)>=0){hasItem=true;ch.push({icon:"✨",text:ITEMS[it]||it,fn:"echoUse('"+it+"')",id:"eu"+it})}
                    });
                    if(!hasItem&&G.hasCat){ch.push({icon:"🐱",text:G.catName||"Кошка",fn:"echoCatHelp()",id:"eccat"})}
                    ch.push({icon:"💪",text:"Выдержать",fn:"echoEndure()",id:"ecend"});
                    showCh(ch);
                    ecPressureStart();
                },null,I.guardian)
            }
            var ITEMS={coffee:"Кофе",drawing:"Рисунок",book:"Книга",photo:"Фото",ticket:"Билет",mask:"Маска"};
            function echoUse(item){
                ecPressureStop();
                var waves=[
                    {resp:"Запах кофе.\nТеплее.\nЭхо рассыпается."},
                    {resp:"Рисунок Лики.\nНа нём — ты.\nНастоящий.\nЭхо замолкает."},
                    {resp:"Страницы светятся.\nИстория ERNIE —\nнастоящая.\nЭхо отступает."}
                ];
                var r=waves[EC.wave]||waves[0];
                catReact("good");
                startD([{stage:true,txt:r.resp},{spk:"ERNIE",cls:"er",txt:"«Каждая вещь —\nне предмет.\nДоказательство.»"}],function(){
                    EC.wave++;
                    notify("✨ Эхо разрушено","gold");
                    echoWave()
                },null,I.guardian)
            }
            function echoCatHelp(){
                ecPressureStop();
                catReact("purr");
                startD([{stage:true,txt:(G.catName||"Кошка")+" прыгает вперёд.\nШипит на эхо."},{stage:true,txt:"Голоса дрожат.\nОтступают."},{spk:"ERNIE",cls:"er",txt:"«Она не боится.\nОна единственная\nкто не боится.»"}],function(){
                    EC.wave++;
                    notify("🐱 Кошка атакует!","gold");
                    echoWave()
                },null,I.guardian)
            }
            function echoEndure(){
                ecPressureStop();
                EC.hp--;
                doShake();
                if(EC.hp<=0){
                    startD([{stage:true,txt:"Голоса давят.\nХолодно.\nТемно."},{stage:true,txt:"Падаешь."},{spk:"ERNIE",cls:"er",txt:"«ВСТАВАЙ.»"},{pause:2,spk:"ERNIE",cls:"er",txt:"«Пожалуйста.»"}],function(){
                        G.lives--;updH();
                        EC.hp=2;echoWave()
                    },null,I.guardian)
                }else{
                    startD([{stage:true,txt:"Выдерживаешь.\nБольно. Но стоишь."},{spk:"ERNIE",cls:"er",txt:"«Ты сильнее\nчем они думают.»"}],function(){
                        EC.wave++;echoWave()
                    },null,I.guardian)
                }
            }
            function echoWin(){
                ecPressureStop();catReact("purr");
                startD([{pause:3,stage:true,txt:"Тишина."},{stage:true,txt:"847 голосов.\nВсе замолкли."},{stage:true,txt:"Впервые за 200 лет."},{pause:3,spk:"СТРАЖ",cls:"gh",txt:"«...Как?»"},{spk:"ERNIE",cls:"er",txt:"«Потому что у него\nесть то, чего\nне было у остальных.»"},{pause:2,spk:"СТРАЖ",cls:"gh",txt:"«Что?»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Причина остаться.»",spd:40},{pause:3,stage:true,txt:"Страж отступает.\nМедленно.\nКак будто разучился."},{spk:"СТРАЖ",cls:"gh",txt:"«Иди.\nИ... будь лучше\nчем мы.»"}],function(){notify("⚔️ Echo Combat · Победа","gold");showEndings()},null,I.guardian)
            }
            function guardCat(){G.uc.gc10=true;startD([{stage:true,txt:(G.catName||"Кошка")+" появляется."},{stage:true,txt:"Откуда?\nОна же осталась\nна восьмом..."},{stage:true,txt:"Подходит к Стражу.\nМурлычет."},{pause:2,stage:true,txt:"Страж замирает."},{spk:"СТРАЖ",cls:"gh",txt:"«Рыжик...?»",spd:50},{spk:"ERNIE",cls:"er",txt:"«Что?»"},{spk:"СТРАЖ",cls:"gh",txt:"«Эта кошка.\nЯ помню.\nОна приходила\nкаждый день.\n200 лет.»"},{spk:"СТРАЖ",cls:"gh",txt:"«Садилась у двери.\nМурлыкала.\nПотом уходила.»"},{spk:"СТРАЖ",cls:"gh",txt:"«Я думал — ко мне.\nНо она ждала.\nЖдала кого-то,\nкто заберёт её\nнаверх.»"},{pause:3,stage:true,txt:"Страж отступает.\nДверь открывается."},{spk:"СТРАЖ",cls:"gh",txt:"«Иди.\nИ... передай ему —\nчто я устал.»"}],function(){notify("🐱 Босс побеждён любовью","gold");showEndings()},null,I.guardian_cat)}
            function guardForce(){G.uc.gf10=true;G.lives--;G.karma-=2;startD([{stage:true,txt:"Шаг вперёд."},{stage:true,txt:"Страж толкает.\nНе сильно.\nНо холодно."},{stage:true,txt:"Отлетаешь."},{spk:"СТРАЖ",cls:"gh",txt:"«Нельзя.\nПравила.»"},{spk:"ERNIE",cls:"er",txt:"«Силой не пройти.\nПопробуй иначе.»"}],function(){updH();notify("❄️ -1♥","bad");guardianChoice()},null,I.guardian)}
            function showEndings(){
                incrementGlobalSaved();
                // Secret ending check
                if((G.notesFound||[]).length>=15&&!G.uc._secretEnd){
                    G.uc._secretEnd=true;
                    setTimeout(function(){
                        var el=document.createElement("div");
                        el.style.cssText="margin-top:16px;padding:12px 16px;background:rgba(200,168,72,.06);border:1px solid rgba(200,168,72,.15);border-radius:4px;max-width:240px;opacity:0;transition:opacity 3s;text-align:center";
                        el.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:8px;letter-spacing:3px;color:rgba(200,168,72,.5);margin-bottom:8px">🔮 СЕКРЕТНАЯ КОНЦОВКА</div><div style="font-family:Raleway,sans-serif;font-size:12px;color:rgba(200,168,72,.6);font-style:italic;line-height:1.8">Ты нашёл '+(G.notesFound||[]).length+' записок из 20.<br><br>Каждая записка — голос того, кто был до тебя.<br><br>Ты слышал их всех.<br>Никто до тебя не слышал.</div>';
                        $("tbc").appendChild(el);
                        setTimeout(function(){el.style.opacity="1"},200);
                    },35000);
                }
                // CHANGE 5: 50-second countdown
                countdown200(function(){
                    showEndingChoices();
                });
            }
            function countdown200(onDone){
                G._tapsDuringCountdown=0;
                $("gTop").style.display="none";$("gBotW").style.display="none";$("gNav").style.display="none";$("gCh").style.display="none";$("gBar").style.display="none";
                sI(I.roof);sF("ЭТАЖ 10 · КРЫША");startMusic("roof");
                var wrap=document.createElement("div");
                wrap.style.cssText="position:fixed;inset:0;z-index:80;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(5,5,8,.9);gap:16px";
                wrap.id="countdownWrap";
                var numEl=document.createElement("div");
                numEl.style.cssText="font-family:'JetBrains Mono',monospace;font-size:64px;color:rgba(200,168,72,.5);letter-spacing:8px;transition:color 1s";
                numEl.textContent="50";
                var subEl=document.createElement("div");
                subEl.style.cssText="font-family:'Raleway',sans-serif;font-size:11px;color:rgba(200,168,72,.3);font-style:italic;letter-spacing:2px";
                subEl.textContent="один год — одна секунда";
                var msgEl=document.createElement("div");
                msgEl.style.cssText="font-family:'Raleway',sans-serif;font-size:13px;color:rgba(200,168,72,0);font-style:italic;transition:all 2s;margin-top:20px;text-align:center;line-height:1.8;max-width:240px";
                wrap.appendChild(numEl);wrap.appendChild(subEl);wrap.appendChild(msgEl);
                document.body.appendChild(wrap);
                // Count taps (impatience detection)
                wrap.onclick=function(){G._tapsDuringCountdown++};
                var count=50;
                var timer=setInterval(function(){
                    count--;
                    numEl.textContent=count;
                    if(count<=10){numEl.style.color="rgba(200,168,72,.8)";numEl.style.fontSize="72px"}
                    if(count===30){msgEl.style.color="rgba(200,168,72,.5)";msgEl.textContent="Он ждал."}
                    if(count===15){msgEl.textContent="Ты подождёшь?"}
                    if(count===5){msgEl.textContent=""}
                    if(count<=0){
                        clearInterval(timer);
                        // Check patience
                        G._wasPatient=G._tapsDuringCountdown<20;
                        numEl.style.transition="all 2s";numEl.style.opacity="0";numEl.style.transform="scale(2)";
                        subEl.style.transition="opacity 2s";subEl.style.opacity="0";
                        msgEl.style.transition="opacity 2s";msgEl.style.opacity="0";
                        if(!G._wasPatient){
                            // Impatient player
                            var impEl=document.createElement("div");
                            impEl.style.cssText="font-family:Raleway,sans-serif;font-size:13px;color:rgba(200,168,72,.3);font-style:italic;opacity:0;transition:opacity 2s;text-align:center;line-height:1.8;max-width:260px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)";
                            impEl.textContent="Ты торопишься.\nКак все 847.";
                            wrap.appendChild(impEl);
                            setTimeout(function(){impEl.style.opacity="1"},500);
                            setTimeout(function(){
                                wrap.style.transition="opacity 2s";wrap.style.opacity="0";
                                setTimeout(function(){wrap.remove();onDone()},2000);
                            },4000);
                        }else{
                            setTimeout(function(){
                                wrap.style.transition="opacity 2s";wrap.style.opacity="0";
                                setTimeout(function(){wrap.remove();onDone()},2000);
                            },1500);
                        }
                    }
                },1000);
            }
            function showEndingChoices(){var preLines=[{stage:true,txt:"Дверь открыта.\nЛестница вверх.\nСвет."}];if(G.catDead){preLines.push({pause:3,stage:true,txt:""});preLines.push({spk:"ERNIE",cls:"er",txt:"«"+(G.catName||"Кошка")+"...»",spd:60});preLines.push({pause:4,stage:true,txt:""});preLines.push({spk:"ERNIE",cls:"er",txt:"«Она была\nединственным живым\nв этой башне.»",spd:40});preLines.push({pause:3,spk:"ERNIE",cls:"er",txt:"«Теперь —\nничего живого.»",spd:40});preLines.push({pause:3,stage:true,txt:""})}preLines.push({spk:"ERNIE",cls:"er",txt:"«10 этажей.\nТы всё ещё тут.»"});preLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«847 человек\nбыли до тебя.\nВсе ушли.\nПосле 10-го,\nпосле 20-го,\nпосле 40-го.\nВсе.»"});preLines.push({pause:2,spk:"ERNIE",cls:"er",txt:"«Ты не уйдёшь?»",spd:40});preLines.push({pause:3,spk:"ERNIE",cls:"er",txt:"«...Пожалуйста,\nне уходи.»",spd:50});startD(preLines,function(){
                // Проверка секрета "Тишина": тихие выборы
                var quiet=0;
                if(G.uc.wp&&!G.uc.wt)quiet++;// прошёл мимо стены
                if(G.uc.cb2&&!G.uc.cl)quiet++;// отошёл от часов
                if(G.uc.dp7&&!G.uc.dl7)quiet++;// обошёл двойника
                if(G.uc.gl6&&!G.uc.gs6)quiet++;// ушёл из беседки
                if(G.uc.wl6&&!G.uc.ww6)quiet++;// ушёл от цветка
                if(G.uc.tl6&&!G.uc.tt6)quiet++;// ушёл от дерева
                var ch=[];
                ch.push({icon:"🚪",text:"Уйти одному",fn:"endA()",id:"ea"});
                if(G.karma>=15&&G.trust>=4){ch.push({icon:"🤝",text:"Забрать ERNIE",fn:"endB()",id:"eb"});HEARTBEAT.start("normal")}
                if(G.karma<=-3)ch.push({icon:"🏚",text:"Остаться",fn:"endC()",id:"ec"});
                var allItems=G.items.indexOf("book")>=0&&G.karma>=20&&G._wasPatient;
                if(allItems)ch.push({icon:"✨",text:"Разрушить башню",fn:"endD()",id:"ed"});
                if(quiet>=4)ch.push({icon:"🤫",text:"Молчать",fn:"endSilence()",id:"es"});
                // Зеркальная концовка: игрок отвечал как ERNIE
                var mirrorScore=0;
                if(G.uc.cqe)mirrorScore++;// вошёл в дверь (как ERNIE вошёл в башню)
                if(G.uc.wt)mirrorScore++;// тронул надпись
                if(G.uc.t9)mirrorScore++;// сказал "верю"
                if(G.ravenAnswers&&G.ravenAnswers.free==="ernie")mirrorScore++;
                if(G.uc.lw)mirrorScore++;// спросил "кто он"
                if(mirrorScore>=4)ch.push({icon:"🪞",text:"Посмотреть в себя",fn:"endE()",id:"ee"});
                // КОНЦОВКА ПИСЬМА — самая редкая — если нашёл 2+ письма
                if(lettersFound.length>=2&&G.trust>=5){
                    ch.push({icon:"📜",text:"Последнее письмо",fn:"endLetter()",id:"el"});
                }
                showCh(ch)
            })}
            function endLetter(){
                showLetter(2,function(){
                    stopMusic();
                    startD([
                        {stage:true,txt:"Складываешь письмо.\nТщательно.\nКак реликвию."},
                        {stage:true,txt:"Кладёшь в карман."},
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Ты нашёл все три.»",spd:50},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Я писал их\nдля себя.\nЧтобы не забыть.\nЧто я — был.»",spd:40},
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Что хотел домой.\nЧто скучал по маме.\nЧто мне было страшно.»",spd:40},
                        {pause:3,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Теперь кто-то\nзнает.»",spd:60},
                        {pause:4,stage:true,txt:""},
                        {spk:"ERNIE",cls:"er",txt:"«Спасибо.»",spd:60},
                        {pause:3,stage:true,txt:""},
                        {stage:true,txt:"Мальчик не плачет.\nПризраки не могут."},
                        {pause:3,stage:true,txt:"Но — почти."},
                        {stage:true,txt:"Что-то стекает\nпо его лицу.\nСветлое.",fn:function(){sChime()}},
                        {pause:3,stage:true,txt:""},
                        {stage:true,txt:"Дверь открывается.\nСама.\nБез борьбы.\nПросто — открывается."},
                        {pause:3,stage:true,txt:""},
                        {stage:true,txt:"ERNIE берёт тебя\nза руку.\nХолодно.\nНо — настоящее."},
                        {spk:"ERNIE",cls:"er",txt:"«Пойдём?»",spd:60},
                        {pause:3,stage:true,txt:""},
                        {narr:true,txt:"Конец — это только начало."},
                        {narr:true,txt:"«Мы оба — домой.»"}
                    ],function(){showTBC("letter")},null,I.ernie_free);
                });
            }
            var tbcTexts={
                a:{title:"Ты свободен.\nОн — нет.",sub:"КОНЦОВКА A"},
                b:{title:"Ты свободен.\nОн тоже.",sub:"КОНЦОВКА B"},
                c:{title:"Ты не освободил меня.\nТы стал мной.",sub:"КОНЦОВКА C"},
                d:{title:"Все свободны.",sub:"TRUE ENDING"},
                e:{title:"Зеркало разбито.\nНаконец.",sub:"SECRET ENDING · ЗЕРКАЛО"},
                letter:{title:"Мы оба — домой.",sub:"SECRET ENDING · ПИСЬМА"},
                true:{title:"Проводник #849.",sub:"КОНЦОВКА D"},
                silence:{title:"Тишина.",sub:"SECRET ENDING · ТИШИНА"}
            };
            // === SECRET ENDING: ТИШИНА ===
            function endSilence(){
                sI(I.ending_silence);
                hideCat();setFx("void");
                startD([
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Молчишь."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Не уходишь.\nНе остаёшься.\nНе разрушаешь."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Просто — молчишь."},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«...»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Ты первый,\nкто не шумел.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«За 200 лет —\nни один не молчал.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Все хотели\nспасти. Уйти.\nОстаться. Разрушить.»"},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Ты — просто\nсел рядом.»",spd:40},
                    {pause:4,stage:true,txt:""},
                    {stage:true,txt:"Садишься на пол\nкрыши."},
                    {stage:true,txt:"ERNIE садится рядом."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Рассвет."},
                    {stage:true,txt:"Тихий."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Ничего не меняется.\nБашня стоит.\nПризраки внизу.\nСтраж у двери."},
                    {pause:3,stage:true,txt:"Но —"},
                    {pause:3,stage:true,txt:"Впервые за 200 лет —"},
                    {pause:3,stage:true,txt:"Не одиноко."},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Спасибо.»",spd:60},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Тут так тихо\nс тобой.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {narr:true,txt:"Конец — это только начало."},
                    {narr:true,txt:"«Тишина.»"}
                ],function(){showTBC("silence")})
            }
            // === TRUE ENDING ===
            function trueEnd(){
                hideCat();setFx(null);
                stopMusic(); // Silence before the transformation
                sI("");
                startD([
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Тихо."},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Спокойно."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Они ушли.\nВсе ушли.\nСвободны."},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"А ты?",fn:function(){doShake()}},
                    {pause:4,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Ты стоишь\nна первом этаже."},
                    {pause:3,stage:true,txt:"Один."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Башня тёплая.\nТихая.\nПустая."},
                    {pause:3,stage:true,txt:"Кто-то должен\nостаться."},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Чтобы встретить\nследующего."},
                    {pause:4,stage:true,txt:"",fn:function(){$("gImgW").style.transition="opacity 3s";$("gImgW").style.opacity="0"}},
                    {pause:3,stage:true,txt:"",cls:"glitch",fn:function(){doShake()}},
                    {narr:true,txt:"ИНИЦИАЛИЗАЦИЯ...",fn:function(){startMusic("void9")}},
                    {pause:3,narr:true,txt:"ЗАГРУЗКА ПРОВОДНИКА #849"},
                    {pause:3,narr:true,txt:"ИМЯ: "+(G.playerName||"НЕИЗВЕСТНО").toUpperCase()},
                    {pause:3,stage:true,txt:""},
                    {narr:true,txt:"ГОЛОС: АКТИВИРОВАН",fn:function(){
                        $("gFl").textContent="Э̸̛Т̵А̶Ж̷ ̸?̶?̵?̸";
                        $("gFl").style.color="rgba(180,40,40,.6)";
                        document.body.style.transition="filter 2s";
                        document.body.style.filter="hue-rotate(180deg) saturate(0.3)";
                        vibrate(200);
                    }},
                    {pause:3,stage:true,txt:""},
                    {narr:true,txt:"ИМУЩЕСТВО: ПУСТО\nПАМЯТЬ: СТЁРТА\nПОСЕТИТЕЛИ: 0"},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"Дверь внизу\nоткрывается."},
                    {pause:3,stage:true,txt:"Шаги."},
                    {pause:3,stage:true,txt:"Кто-то входит."},
                    {pause:3,stage:true,txt:""},
                    {pause:3,stage:true,txt:"И ты говоришь:"},
                    {pause:3,stage:true,txt:""},
                    {narr:true,txt:"«Т-ш-ш-ш.\nНе двигайся.\nОни слушают.»"},
                    {pause:3,narr:true,txt:"«Я — единственный,\nкому ты можешь\nверить.»"},
                    {pause:3,narr:true,txt:"«Наверное.»",fn:function(){
                        document.body.style.filter="";
                        $("gFl").style.color="";
                    }}
                ],function(){showTBC("true")})
            }
            function showTBC(ending){
                var t=tbcTexts[ending]||tbcTexts.a;
                var el=$("tbc");
                var sc=countSaved();
                var lightsText=sc===0?"\n\nБашня тёмная.\nНикто не ушёл.":
                    sc<3?"\n\n"+sc+" огонь внизу.\nКто-то свободен.":
                    sc<5?"\n\n"+sc+" огня.\nБашня светлеет.":
                    "\n\n5 огней.\nВпервые за 200 лет —\nв башне светло.";
                $("tbcTitle").textContent=t.title+lightsText;
                $("tbcSub").textContent=t.sub;
                el.classList.add("show");
                stopMusic();
                // Сохраняем catName и playerName для стены эхо
                if(G.catName)TM.catName=G.catName;
                if(G.playerName)TM.playerName=G.playerName;
                // Сохраняем концовку
                if(!TM.endings)TM.endings=[];
                if(TM.endings.indexOf(ending)<0)TM.endings.push(ending);
                var isNew=TM.endings.filter(function(e){return e===ending}).length===1;
                try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}
                setTimeout(function(){$("tbcTitle").style.opacity="1"},300);
                setTimeout(function(){$("tbcSub").style.opacity="1"},4000);
                // Кнопки появляются через 15 секунд
                setTimeout(function(){$("tbcCont").style.opacity="1"},6000);
                setTimeout(function(){$("tbcReplay").style.opacity="1"},7000);
                setTimeout(function(){$("tbcShare").style.opacity="1"},8000);
                setTimeout(function(){$("tbcInvite").style.opacity="1"},9000);
                setTimeout(function(){$("tbcFeedback").style.opacity="1"},10000);
                setTimeout(function(){if($("tbcDonate"))$("tbcDonate").style.opacity="1"},12000);
                // Статистика прохождения
                setTimeout(function(){
                    saveTM();
                    var stats=document.createElement("div");
                    stats.style.cssText="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txtd);letter-spacing:1px;margin-top:8px;line-height:1.6;opacity:0;transition:opacity 2s;text-align:left;border-left:2px solid rgba(200,168,72,.15);padding-left:12px;max-width:240px";
                    var endingsFound=TM.endings?TM.endings.length:1;
                    var endingsTotal=7;
                    var echoStr="✦ ЭХО: "+G.echo;
                    if(G.echo>=(TM.bestEcho||0))echoStr+=" <span style='color:var(--gold)'>РЕКОРД!</span>";
                    stats.innerHTML=echoStr+
                        "<br>◆ КАРМА: "+(G.karma>0?"+":"")+G.karma+
                        "<br>♥ ОСТАЛОСЬ: "+G.lives+"/5"+
                        "<br>✦ СПАСЕНО: "+countSaved()+"/5 душ"+"<br>⏱ ВРЕМЯ: "+getSessionMinutes()+" мин"+
                        "<br>🔗 КОМБО: "+G.combos+
                        "<br>🔮 СЕКРЕТЫ: "+G.secrets+"/4"+
                        "<br>📜 ЗАПИСКИ: "+(G.notesFound||[]).length+"/20"+(G.perfectRun?"<br>💎 ИДЕАЛЬНОЕ ПРОХОЖДЕНИЕ":"")+
                        (TM.runs>1?"<br><br><span style='opacity:.4'>ПРОХОЖДЕНИЕ #"+TM.runs+"</span>":"")+"<br><br><span style=\"font-size:9px;opacity:.5\">Глобально спасено: ~"+getGlobalSaved()+" душ</span>"+
                        "<br>🎒 ПРЕДМЕТЫ: "+G.items.length+"/6"+
                        "<br>🏁 КОНЦОВОК: "+endingsFound+"/"+endingsTotal+
                        (G.catName?"<br>🐱 "+G.catName.toUpperCase():"");
                    if(isNew){
                        stats.innerHTML+="<br><br>✦ НОВАЯ КОНЦОВКА"
                    }
                    $("tbc").appendChild(stats);
                    setTimeout(function(){stats.style.opacity="1"},100);
                },6000);
                // Письмо от ERNIE (только при первом прохождении или на особых концовках)
                var showLetter=true;
                if(showLetter){
                    setTimeout(function(){
                        var letterLines={
                            a:G.uc.d7a?"Ты ушёл.\nИ забрал часть меня.\nЯ не помню какую.\nНо чувствую —\nпустое место.\n\nТы думал я не замечу?\nЯ призрак.\nНе дурак.\n\n...Но я всё равно\nждал что ты\nвернёшься.\n— Э.":"Ты ушёл.\nЯ ожидал.\n847 раз ожидал.\nНо всё равно — обидно.\n— Э.",
                            b:"Ты сказал «идём».\nНикто за 200 лет.\nЯ не знаю как благодарить.\nПоэтому — молчу.\nЭто и есть «спасибо».\n— Э., 14 лет (снова)",
                            c:"Ты остался.\nВместо меня.\nТеперь ты поймёшь.\n200 лет — долго.\nНо не бесконечно.\nСправишься.\n— Э.",
                            d:"Башни нет.\nМы все свободны.\nПервый раз за 200 лет\nя не знаю что делать.\nЭто... хорошо?\nДа. Хорошо.\n— Э., живой",
                            e:"Ты — это я.\nЯ — это ты.\nМы оба боялись.\nМы оба вышли.\nЗеркало разбито.\nНаконец.\n— Э.",
                            letter:"Три письма.\nТы нашёл все три.\nЯ писал их\nчтобы не забыть.\nТы прочитал —\nзначит, не забыл.\nЭтого достаточно.\nМы — домой.\n— Э.",
                            silence:"Тишина.\nСпасибо за тишину.\n— Э.",
                            true:"Инициализация...\nПроводник #849 активирован.\nТы знаешь что делать.\nНаверное.\n— Э. (предыдущий)"
                        };
                        var mins=getSessionMinutes();
                        var letter=G.perfectRun?"Ни одной ошибки.\nНи одной потери.\nИдеально.\n\nЗа 200 лет — впервые.\nТы не просто прошёл.\nТы победил.\n\n— Э., поражён":(mins<=15)?""+mins+" минут.\nТы торопился.\nКак все 847.\n\nНо дошёл.\nЭто главное.\nНаверное.\n\n— Э., не уверен":(countSaved()>=5)?"Ты спас их всех.\n5 душ. 5 огней.\n\nЗа 200 лет —\nникто даже не пытался.\n\nА ты просто...\nпогладил кошку.\nСварил кофе.\nСказал «прости».\n\nОказывается,\nэтого достаточно.\n\n— Э., бывший призрак":(letterLines[ending]||letterLines.a);
                        var letterEl=document.createElement("div");
                        letterEl.style.cssText="margin-top:20px;padding:16px 20px;background:rgba(200,168,72,.04);border:1px solid rgba(200,168,72,.1);border-radius:4px;max-width:240px;opacity:0;transition:opacity 3s;cursor:pointer";
                        letterEl.innerHTML='<div style="font-family:JetBrains Mono,monospace;font-size:8px;letter-spacing:2px;color:var(--txtd);margin-bottom:10px">ПИСЬМО</div><div style="font-family:Raleway,sans-serif;font-size:13px;color:var(--txt2);font-style:italic;line-height:1.8;white-space:pre-line">'+letter+'</div>';
                        letterEl.onclick=function(){sChime();this.style.borderColor="rgba(200,168,72,.3)"};
                        $("tbc").appendChild(letterEl);
                        setTimeout(function(){letterEl.style.opacity="1"},100);
                        // Эпилог
                        setTimeout(function(){
                            var epi=document.createElement("div");
                            epi.style.cssText="font-family:'Raleway',sans-serif;font-size:12px;font-style:italic;color:rgba(200,168,72,.5);text-align:center;margin-top:20px;opacity:0;transition:opacity 5s;max-width:220px;line-height:1.8";
                            var sc=countSaved();
                            var mins=getSessionMinutes();
                            if(sc>=5)epi.textContent="Башня пуста. Впервые за 200 лет — тихо. По-настоящему тихо.";
                            else if(sc>=3)epi.textContent="Несколько огней внизу. Кто-то свободен. Не все. Но кто-то.";
                            else if(sc>=1)epi.textContent="Один огонь. Маленький. Но горит.";
                            else epi.textContent="Башня стоит. Как стояла. Как будет стоять.";
                            // Time comparison
                            setTimeout(function(){
                                var timeEl=document.createElement("div");
                                timeEl.style.cssText="font-family:'JetBrains Mono',monospace;font-size:10px;color:rgba(200,168,72,.4);text-align:center;margin-top:16px;opacity:0;transition:opacity 6s;line-height:2;letter-spacing:1px";
                                timeEl.textContent="Ты был здесь "+mins+" мин. ERNIE был здесь 200 лет.";
                                $("tbc").appendChild(timeEl);
                                setTimeout(function(){timeEl.style.opacity="1"},300);
                            },8000);
                            $("tbc").appendChild(epi);
                            setTimeout(function(){epi.style.opacity="1"},300);
                        },16000);
                    },9000);
                }
                // Тизер Этаж 0
                setTimeout(function(){
                    var hint=document.createElement("div");
                    hint.style.cssText="font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(90,127,160,.25);letter-spacing:3px;margin-top:24px;transition:opacity 3s;cursor:pointer";
                    hint.textContent="ЭТАЖ 0 · ПОДВАЛ";
                    hint.style.opacity="0";
                    hint.onclick=function(){
                        hint.style.color="rgba(200,168,72,.4)";
                        hint.innerHTML="ЭТАЖ 0 · ПОДВАЛ<br><span style='font-size:8px;letter-spacing:1px;opacity:.5'>ERNIE не был первым. Под первым этажом —.<br>Она начинается снизу.<br>Всегда начиналась снизу.</span>";
                        tone(110,.8,"sine",.03);
                        setTimeout(function(){tone(87,1,"sine",.02)},300);
                    };
                    $("tbc").appendChild(hint);
                    setTimeout(function(){hint.style.opacity="1"},100);
                },14000);
                // CHANGE 7: TOWER POSTSCRIPT — appears once, never again
                if(!TM._towerSpoke){
                    setTimeout(function(){
                        TM._towerSpoke=true;
                        try{localStorage.setItem("ernie_memory",JSON.stringify(TM))}catch(e){}
                        var ps=document.createElement("div");
                        ps.style.cssText="position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transition:opacity 3s";
                        ps.id="towerPostscript";
                        var lines=["Привет.","Это не ERNIE.","Это башня.","","Он ушёл.","","Но я — нет.","","Я жду.","","Номер 849."];
                        var container=document.createElement("div");
                        container.style.cssText="text-align:center;max-width:200px";
                        lines.forEach(function(l,i){
                            var p=document.createElement("div");
                            p.style.cssText="font-family:'Raleway',sans-serif;font-size:12px;color:rgba(180,180,190,.5);font-style:italic;line-height:2.2;opacity:0;transition:opacity 2s";
                            p.textContent=l;
                            container.appendChild(p);
                            setTimeout(function(){p.style.opacity="1"},2000+i*1500);
                        });
                        ps.appendChild(container);
                        document.body.appendChild(ps);
                        setTimeout(function(){ps.style.opacity="1"},100);
                        // Disappear after showing
                        setTimeout(function(){
                            ps.style.transition="opacity 5s";
                            ps.style.opacity="0";
                            setTimeout(function(){ps.remove()},6000);
                        },2000+lines.length*1500+5000);
                    },25000);// 25 seconds after TBC appears
                }
            }
            function shareTBC(){
                var t=tbcTexts[TM.endings?TM.endings[TM.endings.length-1]:"a"]||tbcTexts.a;
                var text="🏚 ERNIE — THE WARDEN'S TOWER\n\n";
                text+="«"+t.title.replace(/\n/g," ")+"»\n\n";
                if(G.catDead)text+="🐱 "+(G.catName||"Кошка")+" погибла за меня.\n";
                else if(G.catName)text+="🐱 "+G.catName+" мурчит.\n";
                if(G.uc.d7a)text+="💔 Я предал призрака за 3 жизни.\n";
                if(G.uc.d7r)text+="💛 Мне предложили 3 жизни. Я отказался.\n";
                if(G.uc.triedToLeave)text+="🚪 Я пытался не входить.\n";
                text+="◆ Карма: "+(G.karma>0?"+":"")+G.karma+"\n";
                text+="♥ Жизней: "+G.lives+"/5\n";
                text+="✦ Спасено: "+countSaved()+"/5 душ\n";
                text+="⏱ Время: "+getSessionMinutes()+" мин\n";
                text+="📜 Записки: "+(G.notesFound||[]).length+"/20\n";
                if(G.perfectRun)text+="💎 Идеальное прохождение\n";
                text+="🏁 Концовок: "+(TM.endings?TM.endings.length:1)+"/7\n\n";
                text+="848 посетителей было до меня.\nМальчик 200 лет ждал.\n\n«Пожалуйста, не уходи.»";
                if(navigator.share){navigator.share({title:"ERNIE — THE WARDEN'S TOWER",text:text}).catch(function(){})}
                else{copyShare()}
            }
            function shareWA(){
                var ending=TM.endings?TM.endings[TM.endings.length-1]:"a";
                var hook=G.catDead?(G.catName||"Кошка")+" погибла за меня на 7 этаже.":G.uc.d7a?"Я предал призрака за 3 жизни.":"Мальчик 200 лет ждал кого-то.";
                var text=encodeURIComponent("🏚 ERNIE — THE WARDEN'S TOWER\n\n"+hook+"\n10 этажей. 7 концовок.\n\n«Пожалуйста, не уходи.»");
                window.open("https://wa.me/?text="+text,"_blank")
            }
            function shareTG(){
                var hook=G.catDead?(G.catName||"Кошка")+" погибла за меня.":G.uc.d7a?"Я предал призрака.":"Мальчик 200 лет ждал.";
                var text=encodeURIComponent("🏚 ERNIE — THE WARDEN'S TOWER\n\n"+hook+"\n10 этажей. 7 концовок.\n\n«Пожалуйста, не уходи.»");
                window.open("https://t.me/share/url?text="+text,"_blank")
            }
            function copyShare(){
                var hook=G.catDead?"🐱 "+(G.catName||"Кошка")+" погибла за меня.":G.uc.d7a?"💔 Я предал призрака за 3 жизни.":"💛 Мальчик 200 лет ждал кого-то.";
                var text="🏚 ERNIE — THE WARDEN'S TOWER\n\n"+hook+"\n10 этажей. 7 концовок. Карма: "+(G.karma>0?"+":"")+G.karma+"\n\n«Пожалуйста, не уходи.»";
                if(navigator.clipboard){navigator.clipboard.writeText(text).then(function(){notify("📋 Скопировано!","gold")})}
            }
            function endA(){document.body.classList.remove("void-mode");document.body.classList.add("ending-mode");trackEvent("ending",{type:"A"});PROMISES.add("Я ушёл");EMOTION.add(-30);GUILT.add("Ты ушёл один",3);HEARTBEAT.stop();stopMusic();startD([{stage:true,txt:"Открываешь дверь."},{stage:true,txt:"Свет. Тепло.\nТрава. Ветер.",fn:function(){sI(I.sunrise);sWind()}},{stage:true,txt:"Мир."},{spk:"ERNIE",cls:"er",txt:"«Иди.\nНе оглядывайся.»"},{stage:true,txt:"Шаг."},{stage:true,txt:"Ещё шаг."},{stage:true,txt:"Дверь закрывается\nза спиной."},{stage:true,txt:"Башня стоит.\nERNIE внутри.\nНавсегда."},{pause:4,stage:true,txt:""},{narr:true,txt:"Конец — это только начало."},{narr:true,txt:"«Ты свободен.\nОн — нет.»"}],function(){showTBC("a")},null,I.door_out)}
            function endB(){document.body.classList.remove("void-mode");document.body.classList.add("ending-mode");trackEvent("ending",{type:"B"});showCat();catReact("good");startD([{stage:true,txt:"«Я не уйду\nбез тебя.»"},{spk:"ERNIE",cls:"er",txt:"«...Что?»"},{stage:true,txt:"«Я. Не уйду.\nБез тебя.»"},{spk:"ERNIE",cls:"er",txt:"«Нельзя.\nЯ — часть башни.\nЯ привязан.\nЯ не могу—»"},{pause:3,stage:true,txt:"Если заберёшь его —\nкто останется с ними?"},{pause:2,stage:true,txt:"Бариста.\nЛика.\nКондуктор.\nТрубач."},{pause:2,stage:true,txt:"Они останутся одни.\nНавсегда."}],function(){showCh([{icon:"🤝",text:"Забрать всё равно",fn:"endB2()",id:"eb2"},{icon:"🚪",text:"...уйти одному",fn:"endA()",id:"ea2"}])})
            }
            function endB2(){var hasPhoto=G.items.indexOf("photo")>=0;var hasBook=G.items.indexOf("book")>=0;startD([{stage:true,txt:"Достаёшь всё,\nчто собрал."}].concat(hasPhoto?[{stage:true,txt:"Фото.\nМальчик 14 лет.\nУ башни.\nУлыбается."},{spk:"ERNIE",cls:"er",txt:"«...Это я.»"},{stage:true,txt:"«Это ты.\nНастоящий.»"}]:[]).concat(hasBook?[{stage:true,txt:"Пустая книга.\nНа обложке — твоё имя."},{stage:true,txt:"Но она не пустая.\nКаждый выбор,\nкаждый разговор,\nкаждое «спасибо» —\nвсё здесь."},{spk:"ERNIE",cls:"er",txt:"«Ты...\nзаписывал?»"},{stage:true,txt:"«Нет.\nОна сама.»"}]:[]).concat([{stage:true,txt:"Каждый предмет —\nне вещь.\nДоказательство."},{stage:true,txt:"Что он — был.\nЧто он — есть.\nЧто он — настоящий."},{spk:"ERNIE",cls:"er",txt:"«...»"},{spk:"ERNIE",cls:"er",txt:"«Я 200 лет\nговорил другим\n«иди».\nНикто не сказал\n«идём».»",spd:40},{pause:3,stage:true,txt:"Свет."},{stage:true,txt:"Тихий.\nНе яркий.\nТёплый."},{stage:true,txt:"Башня дрожит.\nНе от злости.\nОт удивления."},{stage:true,txt:"Мальчик.\n14 лет.\nСтоит рядом."},{stage:true,txt:"Не прозрачный.\nНастоящий."},{stage:true,txt:"Смотрит на свои руки."},{spk:"ERNIE",cls:"er",txt:"«Я...\nчувствую пол.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Подожди.»",spd:50},{pause:3,spk:"ERNIE",cls:"er",txt:"«Лика будет одна.\nОна не боится темноты.\nОна боится тишины.»",spd:40},{pause:4,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Бариста будет\nпротирать стакан.\nКаждый день.\nДля клиента,\nкоторый не придёт.»",spd:40},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«Ты уверен?»",spd:50},{pause:4,stage:true,txt:""},{stage:true,txt:"Два шага к двери.",fn:function(){sI(I.ending_together)}},{stage:true,txt:"Вместе."},{stage:true,txt:"Свет.\nТрава.\nВетер.",fn:function(){sI(I.sunrise);sWind()}},{narr:true,txt:"Конец — это только начало."},{narr:true,txt:"«Ты свободен.\nОн тоже.»"}]),function(){showTBC("b")},null,I.ernie_free)}
            function endC(){document.body.classList.remove("void-mode");document.body.classList.add("ending-mode");trackEvent("ending",{type:"C"});sI(I.new_warden);startD([{stage:true,txt:"«Я остаюсь.»"},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Что?»"},{stage:true,txt:"«Башне нужен\nновый проводник.»"},{spk:"ERNIE",cls:"er",txt:"«Нет.»"},{stage:true,txt:"«Ты устал.\n200 лет.\nХватит.»"},{spk:"ERNIE",cls:"er",txt:"«Нет. Нет, нет.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Ты не понимаешь\nчто это значит.»",spd:40},{spk:"ERNIE",cls:"er",txt:"«Это не героизм.\nЭто клетка.\nОна красивая\nпервые 10 лет.\nПотом — нет.»"},{pause:3,spk:"ERNIE",cls:"er",txt:"«Пожалуйста.\nНе делай этого.»",spd:50},{pause:3,stage:true,txt:""},{stage:true,txt:"«Иди.\nТы свободен.»"},{pause:4,stage:true,txt:"ERNIE плачет.\nБез слёз.\nПризраки не плачут.\nНо он — плачет."},{pause:3,spk:"ERNIE",cls:"er",txt:"«Я не хочу\nбыть свободным\nтакой ценой.»",spd:40},{pause:4,stage:true,txt:""},{stage:true,txt:"Обнимаешь его.\nХолодно.\nРуки проходят\nсквозь."},{stage:true,txt:"Но он чувствует."},{pause:3,stage:true,txt:""},{spk:"ERNIE",cls:"er",txt:"«...Дурак.»",spd:60},{pause:3,spk:"ERNIE",cls:"er",txt:"«Спасибо.\nДурак.»",spd:50},{pause:4,stage:true,txt:"Свет.\nТёплый.\nERNIE исчезает."},{pause:3,stage:true,txt:"Не исчезает.\nВпервые за 200 лет —\nуходит."},{pause:4,stage:true,txt:""},{stage:true,txt:"Башня тихая.\nТёплая.\nКак дом."},{pause:3,stage:true,txt:"Проходит время.\nСколько?\nНе знаешь."},{stage:true,txt:"Не важно."},{pause:3,stage:true,txt:"Где-то внизу —\nдверь открывается."},{stage:true,txt:"Шаги."},{stage:true,txt:"Кто-то входит."},{pause:3,stage:true,txt:"И ты говоришь:",fn:function(){sI(I.new_warden)}},{pause:3,narr:true,txt:"«Привет.\nНе бойся.\nЯ тут.»"},{pause:3,narr:true,txt:"«Меня зовут...\n...\n"+(G.playerName||"...").toUpperCase()+".»",spd:60},{pause:15,stage:true,txt:""},{narr:true,txt:"«Наверное.»",spd:80},{pause:4,narr:true,txt:"«Я забываю имена.\nЭто нормально.»"},{pause:3,narr:true,txt:"Конец — это только начало."}],function(){showTBC("c")},null,I.roof)}
            function endD(){document.body.classList.remove("void-mode");document.body.classList.add("ending-mode");trackEvent("ending",{type:"D"});showCat();catReact("purr");startD([{stage:true,txt:"Кладёшь предметы\nна пол крыши."},{stage:true,txt:"Один за другим.\nВ круг."},{stage:true,txt:"Книга.\nФото.\nВсё, что собрал."},{stage:true,txt:"Книга открывается сама."},{stage:true,txt:"Пишет."},{stage:true,txt:"Историю ERNIE.\nОт первого дня\nдо последнего."},{stage:true,txt:"Каждую страницу,\nкоторую он сжёг —\nкнига восстанавливает."},{spk:"ERNIE",cls:"er",txt:"«Что ты делаешь?»"},{stage:true,txt:"«Заканчиваю\nтвою историю.»"},{spk:"ERNIE",cls:"er",txt:"«Нельзя—\nбашня не—»"},{stage:true,txt:"Трещина."},{stage:true,txt:"Тихая.\nКак первая трещина\nна льду весной."},{stage:true,txt:"Потом — вторая."},{stage:true,txt:"Третья."},{stage:true,txt:"Башня дрожит.",fn:function(){sI(I.tower_crumble)}},{stage:true,txt:"Не от злости.\nОт страха."},{stage:true,txt:"Впервые за 200 лет —\nбашня боится.",fn:function(){sI(I.tower_crumble)}},{stage:true,txt:"СВЕТ.",fn:function(){sChime();sFree()}},{stage:true,txt:"...",fn:function(){sI(I.sunrise);startMusic("roof")}},{stage:true,txt:"Поле."},{stage:true,txt:"Рассвет."},{stage:true,txt:"Башни нет.\nБыла — и нет.\nКак сон."},{stage:true,txt:"Призраки —\nстоят в траве.\nНастоящие."},{stage:true,txt:"Бариста смотрит\nна свои руки.\n«Я... тёплый?»"},{stage:true,txt:"Лика смеётся.\nДетский смех.\nНастоящий.\nВпервые за 200 лет."},{stage:true,txt:"Кондуктор стоит.\nБез фуражки.\nУлыбается.\n«Я приехал.»"},{stage:true,txt:"Библиотекарь\nснимает очки.\nПлачет."},{stage:true,txt:"Актёр.\nЛицо не меняется.\nОдно. Настоящее."},{stage:true,txt:"ERNIE стоит рядом.\n14 лет.\nЖивой."},{stage:true,txt:"Смотрит на небо.\nВпервые."},{spk:"ERNIE",cls:"er",txt:"«Оно голубое.»"},{pause:2,stage:true,txt:"Пауза."},{spk:"ERNIE",cls:"er",txt:"«Я забыл.»",spd:50},{pause:3,stage:true,txt:"Кошка трётся о ноги."},{stage:true,txt:"Мурчит."}].concat(G.hasCat?[]:[{stage:true,txt:"Она тоже пришла.\nОткуда-то.\nЖдала."}]).concat([{narr:true,txt:"Конец — это только начало."},{narr:true,txt:"«Все свободны.»"}]),function(){trueEnd()},null,I.ernie_free)}

            // === ENDING E: ЗЕРКАЛО ===
            // Разблокируется: если игрок отвечал именно так же как ERNIE на ключевые вопросы
            function endE(){document.body.classList.remove("void-mode");document.body.classList.add("ending-mode");trackEvent("ending",{type:"E"});
                stopMusic();
                setFx("void");
                startD([
                    {stage:true,txt:"Ты не уходишь.\nНе остаёшься.\nНе разрушаешь.\nНе молчишь."},
                    {pause:3,stage:true,txt:"Ты смотришь на него."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"И вдруг понимаешь."},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Ты — это он."},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«...Что?»"},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Те же ответы.\nТот же страх.\nТот же способ\nпрятаться\nза словами."},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Нет.»"},
                    {pause:3,stage:true,txt:"«Да.»"},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я вошёл в башню\nпотому что боялся\nбыть собой\nснаружи.»"},
                    {pause:3,stage:true,txt:"Ты тоже."},
                    {pause:3,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Я говорил людям\n«иди» — чтобы\nне признавать,\nчто хочу идти\nсам.»"},
                    {pause:3,stage:true,txt:"Ты тоже."},
                    {pause:4,stage:true,txt:""},
                    {spk:"ERNIE",cls:"er",txt:"«Тогда.»",spd:60},
                    {pause:3,spk:"ERNIE",cls:"er",txt:"«Мы оба выходим.»",spd:40},
                    {pause:3,stage:true,txt:""},
                    {stage:true,txt:"Вдвоём.\nНе потому что ты спас его.\nИ не потому что он вёл тебя.",fn:function(){sChime()}},
                    {pause:3,stage:true,txt:"Потому что оба\nпоняли одно:"},
                    {pause:3,stage:true,txt:""},
                    {narr:true,txt:"«Не нужно\nбыть особенным,\nчтобы выйти.»"},
                    {pause:3,stage:true,txt:"",fn:function(){startMusic("roof")}},
                    {narr:true,txt:"«Нужно просто\nпризнать,\nчто хочешь.»"},
                    {pause:4,stage:true,txt:""},
                    {stage:true,txt:"Рассвет.\nДверь открыта.",fn:function(){sI(I.sunrise)}},
                    {narr:true,txt:"Конец — это только начало."},
                    {narr:true,txt:"«Зеркало разбито.\nНаконец.»"}
                ],function(){showTBC("e")})
            }
            function inviteFriend(){
                var text="🏚 ERNIE — THE WARDEN'S TOWER\n\nМальчик-призрак. 200 лет. 847 посетителей.\nНикто не вышел.\n\n«Пожалуйста, не уходи.»\n\nПопробуй не уйти.";
                var url=window.location.href;
                if(navigator.share){navigator.share({title:"ERNIE — THE WARDEN'S TOWER",text:text,url:url}).catch(function(){})}
                else{window.open("https://t.me/share/url?url="+encodeURIComponent(url)+"&text="+encodeURIComponent(text),"_blank")}
            }
            function showFeedback(){$("feedbackWrap").style.display=$("feedbackWrap").style.display==="none"?"block":"none"}
            // === ДНЕВНИК ===
            var DIARY=[];
            function addDiary(text,type,floor){
                type=type||"wall";floor=floor||G.currentFloor||"?";
                DIARY.push({text:text,type:type,floor:floor,time:Date.now()});
                // Подсветка кнопки
                var btn=$("diaryBtn");if(btn){btn.style.opacity="1";btn.style.animation="flk 1s ease 3"}
                setTimeout(function(){if(btn)btn.style.animation=""},3000);
            }
            function openDiary(){
                var el=$("diaryOverlay");var list=$("diaryList");
                list.innerHTML="";
                if(DIARY.length===0){
                    list.innerHTML='<div class="diary-empty">Дневник пуст.<br>Записки появятся по мере прохождения.</div>';
                }else{
                    DIARY.slice().reverse().forEach(function(d,i){
                        var e=document.createElement("div");e.className="diary-entry";
                        e.style.animationDelay=(i*0.06)+"s";
                        var typeLabel={wall:"📝 СТЕНА",letter:"✉️ ПИСЬМО",secret:"🔮 СЕКРЕТ",lore:"📚 ЛОР",demon:"👁 ???"}[d.type]||"📝";
                        e.innerHTML='<div class="de-floor">ЭТАЖ '+d.floor+'</div><div class="de-type '+d.type+'">'+typeLabel+'</div>'+d.text;
                        list.appendChild(e);
                    });
                }
                el.classList.add("show");
            }
            function closeDiary(){$("diaryOverlay").classList.remove("show")}
            // Показать важную записку в popup
            function showWallNote(icon,text,type,floor){addEcho(2);
                $("wnIcon").textContent=icon||"📜";
                $("wnText").textContent=text;
                $("wallNote").classList.add("show");
                if(window._wnT)clearTimeout(window._wnT);window._wnT=setTimeout(closeWallNote,8000);
                addDiary(text,type||"wall",floor);
                tone(330,.3,"sine",.02);
            }
            function closeWallNote(){$("wallNote").classList.remove("show")}

// ╔══════════════════════════════════════════════════════════════╗
// ║  v96: EMOTIONAL REVOLUTION — 10 SYSTEMS                     ║
// ║  Inspired by: Undertale, Disco Elysium, Celeste,            ║
// ║  Papers Please, Outer Wilds, To The Moon                    ║
// ╚══════════════════════════════════════════════════════════════╝

// ============================================================
// 1. HOLD-TO-CHOOSE — Тяжёлые решения требуют удержания
//    (Undertale genocide confirm / Papers Please stamp)
// ============================================================
(function(){
    var holdTimer=null,holdTarget=null,holdStarted=0,holdDuration=2500;
    var ernieHoldComments=[
        "«Подожди...»","«Ты уверен?»","«Серьёзно?»",
        "«Я бы не стал...»","«Ладно. Твой выбор.»",
        "«...»"
    ];
    function setupHoldBtn(btn){
        if(!btn||!btn.hasAttribute("data-w")||btn.getAttribute("data-w")!=="heavy")return;
        var hint=document.createElement("span");
        hint.className="hold-hint";hint.textContent="удерживай";
        btn.appendChild(hint);
        btn.style.setProperty("--hold-dur",holdDuration+"ms");
        var origClick=btn.onclick;
        btn.onclick=null;
        var startHold=function(e){
            e.preventDefault();e.stopPropagation();
            holdTarget=btn;holdStarted=Date.now();
            btn.classList.add("holding");
            vibrate(15);
            // ERNIE комментирует удержание
            var commentDelay=holdDuration*0.4;
            holdTimer=setTimeout(function(){
                if(holdTarget===btn){
                    var c=ernieHoldComments[Math.floor(Math.random()*ernieHoldComments.length)];
                    notify("💭 ERNIE: "+c.replace(/«|»/g,""),null);
                    tgHaptic("light");
                }
            },commentDelay);
            // Завершение удержания
            setTimeout(function(){
                if(holdTarget===btn&&btn.classList.contains("holding")){
                    btn.classList.remove("holding");
                    vibrate(50);tgHaptic("heavy");
                    holdTarget=null;
                    // Выполняем действие
                    var fn=btn.getAttribute("data-fn");
                    if(fn){try{eval(fn)}catch(e){}}
                    else if(origClick)origClick.call(btn,e);
                }
            },holdDuration);
        };
        var endHold=function(e){
            if(holdTarget===btn&&(Date.now()-holdStarted)<holdDuration){
                btn.classList.remove("holding");
                holdTarget=null;
                if(holdTimer)clearTimeout(holdTimer);
                // Не хватило мужества
                if(Date.now()-holdStarted>800){
                    notify("⟲ Отпустил","gold");
                    EMOTION.add(-5);// Облегчение
                }
            }
        };
        btn.addEventListener("touchstart",startHold,{passive:false});
        btn.addEventListener("mousedown",startHold);
        btn.addEventListener("touchend",endHold);
        btn.addEventListener("mouseup",endHold);
        btn.addEventListener("touchcancel",endHold);
        btn.addEventListener("mouseleave",endHold);
    }
    // Мутация: подхватывать новые кнопки
    var obs=new MutationObserver(function(muts){
        muts.forEach(function(m){
            m.addedNodes.forEach(function(n){
                if(n.nodeType===1){
                    if(n.matches&&(n.matches('[data-w="heavy"]')))setupHoldBtn(n);
                    if(n.querySelectorAll){n.querySelectorAll('[data-w="heavy"]').forEach(setupHoldBtn)}
                }
            });
        });
    });
    obs.observe(document.body,{childList:true,subtree:true});
    window._setupHoldBtn=setupHoldBtn;
})();

// ============================================================
// 2. ERNIE MOOD STATE MACHINE
//    (Disco Elysium personality system)
// ============================================================
var ERNIE_MOOD={
    state:"guarded",// cold → guarded → warming → open → vulnerable
    threshold:{cold:-5,guarded:0,warming:3,open:6,vulnerable:10},
    getState:function(){
        var t=G.trust||0;
        if(t<=-2)return "cold";
        if(t<=1)return "guarded";
        if(t<=3)return "warming";
        if(t<=5)return "open";
        return "vulnerable";
    },
    apply:function(){
        var s=this.getState();
        if(s===this.state)return;
        var old=this.state;this.state=s;
        document.body.classList.remove("ernie-mood-cold","ernie-mood-guarded","ernie-mood-warming","ernie-mood-open","ernie-mood-vulnerable");
        document.body.classList.add("ernie-mood-"+s);
        // Переход между состояниями — микро-событие
        if(s==="warming"&&old==="guarded"){
            setTimeout(function(){notify("💭 ERNIE говорит чуть теплее",null)},2000);
        }
        if(s==="open"&&old==="warming"){
            setTimeout(function(){notify("💛 ERNIE доверяет тебе",null)},1500);
            ernieThree();
        }
        if(s==="vulnerable"){
            setTimeout(function(){notify("💛 ERNIE раскрыт. Полностью.",null)},1000);
        }
        if(s==="cold"&&(old==="guarded"||old==="warming")){
            setTimeout(function(){notify("❄️ ERNIE замолчал","bad")},1000);
        }
    },
    // Модификатор скорости текста в зависимости от настроения
    getSpeedMod:function(){
        var s=this.getState();
        if(s==="cold")return 1.5;// Медленнее — осторожно
        if(s==="guarded")return 1.2;
        if(s==="warming")return 1;
        if(s==="open")return 0.9;
        if(s==="vulnerable")return 0.7;// Быстрее — не может сдерживаться
        return 1;
    },
    // Вставить дополнительные паузы для холодного ERNIE
    getExtraPause:function(){
        var s=this.getState();
        if(s==="cold")return 2000;
        if(s==="guarded")return 800;
        if(s==="vulnerable")return 400;
        return 0;
    }
};

// ============================================================
// 3. PROMISE SYSTEM — Обещания преследуют
//    (Outer Wilds memory / To The Moon promises)
// ============================================================
var PROMISES={
    list:[],
    add:function(text,floor){
        this.list.push({text:text,floor:floor||G.currentFloor,time:Date.now(),broken:false});
        try{localStorage.setItem("ernie_promises",JSON.stringify(this.list))}catch(e){}
    },
    check:function(keyword){
        return this.list.filter(function(p){return p.text.indexOf(keyword)>=0});
    },
    whisper:function(text){
        var el=$("promiseWhisper");
        if(!el)return;
        el.textContent="«"+text+"»";
        el.classList.add("show");
        setTimeout(function(){el.classList.remove("show")},4000);
    },
    // Случайное напоминание о обещании
    haunt:function(){
        if(this.list.length===0)return;
        var p=this.list[Math.floor(Math.random()*this.list.length)];
        this.whisper("Ты сказал: «"+p.text+"»");
        vibrate(15);
    },
    load:function(){
        try{var s=localStorage.getItem("ernie_promises");if(s)this.list=JSON.parse(s)}catch(e){}
    }
};
PROMISES.load();
// Напоминания каждые 3-5 минут
setInterval(function(){
    if(G.currentFloor>=3&&PROMISES.list.length>0&&Math.random()<0.3){PROMISES.haunt()}
},180000);

// ============================================================
// 4. GUILT ECHO SYSTEM — Плохие выборы создают эхо
//    (Undertale genocide consequences)
// ============================================================
var GUILT={
    echoes:[],
    add:function(text,severity){
        this.echoes.push({text:text,severity:severity||1,floor:G.currentFloor});
        if(this.echoes.length>=3)document.body.classList.add("guilt-active");
    },
    // Мерцающий текст вины на экране
    manifest:function(){
        if(this.echoes.length===0)return;
        var echo=this.echoes[Math.floor(Math.random()*this.echoes.length)];
        var el=document.createElement("div");
        el.className="guilt-echo";
        el.textContent=echo.text;
        el.style.top=(20+Math.random()*60)+"%";
        el.style.left=(10+Math.random()*60)+"%";
        el.style.fontSize=(10+echo.severity*2)+"px";
        el.style.animationDelay=(Math.random()*4)+"s";
        document.body.appendChild(el);
        setTimeout(function(){el.remove()},8000);
    },
    // Проверка: если много вины — экран дрожит
    pulse:function(){
        if(this.echoes.length>=5&&Math.random()<0.15){
            this.manifest();
            vibrate(10);
        }
    }
};
// Пульс вины каждые 20-40 секунд
setInterval(function(){GUILT.pulse()},25000);

// ============================================================
// 5. NPC CROSS-REFERENCE WEB
//    (Disco Elysium interconnected world)
// ============================================================
var NPC_WEB={
    // Генерирует перекрёстные реплики
    getCrossRef:function(npcId,floor){
        var refs=[];
        // Бариста упоминает других
        if(npcId==="barista"){
            if(G.saved&&G.saved.conductor)refs.push("«Кондуктор уехал.\nЗначит, поезда\nвсё-таки ходят.\nА ко мне —\nни одного клиента.»");
            if(G.saved&&G.saved.lika)refs.push("«Лика ушла.\nЕё шоколад\nостывает.\nУже 200 лет.»");
            if(G.catDead)refs.push("«Кошка...\nОна заходила\nкаждый день.\nПросто сидела.\nТеперь — пусто.»");
        }
        // Кондуктор упоминает
        if(npcId==="conductor"){
            if(G.uc.cc)refs.push("«Бариста\nпередаёт привет.\nНу, кивнул\nв мою сторону.\nЭто считается.»");
        }
        // Библиотекарь
        if(npcId==="librarian"){
            if(G.uc.ld)refs.push("«Девочка рисовала\nтебя.\nВидел на стене.\nПохоже.»");
        }
        // Актёр
        if(npcId==="actor"){
            if(G.uc.cc)refs.push("«Бариста говорит,\nмои выступления —\nлучшее,\nчто есть в башне.\n...Он врёт.\nНо приятно.»");
        }
        return refs;
    },
    // Показать случайную перекрёстную реплику
    inject:function(npcId){
        var refs=this.getCrossRef(npcId,G.currentFloor);
        if(refs.length>0&&Math.random()<0.6){
            return refs[Math.floor(Math.random()*refs.length)];
        }
        return null;
    }
};

// ============================================================
// 6. HEARTBEAT SYNC — Сердцебиение экрана
//    (Celeste anxiety / Hellblade psychosis)
// ============================================================
var HEARTBEAT={
    active:false,
    mode:null,// 'normal','fast','stop'
    sound:null,
    start:function(mode){
        this.active=true;this.mode=mode||"normal";
        document.body.classList.remove("heartbeat-sync","heartbeat-fast","heartbeat-stop");
        if(mode==="fast")document.body.classList.add("heartbeat-fast");
        else if(mode==="stop"){document.body.classList.add("heartbeat-stop");this.stopSound();return}
        else document.body.classList.add("heartbeat-sync");
        this.startSound(mode);
    },
    stop:function(){
        this.active=false;this.mode=null;
        document.body.classList.remove("heartbeat-sync","heartbeat-fast","heartbeat-stop");
        this.stopSound();
    },
    // СТОП сердцебиения — самый мощный момент
    dramatic_stop:function(){
        var self=this;
        this.start("fast");
        setTimeout(function(){
            self.start("stop");
            vibrate(100);
            // Тишина. 3 секунды абсолютной тишины.
            stopMusic();
            if(AC){try{AC.suspend()}catch(e){}}
            setTimeout(function(){
                if(AC){try{AC.resume()}catch(e){}}
            },3000);
        },3000);
    },
    startSound:function(mode){
        if(!AC||!SETT.sfx)return;
        var self=this;var bpm=mode==="fast"?100:65;
        var interval=60000/bpm;
        function beat(){
            if(!self.active||self.mode==="stop")return;
            tone(50,.12,"sine",.05);
            setTimeout(function(){tone(45,.15,"sine",.04)},interval*0.25);
            self.sound=setTimeout(beat,interval);
        }
        beat();
    },
    stopSound:function(){
        if(this.sound)clearTimeout(this.sound);this.sound=null;
    }
};

// ============================================================
// 7. EMOTIONAL TEMPERATURE SYSTEM
//    (Celeste pacing / music game flow)
// ============================================================
var EMOTION={
    temp:0,// -100 (горе) до +100 (радость), 0 = нейтрально
    history:[],
    add:function(n){
        var old=this.temp;
        this.temp=Math.max(-100,Math.min(100,this.temp+n));
        this.history.push({val:n,time:Date.now(),total:this.temp});
        this.updateBar();
        // Эмоциональный контраст — если резкий перепад, усиливаем эффект
        if(Math.abs(this.temp-old)>30){
            vibrate(30);
            if(n>0)sChime();
            else sDanger();
        }
    },
    updateBar:function(){
        var bar=$("emotionBar");if(!bar)return;
        bar.className="";
        if(this.temp>20)bar.className="warm";
        else if(this.temp<-20)bar.className="pain";
        else if(this.temp<-5)bar.className="cold";
    },
    // Анализ пейсинга — нужна ли смена тона?
    needsRelief:function(){return this.temp<-40},
    needsTension:function(){return this.temp>40},
    // Автоматический комедийный бит после трагедии (Undertale style)
    autoRelief:function(){
        if(!this.needsRelief())return null;
        var reliefs=[
            function(){if(G.hasCat)notify("🐱 "+(G.catName||"Кошка")+" чихнула. В самый неподходящий момент.","gold")},
            function(){notify("🐦‍⬛ Ворон: «Кар. (Сочувственно.)»","gold")},
            function(){notify("💭 ERNIE: «Извини. Мне нужен перерыв.\nШучу. Я призрак.\nУ меня бесконечный перерыв.»",null)},
            function(){if(G.hasCat){notify("🐱 "+(G.catName||"Кошка")+" легла на ногу. Тёплая.","gold");sPurr()}}
        ];
        var fn=reliefs[Math.floor(Math.random()*reliefs.length)];
        this.add(15);// Немного поднять
        return fn;
    }
};

// ============================================================
// 8. SILENCE PRESSURE — Терпение вознаграждается
//    (Papers Please patience / Undertale sparing)
// ============================================================
var PATIENCE={
    skips:0,
    waits:0,
    lastSkipTime:0,
    // Отслеживать пропуски текста
    registerSkip:function(){
        this.skips++;
        this.lastSkipTime=Date.now();
        if(this.skips===5){
            setTimeout(function(){notify("💭 ERNIE: «Ты торопишься.»",null)},1000);
            G.trust=Math.max(-5,(G.trust||0)-0.5);
            document.body.classList.add("skip-hurt");
            setTimeout(function(){document.body.classList.remove("skip-hurt")},1000);
        }
        if(this.skips===12){
            setTimeout(function(){notify("💭 ERNIE: «...Ладно.\nЯ буду короче.»",null)},500);
        }
        if(this.skips>=20&&!G.uc._skipSecret){
            G.uc._skipSecret=true;
            setTimeout(function(){
                notify("💭 ERNIE: «Ты не читаешь.\nНичего.\nЯ мог бы написать\nчто угодно.»",null);
                setTimeout(function(){
                    notify("💭 ERNIE: «Тут написано:\n«ты мне нравишься».\nНо ты не увидел.»","gold");
                },4000);
            },2000);
        }
    },
    // Награда за терпеливое ожидание
    registerWait:function(){
        this.waits++;
        if(this.waits%5===0){
            document.body.classList.add("patience-glow");
            setTimeout(function(){document.body.classList.remove("patience-glow")},3000);
        }
        if(this.waits===10){
            G.trust=(G.trust||0)+1;
            setTimeout(function(){notify("💛 ERNIE заметил, что ты не торопишься",null)},2000);
        }
    }
};

// ============================================================
// 9. REAL-TIME AWARENESS — ERNIE считает секунды
//    (Outer Wilds time / Animal Crossing real time)
// ============================================================
var TIMEAWARE={
    sessionStart:Date.now(),
    getPlayTime:function(){return Math.floor((Date.now()-this.sessionStart)/1000)},
    getLastVisit:function(){
        try{return parseInt(localStorage.getItem("ernie_lastvisit"))||0}catch(e){return 0}
    },
    saveVisit:function(){
        try{localStorage.setItem("ernie_lastvisit",Date.now().toString())}catch(e){}
    },
    getAbsenceSeconds:function(){
        var last=this.getLastVisit();
        if(!last)return 0;
        return Math.floor((Date.now()-last)/1000);
    },
    formatTime:function(sec){
        if(sec<60)return sec+" секунд";
        if(sec<3600)return Math.floor(sec/60)+" минут";
        if(sec<86400)return Math.floor(sec/3600)+" часов";
        return Math.floor(sec/86400)+" дней";
    },
    // Генерировать реплику ERNIE о времени
    getTimeComment:function(){
        var abs=this.getAbsenceSeconds();
        if(abs<60)return null;// Только что был
        if(abs<3600)return "«"+this.formatTime(abs)+".\nЯ считал.»";
        if(abs<86400)return "«"+this.formatTime(abs)+".\nНе то чтобы я ждал.\nПросто... считал.»";
        return "«"+this.formatTime(abs)+".\nЯ перестал считать\nпосле "+Math.floor(abs/3600)+" часов.\nПотом начал заново.»";
    },
    // Проверка времени суток
    isLateNight:function(){var h=new Date().getHours();return h>=1&&h<5},
    isMorning:function(){var h=new Date().getHours();return h>=6&&h<10},
    getLateNightComment:function(){
        if(!this.isLateNight())return null;
        var comments=[
            "«Три часа ночи.\nТы должен спать.»",
            "«Я не сплю.\nПотому что не могу.\nНо ты можешь.\nИди спать.»",
            "«В башне всегда ночь.\nНо у тебя есть утро.\nНе теряй его.»"
        ];
        return comments[Math.floor(Math.random()*comments.length)];
    }
};
// Сохранять время визита каждые 30 сек
setInterval(function(){TIMEAWARE.saveVisit()},30000);
TIMEAWARE.saveVisit();

// ============================================================
// 10. PATTERN RECOGNITION — Игра замечает привычки
//     (Stanley Parable narrator awareness)
// ============================================================
var PATTERNS={
    choices:[],// {position: 0-based index, total: total options}
    trackChoice:function(index,total){
        this.choices.push({idx:index,total:total,floor:G.currentFloor});
        this.analyze();
    },
    analyze:function(){
        if(this.choices.length<5)return;
        var last5=this.choices.slice(-5);
        // Всегда первый вариант?
        var allFirst=last5.every(function(c){return c.idx===0});
        if(allFirst&&!this._warned1){
            this._warned1=true;
            setTimeout(function(){
                notify("🐦‍⬛ Ворон: «Ты всегда выбираешь первое.\nИнтересная стратегия.»","gold");
            },3000);
        }
        // Всегда последний?
        var allLast=last5.every(function(c){return c.idx===c.total-1});
        if(allLast&&!this._warned2){
            this._warned2=true;
            setTimeout(function(){
                notify("💭 ERNIE: «Ты всегда выбираешь последнее.\nКак будто ждёшь чего-то.»",null);
            },3000);
        }
        // Очень быстрые выборы?
        if(this.choices.length>=3){
            var last3=this.choices.slice(-3);
            var fast=true;
            for(var i=1;i<last3.length;i++){
                // Если нет timestamps, skip
                fast=false;
            }
        }
    },
    // Показать заметку паттерна
    showNote:function(text){
        var el=$("patternNote");if(!el)return;
        el.textContent=text;el.classList.add("show");
        setTimeout(function(){el.classList.remove("show")},5000);
    }
};

// ============================================================
// INTEGRATION: Подключение систем к существующему коду
// ============================================================

// Перехват updH для обновления настроения ERNIE
var _origUpdH=updH;
updH=function(){
    _origUpdH();
    ERNIE_MOOD.apply();
    // Эмоциональная температура от кармы
    if(G.karma>0)EMOTION.add(1);
    else if(G.karma<0)EMOTION.add(-1);
    // Проверка облегчения после трагедии
    var relief=EMOTION.autoRelief();
    if(relief)setTimeout(relief,4000+Math.random()*3000);
};

// Перехват showCh для добавления hold-to-choose и трекинга паттернов
var _origShowCh=showCh;
showCh=function(arr){
    _origShowCh(arr);
    // Setup hold buttons
    setTimeout(function(){
        document.querySelectorAll('.g-cb[data-w="heavy"],.ch-btn[data-w="heavy"]').forEach(function(btn){
            if(!btn._holdSetup){btn._holdSetup=true;window._setupHoldBtn(btn)}
        });
    },100);
    // Track pattern
    var btns=document.querySelectorAll(".g-cb,.ch-btn");
    btns.forEach(function(btn,i){
        var origClick=btn.onclick;
        if(origClick&&!btn._patternTracked){
            btn._patternTracked=true;
            btn.onclick=function(e){
                PATTERNS.trackChoice(i,btns.length);
                if(origClick)origClick.call(btn,e);
            };
        }
    });
};

// Перехват fadeIn для добавления вины и heartbeat
var _origFadeIn=fadeIn;
fadeIn=function(cb){
    // Пульс вины на переходах
    GUILT.pulse();
    // Обновить время
    TIMEAWARE.saveVisit();
    _origFadeIn(cb);
};

// Перехват startD (dialogue) для отслеживания пропусков и терпения
var _origDialogTapTime=0;
document.addEventListener("click",function(){
    // Если диалог идёт и прошло мало времени — это skip
    if(G.currentFloor>=1){
        var now=Date.now();
        if(now-_origDialogTapTime<400){
            PATIENCE.registerSkip();
        }else if(now-_origDialogTapTime>3000){
            PATIENCE.registerWait();
        }
        _origDialogTapTime=now;
    }
});

// Перехват notify для эмоциональной температуры
var _origNotify=notify;
notify=function(t,tp){
    _origNotify(t,tp);
    // Анализ эмоции по типу нотификации
    if(tp==="bad"){EMOTION.add(-8)}
    else if(tp==="gold"){EMOTION.add(5)}
};

// Перехват addEcho для усиления эмоций
var _origAddEcho=addEcho;
addEcho=function(n,label){
    _origAddEcho(n,label);
    EMOTION.add(n>0?n:-n);
};

// Перехват gameOver для guilt
var _origGameOver=gameOver;
// (gameOver уже определён, мы добавим guilt при смерти)

// Специальные функции для интеграции
// Heartbeat для этажа 9 — самый эмоциональный момент
var _origF9=typeof f9ErniePlea==="function"?f9ErniePlea:null;
if(_origF9){
    var _f9patched=false;
    // Патч будет через setTimeout чтобы все функции были определены
}

// Автоматический heartbeat в опасных ситуациях
var _origFlashDamage=flashDamage;
flashDamage=function(){
    _origFlashDamage();
    HEARTBEAT.start("fast");
    EMOTION.add(-15);
    setTimeout(function(){HEARTBEAT.stop()},3000);
};

// Promise detection в ключевых моментах
// Перехватываем f8yes (когда игрок говорит "Да" на 8 этаже)
var _origF8yes=typeof f8yes==="function"?f8yes:null;

// Добавить guilt при плохих действиях
var _origAddDread=addDread;
addDread=function(n){
    _origAddDread(n);
    if(n>15){
        GUILT.add("...не стоило",Math.ceil(n/10));
    }
};

// ============================================================
// STARTUP: Инициализация систем при загрузке
// ============================================================
setTimeout(function(){
    // Показать время отсутствия
    var timeComment=TIMEAWARE.getTimeComment();
    if(timeComment&&TM.runs>=1){
        setTimeout(function(){
            showGhostPop("ERNIE",I.ava_ernie,timeComment.replace(/«|»/g,""));
        },8000);
    }
    // Поздняя ночь
    var lateComment=TIMEAWARE.getLateNightComment();
    if(lateComment&&G.currentFloor>=1){
        setTimeout(function(){
            notify("💭 ERNIE: "+lateComment.replace(/«|»/g,"").replace(/\n/g," ").substring(0,60),null);
        },15000);
    }
    // Применить настроение
    ERNIE_MOOD.apply();
},3000);

// Heartbeat при сердцебиении ERNIE на этаже 9
setTimeout(function(){
    var origF9=window.f9ErniePlea;
    if(origF9&&!window._f9patched){
        window._f9patched=true;
        window.f9ErniePlea=function(){
            HEARTBEAT.start("normal");
            EMOTION.add(-30);
            origF9();
        };
    }
    // Heartbeat stop при правде на этаже 8
    var origF8P2=window.f8Part2;
    if(origF8P2&&!window._f8patched){
        window._f8patched=true;
        window.f8Part2=function(){
            // Драматическая остановка сердца при раскрытии правды
            if(G.uc.pne||G.trust>=5){
                HEARTBEAT.start("normal");
                setTimeout(function(){HEARTBEAT.dramatic_stop()},8000);
            }
            EMOTION.add(-40);
            origF8P2();
        };
    }
    // Promise при выборе на этаже 9 - "Я открою дверь" / "Я закрою игру"
    var origCatBye=window.f8Part2b;
    if(origCatBye&&!window._catByePatched){
        window._catByePatched=true;
        window.f8Part2b=function(){
            if(G.hasCat){
                PROMISES.add("Я вернусь за кошкой",8);
                EMOTION.add(-25);
            }
            origCatBye();
        };
    }
    // NPC cross-references: inject into ghost notifications
    var origGhostNotify=window.ghostNotify;
    if(origGhostNotify){
        window.ghostNotify=function(floor){
            origGhostNotify(floor);
            // Перекрёстные ссылки с 40% шансом
            if(Math.random()<0.4){
                var npcs=["barista","conductor","librarian","actor"];
                var npc=npcs[Math.floor(Math.random()*npcs.length)];
                var ref=NPC_WEB.inject(npc);
                if(ref){
                    var names={barista:"БАРИСТА",conductor:"КОНДУКТОР",librarian:"БИБЛ.",actor:"АКТЁР"};
                    setTimeout(function(){
                        showGhostPop(names[npc]||npc,I["ava_"+npc]||I.ava_ernie,ref.replace(/«|»/g,""));
                    },8000+Math.random()*5000);
                }
            }
        };
    }

    // Guilt на плохие выборы
    // Если жизни = 0 (уже перехвачено через flashDamage)
    // Добавим guilt при конкретных плохих выборах
    var origShadowGo=window.shadowGo;
    if(origShadowGo){
        window.shadowGo=function(){
            if(!G.hasCat){
                GUILT.add("Тень тронула тебя",2);
                PROMISES.add("больше не буду лезть к теням");
            }
            origShadowGo();
        };
    }
    var origPhoneAnswer=window.phoneAnswer;
    if(origPhoneAnswer){
        window.phoneAnswer=function(){
            GUILT.add("Ты ответил. Башня знает.",3);
            EMOTION.add(-20);
            HEARTBEAT.start("fast");
            setTimeout(function(){HEARTBEAT.stop()},12000);
            origPhoneAnswer();
        };
    }

    // Heartbeat при прощании с кошкой
    if(origCatBye){
        // Already patched above
    }
},1000);

// ============================================================
// BONUS: Эмоциональные микро-события между этажами
// ============================================================
setInterval(function(){
    if(G.currentFloor<2||G.currentFloor>=10)return;
    // Микро-событие: ERNIE вспоминает что-то
    if(Math.random()<0.03){
        var microMemories=[
            "«Мама пела\nколыбельную.\nНе помню слов.\nПомню голос.»",
            "«Дождь.\nЯ любил дождь.\nТеперь слышу его\nтолько когда ты\nоткрываешь дверь.»",
            "«Я забыл свой день рождения.\nНо помню торт.\nШоколадный.\nСо свечами.»",
            "«Иногда я думаю —\nчто если дверь\nвсегда была открыта?\nА я просто\nне пробовал?»",
            "«847.\nЯ помню\nкаждое имя.\nКроме своего.\nИногда.»"
        ];
        var mem=microMemories[Math.floor(Math.random()*microMemories.length)];
        showGhostPop("ERNIE",I.ava_ernie,mem.replace(/«|»/g,""));
        EMOTION.add(-5);
        ernieThree();
    }
},60000);

// ============================================================
// BONUS: "Тёплые моменты" — контраст с темнотой
// (Celeste + Undertale: надежда среди отчаяния)
// ============================================================
setInterval(function(){
    if(G.currentFloor<1||G.currentFloor>=10)return;
    if(EMOTION.needsRelief()&&Math.random()<0.1){
        var warmMoments=[
            function(){
                if(G.hasCat){
                    notify("🐱 "+(G.catName||"Кошка")+" мурчит у ноги. Просто так.","gold");
                    sPurr();EMOTION.add(15);
                }
            },
            function(){
                notify("☕ Запах кофе. Откуда-то сверху. Борис.","gold");
                EMOTION.add(10);
            },
            function(){
                if(G.saved&&countSaved()>0){
                    notify("✨ Где-то далеко — кто-то свободен. Благодаря тебе.","gold");
                    EMOTION.add(20);sChime();
                }
            },
            function(){
                notify("🌧 Дождь стучит. Тихо. Как дома.","gold");
                EMOTION.add(10);
            }
        ];
        var fn=warmMoments[Math.floor(Math.random()*warmMoments.length)];
        fn();
    }
},45000);

// ╔══════════════════════════════════════════════════════════════╗
// ║  v97: "CAN'T CLOSE, CAN'T FORGET" ENGINE                   ║
// ║  7 systems that make the game unforgettable                 ║
// ╚══════════════════════════════════════════════════════════════╝

// ============================================================
// 1. ERNIE TYPING INDICATOR — он живой, он думает
//    Показывается ПЕРЕД репликами ERNIE. Иногда "стирает".
// ============================================================
var TYPING={
    el:null,timer:null,
    show:function(duration,deleted){
        this.el=$("ernieTyping");if(!this.el)return;
        this.el.className="show"+(deleted?" deleted":"");
        this.el.style.display="flex";
        vibrate(5);
        var self=this;
        this.timer=setTimeout(function(){self.hide()},duration||1500);
    },
    hide:function(){
        if(this.el)this.el.style.display="none";
        if(this.timer){clearTimeout(this.timer);this.timer=null}
    },
    // Случайно показать перед важной репликой ERNIE
    beforeSpeak:function(cb,important){
        var dur=important?2200:800+Math.random()*800;
        // 8% шанс что ERNIE "стирает" — передумал
        var deleted=Math.random()<0.08;
        this.show(dur,deleted);
        if(deleted){
            // Стёр → пауза → печатает заново
            var self=this;
            setTimeout(function(){
                self.show(dur*0.7,false);
                setTimeout(function(){self.hide();if(cb)cb()},dur*0.7);
            },dur+400);
        }else{
            var self=this;
            setTimeout(function(){self.hide();if(cb)cb()},dur);
        }
    }
};

// Перехват: добавить typing перед репликами ERNIE в startD
var _origStartD=startD;
startD=function(lines,endCb,choices,img){
    // Вставляем typing indicator перед первой репликой ERNIE
    var enhanced=[];
    var typingInserted=false;
    lines.forEach(function(line,i){
        if(!typingInserted&&line.spk==="ERNIE"&&line.cls==="er"&&i>0){
            // Вставляем typing перед первой репликой ERNIE (не самой первой строкой)
            enhanced.push({_typing:true,pause:0.3});
            typingInserted=true;
        }
        enhanced.push(line);
    });
    // Передаём дальше, typing будет показываться через перехват tw()
    _origStartD(enhanced,endCb,choices,img);
};

// ============================================================
// 2. SUBLIMINAL FLASH — подсознательные вспышки
//    0.15-0.3 секунды текста/образа. Игрок думает "что это было?"
// ============================================================
var SUBLIMINAL={
    pool:[
        "847","помоги","не уходи","слышишь?","мама","тут холодно",
        "он врёт","дверь","один","время","помнишь?","выход",
        "не оглядывайся","кто ты?","8:47","последний","тише"
    ],
    cooldown:false,
    flash:function(text,duration){
        if(this.cooldown)return;
        this.cooldown=true;
        var el=$("subFlash");if(!el)return;
        el.querySelector(".sf-text").textContent=text||this.pool[Math.floor(Math.random()*this.pool.length)];
        el.classList.add("fire");
        vibrate(5);
        var dur=duration||150;// 0.15 секунды — подсознание
        setTimeout(function(){
            el.classList.remove("fire");
        },dur);
        var self=this;
        setTimeout(function(){self.cooldown=false},30000);// 30с cooldown
    },
    // Автоматические вспышки на переходах
    maybeFlash:function(){
        if(G.currentFloor<2)return;
        if(Math.random()<0.12){// 12% шанс
            var delay=500+Math.random()*2000;
            var self=this;
            setTimeout(function(){self.flash()},delay);
        }
    }
};

// Интегрируем в fadeIn
var __origFadeIn=fadeIn;
fadeIn=function(cb){
    SUBLIMINAL.maybeFlash();
    __origFadeIn(cb);
};

// ============================================================
// 3. IMAGE TOUCH SECRETS — удерживай картинку для секрета
//    Каждая картинка скрывает что-то. Награда для любопытных.
// ============================================================
var IMG_SECRETS={
    secrets:{
        city:"Надписи на стенах.\n847 имён.",
        cafe_ext:"В окне — силуэт.\nВсегда.",
        station:"Расписание.\nВсе поезда → ТУДА.",
        library:"Книга без обложки.\nТвоё имя внутри.",
        theater:"Пустые кресла.\nНо аплодисменты.",
        lab:"Формула на доске.\nДуша = масса × время²",
        garden:"Цветок жив.\nЕдинственный.",
        mirror:"Отражение\nна секунду позже.",
        voices:"847 ртов.\n1 крик.",
        void9:"Ничего.\nИ это — страшнее.",
        roof:"Небо.\nНастоящее.",
        boris:"200 лет.\n1 рецепт.",
        conductor:"Билет.\nНазад.",
        cat:"Тёплая.\nЖивая.\nЕдинственная.",
        guardian:"Устал.\n200 лет стоит.",
        ernie_visible:"14 лет.\nНавсегда.",
        tower_inside:"Вверх.\nВсегда вверх.",
        shadow:"Не монстр.\nПустой.",
        lika:"Рисует солнце.\n200 лет.\nОдно и то же."
    },
    currentImg:null,holdTimer:null,active:false,
    init:function(){
        var self=this;
        var imgW=$("gImgW");if(!imgW)return;
        var startHold=function(e){
            if(self.active)return;
            self.holdTimer=setTimeout(function(){
                self.reveal();
            },800);// 0.8 секунды удержания
        };
        var endHold=function(){
            if(self.holdTimer){clearTimeout(self.holdTimer);self.holdTimer=null}
            self.hideReveal();
        };
        imgW.addEventListener("touchstart",startHold,{passive:true});
        imgW.addEventListener("mousedown",startHold);
        imgW.addEventListener("touchend",endHold);
        imgW.addEventListener("mouseup",endHold);
        imgW.addEventListener("touchcancel",endHold);
    },
    reveal:function(){
        this.active=true;
        var imgEl=$("gI");if(!imgEl)return;
        var src=imgEl.src||"";
        // Найти ключ по URL
        var key=null;
        for(var k in I){
            if(src.indexOf(k)>=0||src===I[k]){key=k;break}
        }
        var secret=key?this.secrets[key]:null;
        if(!secret)secret="...";
        $("imgSecretText").textContent=secret;
        $("imgSecret").classList.add("show");
        vibrate(15);
        GHOST.increment();
        // Микро-достижение
        if(!G.uc["_imgS_"+key]&&key){
            G.uc["_imgS_"+key]=true;
            MICRO.show("👁 секрет картинки");
        }
    },
    hideReveal:function(){
        this.active=false;
        $("imgSecret").classList.remove("show");
    }
};
setTimeout(function(){IMG_SECRETS.init()},2000);

// ============================================================
// 4. GHOST COUNTER — таинственное число
//    Считает каждое взаимодействие. Никто не знает зачем.
//    На 847 — что-то происходит.
// ============================================================
var GHOST={
    count:0,
    el:null,
    init:function(){
        this.el=$("ghostCount");
        try{this.count=parseInt(localStorage.getItem("ernie_ghost"))||0}catch(e){}
        this.update();
        // Активировать после этажа 1
        setTimeout(function(){
            if(G.currentFloor>=1&&GHOST.el)GHOST.el.classList.add("active");
        },5000);
    },
    increment:function(){
        this.count++;
        this.update();
        this.save();
        // Пульс при кратных 100
        if(this.count%100===0){
            if(this.el){this.el.classList.add("pulse");var self=this;setTimeout(function(){self.el.classList.remove("pulse")},2000)}
            vibrate(20);
        }
        // 847 — секретное событие
        if(this.count===847&&!G.uc._ghost847){
            G.uc._ghost847=true;
            setTimeout(function(){
                SUBLIMINAL.flash("847",300);
                vibrate(100);
                setTimeout(function(){
                    notify("👁 847","gold");
                    G.karma+=3;G.trust+=1;updH();
                    addEcho(20,"847");
                    MICRO.show("◆ число совпало");
                },500);
            },1000);
        }
    },
    update:function(){if(this.el)this.el.textContent=this.count},
    save:function(){try{localStorage.setItem("ernie_ghost",this.count.toString())}catch(e){}}
};
setTimeout(function(){GHOST.init()},1000);

// Считать при каждом тапе
document.addEventListener("click",function(){
    if(G.currentFloor>=1)GHOST.increment();
});

// ============================================================
// 5. MICRO-ACHIEVEMENTS — тихие шёпоты
//    Не popup, а элегантный шёпот внизу экрана
// ============================================================
var MICRO={
    queue:[],busy:false,
    show:function(text){
        this.queue.push(text);
        if(!this.busy)this.drain();
    },
    drain:function(){
        if(this.queue.length===0){this.busy=false;return}
        this.busy=true;
        var text=this.queue.shift();
        var el=document.createElement("div");
        el.className="micro-ach";
        el.textContent=text;
        document.body.appendChild(el);
        var self=this;
        setTimeout(function(){el.remove();self.drain()},3200);
    },
    // Авто-ачивки по событиям
    trackAction:function(action){
        var achieved=G.uc._microAch||{};
        if(achieved[action])return;
        achieved[action]=true;
        G.uc._microAch=achieved;
        var labels={
            firstChoice:"первый выбор",
            firstItem:"первый предмет",
            firstNPC:"первая встреча",
            firstDeath:"первая смерть",
            petCat:"погладил кошку",
            namedCat:"дал имя",
            readWall:"прочитал стену",
            drankCoffee:"выпил кофе",
            foundSecret:"нашёл секрет",
            savedNPC:"спас призрака",
            reachedFloor5:"середина башни",
            reachedFloor9:"почти вершина",
            reachedRoof:"крыша",
            survived10min:"10 минут в башне",
            survived30min:"30 минут в башне",
            noSkip:"читал не торопясь",
            allLocations:"исследовал всё"
        };
        if(labels[action])this.show(labels[action]);
    }
};
// Отслеживание времени для ачивок
setTimeout(function(){MICRO.trackAction("survived10min")},600000);
setTimeout(function(){MICRO.trackAction("survived30min")},1800000);

// ============================================================
// 6. ERNIE TELLS — визуальные подсказки когда врёт
//    Экран слегка глючит когда ERNIE скрывает правду
// ============================================================
var TELLS={
    // Моменты когда ERNIE врёт или скрывает
    lieFloors:{
        1:true,// Не говорит про стены из людей
        2:true,// Скрывает правду о Тени
        3:true,// Скрывает запретную секцию
        7:true // Скрывает своего двойника
    },
    check:function(){
        if(!this.lieFloors[G.currentFloor])return;
        if(Math.random()<0.15){
            document.body.classList.add("ernie-tell");
            setTimeout(function(){document.body.classList.remove("ernie-tell")},4000);
        }
    },
    hesitate:function(){
        document.body.classList.add("ernie-hesitate");
        setTimeout(function(){document.body.classList.remove("ernie-hesitate")},1500);
    }
};

// ============================================================
// 7. CINEMATIC MODE — кинематографические моменты
//    Чёрные полосы + замедление + фокус
// ============================================================
var CINEMA={
    active:false,
    enter:function(){
        if(this.active)return;
        this.active=true;
        document.body.classList.add("cine-bars","active");
        vibrate(10);
    },
    exit:function(){
        this.active=false;
        document.body.classList.remove("active");
        setTimeout(function(){document.body.classList.remove("cine-bars")},800);
    },
    // Вход на новый этаж — кинематографический
    floorReveal:function(imgKey){
        this.enter();
        // Deep zoom на картинку
        var imgW=$("gImgW");
        if(imgW)imgW.classList.add("deep-zoom");
        setTimeout(function(){
            if(imgW)imgW.classList.remove("deep-zoom");
        },1200);
        var self=this;
        setTimeout(function(){self.exit()},4000);
    }
};

// ============================================================
// 8. RETURN HOOK — фраза при закрытии + при возвращении
// ============================================================
var RETURN_HOOK={
    // Сохранить "последнее что делал" для возвращения
    saveState:function(){
        try{
            var state={
                floor:G.currentFloor,
                karma:G.karma,
                hasCat:G.hasCat,
                catName:G.catName,
                trust:G.trust,
                lastAction:Date.now(),
                savedCount:countSaved?countSaved():0,
                items:G.items?G.items.length:0
            };
            localStorage.setItem("ernie_return",JSON.stringify(state));
        }catch(e){}
    },
    // Получить контекст возвращения
    getReturnContext:function(){
        try{
            var s=localStorage.getItem("ernie_return");
            return s?JSON.parse(s):null;
        }catch(e){return null}
    }
};
// Автосохранение контекста
setInterval(function(){RETURN_HOOK.saveState()},15000);
// При закрытии
window.addEventListener("beforeunload",function(){RETURN_HOOK.saveState()});
document.addEventListener("visibilitychange",function(){
    if(document.hidden)RETURN_HOOK.saveState();
});

// ============================================================
// INTEGRATION: Привязать системы к игровому циклу
// ============================================================

// Ghost counter при каждом выборе
var __origShowCh=showCh;
showCh=function(arr){
    __origShowCh(arr);
    GHOST.increment();
    TELLS.check();
    // Pulse-choice на первую кнопку если это важный выбор
    setTimeout(function(){
        var btns=document.querySelectorAll(".g-cb");
        if(btns.length>=3&&btns[0])btns[0].classList.add("pulse-choice");
    },500);
};

// Cinematic mode при входе на этажи
var __origShowDoorF=typeof showDoorF==="function"?showDoorF:null;
setTimeout(function(){
    if(typeof showDoorF==="function"&&!window._doorPatched){
        window._doorPatched=true;
        var orig=showDoorF;
        showDoorF=function(num,label,cb){
            CINEMA.enter();
            GHOST.increment();
            // Micro-achievement по этажам
            if(num===5)MICRO.trackAction("reachedFloor5");
            if(num===9)MICRO.trackAction("reachedFloor9");
            if(num===10)MICRO.trackAction("reachedRoof");
            orig(num,label,function(){
                CINEMA.exit();
                if(cb)cb();
            });
        };
    }
},500);

// Typing indicator перед случайными репликами ERNIE
var __origNotify2=notify;
notify=function(t,tp){
    __origNotify2(t,tp);
    GHOST.increment();
};

// Subliminal при опасных моментах
var __origAddDread=addDread;
addDread=function(n){
    __origAddDread(n);
    if(n>=20){
        SUBLIMINAL.flash(null,200);
    }
};

// Micro-achievements hooks
var __origAddItem=typeof addItem==="function"?addItem:null;
setTimeout(function(){
    if(typeof addItem==="function"&&!window._itemPatched){
        window._itemPatched=true;
        var orig=addItem;
        addItem=function(key){
            orig(key);
            MICRO.trackAction("firstItem");
            GHOST.increment();
        };
    }
    // petCat
    if(typeof petCat==="function"&&!window._petPatched){
        window._petPatched=true;
        var origPet=petCat;
        petCat=function(){
            origPet();
            MICRO.trackAction("petCat");
        };
    }
},500);

// ============================================================
// PARALLAX: Лёгкий параллакс на картинке при наклоне/движении
// ============================================================
(function(){
    var imgEl=null;
    function updateParallax(x,y){
        if(!imgEl)imgEl=$("gI");
        if(!imgEl)return;
        var dx=(x-0.5)*8;// ±4px
        var dy=(y-0.5)*4;// ±2px
        imgEl.style.transform="scale(1.08) translate("+dx+"px,"+dy+"px)";
    }
    // Gyroscope
    if(window.DeviceOrientationEvent){
        window.addEventListener("deviceorientation",function(e){
            if(e.gamma===null)return;
            var x=Math.max(0,Math.min(1,(e.gamma+45)/90));
            var y=Math.max(0,Math.min(1,(e.beta-20)/60));
            updateParallax(x,y);
        });
    }
    // Fallback: touch position
    document.addEventListener("touchmove",function(e){
        var t=e.touches[0];
        if(!t)return;
        var x=t.clientX/window.innerWidth;
        var y=t.clientY/window.innerHeight;
        updateParallax(x,y);
    },{passive:true});
})();

// ============================================================
// SNAP TEXT: Для ключевых моментов — слова появляются по одному
// ============================================================
function snapText(el,text,cb){
    var words=text.split(/\s+/);
    el.innerHTML="";
    words.forEach(function(w,i){
        var span=document.createElement("span");
        span.className="snap-word";
        span.textContent=w+" ";
        span.style.animationDelay=(i*0.12)+"s";
        el.appendChild(span);
    });
    if(cb)setTimeout(cb,words.length*120+400);
}

// ============================================================
// MYSTERY BREADCRUMBS: Скрытые числа и символы
// ============================================================
setInterval(function(){
    if(G.currentFloor<2||G.currentFloor>=10)return;
    if(Math.random()>0.04)return;// 4% каждые 40 сек
    var crumbs=["₈₄₇","∞","◇","⟐","⌇","░","▒"];
    var crumb=crumbs[Math.floor(Math.random()*crumbs.length)];
    var el=document.createElement("div");
    el.style.cssText="position:fixed;z-index:1;pointer-events:none;font-size:"+(8+Math.random()*6)+"px;color:rgba(90,127,160,"+(0.03+Math.random()*0.04)+");top:"+(10+Math.random()*80)+"%;left:"+(5+Math.random()*90)+"%;transition:opacity 8s;font-family:monospace";
    el.textContent=crumb;
    document.body.appendChild(el);
    setTimeout(function(){el.style.opacity="0";setTimeout(function(){el.remove()},8000)},3000);
},40000);
            function sendFeedback(){
                var t=$("feedbackText").value.trim();if(!t)return;
                // Сохраняем локально + открываем Telegram
                try{var fb=JSON.parse(localStorage.getItem("ernie_feedback")||"[]");fb.push({text:t,date:new Date().toISOString(),karma:G.karma,floor:G.currentFloor});localStorage.setItem("ernie_feedback",JSON.stringify(fb))}catch(e){}
                // Отправка через Telegram — замени USERNAME на свой
                var msg="🏚 ERNIE Feedback\n\n"+t+"\n\n◆ Карма: "+(G.karma>0?"+":"")+G.karma+"\n♥ Жизни: "+G.lives+"\n🏁 Этаж: "+(G.currentFloor||"?")+"\n🔄 Прохождение: "+TM.runs;
                if(G.catName)msg+="\n🐱 "+G.catName;
                window.open("https://t.me/share/url?text="+encodeURIComponent(msg),"_blank");
                $("feedbackWrap").innerHTML='<div style="font-family:Raleway,sans-serif;font-size:14px;color:var(--gold);font-style:italic">Спасибо. ERNIE запомнит.</div>'
            }
        </script>
<div id="notePopup" onclick="this.classList.remove('show')">
<div id="noteInner" onclick="event.stopPropagation()">
<div class="note-title">ОБРЫВОК</div>
<div class="note-text" id="noteText"></div>
<div class="note-close" onclick="document.getElementById('notePopup').classList.remove('show')">закрыть</div>
</div>
</div>
<div id="itemPopup" onclick="closeItemPop()">
<img id="itemPopImg" src="">
<div id="itemPopName"></div>
<div id="itemPopDesc"></div>
<div id="itemPopClose">закрыть</div>
</div>
<div id="vigDiv" class="vignette vig-5"></div>
<div id="heartbeatLine"></div>
<div id="emotionBar"></div>
<div id="promiseWhisper"></div>
<div id="patternNote"></div>
<div id="ernieTyping"><span class="et-name">ERNIE</span><div class="typing-dots"><span></span><span></span><span></span></div></div>
<div id="subFlash"><div class="sf-text"></div></div>
<div id="ghostCount">0</div>
<div id="diaryOverlay"><div id="diaryClose" onclick="closeDiary()">✕</div><div id="diaryTitle">📓 ДНЕВНИК БАШНИ</div><div id="diaryList"></div></div>
<div id="wallNote" onclick="closeWallNote()"><div class="wn-icon" id="wnIcon">📜</div><div class="wn-text" id="wnText"></div><div class="wn-close" onclick="closeWallNote()">закрыть</div></div>
<div id="tbc">
<div id="tbcLine"></div>
<div id="tbcTitle"></div>
<div id="tbcSub"></div>
<div id="tbcCont">продолжение следует...</div>
<div id="tbcReplay" onclick="location.reload()">начать заново</div>
<div id="tbcShare" onclick="shareTBC()" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue);letter-spacing:2px;opacity:0;transition:opacity 1s ease 5s;cursor:pointer;padding:8px 20px;border:1px solid rgba(90,127,160,.15);border-radius:3px;margin-top:8px">поделиться</div>
<div id="tbcSocial" style="display:none">
<div onclick="shareWA()" style="cursor:pointer;font-size:22px;padding:6px;border-radius:50%;background:rgba(37,211,102,.1);border:1px solid rgba(37,211,102,.15)">💬</div>
<div onclick="shareTG()" style="cursor:pointer;font-size:22px;padding:6px;border-radius:50%;background:rgba(0,136,204,.1);border:1px solid rgba(0,136,204,.15)">✈️</div>
</div>
<div id="tbcInvite" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold);letter-spacing:2px;opacity:0;transition:opacity 1s ease 6s;cursor:pointer;padding:10px 24px;border:1px solid rgba(200,168,72,.25);border-radius:3px;margin-top:14px;background:rgba(200,168,72,.05)" onclick="inviteFriend()">🎁 пригласить друга в башню</div>
<a id="tbcDonate" href="https://boosty.to/ernie_tower" target="_blank" style="display:block;font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(200,168,72,.4);letter-spacing:1px;opacity:0;transition:opacity 1s ease 8s;cursor:pointer;padding:8px 20px;margin-top:12px;border:1px solid rgba(200,168,72,.1);border-radius:3px;text-decoration:none">☕ если игра что-то значила</a>
<div id="tbcFeedback" style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txtd);letter-spacing:1px;opacity:0;transition:opacity 1s ease 7s;cursor:pointer;padding:8px 16px;margin-top:10px;border:1px solid rgba(90,127,160,.08);border-radius:3px" onclick="showFeedback()">✉️ написать создателю</div>
<div id="feedbackWrap" style="display:none" style="display:none;margin-top:12px;text-align:center">
<textarea id="feedbackText" maxlength="200" placeholder="" style="background:var(--bg3);border:1px solid rgba(74,107,138,.15);color:var(--txt);font-size:13px;padding:10px;border-radius:4px;width:220px;height:60px;font-family:inherit;resize:none;outline:none"></textarea>
<br><button onclick="sendFeedback()" style="margin-top:8px;padding:8px 20px;background:var(--bg3);border:1px solid rgba(200,168,72,.15);color:var(--gold);font-size:10px;border-radius:3px;font-family:'JetBrains Mono',monospace;letter-spacing:2px">отправить</button>
</div>
</div>
<div id="ravenPopup" onclick="closeRavenPop()">
<img id="ravenPopImg" src="">
<div id="ravenPopRight">
<div id="ravenPopName">ВОРОН</div>
<div id="ravenPopText"></div>
</div>
<div id="ravenPopClose" onclick="closeRavenPop()">✕</div>
</div>
<div id="ghostPopup" onclick="closeGhostPop()" style="display:none;position:fixed;top:60px;left:12px;right:12px;max-width:340px;background:rgba(20,18,25,.95);border:1px solid rgba(200,168,72,.15);border-radius:12px;padding:12px 14px;z-index:200;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.5);transition:opacity .5s ease,transform .5s ease">
<div style="display:flex;align-items:center;gap:12px">
<img id="ghostPopImg" src="" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid rgba(200,168,72,.2);flex-shrink:0">
<div style="flex:1;min-width:0">
<div id="ghostPopName" style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--gold);letter-spacing:2px;margin-bottom:4px">БАРИСТА</div>
<div id="ghostPopText" style="font-family:Raleway,sans-serif;font-size:13px;color:var(--txt);line-height:1.5;font-style:italic;white-space:pre-line"></div>
</div>
</div>
</div>
    
<div id="cafeMenu" onclick="closeCafeMenu()">
<div class="cafe-menu-card" onclick="event.stopPropagation()">
<div class="cafe-menu-title">☕ МЕНЮ</div>
<div class="cafe-menu-item" onclick="orderDrink('espresso')"><span class="cafe-menu-icon">☕</span><div><div class="cafe-menu-name">Эспрессо</div><div class="cafe-menu-price">Ваша душа</div></div></div>
<div class="cafe-menu-item" onclick="orderDrink('latte')"><span class="cafe-menu-icon">🥛</span><div><div class="cafe-menu-name">Латте</div><div class="cafe-menu-price">Ваша душа с молоком</div></div></div>
<div class="cafe-menu-item" onclick="orderDrink('cappuccino')"><span class="cafe-menu-icon">☁️</span><div><div class="cafe-menu-name">Капучино</div><div class="cafe-menu-price">Ваша душа с пенкой</div></div></div>
<div class="cafe-menu-item" onclick="orderDrink('americano')"><span class="cafe-menu-icon">🫗</span><div><div class="cafe-menu-name">Американо</div><div class="cafe-menu-price">Ваша душа, разбавленная</div></div></div>
<div class="cafe-menu-item" onclick="orderDrink('hotchoc')"><span class="cafe-menu-icon">🍫</span><div><div class="cafe-menu-name">Горячий шоколад</div><div class="cafe-menu-price">Обещано Лике. Не трогай.</div></div></div>
<div class="cafe-menu-item" onclick="orderDrink('tea')"><span class="cafe-menu-icon">🍵</span><div><div class="cafe-menu-name">Чай</div><div class="cafe-menu-price">Серьёзно?</div></div></div>
<div class="cafe-menu-item" onclick="orderDrink('water')"><span class="cafe-menu-icon">💧</span><div><div class="cafe-menu-name">Вода</div><div class="cafe-menu-price">Бесплатно. Как всё тут.</div></div></div>
<div class="cafe-menu-note" id="cafeMenuNote">Все напитки призрачные.<br>Побочный эффект: лёгкая прозрачность.</div>
</div>
</div>
</body>
</html>
